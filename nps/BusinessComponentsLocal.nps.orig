/**
 * BusinessComponentsLocal.nps
 * This NPS file implements Local Business Componentes.
 * added centralized location. 
 *
 * Copyright - (c) 2005-2007 - Torex Retail PLC-
 *
 * $Source -: /NewPOS/SRC/np61cvs/cvs/___Config61/Posdata/US/nps/BusinessComponentsLocal.nps,v
 * $Revision: .1.18 $
 * $Date: 2009/09/24 18:31:41 $ (of revision)
  * $Author: rschreiber $ (of revision)
 */
const TENDER_SCREEN_NBR="53";
const STORE_SCREEN_NBR="51";
const STORE_MOBILE_ORDER="49";
const RECALL_MOBILE_ORDER="50";


const MOBILE_PAYMENT_EXECUTE	= 0;
const MOBILE_PAYMENT_CANCEL		= 1;
const MOBILE_PAYMENT_TIMEDOUT	= 2;
const BYPREVIEW_SCREEN_NBR="9998";

const MOS_NONE			= 0;
const MOS_SUBMITTED		= 1;
const MOS_RECALLED		= 2;
const MOS_PENDING		= 3;
const MOS_CANCELLED		= 4;
const MOS_AUTHORIZED	= 5;
const MOS_DECLINED		= 6;
const MOS_TIMEDOUT		= 7;

const MAP_NONE			= 0;
const MAP_AUTHORIZED	= 1;
const MAP_DECLINED		= 2;

const INITIAL_BUSINESS_DATE="InitialBusinessDate";
const FINAL_BUSINESS_DATE="FinalBusinessDate";

const ANY_TENDER = "ANY_TENDER";

// Product types (classes)
const PC_UNDEFINED_KIND				=	0;		//!< Undefined kind
const PC_RAW_ITEM					=	1;		//!< Raw ingredient
const PC_PRODUCT					=	2;		//!< Regular product
const PC_VALUE_MEAL					=	3;		//!< Value meal
const PC_CHOICE						=	4;		//!< Choice (pseudo-product)
const PC_GROUP						=	5;		//!< Group (pseudo-product)
const PC_COMMENT					=	6;		//!< Comment
const PC_OPTION						=	7;		//!< Heads optional components
												//!< like cann-adds and comments (pseudo-product)
const PC_NON_FOOD_PRODUCT			=	8;		//!< Non food product
const PC_COUPONS					=	9;		//!< Coupons

var DISCOUNT_KIND_CUSTOMER		= 0;
var DISCOUNT_KIND_EMPLOYEE_MEAL	= 1;
var DISCOUNT_KIND_MANAGER_MEAL	= 2;
var DISCOUNT_KIND_POLICE		= 3;

//Credit tender codes
var TENDER_CODE_AMEX			= 21;
var TENDER_CODE_VISA			= 22;
var TENDER_CODE_MASTER			= 23;

var ZERO_DUE_AMOUNT             = "0.00";

var gsCurrOrderID = ""; //!< Current order ID 
var gsLastOrderID = ""; //!< Last order ID 
executeScript("Offers.nps", true);
executeScript("BCCoinDispenser.nps",true);
executeScript("BCCashless.nps",true);
executeScript("BCTandem.nps",true);
executeScript("BCCOD.nps",true);
executeScript("BCEvents.nps",true);
executeScript("telequipt.nps",true);
executeScript("taxFilters.nps",true);
executeScript("MobileCheckin.nps",true);
executeScript("everest.nps",true);
executeScript("Cashless3.nps",true);

/** PosDoSkipCarJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosDoSkipCarJS</b>\n
 * This BC put skip Car!\n
 * In a workflow sequence it is called:<b>PosDoSkipCarJS</b>\n
 * In java script it should be called:<b>PosDoSkipCarJS</b>\n
 * Return - rval - true if possible
 */
function PosDoSkipCarJS() {
	return(PosDoSkipCar_CSL());
}


/**PosChangeTaxModeJS
 *
 * @brief - This BC gives a discount in a sale
 * Return - rval - true if allowed to continue
 */
function PosChangeTaxModeJS(mode,flags)
{
	return(PosChangeTaxMode_CSL(mode,flags));
}

/**StartSpecialTrxJS
 *
 * @brief - This BC starts a special transaction (waste,refund)
 * Return - rval - true if allowed to continue
 */
function StartSpecialTrxJS(level,singleSignOn,kind,message,destination)
{
	return(StartSpecialTrx_CSL(level,singleSignOn,kind,message,destination));
}

/**HideButtonIfMatchPODJS
 *
 * @brief - This BC hhides a button (according to a type)
 * Return - rval - true
 */

function HideButtonIfMatchPODJS(podType,btnType) {
	return(HideButtonIfMatchPOD_CSL(podType,btnType));
}

/**PosChangePasswordJS
 *
 * @brief - This BC changes/resets an user password
 * changeType: "CHANGE","RESET","RESETALL"
 * Return - true if changed, false otherwise
 */
function PosChangeUserPasswordJS(changeType) {
	return(PosChangeUserPassword_CSL(changeType));
}

/**PosTimePunchJS
 *
 * @brief - This BC set a time punch for a user
 * Return - true if changed, false otherwise
 */
function PosTimePunchJS()
{
	return(PosTimePunch_CSL());
}

/**PosChangeBtnTitleJS
 *
 * @brief - This BC changes the title of a button according to a received propertu message
 * Return - true
 */
function PosChangeBtnTitleJS(btnNbr,msg,c1,c2,c3) {

	return(PosChangeBtnTitle_CSL(btnNbr,msg,c1,c2,c3));
}

/**PosIsBreakfastTimeJS
 *
 * @brief - This BC shows checks if it is breakfast time (or a flag is set indicating that)
 * Return - true if breakfast time, false otherwise
 */
function PosIsBreakfastTimeJS() {
	return(PosIsBreakfastTime_CSL());
}

/**PosCheckClicksJS
 *
 * @brief - This BC decrements the number of clicks for a given screen and shows a new screen if the number of clicks is zeroed
 * Return - true if breakfast time, false otherwise
 */
function PosCheckClicksJS(screenNbr) {

	return(PosCheckClicks_CSL(screenNbr));
}

/**PosCheckChoicesJS
 *
 * @brief - This BC checks for open choice of a kind
 * Return - rval - true if allowed to continue
 */
function PosCheckChoicesJS(choices) {
	return(PosCheckChoices_CSL(choices));
}

/**PosIsSaleEmptyJS()
 *
 * @brief - This BC checks if a sale is empty
 * Return - true if empty
 */
function PosIsSaleEmptyJS() {
	return(PosIsSaleEmpty_CSL());
}

/**PosSetSessionPropertyForAllJS
 *
 * @brief - This BC sets a session property in all registers online
 * Return - true if empty
 */
function PosSetSessionPropertyForAllJS(key,value,persist) {
	return(PosSetSessionProperty(key,value,persist,true));
}

/**PosDoTenderJS - removed unused copy of this function... */

/**PosNextDollarTenderJS
 *
 * @brief - This BC calculates the amount of the total due rounded up to the next dollar.  
 * Amounts are always raised to the next whole dollar. Both 2.00 and 2.99 would mean a 3.00 tender
 * Return - returns false if no sale in progress, otherwise return true
 */
function PosNextDollarTenderJS(tenderID, flags)
{
     var currentView = rootHlp.getCurrentView();
     if(currentView == null) {
          PosShowMessage("MSG_BC_NO_ORDER_IN_PROGRESS");
          return false;
     }

	// Get the current amount due, add 1 dollar and subract the cents portion from this amount
     var view = new XML(currentView);
	 var DecimalAmountDue = new BigDecimal(view.@totalDue);
	 DecimalAmountDue = DecimalAmountDue.add("1.00");
	 var CentsPartIndex = DecimalAmountDue.toString().indexOf('.');
	 var CentsPart = DecimalAmountDue.toString().substr(CentsPartIndex);
	 DecimalAmountDue = DecimalAmountDue.subtract(CentsPart);
	 
	 // Now tender the order with the calculated amount
	 PosDoTenderJS(tenderID, DecimalAmountDue, flags);
	 
	 return true;
	 
}

/** PosCanVoidSaleJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosCanVoidSaleJS</b>\n
 * This BC checks if it's possible to void a sale!\n
 * In a workflow sequence it is called:<b>PosCanVoidSaleJS</b>\n
 * In java script it should be called:<b>PosCanVoidSaleJS()</b>\n
 * This BC does not require parameters.\n
 * Return - rval - True if possible
 */
function PosCanVoidSaleJS() {

     const COUPONS=9;

     var currentView = rootHlp.getCurrentView();
     if(currentView == null) {
          PosShowMessage("MSG_BC_NO_ORDER_TO_VOID");
          return false;
     }

     var view = new XML(currentView);
     if((view.@transactionKind == ACC_OT_MANAGER) || (view.@transactionKind == ACC_OT_CREW)) {
          PosShowMessage("MSG_BC_VOID_CREW_MEAL");
          return false;
     }
     if((view.@transactionKind != ACC_OT_SALE) && (view.@transactionKind != ACC_OT_DISCOUNT)) {
          PosShowMessage("MSG_BC_VOID_LAST_SALE");
          return false;
     }

     if((view.@saleStatus == SALE_STATUS_CURRENT_VOIDED) || (view.@saleStatus == SALE_STATUS_LAST_VOIDED)) {
          PosShowMessage("MSG_BC_OVERRUNG_ORDER");
          return false;
     }

     var allowed = true;

     var items = view.ItemView;
     if(items.length() != 0) {
		  // SDE-2782  RPS 08/18/2009
          var giftCard = items.((quantity > 0) && (familyGroup == GIFT_COUPON) && ((productType == NON_FOOD_PRODUCT) || (productType == GIFT_COUPON)) && (category == PAPER));
          allowed=(giftCard.length() == 0);
          if(!allowed) {
               PosShowMessage("MSG_BC_OVERRING_GC");
          }
     }
     var tenders    = view.ItemTenderView;
     if((allowed) && (tenders.length() != 0)) {
          var electronicPayment = tenders.(cat == "TENDER_ELECTRONIC_PAYMENT");
          allowed=(electronicPayment.length() == 0);
          if(!allowed) {
               PosShowMessage("MSG_BC_OVERRING_CASHLESS");
          }
     }
     return allowed;
}

/** CanSellGiftCardJS
 *
 * @brief - This function implements the BC,Business Component: <b>CanSellGiftCardJS</b>\n
 * This BC checks if it's possible to sell gift cards!\n
 * In a workflow sequence it is called:<b>CanSellGiftCardJS</b>\n
 * In java script it should be called:<b>CanSellGiftCardJS</b>\n
 * Return - rval - true if possible
 */
function CanSellGiftCardJS()
{
     // check if it's refund or waste
     if(PosCheckTransactionKind("1") || PosCheckTransactionKind("2")) {
          return(false);
     }
     if(PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) {
          return(true);
     }
     if(PosCheckSessionProperty("POD","HOT")) {
          return(true);
     }
	// NVS-109  RPS  10-15-09   Always allow MOT to sell Gift Cards
	if (PosCheckParameter("PosType", "IsMOT", "true")) {
		return(true);
	}
     return(PosIsAdaptorLoadedJS("ESocket") || PosCheckParameter("Cashless3", "Active", "true"));  //NVS - 229 JWC 5-6-10
}

/** CanReceiveCouponsJS()
 *
 * @brief - This function implements the BC,Business Component: <b>CanReceiveCouponsJS</b>\n
 * This BC checks if it's possible to receive coupons as payment.\n
 * In a workflow sequence it is called:<b>CanReceiveCouponsJS</b>\n
 * In java script it should be called:<b>CanReceiveCouponsJS</b>\n
 * Return - rval - true if possible
 */
function CanReceiveCouponsJS()
{

     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(auxShowMessageClearCalc("MSG_BC_NO_ORDER_IN_PROGRESS"));
     }
     var view = new XML(curView);
     var items = view.ItemView;
     if(items.length() == 0) {
          return(true);
     }
	 var offers = view.Offers;
     if(offers.length() > 0) { // && !PosCheckParameter("Account","AllowCouponInOffer","true")) {  ***** NVS-1667 leaving reference to parameter as comment. Might use it later.
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_OFFER"));
     }
     var giftCard = items.((quantity > 0) && (familyGroup == GIFT_COUPON) && (productType == NON_FOOD_PRODUCT) && (category == PAPER));
     if(giftCard.length() != 0) {
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_GC"));
     }
     var giftOrCoupon = items.((quantity > 0) && (familyGroup == GIFT_COUPON));
     if(giftOrCoupon.length() != 0) {
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_COUPON"));
     }
    if("true"!=rootHlp.findParamInSectionConfig("AllowNonProductDiscount","Cash"))
	{
		var NonProduct = items.((quantity > 0) && (isGrillLine != "true") && (familyGroup == NON_FOOD_PRODUCT));
		if(NonProduct.length() != 0) {
		  return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_NON_PRODUCT"));
		}
    }
     return(true);
}

/**PosCanApplyPromoOrder
 *
 * @brief - This BC verifies if it's possible to promo an order
 * Return - rval - true if allowed to continue
 */
function PosCanApplyPromoOrder()
{
     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(true);
     }
     var view = new XML(curView);
     if(null == view) {
          return(true);
     }

	// It's not allowed execute Promo Order when there are any kind of Deposits
	var deposit = view.Deposit;
	if(deposit.length() > 0) {
		if(PosCheckParameter("Account","AllowDepositInPromo","false")) {
			// There is Deposit
			PosShowMessage ("PROMO is not possible: There are Deposit in this sale");
			return(false);
		}
	}

	if((view.@transactionKind != ACC_OT_SALE) && (view.@transactionKind != ACC_OT_DISCOUNT)
			&& (view.@transactionKind != ACC_OT_MANAGER) && (view.@transactionKind != ACC_OT_CREW)) {
		return(true);
	}

	if (hasFloatPriceItems()) {
		// SQC-443 - By KFG
		PosShowMessage("MSG_BC_INVPROMO");
		return false;
	}
     var items=view.ItemView;
     if(null == items) {
          return(true);
     }
     var giftCardLines=0;
     var i;
     for(i=0; i < items.length(); i++) {
          var item=items[i];

        // SDE-1444
          var bGiftCard = (item.quantity > 0) && (item.familyGroup == GIFT_COUPON) && (item.productType == NON_FOOD_PRODUCT) && (item.category == PAPER);
          var bGiftCert = (item.quantity > 0) && (item.familyGroup == GIFT_COUPON) && (item.productType == 9) && (item.category == PAPER);

          if(bGiftCard || bGiftCert) {
               // Gift Card not allowed
               giftCardLines++;
          }
     }
     if(giftCardLines == items.length()) {
          PosShowMessage("MSG_BC_PROMO_GC_ORDER");
          return(false);
     }
     if(giftCardLines > 0) {
          PosShowMessage("MSG_BC_PROMO_GC");
          return(false);
     }
	return(true);

	/**hasFloatPriceItems
	 *
	 * @brief - Verifies if the current order has any float price item.
	 * @return - TRUE - if the order has at least one float price item.
	 * @since - NPS-5384 & SQC-443
	 * @author - Kalil
	 */
	function hasFloatPriceItems() {
		var curView = rootHlp.getCurrentView();
		if (curView != null) {
			var view = new XML(curView);
			var items = view.ItemView;
			for (var i=0;i<items.length();i++) {
				if ((new Number(items[i].isFloatPrice)>0) && (new Number(items[i].quantity)>0)) {
					return true;
				}
			}
		}
		return false;
	}
}

/** PosRecallByPreviewNotDTJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosRecallByPreviewNotDTJS</b>\n
 * This BC does the auto recall!\n
 * In a workflow sequence it is called:<b>PosRecallByPreviewNotDTJS</b>\n
 * In java script it should be called:<b>PosRecallByPreviewNotDTJS</b>\n
 * Return - rval - true if possible
 */
function PosRecallByPreviewNotDTJS()
{
     if(!PosCheckState("POS_OpLogged")) {
               PosShowMessage("MSG_BC_NOTOPENFORSALE");
               return(false);
     }

     if(!PosCheckSessionProperty("POD","DRIVE_THRU")) {
          if(!PosCheckCashDrawer()) {
               PosShowMessage("MSG_BC_DRAWEROPENED");
               return(false);
          }

          PosOffersClearMessage();   /* NPO-48 */
          var Recall_Result = PosRecallNextOrder("RecallByPreview");

          if (PosCheckSessionProperty("POD","FC") ) {
               // only move the screen to preivew if successful call
               if (Recall_Result == true) {
                    PosShowScreen(BYPREVIEW_SCREEN_NBR);
                    return(true);
               }
          } else {
               PosShowScreen(BYPREVIEW_SCREEN_NBR);
          }
     }
     return(false);
}

/** PosDoAutoRecallJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosDoAutoRecall</b>\n
 * This BC does the auto recall!\n
 * In a workflow sequence it is called:<b>PosDoAutoRecallJS</b>\n
 * In java script it should be called:<b>PosDoAutoRecallJS</b>\n
 * Return - rval - true if possible
 */
function PosDoAutoRecallJS()
{
     var RecalledNotDT=0;

    //NVS-362  11-1-10
	if (IsFaceToFace() == true)
	{
		return(false);
	}
    // SDE_1941 - auto recall should not happen during SKIM
    // is SKIM in progress?
    var bSkimInProgress = PosCheckSessionProperty("SkimInProgress","true");
    if (bSkimInProgress)
	{
        return(false);
    }

    if(!PosCheckSessionProperty("POD","DRIVE_THRU"))
	{
        if(PosCheckParameter("UserInterface","autoPreview","true"))
		{
               RecalledNotDT=1;
        }
		else
		{
               // autoPreview = false
               return(false);
          }

		if(RecalledNotDT==0)
		{ // Recalled  DT
			if(!PosCheckSessionProperty("POD","DRIVE_THRU") && !PosCheckSessionProperty("POD","WALK_THRU"))
			{
               return(false);
          }
     }
    }


    if(PosCheckParameter("UserInterface","DDTsupport","true") || (RecalledNotDT==1))
	{ // RecalledNotDT==1 autoPreview = true
        if(!PosCheckCashDrawer())
		{
               return(false);
          }
          PosOffersClearMessage();   /* NPO-48 */
          PosRecallNextOrder("RecallByPreview");
          PosShowScreen("9998");
          return(true);
     }
    
	if(PosCheckParameter("OperationMode","autoRecall","true"))
	{
			// Removed the following check for SDE-2001
			if(!PosCheckCashDrawer())
			{
			  return(false);
			}

			PosOffersClearMessage();   /* NPO-48 */

			/* if (PosRecallNextOrder()) */
			if(PosRecallNextOrder() && rootHlp.GetOrderSrc() == "" && rootHlp.GetMobileOrderStatus() == MOS_NONE)
			{
				var curView = rootHlp.getCurrentView();
					if(curView == null)
					{
					return(true);
				}
				var view = new XML(curView);
					if(null == view)
					{
					return(true);
				}

				// NPS-9744
					if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED)
					{
					return(true);
				}
					if (PosDoTotal())
					{
						if(view.@transactionKind == ACC_OT_SKIP_CAR)
						{
						PosDoTenderJS(0,-1,'NOPREVIEW');
						}
						else
						{
						PosDoBeforeTenderScreenJS();
						/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
						PosApplyOffers_COE(false);
					}
					}
					else
					{
					PosShowScreen(rootCtx.get("baseScreenId"));
				}
				return(true);
			}

    }

    return(false);
}

/** PosDoNextOrderJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosDoNextOrderJS</b>\n
 * This BC gets the next order!\n
 * In a workflow sequence it is called:<b>PosDoNextOrderJS</b>\n
 * In java script it should be called:<b>PosDoNextOrderJS</b>\n
 * Return - rval - true if possible
 */
function PosDoNextOrderJS()
{
     if(PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) {
          if(PosCheckSessionProperty("saleRecalled","true")) {
			if(!PosCheckCashDrawer()) {
				PosShowMessage("MSG_BC_DRAWEROPENED");
				return(false);
			}
		  	PosOffersBackFromTotal();  /* NPO-62 */
			PosOffersClearMessage();   /* NPO-48 */
			if(PosRecallNextOrder("next"))
			{
				if(rootHlp.GetOrderSrc() != '3' && rootHlp.GetOrderSrc() != '4')
				{
					if(PosDoTotal())
					{
						PosDoBeforeTenderScreenJS();
						/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
						PosApplyOffers_COE(false);
					}
				}
				return(true);
			}
               else {
                    if(PosNotATransactionInProgress(true)) {
                         PosShowScreen(rootCtx.get("baseScreenId"));
                    }
			}
		}
	}
	return(false);
}

function PosDoAcceptMobileOrderJS(bUpdateCOD,bAcceptCODDisable,bForceMobileOrder,bCalledFromPayByMobile)
{

	// nvs-1508
	if (bCalledFromPayByMobile == undefined)
	{
		PosCommStatusCOD("MSG_BC_ERRORSETCOD1");
	}
	var ret = false;
	ret = PosDoAcceptMobileOrder(bUpdateCOD,bAcceptCODDisable,bForceMobileOrder);

	return ret;
}

function PosStoreScreenReturnActivationJS()
{
	var ret = false;

	if(rootHlp.GetMobileOrderStatus() != MOS_PENDING)
	{
		ret = PosChangeButtonProperties(0,"disable|true");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"disable|false");
	}
	
	return ret;
}

function PosPayByMobileActivationJS()
{
	var ret = false;
	var MobileOrderStatus = rootHlp.GetMobileOrderStatus();
	if(MobileOrderStatus != MOS_NONE)
	{	
		ret = PosChangeButtonProperties(0,"visible|true");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"visible|false");
	}
	
	return ret;
}

function PosDoPayAtRestaurantJS()
{
	//NVS-4803 - msilva
	if (PosCheckSessionProperty("POD", "DRIVE_THRU")) { 
		ret = PosDoSendCommandToFOEJS(MOBILE_PAYMENT_CANCEL); 
		if(!ret){ 
			PosShowMessage('MSG_BC_MOBILE_REQUEST_FAILED'); 
		} 
		else { 
			//NVS-4801 - msilva
			PosSetSessionProperty("SavedFOEView", "", "true");	// NPS-12260 
		} 
		PosShowScreen(STORE_SCREEN_NBR); 
	} 
	else if (PosCheckSessionProperty("POD", "WALK_THRU")) { 
		PosShowScreen(STORE_SCREEN_NBR); 
	} 
	else { 
		PosShowScreen(TENDER_SCREEN_NBR); 
	} 	
	
}

function PosDoPayByMobileOrderJS()
{
	//NVS-4803 - msilva
	var ret = false; 
	
	if (PosCheckSessionProperty("POD", "DRIVE_THRU")) { 
		ret = PosDoSendCommandToFOEJS(MOBILE_PAYMENT_EXECUTE); 
		if(!ret) 
		{ 
			PosShowMessage('MSG_BC_MOBILE_REQUEST_FAILED'); 
		} 
		else 
		{ 
			//NVS-4801 - msilva
			PosSetSessionProperty("SavedFOEView", "", "true");	// NPS-12260 
			PosShowScreen(STORE_SCREEN_NBR); 
		} 
		PosDoAcceptMobileOrderJS('false','false','false','true'); // added parameter for NVS-1508
		PosRefreshButtons(); 
	} 
	else { 
		//NVS-4803 - msilva
		ret = true; 
		
		PosDoMobilePayment(); 
		
		var bEndOfSale = PosDoTender(-1, 0); 
		if (bEndOfSale) { 
			// Clear offers area 
			PosOffersClearMessage(); 
			PosDoEndOfSale(true); 
			PosShowScreen(rootCtx.get("baseScreenId")); 
		} 
		else { 
			PosShowScreen(TENDER_SCREEN_NBR); 
		} 
	} 
	
	return ret; 	
	
}

function PosDoSendCommandToFOEJS(command)
{
	var ret = false;
	ret = PosDoSendCommandToFOE(command);
	if(ret)
	{
		var MobileOrderStatus = MOS_NONE;
		switch(command)
		{
		case MOBILE_PAYMENT_EXECUTE:
			MobileOrderStatus = MOS_PENDING;
			break;
		case MOBILE_PAYMENT_CANCEL:
			MobileOrderStatus = MOS_NONE;
			break;
		case MOBILE_PAYMENT_TIMEDOUT:
			MobileOrderStatus = MOS_TIMEDOUT;
			break;
		}
		PosSetMobileOrderStatus(MobileOrderStatus);
	}
	
	return ret;
}

function isPartiallyApproved()
{
	var ret = false;
	try
	{
		var ViewXml = rootHlp.getCurrentView();
		var view = new XML(ViewXml);
		//Getting totalDue
		var TotalAmount = Number(view.@totalAmount);
		var TotalDue = Number(view.@totalDue);
		
		ret = (TotalDue != 0);
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[isPartiallyApproved] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[isPartiallyApproved] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function PosDoPaymentStatusActivationJS(ButtonFont,ApprovedColor,PartiallyApprovedColor,DeclinedColor,PendingColor)
{
	var ret = false;
	try
	{
		var PaymentStatus = rootHlp.GetMobileOrderStatus();
		
		var text = "";
		var color = "";
		
		switch(PaymentStatus)
		{
			case MOS_PENDING:
				text = "MSG_BC_MOBILE_PAYMENT_PENDING";
				color = PendingColor;
				break;
			case MOS_AUTHORIZED:
				var PartiallyApproved = isPartiallyApproved();
				text = (PartiallyApproved ? "MSG_BC_MOBILE_PARTIALLY_PAYMENT_APPROVED" : "MSG_BC_MOBILE_PAYMENT_APPROVED");
				color = (PartiallyApproved ? PartiallyApprovedColor : ApprovedColor);
				break;
			case MOS_DECLINED:
				text = "MSG_BC_MOBILE_PAYMENT_DECLINED";
				color = DeclinedColor;
				break;
			case MOS_TIMEDOUT:
				text = "MSG_BC_MOBILE_PAYMENT_TIMEDOUT";
				color = DeclinedColor;
				break;
			default:
				text = "Unknown";
				color = "BLACK";
				break;
		}
		//Set button property
		var Status = rootHlp.getSysMessage(text);
		var finaltext = rootHlp.getSysMessage("MSG_BC_MOBILE_PAYMENT_STATUS",Status);
		PosChangeButtonProperties(0,"textup|" + color);
		PosChangeButtonProperties(0,"title|" + finaltext);
		PosChangeButtonProperties(0,"font|" + ButtonFont);
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[PosDoPaymentStatusActivationJS] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[PosDoPaymentStatusActivationJS] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function PosDoServePaidJS()
{
	var ret = false;
	try
	{
		if (rootHlp.GetMobileOrderStatus() == MOS_DECLINED || rootHlp.GetMobileOrderStatus() == MOS_TIMEDOUT || isPartiallyApproved() == true)
		{
			PosDoPayOnSiteJS();
			return  true;
		}
	
	PosDoSetGenericCounter(false,0);
	ret = PosDoTenderJS(-1,0,'NOPREVIEW|SAVE');
	if(!ret)
	{
		ret = PosShowScreen(TENDER_SCREEN_NBR);
	}
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[PosDoServePaidJS] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[PosDoServePaidJS] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}
	
	return ret;
}

function PosDoPayOnSiteJS()
{
	var ret = false;

	PosDoSetGenericCounter(false,0);
	if(rootHlp.GetMobileOrderStatus() == MOS_PENDING)
	{
		PosDoSendCommandToFOEJS(MOBILE_PAYMENT_CANCEL);
	}
		
	ret = PosShowScreen(TENDER_SCREEN_NBR);
	
	return ret;
}

function PosDoBeforeTenderScreenJS()
{
	var ret = true;
	try
	{
		if(rootHlp.GetMobileOrderStatus() != MOS_NONE && rootHlp.GetOrderSrc() == '1' && rootHlp.GetMobileOrderStatus() != MOS_SUBMITTED)
		{
			var OrderKey = rootHlp.GetViewOrderKey();
			PosDoQueryPaymentStatus(OrderKey);
			ret = PosShowScreen(RECALL_MOBILE_ORDER);
			if(rootHlp.GetMobileOrderStatus() == MOS_PENDING)
			{
				PosDoSetGenericCounter(true,30);
			}
			else
			{
				PosDoSetGenericCounter(false,0);
			}
		}
		else
		{
			/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
			PosApplyOffers_COE(false);
			PosSetSessionProperty("runPromotionOnTotal","false",false,false)
			ret = PosShowScreen(TENDER_SCREEN_NBR);
			//NVS-4948 15-AUG-2016 John Brancaleon - Apply Offers before Applying promotions 
		}
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[PosDoBeforeTenderScreenJS] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[PosDoBeforeTenderScreenJS] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function PosDoMobileStoreReturnActivationJS()
{
	var ret = false;
	if(rootHlp.GetMobileOrderStatus() != MOS_NONE)
	{
		ret = PosChangeButtonProperties(0,"visible|false");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"visible|true");
	}
	
	return ret;
}


function PosDoRecallMobileButtonActivationJS()
{
	var ret = false;
	if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED)
	{
		ret = PosChangeButtonProperties(0,"bitmap|ServePaid.png");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"bitmap|PayOnSite.png");
	}
	
	return ret;
}

function PosDoRecallMobileButtonJS()
{
	var ret = false;
	if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED)
	{
		ret = PosDoServePaidJS();
	}
	else
	{
		ret = PosDoPayOnSiteJS();
	}
	
	return ret;
}

function PosDoServePaidActivationJS()
{
	var ret = false;

	if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED)
	{
		ret = PosChangeButtonProperties(0,"disable|false");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"disable|true");
	}
	
	return ret;
}
	
function PosDoServePayOnSiteActivationJS()
{
	var ret = false;
	if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED)
	{
		ret = PosChangeButtonProperties(0,"disable|true");
	}
	else
	{
		ret = PosChangeButtonProperties(0,"disable|false");
	}
	
	return ret;
}

/** PosDoRecallOrderJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosDoNextOrderJS</b>\n
 * This BC gets the next order!\n
 * In a workflow sequence it is called:<b>PosDoNextOrderJS</b>\n
 * In java script it should be called:<b>PosDoNextOrderJS</b>\n
 * Return - rval - true if possible
 */
function PosDoRecallOrderJS(type)
{
     if(!PosCheckCashDrawer()) {
		PosShowMessage("MSG_BC_DRAWEROPENED");
		return(false);
	}
     PosOffersClearMessage();   /* NPO-48 */
     if(PosRecallNextOrder(type)) {

		if(rootHlp.GetOrderSrc() == "")
		{
			var curView = rootHlp.getCurrentView();
			if(curView == null) {
				return(true);
			}
			var view = new XML(curView);
			if(null == view) {
				return(true);
			}

			// NPS-9744
			if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED) {
				return(true);
			}
			// NVS-3672 - Felipe Ramas
			 if (!PosCheckSessionProperty("POD","DT")){
				 // Non-CYT orders when recalled goes to Tender Screen, CYT orders get back to Sales Screen - Felipe Ramas/Marcelo Tripoli - NVS-3418
				 if(PosHasCYTProductInSale(true) && PosVerifyTagId())
				 {
					/* Ensure for tagid */
					PosDoBackFromTotal();  
					PosShowScreen(rootCtx.get("baseScreenId"));
					return false;
				 }
			 }
			if (PosDoTotal()) {
				if(view.@transactionKind == ACC_OT_SKIP_CAR) {
					PosDoTenderJS(0,-1,'NOPREVIEW');
				}
				else {
					// NVS-791
					if(hlp.isPromoOrder()) { 
						//Turn off the get authorization to discount 
						PosSetSessionProperty("discountForPromoOrder","true","false"); 
						PosSetSessionProperty("CalledFromPromoOrder","true","false");
						PosDoPromoOrder(); 
						//Turn on the get authorization to discount 
						PosSetSessionProperty("discountForPromoOrder","false","false"); 
					} 
					PosDoBeforeTenderScreenJS();
					/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
					PosApplyOffers_COE(false);
				}
			}
			else {
				PosShowScreen(rootCtx.get("baseScreenId"));
			}
		}
		else if(rootHlp.GetOrderSrc() == "1")
		{
			if (PosDoTotal())
			{ 
				PosDoBeforeTenderScreenJS();
			}
		}
		return(true);
	}
	else {
		if(PosNotATransactionInProgress(true)) {
			PosShowScreen(rootCtx.get("baseScreenId"));
          }
     }
     return(false);
}

/**PosPromoOrderJS
 *
 * @brief - This BC promo-es an order
 * Return - rval - true if allowed to continue
 */
function PosPromoOrderJS(level,sigleSignOn,promoType,preview,choices)
{
	var saleType = 0;
     if(PosNotATransactionInProgress(true)) {
          PosShowMessage("MSG_BC_NO_ORDER_IN_PROGRESS");
          return(false);
     }

	//NVS-4118 - msilva - Change to support Table Service Model Specifications on Promoted orders
	if(PosCheckSessionProperty("PromoOrderInProgress","true")){
		saleType = rootHlp.getSaleType();
	}else{

		// Lindomar Araujo - 2016/08/11 - NVS-4960 Changed to ask for the manager authorization before asking the saleType(EatIn or TakeOut)
		if(!PosValidatePromoOrder(level, sigleSignOn)) { //NVS-776
			return(false); 
		} 

		if(PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) {
			// Drive Thru
			saleType = 1;
			PosSetSaleType(saleType);
			PosSetSessionProperty("PromoOrderInProgress","true","true");
		 }
		 else {
			if(!PosItemSelection("eatin.png|takeout.png|cancel.png","0|1|2","Select","Select EatIn - TakeOut or Cancel")) {
				PosSetSessionProperty("discountForPromoOrder","false","false");
			   return(false);
			}
			var ret=Number(rootCtx.get("SelectedButtonValue"));
			if((ret != 0) && (ret != 1)) {
				/* NVS-892 -needs to be cleared if the user presses cancel */
				PosSetSessionProperty("discountForPromoOrder","false","false");
				PosSetSessionProperty("CalledFromPromoOrder","false","false");
			   return(false);
			}
			saleType = ret;
			PosSetSaleType(saleType);
			PosSetSessionProperty("PromoOrderInProgress","true","true");
		}	
	}

	//NVS-4118 - msilva - Change to support Table Service Model Specifications on Promoted orders
	PosShowScreen(rootCtx.get("baseScreenId"));
	var verifyAndShowTagIdSmartScreenJSResult = VerifyAndShowTagIdSmartScreenJS(false,saleType);
	if(verifyAndShowTagIdSmartScreenJSResult) 
	{ 
		PosSetSessionProperty("discountForPromoOrder","false","false");
		PosSetSessionProperty("CalledFromPromoOrder","false","false");
		return(false); 
	} 	

	PosSetSessionProperty("PromoOrderInProgress","false","false");

	// NVS-1623 - Remove any applied offer before promo the order
	if(PosIsOfferApplied() && !PosDoClearOffer()) 
	{
		return(false);
	}

	if(!PosCanApplyPromoOrder()) {
		// Can't promo
		return(false);
	}

	// Lindomar Araujo - 2016/08/11 - NVS-4960 Changed to ask for the manager authorization before asking the saleType(EatIn or TakeOut)
	// if(!PosValidatePromoOrder(level, sigleSignOn)) { //NVS-776
	//	return(false); 
	//	} 


	/* NVS-792 -check if non products are in this sale */
     var curView = rootHlp.getCurrentView();
	var view = new XML(curView);
	var items = view.ItemView;     
	
     var NonProduct = items.((quantity > 0) && (isGrillLine != "true") && (familyGroup == NON_FOOD_PRODUCT));
     if(NonProduct.length() != 0) {
		PosShowMessage("MSG_BC_DISCOUNT_NON_PRODUCT");
		return(false);
	} 
	
	PosSetSessionProperty("discountForPromoOrder","true","false");
	
	/* //NVS-646 RPS 10-7-2011   Removed per NVS-776
	if (!PosCheckParameter("OperationMode", "enableBypassManagerApproval", "true")) {
		if(!PosCheckSessionProperty("getAuthForForPromoOrder","false")) {
			if(!PosGetAuthorization(level,sigleSignOn)) {
				PosSetSessionProperty("discountForPromoOrder","false","false");
				// Not Authorized
				return(false);
			}
		}
	}*/

	// Handle choices...
	if(!PosAutoChoice()) {
		PosSetSessionProperty("discountForPromoOrder","false","false");
		return(false);
	}
	if((choices != undefined) && (choices != null)) {
		var choiceArray=choices.split(",");
		if(choiceArray != null) {
			var i=0;
			for(;i < choiceArray.length; i++) {
				var choice_screen=choiceArray[i].split("|");
				if(choice_screen != null) {
					if(!PosCheckChoice(choice_screen[0],-1,true,"MSG_BC_SALE_INCOMPLETE")) {
						PosSetSessionProperty("discountForPromoOrder","false","false");
						return(false);
					}
				}
			}
          }
     }
	

	if(!PosCheckSalesType_CSL(saleType)) {
		return(false);
	}
	
	//NVS-582 RPS set session property used in onDiscount to prevent redundant authorization Check
	PosSetSessionProperty("CalledFromPromoOrder","true","false");
		
	if(!PosDoTotal()) {
		PosSetSessionProperty("discountForPromoOrder","false","false");
		PosSetSessionProperty("CalledFromPromoOrder","false","false");
		return(false);
	}


	if(!PosDoPromoOrder()) {
		if(!PosDoPromoItem(promoType)) {
			PosSetSessionProperty("CalledFromPromoOrder","false","false");
			PosSetSessionProperty("discountForPromoOrder","false","false");
			PosDoBackFromTotal(); 
			return(false);
		}
	}
	PosSetSessionProperty("CalledFromPromoOrder","false","false");
	PosSetSessionProperty("discountForPromoOrder","false","false");
	PosHandleCalculatorButton("clear");

	if(PosCheckSessionProperty("workingMode","orderTaker") /* NVS-1121 */ ) {
		if(!PosDoStore()) {
			return(false);
		}

		PosShareCODJS(); //NVS-1344 code fix
		// NVS-1049
		if(PosCheckSessionProperty("pickListAutomaticPrint","on")) {
			var showCanceledItems = rootHlp.findParamInSectionConfig("showCanceledItems","UserInterface");
			PosCreateReport("FULLCONSVIEW","reportPickList@reports.nps","NOPREVIEW",showCanceledItems+":1");
		}
    	PosOffersClearMessage();
		PosHideFloatScreen();		// NVS-4384
	}
	else {
		PosDoTenderJS(-1,-1,'NOPREVIEW');    /* NVS-1049 */
     }
	 
     if(!PosCheckParameter("OperationMode","autoRecall","true")) {
	 // Change due to NVS-1679
		PosSetSessionProperty("activatedCOD","0","true"); 
		PosSetSessionProperty("lastSelectedCOD","0","true");
     		PosShowScreen(rootCtx.get("baseScreenId"));
	 }
	 
     return(true);
}
/**PosDoSaleSizeJS
 *
 * @brief - This BC sells an item
 * Return - rval - true if allowed to continue
 */
function PosDoSaleSizeJS(size,productCode)
{
	if(typeof(onDoSaleJS) == "function") {
		if(!onDoSaleJS()) {
			return(true);
		}
	}
	// This BC is responsible for verifying if current sale was totalized and the new product is a CYT. \n
	// The sale will be cancelled in this situation and a new sale will be start. \n
	// The new sale will have all products of old sale and it will have the new product (CYT product). \n
	if(PosCheckCYTSale(productCode) == false)
	{
		return false;
	}

	if(PosNotATransactionInProgress(true)) {
		PosSetSessionProperty("CASHLESS","","true");
		if(typeof(onSaleStartJS) == "function") {
			if(!onSaleStartJS()) {
				return(true);
			}
		}
		// Sale not started as yet...
		if(!PosCheckCashDrawer()) {
			PosRefreshButtons();
			// Drawer open
			PosShowMessage("MSG_BC_DRAWER_OPENED");
            rootCtx.remove("selectedProductWithSize");
			return(true);
		}
		// Checks whether this order can be a multi-order
		var trxType=Number(rootCtx.get("transactionSaleType"));
		if(	(trxType != 1) && 
		   	(trxType != 2) && 
		   	(PosCheckSessionProperty("POD","DRIVE_THRU") ||
			PosCheckSessionProperty("POD","WALK_THRU")) && 
		   	PosCheckSessionProperty("workingMode","cashier") &&
		   	Number(rootCtx.get("DTStoreMode")) != 1 &&
		   	PosCheckSessionProperty("bMultiOrder",false)) {
			// Can be a Multi-Order
			var multiOrder=false;
		   	if(PosCheckSessionProperty("firstSaleDone",true)) {
				// Asks for selection
				if(!PosItemSelection("multiorderthis.png|neworder.png|cancel.png","1|0|2","Question","MSG_BC_ISNEWORDER") ||
                         Number(rootCtx.get("SelectedButtonValue")) > 1) {
                         rootCtx.remove("selectedProductWithSize");
					return(true);
				}
                    multiOrder=(Number(rootCtx.get("SelectedButtonValue"))==1)?true:false;
			}
			PosMultiOrder(multiOrder);
		}
	}
	if(Number(size) >= 0) {
		PosSizeSelection(size);
	}
	PosDoMultiChoice(productCode);
	// Is this product a Choice solution?
	var ret=true;
	if(!PosDoChoice(productCode)) {
		// Sale did not end with a choice
		if(PosDoSale(productCode)) {
			// Are there choices that can be solved?
			if(!PosCheckSessionProperty("POD","CSO")) {
				if(!PosAutoCCM(productCode)) {
					if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
						PosAutoChoice("0");
					} else {
						PosAutoChoice("1");
					}
				}
			}
			rootCtx.set("firstSaleDone",true,true);
		}
		else {
			ret=false;
		}
		
		if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
			PosEndSmartReminder();
			PosShowGrillFloatScreen();
		}
		
		PosDoQuantum(-1);
          rootCtx.remove("selectedProductWithSize");
	} else {

		PosAutoChoice("0");
		if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
            //@since : NPS-6076 - Auto Total
            if(! PosDoCheckOpenChoices()) {
				PosEndSmartReminder();
                PosExecuteSavedWorkflow();                
            }
		}
	}

	return(ret);
}

/**PosDoSaleJS
 *
 * @brief - This BC sells an item
 * Return - rval - true if allowed to continue
 */
function PosDoSaleJS(productCode)
{
     var ret=PosDoSaleSizeJS(-1,productCode);
     if(ret) {
          return(true);
     }
     if( PosCheckSessionProperty("dedicatedCOD","false") &&
          !PosCheckSessionProperty("activatedCOD","0") &&
          PosCheckSessionProperty("POD","DRIVE_THRU") &&
          PosCheckSessionProperty("workingMode","orderTaker|both")) {

          while(!ret) {
               var cod=rootCtx.get("activatedCOD");
               if(cod<0) {
                    var newCod=String(-cod);
                    PosSetSessionProperty("activatedCOD",newCod,"true")
                    //PosCommStatusCOD("MSG_BC_ERRORCONFIGCOD");
                    PosDisplayText("MSG_BC_ROUTEDCOD",1,true,false,newCod);
                    ret=PosDoSaleSizeJS(-1,productCode);
               }
               else {
                    ret=true;
               }
          }
     }
     // Refresh screen (might have to refresh after a COD colision)
     PosRefreshButtons();
     return(ret);
}

/**PosDoEndOfSaleJS
 *
 * @brief - This BC ends the sale in a tendering process
 * Return - rval - true if should stop execution
 */
function PosDoEndOfSaleJS(noAutoRecall,flags,kioskDup)
{
	PosSetForeignCurrency("-1");  //LC NVS-842
	PosOffersEndOfSale();
     if(!PosDoEndOfSale(true)) {
          return false;
     }
     /* NVS-48 -mark the start of the sale end so we know if the reciept was printed */
	PosSetSessionProperty("EndOfSaleReceiptPrinted","0","true");

     var lastView = rootHlp.getLastSaleView();
     if(lastView == null) {
          lastView = rootHlp.getCurrentView();
     }
	PosUpdateBarcodeForOrder(lastView);
     var view = new XML(lastView);
     if(PosIsCashlessLoadedJS()) {
          PosCashlessEndOfSale();
     }
     // BusinessComponentsCSOLocal.nps loaded means that coins dispenser will be called by the bill acceptor
     if(typeof(PosBillAcceptorEvt) != 'function') {
          // PosDispenseChangeJS function might not exist in a local configuration!
          if(typeof(PosDispenseChangeJS) == 'function') {
               PosDispenseChangeJS();
          }
     }
     if(view.@transactionKind != ACC_OT_SKIP_CAR) {
          if(kioskDup == null) {
               kioskDup=false;
          }
          PosCreateReceiptJS(kioskDup,"VIEW","receipt@reports.nps",flags);
     }

	/* NVS-48 -mark the end of the sale end so we know if the reciept was printed */
	PosSetSessionProperty("EndOfSaleReceiptPrinted","1","true");
     if(PosCheckSessionProperty("pickListAutomaticPrint","on")) {
          var showCanceledItems = rootHlp.findParamInSectionConfig("showCanceledItems","UserInterface");
          if(!PosCheckSessionProperty("workingMode","orderTaker")) {      /* NVS-1049 not orderTaker */
               showCanceledItems = showCanceledItems+":1"
          }
          PosCreateReport("FULLCONSVIEW","reportPickList@reports.nps",flags,showCanceledItems);
     }

     /* SDE-2276 -Cancel preswipe on non-cashless sales */
     if (PosCheckParameter("TCLExtension","esocket","true") && (!PosCheckSessionProperty("POD","DRIVE_THRU"))) {
          /* NVS-1166 PRE_SWIPE CANCEL only if no cashless trans */
		  if (view.ItemTenderView.toString().indexOf("TENDER_ELECTRONIC_PAYMENT") == -1) {
               result=npTCLEvalEx("Everest_Operation 22 0 0");
          }
     }

     PosGCActivationJS(flags);
     PosSetSessionProperty("activatedCOD","0","true");
	
	// Calling PosDisplayLaneOpenMessage will also close the open session.
	PosDisplayLaneOpenMessage();

     if(noAutoRecall || !PosDoAutoRecallJS()) {
          PosShowScreen(rootCtx.get("baseScreenId"));
          // Either no auto recall was received, or the drawer is opened or failed auto recall
          PosDoSkimWarning();
     }

	 PosHideFloatScreen();
	 

     // Correct end, returns true to stpo further execution
     return(true);
}

/**PosDoStoreJS
 *
 * @brief - This BC store the sale in a tendering process
 * Return - rval - true if should stop execution
 */
function PosDoStoreJS()
{
	 //PosOffersClearMessage();

	 // NVS-1967
	if(PosCheckParameter("Cashless3", "Active", "true")) {
		StopCashlessSession();
	}
     if(!PosDoStore()) {
          return(false);
     }
	 PosShareCODJS();  //NVS-1344
     PosSetSessionProperty("activatedCOD","0","true");
     PosShowScreen(rootCtx.get("baseScreenId"));

     if(PosCheckSessionProperty("pickListAutomaticPrint","on")) {
          var showCanceledItems = rootHlp.findParamInSectionConfig("showCanceledItems","UserInterface");
          PosCreateReport("FULLCONSVIEW","reportPickList@reports.nps","NOPREVIEW",showCanceledItems+":1");
     }

	//if (PosCheckParameter("PosType", "IsMOT", "true") && IsBlueToothPrinterConfigured() == true) {
	//	PosCreateReport("FULLCONSVIEW","reportOrderNumber@reports.nps","NOPREVIEW",showCanceledItems+":1");
	//}
	//Again
	PosOffersClearMessage();

	var lastView = rootHlp.getLastSaleView(); 
	if(lastView == null) { 
		lastView = rootHlp.getCurrentView(); 
	} 

	rootCtx.set(KEY_VIEW, lastView.toString(), true); 
	
     return(true);
}

function IsBlueToothPrinterConfigured() {
	var ReturnValue = false;
	if (PosCheckParameter("OperationMode", "BlueToothPrinter", "true")) {
		ReturnValue = true;
	}
	
	return ReturnValue;
}

/**
 *
 * @brief - This BC totalizes a sale and check if total is correct
 * Return - rval - true if allowed to continue
*/
function PosDoTotalConfirmJS(saleType,screenNumber,screenNumberStore,flags,choices)
{
     var retTot = PosDoTotalJS(saleType,screenNumber,screenNumberStore,flags,choices);
     if( retTot == false ) return false;

     //Verificar se OrderInProgress
     var checkOrder = PosCheckParameter('OperationMode', 'CheckOrderTotal', 'true');

     checkOrder = checkOrder && (Number(rootCtx.get("DTStoreMode")) != TANDEM_FACE) && (PosCheckSessionProperty("workingMode","orderTaker") || (PosCheckSessionProperty("workingMode","both") && PosCheckSessionProperty("saleRecalled","false")));

     // Check COD Status
     PosIsCODOnline();
     var is_COD_OnLine = false;
     if (PosCheckSessionProperty("IsCODOnline","1")) {
          is_COD_OnLine = true;
     }
     if( checkOrder && is_COD_OnLine ) {

		var curView = rootHlp.getCurrentView(); 
		if(curView == null) {
			return(true); 
		} 
		var view = new XML(curView); 
		if(null == view) {
			API.dbg("ERROR! XML NULL");
			return(true); 
		}
		
          var total = view.@totalDue;
          var totalFmt = API.formatNumber(total, "###,###,##0.00", 20);
          totalFmt = totalFmt.replace(/^\s*/, "").replace(/\s*$/, "");
          //var retConf = PosShowConfirmationMessage('Is your order correct on the screen ?','Store','Return');

          var retConf = PosShowConfirmationMessage('If your order is correct on the screen, your total is $' + totalFmt,'Store','Modify');

          if( retConf ) {
               //Do Store order
               PosDoStoreJS();
          } else {
               //Do modify order / back from total
               PosDoBackFromTotal();
               // SDE-2576
               //PosSetCOD(saleType)
               if( !PosCheckSessionProperty('view','') ) {
                    PosCreateReport('VIEW', 'receipt@reports.nps', 'NOPREVIEW|SAVE', '_CASHLESS');
               }
               PosSetSessionProperty('BackFromTotal', 'true');
               PosShowScreen(rootCtx.get("baseScreenId"));
               PosShowGrillFloatScreen();
          }
     }

     return retTot;
}

/**PosDoTotalJS
 *
 * @brief - This BC totalizes a sale
 * Return - rval - true if allowed to continue
 */
function PosDoTotalJS(saleType,screenNumber,screenNumberStore,flags,choices) {
	if(PosNotATransactionInProgress(true)) {
		return(false);
	}
	if(!PosSetSaleType(saleType)) {
		return(false);
	}
	// Handle choices...
	if(!PosAutoChoice()) {
		return(false);
	}

	/* NVS-578 handle choice bypass */
	var choiceArray=null;
	if(choices != null) {
		var choiceArray=choices.split(",");
		if(!PosDoHandleOpenChoicesCSL(choiceArray, true, "MSG_BC_SALE_INCOMPLETE")) {
			return(false);
		}          
	}

	// Handle choices...
	if(PosSetOnTotalSmartReminder()) {
	  return(false);
	}
	// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications	
	if(VerifyAndShowTagIdSmartScreenJS(true,saleType)) 
	{ 
	 return(false); 
	} 
	if(choices != null) {
		var choiceArray=choices.split(",");
		if(choiceArray != null) {
			var i=0;
			for(;i < choiceArray.length; i++) {
				var choice_screen=choiceArray[i].split("|");
				if(choice_screen != null) {
					 if(!PosCheckChoice(choice_screen[0],choice_screen[1],true,"MSG_BC_SALE_INCOMPLETE")) {
						  return(false);
					 }
				}
		   }
	  }
	}

	var retTotal = PosDoTotal();
	if ( !retTotal ) {
		return(false);
	}
	var tenderType=-1;
	if(PosCheckTransactionKind(1)) {
		// Refund
		if(PosCheckRefund()) {
			var ok=true;
			if(PosIsCashlessLoadedJS()) {
				ok=PosItemSelection("cashless.png|cash.png|cancel.png","10|0|-1","Choose","Choose: CASHLESS, CASH or CANCEL");
			} else {
				ok=PosItemSelection("cash.png|cancel.png","0|-1","Choose","Choose: CASH or CANCEL");
			}
			if(ok) {
				tenderType=Number(rootCtx.get("SelectedButtonValue"));
				if(0 == tenderType) {
					// NPS-143 RPS 05/17/2010
					if(!PosCheckCash() || !CashAvailableJS()) {
						tenderType=-1;
					}
				}
			}
		}
	} else {
		if(PosCheckTransactionKind(2)) {
			// Waste
			tenderType=0;
		} else {
			// Normal Sale
			//NVS-397 JWC 1/11/2011
			if((Number(rootCtx.get("DTStoreMode")) != TANDEM_FACE || PosCheckParameter("PosType","isMOT","true")) && (PosCheckSessionProperty("workingMode","orderTaker") || (PosCheckSessionProperty("workingMode","both") && PosCheckSessionProperty("saleRecalled","false")))) {
				if(rootHlp.GetOrderSrc() == '1' && rootHlp.GetMobileOrderStatus() == MOS_RECALLED) {
					PosShowScreen(STORE_MOBILE_ORDER);
				} else {
					//Swich the screen after calculations are done NVS-3465
					// NVS-4449 - msilva - force applying OnTotal offers on DT OT
					/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
					PosApplyOffers_COE(false);
					/* NVS-4126 -refresh the COD's after disocunts are applied and before the store screen */ 
					PosRefreshSalePanel("STORE");
					PosShowScreen(screenNumberStore);
				}
				// Lindomar Araujo - 06/23/2016 NVS-4646 (CR#8063901 - CR#8610096) - Full Customer Choice Enhancements
				PosRunAutoBundling();
			} else {
				//Swich the screen after calculations are done NVS-3465
				//NVS-4948 15-AUG-2016 John Brancaleon -  Change where the PosOffersOnTotal is called
				PosShowScreen(screenNumber);
				//PosOffersOnTotal(true);				
				/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
				PosApplyOffers_COE(false);
				
				// Lindomar Araujo - 06/23/2016 NVS-4646 (CR#8063901 - CR#8610096) - Full Customer Choice Enhancements
				PosPromotionGetZeroAmountAuthorization();
				PosRunAutoBundling();
				/* var hlp = new BusinessObjectHelper; */
				if (rootHlp.GetOrderSrc() == '1' && rootHlp.GetMobileOrderStatus() == MOS_RECALLED) {
					PosShowScreen(STORE_MOBILE_ORDER);
				}
				else {
					PosShowScreen(screenNumber);
				}
				if(PosCheckSessionProperty("SuggestiveSellingMode","on")) { 
					if( PosCheckSessionProperty("saleRecalled","false")){ 
						PosSuggestiveSelling(sugSelButtonNumber); 
					}
					if (suggestiveSellingProduct=="") {
						if(PosCanSuggestDonation()) {
							PosRMHCdonation();
						}
					}
				} else {
					if(PosCanSuggestDonation()) {
						PosRMHCdonation();
					}
				}
			}
			return(true);
		}
	}
	if((tenderType < 0) || !PosDoTender(tenderType,-1)) {
		PosDoBackFromTotal();
		return(false);
	}
	return(PosDoEndOfSaleJS(true,flags,0));
}

// NPS-143 RPS 05/17/2010
/* CashAvailableJS
 * @brief - Determines if the amount of cash in the drawer minus the initial float, is
 *          greater than the current sale amount.
 * @success returns true if there is enough cash
 * @failure returns false if there is not enough cash.
 * @remarks can be bypassed by setting the parameter ignoreCheckCashAvail in SpecialTransactions to true
 */

function CashAvailableJS() {
	var ReturnValue = false;
	var CashOnHand = 0;
    var ProductSales = new BigDecimal("0.00");
	if (PosCheckParameter("SpecialTransactions", "ignoreCheckRefundCashAvail", "true") == false) {
		var XMLArray = rootHlp.getReportXML("CASH","PMIX","","","");
		if((XMLArray != null) && (XMLArray.length > 0)) {
			var CashRoot = new XML(XMLArray[1].toString());
			if(CashRoot != null) {
				var currentOperator	= findCurrentOperator(CashRoot);
				//var initialFloat = Number(addInitialFloats(CashRoot, currentOperator));
				var totalCashTendered = Number(addTendersSummary(CashRoot, currentOperator));
				var totalSkims = Number(addSkimsSummary(CashRoot, currentOperator));
				var tender = totalCashTendered - totalSkims;

				var CashOnHand = new BigDecimal(tender);
				
				// SDO-3546
				ProductSales = ProductSales.add(currentOperator.CashTotals.ProductSales.Cash.@netAmount);
				ProductSales = ProductSales.add(currentOperator.CashTotals.ProductSales.Cash.@taxAmount);
			}
		}
		var lastView = rootHlp.getCurrentView();
		if(lastView == null) {
		lastView = rootHlp.getLastSaleView();
		}
		var view = new XML(lastView);
		var TotalDue = new BigDecimal(view.@grossAmount);
		//SDO-3546
		if ((TotalDue.compareTo(CashOnHand) <= 0) && (TotalDue.compareTo(ProductSales) <= 0)) {
			ReturnValue = true;
		} else {
			if (TotalDue.compareTo(CashOnHand) > 0) {
				PosShowMessage("MSG_BC_CHECKCASHREFUND");
			} else {
				PosShowMessage("MSG_BC_CHECKPRODSALESREFUND");
			}
		}
	} else {
		ReturnValue = true;
	}

	return ReturnValue;


	/**
	 * Adds the summary of skims followed by the total of operations and its total amount
	 * @return total amount of skims
	 */
	function addSkimsSummary(rootCash, currentOperator)
	{
		var nodeCashDetails			= findFirst(currentOperator, "CashDetails");
		var nodesTransfersOut		= nodeCashDetails.TransfersOut;
		var nodesTransfersOutSize	= nodesTransfersOut.length();
		var totalTransfer			= new BigDecimal(0);

		if(nodesTransfersOutSize > 0) {
			for(var i = 0; i < nodesTransfersOutSize; i++) {
				var nodeTransferOut = nodesTransfersOut[i];
				var transferName 	= getAttribute(nodeTransferOut, "type");
				var transferAmount 	= new BigDecimal(getNumberAttribute(nodeTransferOut, "amount"));
				var transferQtty 	= getNumberAttribute(nodeTransferOut, "count");
				totalTransfer 		= totalTransfer.add(transferAmount);

//				addTendersLine();
//				addLine(API.setOnLeft(transferName, 20) + " " + API.setOnRight("OPERS", 5) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//				addTendersLine();

				// assumes that all transfer out operations are maden in cash (TenderType 0)
				currencyName = findTenderDescription(rootCash, "0");
//				addLineOperation("1 - " + currencyName, transferQtty, transferAmount,null);

//				addTendersLine();
//				addLineOperation("TOTAL:", null, transferAmount, null);
//				addLine("");
			}
		}
		return totalTransfer;
	}

	/**
	 * Adds the summary of tenders followed by the total of operations and its total amount
	 * @return total amount of tenders
	 */
	function addTendersSummary(rootCash, currentOperator)
	{
		var tenderName;
		var localAmount;
		var operations = 0;
		var nodesTenderSize = 0;
		var initialFloat = new BigDecimal(0);

		var nodeTenders		= findFirst(currentOperator, "Tenders");
		if(nodeTenders != null){
			var nodesTenders 	= nodeTenders[0].*;
			var nodesTenderSize = nodesTenders.length();
			var nodeTender 		= nodesTenders[0];
			operations 			= getNumberAttribute(nodeTender[0], "tc");
		}

		var nodeSkim		= findFirst(currentOperator, "TransfersOut");
		if(nodeSkim != null){
			var nodesSkim		= nodeSkim.Transfer;
			var nodesSkimSize	= nodesSkim.length();
		}

		var totalLocalAmount = new BigDecimal(0);
		var totalOperations  = new BigDecimal(0);
		var totalSkim 		 = new BigDecimal(0);

//		if( (nodesTenderSize > 0) && (operations > 0) ) {
		if(nodesTenderSize > 0) {
			totalSkim = new BigDecimal(getNumberAttribute(nodeSkim, "amount"));

//			addTendersLine();
//			addLine(API.setOnLeft("TENDERS", 20) + " " + API.setOnRight("OPERS", 5) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//			addTendersLine();

			nodesTenderSize = 1; // Get only <TenderType id="0" name="US$" />
			for(var i = 0; i < nodesTenderSize; i++) {
				var nodeTender = nodesTenders[i];

				operations 		= getNumberAttribute(nodeTender, "tc");
				localAmount 	= new BigDecimal(getNumberAttribute(nodeTender, "drawerAmount"));
				initialFloat 	= getNumberAttribute(nodeTender, "initialFloat");
				localAmount 	= localAmount.subtract(initialFloat);
				tenderId 		= getNumberAttribute(nodeTender, "id");
				// search the description of tender id
				tenderName 		= findTenderDescription(rootCash, tenderId);

				// assumes that all transfer out operations are maden in cash (TenderType 0) so skim amount is added only to cash amount
				if(tenderId=="0") {
					localAmount = localAmount.add(totalSkim);
				}
//				addLineOperation((i + 1) + " - " + tenderName, operations, localAmount,null);

				totalLocalAmount = totalLocalAmount.add(localAmount);
				totalOperations  = totalOperations.add(operations);
			}
//			addTendersLine();
//			addLineOperation("TOTAL:", totalOperations, totalLocalAmount, "");
//			addLine("");
		}
		return totalLocalAmount;
	}

	/**
	 * Adds all initial floats
	 * @return total initial floats
	 */
	function addInitialFloats(rootCash, currentOperator)
	{
		var nodeInitialFloat		= findFirst(currentOperator, "TransfersIn");
		var nodesInitialFloat		= nodeInitialFloat.Transfer;
		var nodesInitialFloatSize	= nodesInitialFloat.length();

		var tenderName;

		var totalLocalAmount= new BigDecimal(0);
		var localAmount 	= new BigDecimal(0);
		var initialFloat 	= new BigDecimal(0);

		if(nodesInitialFloatSize > 0) {
//			addTendersLine();
//			addLine(API.setOnLeft("INITIAL FLOATS", 26) + " " + API.setOnRight("LOCAL AMOUNT", 12));
//			addTendersLine();

			totalOperations  = getNumberAttribute(nodeInitialFloat, "count");
			totalLocalAmount = getNumberAttribute(nodeInitialFloat, "amount");

			for(var i = 0; i < nodesInitialFloatSize; i++) {
				var nodeInitialFloat = nodesInitialFloat[i];

				localAmount = getNumberAttribute(nodeInitialFloat, "amount");
				tenderId = getNumberAttribute(nodeInitialFloat, "tenderId");
				// search the description of tender id
				tenderName = findTenderDescription(rootCash, tenderId);
//				addLineOperation((i + 1) + " - " + tenderName, "1", localAmount,null);
			}
//			addTendersLine();
//			addLineOperation("TOTAL:", totalOperations, totalLocalAmount, "");
		}
		return totalLocalAmount;
	}

	/** Wraps XMLElement.findFirst() to ignore null nodes */
	function findTenderDescription(rootNode,tenderId)
	{

		var cmd = "rootNode.TenderTable.TenderType.(@id == " + tenderId + ")";
		var value = eval(cmd);
		return value.@name;
	}

}
/**PosRemotePickListJS
 *
 * @brief - This BC prints a remote pickList
 * Return - rval - true
 */
function PosRemotePickListJS(view) {

	rootCtx.set(KEY_REMVIEW,view,true);
	var showCanceledItems = rootHlp.findParamInSectionConfig("showCanceledItems","UserInterface");
	PosCreateReport("FULLCONSVIEW","reportPickList@reports.nps","REMOTE",showCanceledItems+":1");
	rootCtx.remove(KEY_REMVIEW,true);
     return(true);
}

/**RepPreviewFilterJS
 *
 * @brief - This BC shows/changes the report preview filter used in reports
 * Return - rval - true if allowed to continue
 */
function RepPreviewFilterJS(change)
{
const reportType=["default","on"];
const properties=[
     "bitmap|printPreviewOff.png,bitmapdn|printPreviewOff.png,title|print\npreview\noff",
     "bitmap|printPreviewOn.png,bitmapdn|printPreviewOn.png,title|print\npreview\non"
];
     var i=0;
     // Loops up to length because the very first time reportPOD might not be set!
     for(i=0;i < reportType.length;i++) {
          if(PosCheckParameter("Report","reportPreviewOverride",reportType[i])) {
               break;
          }
     }
     if(i >= reportType.length) {
          i=("true"==change) ? 1 : 0;
     } else {
          if("true"==change) {     // Next
               ++i;
          }
          if(i >= reportType.length) {
               i=0;
          }
     }
     // either reportPOD was not set or changing from the last to the first...
     PosChangeButtonProperties(0,properties[i]);
     if("true"==change) {     // Next
          PosSetParameter("Report","reportPreviewOverride",reportType[i]);
     }
     return(true);
}

/**PODFilterJS
 *
 * @brief - This BC shows/changes the POD Filter used in reports
 * Return - rval - true if allowed to continue
 */
function PODFilterJS(change)
{
const reportType=["ALL","FC","DT","WT"];
const reportButton=["bitmap|postypeall.png","bitmap|postypefc.png","bitmap|postypedt.png","bitmap|postypewt.png"];

     var i=0;
     // Loops up to length because the very first time reportPOD might not be set!
     for(;i < reportType.length;i++) {
          if(PosCheckSessionProperty("reportPOD",reportType[i])) {
               break;
          }
     }
     if("true"==change) { // Next
          i++;
     }
     if(i >=reportType.length) {
          i=0;
     }
     // either reportPOD was not set or changing from the last to the first...
     PosChangeButtonProperties(0,reportButton[i]);
     if("true"==change) { // Next
          PosSetReportScope("CONSOLIDATED",reportType[i]);
     }
     return(true);
}

/**PosDoOperatorLoginJS
 *
 * @brief - This BC performs the loggin for an operator
 * Return - rval - true if allowed to continue
 */
function PosDoOperatorLoginJS(tp,flags)
{
     if(!PosDoOperatorLogin()) {
          return(false);
     }
     PosCreateReport("CASH","reportOperatorLogin@reports.nps",flags);
     PosShowScreen(rootCtx.get("baseScreenId"));
	PosDisplayLaneOpenMessage();

	 return(true);
}

/**PosReportSOSJS
 *
 * @brief - This BC creates an SOS report
 * Return - rval - true if allowed to continue
 */
function PosReportSOSJS(dataTypes,flags) {

     var report="";
     var pod="";
	 //NVS-137  RPS 11/06/09
     PosItemSelection('BLK_MFY.png|BLK_DTS.png|BLK_FC.png|BLK_CSR.png|BLK_MCCAFE.png|BLK_OTHREP.png|BLK_CANCEL.png',
          '0|1|2|3|4|5|6',
          'MSG_WFL_SELECT',
          'MSG_WFL_SEL_REPORT');
     selectedItem = Number(rootCtx.get("SelectedButtonValue"));
     /* "other" was chosen, display the "other" options */
     if (selectedItem == 5) {
          PosItemSelection('DTD.png|cancel.png',
               '7|6',
               'MSG_WFL_SELECT',
               'MSG_WFL_SEL_REPORT');
          selectedItem = Number(rootCtx.get("SelectedButtonValue"));
     }
     /* define the report params */
     switch(selectedItem) {
     case 0:
          report="reportSosMfy@reports.nps";
          pod="MFY";
          break;
     case 1:
          report="reportSosDTHourly@reports.nps";
          pod="DT|*WT";
          break;
     case 2:
          report="reportSosFc@reports.nps";
          pod="FC";
          break;
     case 3:
          report="reportSosCsr@reports.nps";
          pod="DT|*WT|FC|MFY|CBB";
          break;
     case 4:
          report="reportSosCbb@reports.nps";
          pod="CBB";
          break;
     case 7:
          report="reportSosDTDiagnostic@reports.nps";
          pod="DT|*WT";
          break;
     default:
          return(true);
     }
     PosCreateReport(dataTypes,report,flags,"","",pod);
     return(true);
}

/**CheckCDrawerOpModeJS
 *
 * @brief - This BC set a button property according to cash drawer oper mode
 * Return - rval - true if allowed to continue
 */
function CashDrawerOpModeJS(buttonNumber,prop,prop1,prop2) {

     if(PosIsCashDrawerForced()) {
          PosChangeButtonProperties(buttonNumber,prop+"|"+prop1,prop+"dn|"+prop2);
     }
     else {
          PosChangeButtonProperties(buttonNumber,prop+"|"+prop2,prop+"dn|"+prop1);
     }
}

/**HideMeIfPreviewByTypeJS
 *
 * @brief - This BC hhides a button (according to a type)
 * btnType: 0 -> RecallByPreview button on a regular screen
 *             1 -> Simple Recall button on a regular screen
 *             2 -> RecallByPreview button on a tender screen
 *             3 -> Simple Recall button on a tender screen
 * Return - rval - true
 */

function HideMeIfPreviewByTypeJS(btnType) {

     var hide=false;


     if( !PosCheckSessionProperty("POD","DRIVE_THRU") ||
          PosCheckSessionProperty("workingMode","orderTaker")) {
          hide=true;
     }
     else {
          if(PosCheckParameter("UserInterface","DDTsupport","true")) {
               if((Number(btnType)%2) == 1) {
                    // Simple Recall cannot have DDTsupport true
                    hide=true;
               }
          }
          else {
               if((Number(btnType)%2) == 0) {
                    // Recall by preview cannot have DDTsupport false
                    hide=true;
               }
          }
          if(!hide && (Number(btnType) > 1) && !PosCheckSessionProperty("saleRecalled","true")) {
               // Tender Screen
               hide=true;
          }
     }
     if(hide) {
          PosChangeButtonProperties(0,"visible|false");
     }
     else {
          PosChangeButtonProperties(0,"visible|true");
     }
     return(true);
}
/**ShowButtonRecallByListJS
 *
 * @brief - This BC hhides a button (according to a type)
 * Return - rval - true
 */

function ShowButtonRecallByListJS(podType,workingMode, btnType) {

     var podDT=false;
     var podWT=false;
     var podFC=false;

     var podTypes=new Array();
     var podStrArray=podType.split("|");
     if ((podStrArray == null) || (podStrArray.length <= 0)) {
          return(null);
     }

     for(var i=0; i < podStrArray.length; ++i) {
          if ("DRIVE_THRU"==podStrArray[i]) {
               podDT = PosCheckSessionProperty("POD","DRIVE_THRU") && PosCheckSessionProperty("workingMode",workingMode);
          }
          if ("WALK_THRU"==podStrArray[i]) {
               podWT = PosCheckSessionProperty("POD","WALK_THRU") && PosCheckSessionProperty("workingMode",workingMode);
          }
          if ("FRONT_COUNTER"==podStrArray[i]) {
               podFC = PosCheckSessionProperty("POD","FRONT_COUNTER");
          }
     }

     if (podDT || podWT || podFC) {
          PosChangeButtonProperties(btnType,"visible|true");
     }
     else {
          PosChangeButtonProperties(btnType,"visible|false");
     }
     return(true);
}

/**ShowButtonToPOD
 *
 * @brief - This BC hhides a button (according to a type)
 * Return - rval - true
 */
function ShowButtonToPOD(btnType, bitmapDT, bitmapdnDT, bitmapWT, bitmapdnWT, bitmapFC, bitmapdnFC) {

     var podDT = PosCheckSessionProperty("POD","DRIVE_THRU");
     var podWT = PosCheckSessionProperty("POD","WALK_THRU");
     var podFC = PosCheckSessionProperty("POD","FRONT_COUNTER");

     var button      ="bitmap|";
     var buttondn ="bitmapdn|";
     if (podDT) {
          if (bitmapDT!=null) {
               button +=bitmapDT;
               buttondn +=bitmapdnDT;
               PosChangeButtonProperties(btnType,button);
               PosChangeButtonProperties(btnType,buttondn);
          }
          else {
               PosChangeButtonProperties(btnType,"visible|false");
          }
     }
     else {
          if (podWT) {
               if (bitmapWT!=null) {
                    button +=bitmapWT;
                    buttondn +=bitmapdnWT;
                    PosChangeButtonProperties(btnType,button);
                    PosChangeButtonProperties(btnType,buttondn);
               }
               else {
                    PosChangeButtonProperties(btnType,"visible|false");
               }
          }
          else {
               if (bitmapFC!=null) {
                    button +=bitmapFC;
                    buttondn +=bitmapdnFC;
                    PosChangeButtonProperties(btnType,button);
                    PosChangeButtonProperties(btnType,buttondn);
               }
               else {
                    PosChangeButtonProperties(btnType,"visible|false");
               }
          }
     }

     return(true);
}

/**PosCreateReceiptJS
 *
 * @brief - This BC perform PosCreateReport with appropriate type of receipt
 * Return - true if ok
 */
function PosCreateReceiptJS(kioskDup,szDataType,szScript,szFlags,szCustParams,szPODtype,szServiceList,szPOSList) {

     if(undefined == szCustParams) {
          szCustParams="";
     }
     if(kioskDup > 0 || PosCheckParameter("Report","kioskReceipt","true")) {
          // Kiosk receipt
          PosCreateReport(szDataType,"receiptkiosk@reports.nps",szFlags,szCustParams,szPODtype,szServiceList,szPOSList);
          PosCreateReport(szDataType,"receiptkiosk@reports.nps",szFlags+"|ALIAS",szCustParams+":1","EXTRAREC",szServiceList,szPOSList);
     }
     else {
          // Normal receipt
		PosSetSessionProperty("SecondCopyOfReceipt", "false");
        	PosCreateReport(szDataType,"receipt@reports.nps",szFlags,szCustParams+"|FirstPass",szPODtype,szServiceList,szPOSList);
		if (PosCheckSessionProperty("SecondCopyOfReceipt", "true") == true) {
			PosCreateReport(szDataType,"receipt@reports.nps",szFlags,szCustParams+"|SecondPass",szPODtype,szServiceList,szPOSList);
     		}
		PosSetSessionProperty("SecondCopyOfReceipt", "false");
	}
	
}

/**PickListOnOffJS
 *
 * @brief - This BC perform the configuration od Pick List receipt
 * Return - true if ok
 */
function PickListOnOffJS(change,onClick)
{
const PickListMode=["on","off"];
const PickListModeButton=["bitmap|pickliston.png","bitmap|picklistoff.png"];

     if(onClick=="true") {
          var i=0;
          // Loops up to length because the very first time reportPOD might not be set!
          for(;i < PickListMode.length;i++) {
               if(PosCheckSessionProperty("pickListAutomaticPrint",PickListMode[i])) {
                    break;
               }
          }
          if("on"==change) { // Next
               i++;
          }
          if(i >=PickListMode.length) {
               i=0;
          }
          // either reportPOD was not set or changing from the last to the first...
          PosChangeButtonProperties(0,PickListModeButton[i]);
          if("on"==change) { // Next
               PosSetSessionProperty("pickListAutomaticPrint",PickListMode[i],"false");
          }
     }
     else {
          var i=0;
          // Loops up to length because the very first time reportPOD might not be set!
          for(;i < PickListMode.length;i++) {
               if(PosCheckSessionProperty("pickListAutomaticPrint",PickListMode[i])) {
                    break;
               }
          }
          PosChangeButtonProperties(0,PickListModeButton[i]);
     }

     return(true);
}

/**PosDetachJS
 *
 * @brief - This BC performs a local or remote detach
 * Return - rval - true if allowed to continue
 */
function PosDetachJS(remote)
{
     if("false" == remote) {
          if(PosCheckState("POS_OpLogged")) {
               PosShowMessage("MSG_BC_LOGOUTOP");
               return(false);
          }
          if(!PosShowConfirmationMessage("MSG_BC_CONFDETACH","MSG_YES","MSG_NO")) {
               return(false);
          }
          if(!PosRemoteDetach()) {
               return(false);
          }
          var cmdLine=rootHlp.findParamInSectionConfig("stageCmd","PosType");
          if(!PosRunOSCommand(cmdLine+" 2")) {
               return(false);
          }
          if(!PosShutdown("92", "remote", "false")) {
               return(false);
          }
     } else {
          if(!PosChooseRemotePOS("1","MSG_BC_REMOTEDETACH","MSG_BC_CONFREMDETACH")) {
               return(false);
          }
          if(!PosRemoteDetach(rootCtx.get("SELECTED_REMPOS"))) {
               return(false);
          }
     }
     return(true);
}

/**PickListOnOffJS
 *
 * @brief - This BC perform the configuration od Pick List receipt
 * Return - true if ok
 */
function PrintPickListJS(flag)
{
     var currentView = rootHlp.getCurrentView();
     if(currentView != null) {
	var view = new XML(currentView);
	rootCtx.set(KEY_REMVIEW,view.toString(),true);
	var showCanceledItems=rootHlp.findParamInSectionConfig("showCanceledItems","UserInterface");
	PosCreateReport("FULLCONSVIEW","reportPickList@reports.nps",flag+"|REMOTE",showCanceledItems+":1");
	rootCtx.remove(KEY_REMVIEW);
     }
     return(true);
}

/**POSVerifyRunnerBoxJS
 *
 * @brief - This function implements the BC,Business Component: <b>POSVerifyRunnerBoxJS</b>\n
 * Return - rval - True for successful execution or False for failure.
 */
function POSVerifyRunnerBoxJS(prop1,prop2) {
         // NVS-1278
	var prop=PosCheckRunnerBox("on")?prop2:prop1;
	PosChangeButtonProperties(0,prop);
	return(true);
}

function POSVerifyDualDisplayJS(prop1,prop2) {
	var prop=(PosCheckDualDisplay("true")==true)?prop2:prop1;
	PosChangeButtonProperties(0,prop);
	return(true);
}

/**PosScreenTimeOutJS
 *
 * @brief - This BC handles a screen timeout event
 * managerScrRange: manager screen range
 * screenRange: CSO screen range
 * grillScreen: CSO grill screen
 * timeoutScreen: CSO timeoutScreen screen
 * Return - true
 */
function PosScreenTimeOutJS(managerScrRange,screenRange,grillScreen,sound) {
     if(!PosCheckCurrentScreen(managerScrRange)) {
          // Not in a manager range
          if(!PosCheckSessionProperty("POD","CSO") || !PosCheckCurrentScreen(screenRange)) {
               // Not CSO or CSO in a regular screen
               PosBackToPreviousScreen();
               return(true);
          }
          if(PosCheckCurrentScreen(rootCtx.get("baseScreenId"))) {
               PosReloadCurrentScreen();
               return(true);
          }
          PosPlaySound(sound);
          // Ask customer if should extend time
          if(PosShowConfirmationMessage("TIMEOUT_SCREEN","Yes","No")) {
               PosReloadCurrentScreen();
               PosProtectQuantity();
               return(true);
          }
          if(PosIsInSaleMode("false") && !PosNotATransactionInProgress("true")) {
               if(PosCheckCurrentScreen(grillScreen)) {
                    PosDoGrillEnd("2");
                    PosDoQuantum("-1");
               }
               if(PosCheckSessionProperty("TenderAccepted","true")) {
                    return(PosDoStoreDuetJS("2","21"));
               }
               else {
                    return(PosDoCancelOrderDuetJS());
               }
          }
     }
     PosShowScreen(rootCtx.get("baseScreenId"));
     return(true);
}


/** PosSOSButtonJS
 *
 * @brief - This is called when one of the time interval buttons on the hourly report configuration screen is pressed
 * ButtonNumber - The actual number of the button in the screen.xml file
 * IntervalNumber - The interval is from 0 to however many intervals the are
 * Return - Always returns true
 */
function PosSOSButtonJS(ButtonNumber, IntervalNumber) {

     var ValueButton = Number(ButtonNumber);
     var NewTitle;
     var  PropertyName = "Temp" + IntervalNumber + "Increment";

     // We will cycle through time intervals, calling RotateTime will get the next value in the cyle
     // This will also set the property value
     var NewTime = RotateTime(PropertyName);
     //Now go and build the test for the button
     NewTitle = PosSOSBuildCaption(IntervalNumber, NewTime);

     PosChangeButtonProperties(ValueButton, NewTitle);
     return(true);
}

/** PosSOSInitJS
 *
 * @brief - called for each button when the screen is ativated
 * ButtonNumber - the number assigned to the Button in screen.xml
 * IntervalNumber - a number from 0 to however many interval there are
 * Return - always returns true.
 */
function PosSOSInitJS(ButtonNumber, IntervalNumber) {
     var NewTitle;
     var CurrentIncrement;
     var Key = "Temp" + IntervalNumber + "Increment";
     var Value = PosGetSOSIncrement(Key);

     NewTitle = PosSOSBuildCaption(IntervalNumber, Value);
     PosChangeButtonProperties(ButtonNumber, NewTitle);

     return(true);

}

/** PosgetSOSIncrement
 * @brief - when supplied with a session parameter name, will retrive the value, a default value of "60" is returned when
 *                  the propoerty is doesn't exist or is empty
 * Key - Name of the property
 * Returns the value of property or a default value of "60"
 */
function PosGetSOSIncrement(Key)
{
     var ReturnValue;

     if (rootCtx != null) {
          ReturnValue = rootCtx.get(Key);
     } else {
          ReturnValue = "60";
     }

     if (ReturnValue == null) {
          ReturnValue = "60";
     }

     return(ReturnValue);
}

/** RotateTime
 * @brief - When supplied the name of a property, will get the propert value and rotate to the next valext the the 15, 30, 60, 15 sequence
 * if the current value is not 15, 30, or 60 it will return "60"
 * Key - name of the property to rotate
 * Returns - the new interval value
 */
function RotateTime(Key)
{
     var Value = PosGetSOSIncrement(Key);
     var NewValue;

     if (Value == "15") {
          Value = "30";
     } else if (Value == "30") {
          Value = "60";
     } else if (Value == "60") {
          Value = "15";
     } else {
          Value = "60";
     }
     PosSetSessionProperty(Key, Value, true);

     return(Value);
}

/**
 * @brief - Prompt the user for required promo privilege
 * Return - always true
 */
function SetPromoAuthorityJS() {
//    var currentAuth = PosCheckSessionProperty("getAuthForForPromoOrder","true") ? "MGR" : "CREW";
     var currentAuth = PosCheckSessionProperty("getAuthForForPromoOrder","false") ? "CREW" : "MGR";

	// NVS-104  RPS 11/04/2009
     if (PosItemSelection("BLK_CREW.png|BLK_MGR.png|BLK_CANCEL.png","0|1|-1","Current: " + currentAuth,"Set Promo Approval")) {
        switch(Number(rootCtx.get("SelectedButtonValue"))) {
        case 1:
              /* Manager */
            PosSetSessionProperty("getAuthForForPromoOrder","true","true", "true");
            break;
        case 0:
            /* Crew */
            PosSetSessionProperty("getAuthForForPromoOrder","false","true", "true");
            break;
        default:
            /* Do nothing */
        }
    }
    return(true);
}

/**
 * @brief - Prompt the user for required promo order privilege
 * Return - always true
 */
// SDE-2600 new function
function SetPromoOrderAuthorityJS() {
//    var currentAuth = PosCheckSessionProperty("getAuthForForPromoOrder","true") ? "MGR" : "CREW";
     var currentAuth = PosCheckSessionProperty("getAuthForForPromoOrder","false") ? "CREW" : "MGR";

	// NVS-104  RPS 11/04/2009
     if (PosItemSelection("BLK_CREW.png|BLK_MGR.png|BLK_CANCEL.png","0|1|-1","Current: " + currentAuth,"Set Promo Order Approval")) {
        switch(Number(rootCtx.get("SelectedButtonValue"))) {
        case 1:
              /* Manager */
            PosSetSessionProperty("getAuthForForPromoOrder","true","true", "true");
            break;
        case 0:
            /* Crew */
            PosSetSessionProperty("getAuthForForPromoOrder","false","true", "true");
            break;
        default:
            /* Do nothing */
        }
    }
    return(true);
}

/**
 * @brief - Prompt the user for required promo oitem privilege
 * Return - always true
 */
// SDE-2600 new function
function SetPromoItemAuthorityJS() {
//    var currentAuth = PosCheckSessionProperty("getAuthForForPromoOrder","true") ? "MGR" : "CREW";
     var currentAuth = PosCheckSessionProperty("getAuthForPromoItem","true") ? "MGR" : "CREW";

	// NVS-104  RPS 11/04/2009
     if (PosItemSelection("BLK_CREW.png|BLK_MGR.png|BLK_CANCEL.png","0|1|-1","Current: " + currentAuth,"Set Promo Item Approval")) {
        switch(Number(rootCtx.get("SelectedButtonValue"))) {
        case 1:
              /* Manager */
            PosSetSessionProperty("getAuthForPromoItem","true","true", "true");
            break;
        case 0:
            /* Crew */
            PosSetSessionProperty("getAuthForPromoItem","false","true", "true");
            break;
        default:
            /* Do nothing */
        }
    }
    return(true);
}


/**
 * @brief - Prompt the user for required discount privilege
 * Return - always true
 */
function SetDiscountAuthorityJS() {
//    var currentAuth = PosCheckSessionProperty("getAuthForForDiscountOrder","true") ? "MGR" : "CREW";
     var currentAuth = PosCheckSessionProperty("getAuthForForDiscountOrder","false") ? "CREW" : "MGR";

	// NVS-104  RPS 11/04/2009
     if (PosItemSelection("BLK_CREW.png|BLK_MGR.png|BLK_CANCEL.png","0|1|-1","Current: " + currentAuth,"Set Discount Approval")) {
        switch(Number(rootCtx.get("SelectedButtonValue"))) {
        case 1:
            /* Manager */
              PosSetSessionProperty("getAuthForForDiscountOrder","true","true", "true");
            break;
        case 0:
            /* Crew */
            PosSetSessionProperty("getAuthForForDiscountOrder","false","true", "true");
            rootHlp.setSavedManagerId();
            break;
        default:
            /* Do nothing */
        }
    }
    return(true);
}


/** PosSosBuildCaption
 * @brief - Bulds the text to display on the button
 * Interval - the time interval of the button
 * Value - the value of the time interval for the button
 * Returns - The caption for the button
 */
function PosSOSBuildCaption(Interval, Value)
{
     var Caption = "title|" + "Hour\n" + Interval + "\n" + Value + " min";

     return Caption;
}


/** PosSOSCancelchangesJS
 * @brief - called when exiting the hourly reports configuration screen and discarding changes
 * ReturnToScreen - Number of the screen to go to upon completion
 * NumberOfKeys - number of interval keys on the configuration screen
 * returns - always returns true
 */
function PosSOSCancelChangesJS(ReturnToScreen, NumberOfKeys)
{


     // We no longer need the temporaries
     PosSOSRemoveTempProperties(NumberOfKeys);
     PosShowScreen(ReturnToScreen)
     return true;
}


/** PosSOSSavePopertiesJS
 * @brief - called when saving changes from the hourly report configuration screen.  Moves the value
 *                  of the temporary properties to the properties with persistence
 * ReturnToScreen - Number of the screen to return to.
 * NumberOfKeys - Number of interval keys on the configuration screen
 * returns - always returns true
 */
function PosSOSSavePropertiesJS(ReturnToScreen, NumberOfKeys)
{
     var Loop, PermProperty, TempProperty, IncrementValue;

     if(!PosShowConfirmationMessage("Confirm Save changes","Yes","No")) {

          return false;
     }

     // for each interval, get the temporary property and move the value to persistent property
     for (Loop = 0; Loop < NumberOfKeys; Loop++) {
          PermProperty = "Hour" + Loop + "Increment";
          TempProperty = "Temp" + Loop + "Increment";
//PosShowMessage("Loop = " + Loop + "  Temp " + TempProperty + " Perm " + PermProperty);
          IncrementValue = PosGetSOSIncrement(TempProperty);
//PosShowMessage("Increment value = " + IncrementValue);
          PosSetSessionPropertyForAllJS(PermProperty, IncrementValue, true);
     }

     // Now get rid of all the temporary properties
     PosSOSRemoveTempProperties(NumberOfKeys);
     PosShowScreen(ReturnToScreen);
     return true;
}

/** PosSosRemoveTempProperties
 * @brief - Removes the temporary properties used by the hourly report configuration screen
 * NumberOfKeys - How many interval keys are on the screen
 * returns - no return value
 */
function PosSOSRemoveTempProperties(NumberOfKeys)
{
     var Loop, TempProperty;

     for (Loop = 0; Loop < NumberOfKeys; Loop++) {
          TempProperty = "Temp" + Loop + "Increment";
          PosRemoveSessionProperty(TempProperty);
     }
}

/** PosSOSSetAlToSameJS
 * @brief - used to sett all hourly report intevals to the same value
 * Increment - The value to set all the report intervals to.  Usually 15, 30, 60
 * NumberOfKeys - The number of intervals on the configuration screen
 * ListOfKeys - An ascii piped delimited list of the button numbers
 * returns - always returns true
 */
function PosSOSSetAllToSameJS(Increment, NumberOfKeys, ListOfKeys)
{
     var Key, Loop, Interval, NewTitle, KeyArray;

     KeyArray = ListOfKeys.split("|");

     // First set all of the temp properties to the requested Increment value, then set the title of the key for display
     for (Loop = 0; Loop < NumberOfKeys; Loop++) {
          Key = "Temp" + Loop + "Increment";
          PosSetSessionProperty(Key, Increment, false);

          NewTitle = PosSOSBuildCaption(Loop, Increment);
          PosChangeButtonProperties(KeyArray[Loop], NewTitle);

     }

     return true;
}

/** PosSOSInitConfigJS
 * @brief - Called on activation of the hourly report configuration screen.  gets all of properties and places them temporaries
 * NumberOfButton - How interval buttons are the configuration screen
 * returns - always returns true
 */
function PosSOSInitConfigJS(NumberOfButtons)
{
     var Loop, PermProperty, TempProperty, IncrementValue;

     // For each interval, get the value and create temporary for use during the configuration session
     for (Loop = 0; Loop < NumberOfButtons; Loop++) {
          PermProperty = "Hour" + Loop + "Increment";
          TempProperty = "Temp" + Loop + "Increment";
          IncrementValue = PosGetSOSIncrement(PermProperty);
          PosSetSessionProperty(TempProperty, IncrementValue, false);
     }

     return true;
}
/**
 * @brief - Voids the current order
 * @return - true on success
 */
function PosDoVoidSaleJS() {
    // Confirm and approve
    if (!PosShowConfirmationMessage("Are you sure you want to overring?", "Yes", "No")) {
        return false;
    }

     // Sanity checks
     if (!PosCanVoidSaleJS()) {
          return false;
     }

    if (!PosGetAuthorization("manager", false)) {
        return false;
    }

    // Void current sale
    var retVal = PosDoVoidSale(true);

     /* clear pin for eSocket config'd stores */
     if (PosCheckParameter("TCLExtension","esocket","true") && (!PosCheckSessionProperty("POD","DRIVE_THRU"))) {
          result=npTCLEvalEx("Everest_Operation 22 0 0");
     }
    PosOffersClearMessage();
    if (retVal) {
		
		// NVS-3397 Split overring receipt into two separte print jobs:
		 // Normal receipt
		PosSetSessionProperty("SecondCopyOfReceipt", "false");
        PosCreateReport("VIEW", "receipt@reports.nps", "NOPREVIEW|SAVE");
		if (PosCheckSessionProperty("SecondCopyOfReceipt", "true") == true) 
		{
			PosCreateReport("VIEW", "receipt@reports.nps", "NOPREVIEW|SAVE");
		}
    }

	// UQA-130 RPS 12-26-2014
	//StopCashlessSession();
	PosDisplayLaneOpenMessage();
	

    return(retVal);
}

/**
 * @brief - determins if a tender type is invalid and hide the  supplied button if it is not
 * @return - void
 */
function PosHideCouponsIfInvalidJS(ButtonNumber, TenderID) {
	/* NVS-264 -can't apply coupons if ELECTRONIC payments are taken */
	if (PosHasElectronicTendersJS()) {
		PosChangeButtonProperties(ButtonNumber, "visible|false");
	} else if (validateTenderIdJS(TenderID) == false) {
          PosChangeButtonProperties(ButtonNumber, "visible|false");
     }
}

/**
 *  @brief - determines if a tender type is valid
 * @return - true if valid tender type, false otherwise
 */
function validateTenderIdJS(desired_Id) {
     // Create an POSDB object to access pos-db/store-db data

     var tender=rootHlp.getTenderDescr(desired_Id);
     if(tender != null) {
          return(true);
     }
     return(false);
}

/**
 * @brief - Assemble and show the confirmation message with the date to rollback to
 * @return - true if msg confirmation or false otherwise
 */
function PosShowRollbackConfirmationMessage() {
     var nRollDate=rootCtx.get("SELECTED_ROLLDATE");
     var ret=0;
     if(null!=nRollDate) {
          var sConfMsg=rootHlp.getSysMessage("MSG_BC_CFGROLLBACK_CONF_DATE", nRollDate);
          ret=PosShowConfirmationMessage(sConfMsg,"MSG_OK","MSG_CANCEL",1,nRollDate);
     }
     return(ret);
}


/**
 * @brief - Assemble and show the Second confirmation message with the date to rollback to
 * @return - true if msg confirmation or false otherwise
 */
function PosShowDblRollbackConfirmationMessage() {
     var nRollDate=rootCtx.get("SELECTED_ROLLDATE");
     var ret=0;
     if(null!=nRollDate) {
          var sConfMsg=rootHlp.getSysMessage("MSG_BC_CFGROLLBACK_DOUBLECONF_DATE", nRollDate);

          ret=PosShowConfirmationMessage(sConfMsg,"MSG_OK","MSG_CANCEL",1,nRollDate);
     }
     return(ret);
}

/**
 * @brief - Assemble and show the message with the manifest dat date
 * @return - true if msg confirmation or false otherwise
 */
function PosShowMessageWithManifestDate(message) {
     var manifestDate=rootHlp.getManifestDate();
     var ret=0;
     var sMsg;
     if(null!=manifestDate) {
          if(0!=Number(manifestDate)) {
          sMsg=rootHlp.getSysMessage(message, manifestDate);
          }
          else {
               sMsg=rootHlp.getSysMessage("MSG_BC_CFGROLLBACK_NODE_OFF");
          }
     }
     else {
          sMsg=rootHlp.getSysMessage(message, "");
     }
     ret=PosShowMessage(sMsg);
     return(ret);
}

/**
 * @brief - Assemble and show the Second confirmation message with the date to rollback to
 * @return - true if msg confirmation or false otherwise
 */
function PosShowMessageLockStatus() {
     var nLockSalesStatus=Number(rootCtx.get("lockSalesStatus"));
     var ret=0;

     switch(nLockSalesStatus) {
     case 2:        // POS offline
          PosShowMessage("MSG_BC_CFGROLLBACK_NODE_OFF");
          break;
     case 3:        // WAY offline
          PosShowMessage("MSG_BC_CFGROLLBACK_WAY_FAILED");
          break;
     case 1:        // lock error
          // fall thru
     default:
          PosShowMessage("MSG_BC_CFGROLLBACK_CANNOT_BLOCK");
          break;
     }

     return(ret);
}

/*
* -1 = open, 2 = close;
*
*/
function SendOpenCloseToEsocketJS(cmd) {
     var businessDate = "";

     /* check if the supervisor service is configured */
     if (!PosCheckParameter("SupervisorService","extname","eSocketDrv.dll")) {
          return (true);
     }
	/* check to see if the POS CLOSE was sucess */
	if (cmd == 2) {
		cmdResponse =rootCtx.get("dayCloseXML");
		data 			=new XML(cmdResponse);
		rootPosList 	= data.params.param.value.struct.member.(name=="POSLIST").value.array.data;
		/* make sure each POS is closed */
		var item;
		var closeSuccess = 1;
		for each (item in rootPosList.value) {
			/* if one POS didn't close, bail!*/
			var varCanOpenClose = Number(item.struct.member.(name=="CanOpenClose").value.i4);
			if(varCanOpenClose == 0) { return true; }
		}
	}
     /* get the configured ip and port */
     var ip   =rootHlp.findParamInSectionConfig("HostIP","SupervisorService");
     var port =rootHlp.findParamInSectionConfig("Port","SupervisorService");
     var bOpened = PosCheckState("POS_Opened");

     /* get new business date when we're opening, (SDE-2767 -and when stored is closed) */
     if ((cmd == 1) && (!bOpened)) {
          businessDate = 0;
     } else {
          businessDate = rootCtx.get("BUSINESSDATE");

     }

     /* no bus date, use today */
     if (!businessDate) {
          d = new Date();
          var cdate = d.getDate();
          if (cdate < 10)     cdate = "0"+cdate.toString();

          var cmonth = d.getMonth()+1;
          if (cmonth < 10)     cmonth = "0"+cmonth.toString();

          var cyear = d.getFullYear().toString();

          businessDate = cyear+cmonth+cdate;
          rootCtx.set("BUSINESSDATE", businessDate, true);
     }

     /* is the eSocket adaptor loaded */
     if (PosCheckParameter("TCLExtension","esocket","true")) {
          result=String(npTCLEvalEx("Everest_Operation 24 "+cmd+" "+businessDate+" "+ip+" "+port));
     } else {
          /* eSocket is not loaded, load the dll, and supervisor functions */
          /* make sure the functions are loaded */
          if(typeof(Esocketdrv_WayCommand) != 'function') {
               loadDll("eSocketDrv.dll","Escoketdrv_WayInit");
          }

          if(typeof(Esocketdrv_WayCommand) == 'function') {
               result=String(Esocketdrv_WayCommand(cmd, businessDate, ip, port));
          }
     }

     /* report only error status's */
     status = result.split("@")[0];
     message = String(result.split("@")[1]);
     storeOpenedMsg = "Store open was already completed for";

     /* SDE-2767 -success is defined as status ==0 or string match "Store open was already completed for" */
     if ((status != 0) && (message.search(storeOpenedMsg) == -1) ) {
          PosSetSessionProperty("CASHLESSOPEN_STATUS","fail",true);
          /* -2 = cashless update in progress */
          if (status == -2) {
               message ="Cashless Update is in progress.\nPlease try again.";
          }

          /* 1= open, 2= close */
          if (cmd == 1) {
               errMsg=rootHlp.getSysMessage("MSG_ESOCKET_OPEN_ERROR", message);
               if(!PosShowConfirmationMessage(errMsg,"MSG_OK","MSG_CANCEL")) {
                    PosShowMessage("MSG_ESOCKET_OPEN_SUPPORT");
                    return false;
               }
          } else if (cmd == 2) {
               if (message == " ") {
                    businessDate =rootCtx.get("BUSINESSDATE");
                    yy   =businessDate.substring(0,4);
                    mm   =businessDate.substring(4,6);
                    dd   =businessDate.substring(6);
                    busDay =mm+"/"+dd+"/"+yy;
                    closeMsg =rootHlp.getSysMessage("MSG_ESOCKET_CLOSE_ERROR1", busDay);
               } else {
                    closeMsg =rootHlp.getSysMessage("MSG_ESOCKET_CLOSE_ERROR2", message);
               }

               PosShowMessage(closeMsg);
          }

     /* successful cashless open */
     } else {
          if (cmd == 1) {
               PosSetSessionProperty("CASHLESSOPEN_STATUS","success",true);
          } else if (cmd == 2) {
               businessDate =rootCtx.get("BUSINESSDATE");
               yy   =businessDate.substring(0,4);
               mm   =businessDate.substring(4,6);
               dd   =businessDate.substring(6);
               busDay =mm+"/"+dd+"/"+yy;
               closeMsg =rootHlp.getSysMessage("MSG_OFFLINE_CLOSE_SUCCESS", busDay);
               PosShowMessage(closeMsg);
          }
     }

     return(true);
}



/* clears eSocketPED -called from workflow */
function eSocket_preSwipeCancelJS () {
     /* SDE-2789 -only for FC */
     if (PosCheckParameter("TCLExtension","esocket","true") && (!PosCheckSessionProperty("POD","DRIVE_THRU"))) {
          result=npTCLEvalEx("Everest_Operation 22 0 0");
     }

     return true;
}



/* call for SWOpenDay */
function PosDoSWOpenDayJS (timeout, forced) {
     var success    =PosDoSWOpenDay(timeout,forced);
     if (success) { 
	  try { 
	    PosWriteFile("E:\\MCD_iSPY_Central\\Input\\TriggerMgr\\RUN_ME_NOW___OFFLINE_NEWPOS___OPEN.FLG","DONE");
	  } catch( ex ) {
	    API.dbg("error writing open file");
	  }
     } 
	 
     /* show a message if open was successful and esocket was configured */
     if ((PosCheckParameter("SupervisorService","extname","eSocketDrv.dll")) && (success)) {
          businessDate =rootCtx.get("BUSINESSDATE");
          yy   =businessDate.substring(0,4);
          mm   =businessDate.substring(4,6);
          dd   =businessDate.substring(6);
          busDay =mm+"/"+dd+"/"+yy;
          if (PosCheckSessionProperty("CASHLESSOPEN_STATUS","success")) {
               openMsg =rootHlp.getSysMessage("MSG_OFFLINE_OPEN_SUCCESS1", busDay);
          } else {
               openMsg =rootHlp.getSysMessage("MSG_OFFLINE_OPEN_SUCCESS2", busDay);
          }

          PosShowMessage(openMsg);
     }

     return success;
}



function PosDayOpenJS() {
     var success    =PosDayOpen();

     /* show a message if open was successful and esocket was configured */
     if ((PosCheckParameter("SupervisorService","extname","eSocketDrv.dll")) && (success)) {
          businessDate =rootCtx.get("BUSINESSDATE");
          yy   =businessDate.substring(0,4);
          mm   =businessDate.substring(4,6);
          dd   =businessDate.substring(6);
          busDay =mm+"/"+dd+"/"+yy;
          if (PosCheckSessionProperty("CASHLESSOPEN_STATUS","success")) {
               openMsg =rootHlp.getSysMessage("MSG_OFFLINE_OPEN_SUCCESS1", busDay);
          } else {
               openMsg =rootHlp.getSysMessage("MSG_OFFLINE_OPEN_SUCCESS2", busDay);
          }

          PosShowMessage(openMsg);
     }

     return success;
}



function PosEndOfDayJS () {
     var success    =PosEndOfDay();
     //NVS-3265 Setting the value of Pick List off upon closing the store.
	 if(success) {
		PosSetSessionProperty("pickListAutomaticPrint","off","true","false");
	 }
     return success;
}


function PosDoSWCloseDayJS (timeout, forced) {
     /* SDE-2635 -check for an operator logged in before attempting close */
     if(PosCheckState("POS_OpLogged")) {
          PosShowMessage("MSG_BC_OPLOGGED");
          return false;
     }
     var success    =PosDoSWCloseDay(timeout, forced);
     //NVS-3265 Setting the value of Pick List off upon closing the store.
     if (success) {
 		PosSetSessionProperty("pickListAutomaticPrint","off","true","true");
    	try { 
     		PosWriteFile("E:\\MCD_iSPY_Central\\Input\\TriggerMgr\\RUN_ME_NOW___OFFLINE_NEWPOS___CLOSE.FLG","DONE");
     	} catch( ex ) {
     		API.dbg("error writing close file");
     	} 
     }

     if (PosCheckParameter("SupervisorService","extname","eSocketDrv.dll")) {
          if (!success) {
               PosSetSessionProperty("CASHLESSCLOSE_STATUS","fail",true);
               businessDate =rootCtx.get("BUSINESSDATE");
               yy   =businessDate.substring(0,4);
               mm   =businessDate.substring(4,6);
               dd   =businessDate.substring(6);
               busDay =mm+"/"+dd+"/"+yy;
               closeMsg =rootHlp.getSysMessage("MSG_ESOCKET_CLOSE_ERROR3", busDay);
               PosShowMessage(closeMsg);
          }
     }

     return success;
}

/**
 * @brief - Set the aspect of the button dimension when show prices is true
 */
function PosShowPricesSizeSelectionJS(btnSize,IsFloat) {
     var actualSize = rootHlp.getSizeSel();
     if(actualSize == btnSize) {
          PosChangeButtonProperties(0,"invert|true",IsFloat);
     }
     else {
          PosChangeButtonProperties(0,"invert|false",IsFloat);
     }
}
function RepEnablePrintFilterJS(change) {
	const reportType=["on","off"];
	const properties=[
		"bitmap|YES.png,bitmapdn|YES.png,title|Enable \nPrint\non",
		"bitmap|NO.png,bitmapdn|NO.png,title|Enable \nPrint\noff"
	];
	var i=0;
	// Loops up to length because the very first time reportPOD might not be set!
	for(i=0;i < reportType.length;i++) {
		if(PosCheckParameter("Report","enablePrint",reportType[i])) {
			break;
		}
	}
	if(i >= reportType.length) {
		i=("true"==change) ? 1 : 0;
	} else {
		if("true"==change) { // Next
			++i;
		}
		if(i >= reportType.length) {
			i=0;
		}
	}
	// either reportPOD was not set or changing from the last to the first...
	PosChangeButtonProperties(0,properties[i]);
	if("true"==change) { // Next
		PosSetParameter("Report","enablePrint",reportType[i]);
	}
	return(true);
}
/**
 * @brief - Check if it has some order with the same major to recall
 */
function PosCheckMultiOrderJS() {
	if(PosCheckSessionProperty("POD","DRIVE_THRU")) {
		return(!PosRecallMultiOrder("true"));
	}
	return(true);
}
/**
 * @brief - Check if PROMO button must show
 */
function PosCheckPromoAuthorityJS() {
	var retVal=false;

	// NPS-5766
	if("enable"==rootHlp.getBusinessLimitsParam("PromoItemAuthorityLimits")) {
		var promoAuthLevel=rootHlp.getBusinessLimitsParam("PromoItemAuthorityLevel");
		if(""==promoAuthLevel) {
			promoAuthLevel="disable";	// default
		}
		// NPS-5766
		//API.SLog("LOGLEVL_DEBUG", "[PosCheckPromoAuthorityJS] PromoItemAuthorityLevel ["+promoAuthLevel+"]");
		if(("crew"==promoAuthLevel)||("manager"==promoAuthLevel)) {
			// show PROMO button for crew and manager
			retVal=true;
		}
	}
	else {
		// compatibility with older version
		retVal=true;
	}
	return(retVal);
}
/**
 * @brief - Check if discount authority configuration must show
 * returns - returns true to show button or false to not shown
 */
function PosCheckDiscountAuthorityJS() {
	var retVal=false;

	// NPS-5766
	if("enable"==rootHlp.getBusinessLimitsParam("DiscountAuthorityLimits")) {
		var discAuthLevel=rootHlp.getBusinessLimitsParam("DiscountAuthorityLevel");
		if(""==discAuthLevel) {
			discAuthLevel="manager";	// default
		}
		// NPS-5766
		if("none"!=discAuthLevel) {
			retVal=true;
		}
	}
	return(retVal);
}
/**
 * @brief - Gets the multiplicity of an item (its quantity times the quantities of its ancestors)
 */
function lGetProductMultiplicity(view, currentIndex, parentIndex, bLastParent) {
	var iCount;
	var nextLevel=Number(view.ItemView[currentIndex].level)-1;
	var multiplicity=Number(view.ItemView[currentIndex].quantity);
	for(iCount=currentIndex; (iCount>=parentIndex)&&(multiplicity!=0)&&(nextLevel>=0); iCount--) {
		if(view.ItemView[iCount].level==nextLevel) {
			multiplicity=multiplicity*Number(view.ItemView[iCount].quantity);
			nextLevel--;
		}
		if((false==bLastParent)&&(0==nextLevel)) {
			// disconsider the level zero parent
			break;
		}
	}
	return(multiplicity);
}
/**
 * @brief - Check to see if in SPOD mode
 *  Checks to if the PODList is set to "FC|WT" to determine if we are in SPOD mode.
 * Return true if in SPOD mode, false otherwise.
 *
 * change made for NVS-413.  Function now check for FC|DT to see if we are NOT in SPOD mode.  All other
 * values result in a SPOD mode being found.
 */
function IsSPODModeJS() {
	var result		= "";
	var ReturnValue = true;
	var PODList = rootStoreDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "OperationMode").Parameter.(@name == "PODList").@value;

	if (PODList == "FC|DT") {
		ReturnValue = false;
	}
	return ReturnValue;
}

/*
 *  PosTenderCondition
 * examines the current sale view and check for a specified condition.
 * parameters - TenderType - condition to check for.
 *	  Current supported value.
 *		EmpMeal - checks if an employee meal is in effect
 *		NoTax - Checks if no tax has been selected
 *
 * Return ture if the condition exists, false otherwise
 * originally created for NVS-60
 */
function PosTenderCondition(TenderType)
{


    var currentView = rootHlp.getCurrentView();
    if(currentView == null) {
        return (false);
    }
    var view = new XML(currentView);
    var Tenders = view.ItemTenderView;
    if(Tenders == null) {
        return(false);
    }


	if (TenderType == "EmpMeal") {
		for(i=0; i < Tenders.length(); i++) {
			var Tender = Tenders[i];
			if (Tender.description == "Employee Meal") {
				return(true);
			}
		}
	}

	if (TenderType == "NoTax") {
		if (view.@taxMode == "2") {
			return (true);
		}
	}

	if (TenderType == "TENDER_GIFT_COUPON"  && (view.ItemTenderView.(cat == "TENDER_GIFT_COUPON")).length() != 0) return(true);
	
	// NVS-1816 Check if there are any tenders
	// NVS-2013 Exclude order level offers from ANY_TENDER check. 
	if (TenderType == ANY_TENDER && Tenders.length() > 0 && (view.ItemTenderView.(code == "99")).length() == 0)
	{
		return true;
	}
	

	return (false);
}
// NVS-58 RPS 9/10/09
/** PosDisableChoiceListJS
 * @brief - Uses the prebuilt choice list to call PosDisableChoice
 * @param - no parameters
 * returns - always returns true
 */

function PosDisableChoiceListJS() {
	var TheList = rootCtx.get("ChoiceDisableList");
	PosDisableChoice(TheList);
	return true;
}
// NVS-32  RPS 09/28/09
function PosRefreshButtonsJS() {
	PosRefreshButtons();
}

// Added for SDO-1784  RPS 01/25/10
function PosIsEnoughCashForRefundJS()
{
    /* var hlp = new BusinessObjectHelper; */
	var ReturnValue = false;

    var currentView = rootHlp.getCurrentView();
    if(currentView == null) {
        return false;
    }
    var view = new XML(currentView);
	var TotalDue = view.@totalDue;

	PosSetSessionProperty("CashInDrawer", "0");
	PosCreateReport("CASH","reportCalcCashInDrawer@reports.nps","NOPREVIEW");

	var CashInDrawer = rootCtx.get("CashInDrawer");
	if (Number(CashInDrawer) >= Number(TotalDue)) {
		ReturnValue = true;
	} else {
		PosShowMessage("MSG_BC_CHECKCASHREFUND");
		ReturnValue = false;
	}

	return ReturnValue;
}



/**PosDoTenderJS
 *
 * @brief - This BC tenders a sale
 * Return - rval - true if allowed to continue
 */
function PosDoTenderJS(tenderID,amount,flags)
{
	PosSetSessionProperty("LargeTenderApproved", "true");
	// Clears info area
	PosDisplayText("",1);
	var bEndOfSale=PosDoTender(tenderID,amount);
	PosHandleCalculatorButton("clear");

		var currentView = rootHlp.getCurrentView();
    if(currentView == null) {
        return (false);
    }
    var view = new XML(currentView);

	if(bEndOfSale) {
		/* NVS-190 JWC 4/1/10 */
		if (PosCheckSessionProperty("CASHLESS_OPENDRAWER","1")) {
			var subtotal = new BigDecimal(view.@totalAmount);
			var tax = new BigDecimal(view.@totalTax);
			var total = new BigDecimal(0);
			total = subtotal.add(tax);
			var totalCashless = new BigDecimal(0);

			for each(var item in view.ItemTenderView){
				if(item.cat == "TENDER_ELECTRONIC_PAYMENT"){
					totalCashless = totalCashless.add(item.value);
				}
			}

			msg=rootHlp.getSysMessage("MSG_BC_OPENDRAWER", subtotal, tax, total, totalCashless);
			if((PosShowConfirmationMessage(msg,"Open Drawer", "Exit"))){
				//pop drawer
				PosOpenCashDrawer();
			}
		}

		// Last tender -> ends sale
		if(typeof(PosDoEndOfSaleJS) == "function") {
			var noAutoRecall=!(PosIsCashDrawerForced()||!PosCheckSessionProperty("IsCDrawerSetToOpen","true"));
			PosSetForeignCurrency("-1");
			PosDoEndOfSaleJS(noAutoRecall,flags,0);

		} else {
			PosSetForeignCurrency("-1");
			PosDoEndOfSale(true);
		}
		// Clears info area, moved for NPO-41, moved lower for NPO-292
		PosOffersClearMessage();
	} else {
		if (PosCheckSessionProperty("LargeTenderApproved", "true")) {
			PosSetForeignCurrency("-1");
			PosRefreshButtons();
			PosRefreshSalePanel();
		}
	}
	return(true);
}
/** PosDoSkipCarJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosDoSkipCarJS</b>\n
 * This BC put skip Car!\n
 * In a workflow sequence it is called:<b>PosDoSkipCarJS</b>\n
 * In java script it should be called:<b>PosDoSkipCarJS</b>\n
 * Return - rval - true if possible
 */
function PosDoSkipCarJS()
{
	if(!PosIsInSaleMode() || !PosNotATransactionInProgress(false)) {
		return(false);
	}
	// Sale not started as yet...
	if(!PosCheckCashDrawer()) {
		// Drawer open
		PosShowMessage("MSG_BC_DRAWER_OPENED");
		return(true);
	}
	if(PosCheckSessionProperty("POD","DRIVE_THRU")) {
		if(!PosShowConfirmationMessage("MSG_BC_DLG_SKIPCAR","MSG_OK","MSG_CANCEL")) {
			return(false);
		}
		PosDoSkipCar();
	}
	PosShowScreen(rootCtx.get("baseScreenId"));

	return(true);
}

/**PosChangeTaxModeJS
 *
 * @brief - This BC gives a discount in a sale
 * Return - rval - true if allowed to continue
 */
function PosChangeTaxModeJS(mode,flags)
{
	if(PosChangeTaxMode(mode)) {
		// Ends sale
		if(typeof(PosDoEndOfSaleJS) == "function") {
			PosDoEndOfSaleJS(false,flags,0);
		}
		else {
			PosDoEndOfSale(true);
		}
	}
	PosHandleCalculatorButton("clear");
	return(true);
}


/**StartSpecialTrxJS
 *
 * @brief - This BC starts a special transaction (waste,refund)
 * Return - rval - true if allowed to continue
 */
function StartSpecialTrxJS(level,singleSignOn,kind,message,destination)
{
	// Should be in Sale mode (operator logged and not alreday performing a transaction
	if(!PosIsInSaleMode() || !PosNotATransactionInProgress(false)) {
		return(false);
	}
	switch(Number(rootCtx.get("transactionSaleType"))) {
	case 1:
		PosShowMessage("MSG_BC_REFUND_IN_PROGRESS");
		break;
	case 2:
		PosShowMessage("MSG_BC_WASTE_IN_PROGRESS");
		break;
	default:
		if(!PosGetAuthorization(level,singleSignOn)) {
			return(false);
		}
		PosOffersClearMessage();   /* NVS-4033 */
	 	PosSetTransactionKind(kind);
		PosShowScreen(rootCtx.get("baseScreenId"));
		PosDisplayText(message,destination);
	}
	return(true);
}

/**HideButtonIfMatchPODJS
 *
 * @brief - This BC hhides a button (according to a type)
 * Return - rval - true
 */

function HideButtonIfMatchPODJS(podType,btnType) {

	if(PosCheckSessionProperty("POD",podType)) {
		PosChangeButtonProperties(btnType,"visible|false");
	}
	else {
		PosChangeButtonProperties(btnType,"visible|true");
	}
	return(true);
}

/**PosTimePunchJS
 *
 * @brief - This BC set a time punch for a user
 * Return - true if changed, false otherwise
 */
function PosTimePunchJS() {

	// Gets user id
	var	sIdtf=rootHlp.showCalculator("MSG_PROMPTUSERID",1);
	if(sIdtf.length == 0) {
		return(false);
	}
	// Gets user current password...
	var sPassword=rootHlp.showCalculator("MSG_PROMPTGETPSWD");
	if(sPassword.length == 0) {
		return(false);
	}
	// Checks operator validity
	if(!rootHlp.validateUser(sIdtf,sPassword,0)) {
		// Reset needs at least a floor manager
		PosShowMessage("MSG_INVPASSWD");
		return(false);
	}
	return(PosTimePunch(sIdtf,sPassword));
}

/**PosIsBreakfastTimeJS
 *
 * @brief - This BC shows checks if it is breakfast time (or a flag is set indicating that)
 * Return - true if breakfast time, false otherwise
 */
function PosIsBreakfastTimeJS() {
	if(PosCheckSessionProperty("BreakfastTime","true")) {
		return(true);
	}
	if(PosCheckSessionProperty("BreakfastTime","false")) {
		return(false);
	}
	return(PosIsBreakfastTime(true));
}

/**PosCheckClicksJS
 *
 * @brief - This BC decrements the number of clicks for a given screen and shows a new screen if the number of clicks is zeroed
 * Return - true if breakfast time, false otherwise
 */
function PosCheckClicksJS(screenNbr) {

	var sNbrCliks=rootCtx.get("clicksOnScreen");
	if((undefined == sNbrCliks) || (null == sNbrCliks)) {
		// Not defined
		return(true);
	}
	var nbrClicks=Number(sNbrCliks)-1;
	if(nbrClicks >= 0) {
		rootCtx.set("clicksOnScreen",nbrClicks,1);
		if(0 == nbrClicks) {
			return(PosShowScreen(screenNbr));
		}
	}
	return(true);
}

/**PosCheckChoicesJS
 *
 * @brief - This BC checks for open choice of a kind
 * Return - rval - true if allowed to continue
 */
function PosCheckChoicesJS(choices) {
	if((choices != undefined) && (choices != null)) {
		var choiceArray=choices.split(",");
		if(choiceArray != null) {
			var i=0;
			for(;i < choiceArray.length; i++) {
				if(!PosCheckChoice(choiceArray[i])) {
					return(true);
				}
			}
		}
	}
	return(false);
}

/**PosIsSaleEmptyJS()
 *
 * @brief - This BC checks if a sale is empty
 * Return - true if empty
 */
function PosIsSaleEmptyJS() {

	var curProdDescr=rootHlp.getSaleItem(0,0);
	return((curProdDescr != null)?false:true);
}

/**PosSetSessionPropertyForAllJS
 *
 * @brief - This BC sets a session property in all registers online
 * Return - true if empty
 */
function PosSetSessionPropertyForAllJS(key,value,persist) {
	return(PosSetSessionProperty(key,value,persist,true));
}


/**PosDoDiscountJS
 *
 * @brief - This BC gives a discount in a sale
 * @param discountID - string - (numeric value) discount id as configured in store-db
 * @param discountType - string - type of discount: 1-normal (default)\n
 *													 2-crew meal\n
 *													 3-manager meal
 * @param discountInputMode - string - optional - type of input: 0-no input (default)\n
														  1-amount\n
														  2-rate\n
														  3-operator inputs an amount\n
														  4-operator inputs a rate
 * @param discountValue - string - optional - it depends of input mode. If input mode is 1 it's a amount. If input mode is 2 it's a rate. Otherwise it's ignored.
 * @param description - string - optional - discount discription.
 * @param flags - This parameter can be null or a pipe-separated list of flags to process. It is used to create and print report in PosDoEndOfSaleJS, in case of end of sale after discount
 * Return - rval - true if allowed to continue
 */
function PosDoDiscountJS(discountID,discountType,discountInputMode,discountValue,description,flags)
{		
	if(PosDoDiscount(discountID,discountType,discountInputMode,discountValue,description)) {
		// Ends sale
		if(typeof(PosDoEndOfSaleJS) == "function") {
			PosDoEndOfSaleJS(false,flags,0);
		}
		else {
			PosDoEndOfSale(true);
		}
	}
	PosHandleCalculatorButton("clear");
	return(true);
}

/**PosChangeBtnTitleJS
 *
 * @brief - This BC changes the title of a button according to a received propertu message
 * Return - true
 */
function PosChangeBtnTitleJS(btnNbr,msg,c1,c2,c3) {

	var sConfMsg="title|"+rootHlp.getSysMessage(msg,c1,c2,c3);
	PosChangeButtonProperties(btnNbr,sConfMsg);
	return(true);
}

/**
 * @brief This function implements the BC,Business Component: <b>PosDoDiscount</b>.
 *
 * Persistence:<b>Not Persisted</b>\n
 * This BC applies a discount to the sale according to the received parameters.
 * An error message is displayed if the current transaction is not a sale.
 *
 * @param nDiscountId - string - (numeric value) discount id as configured in store-db
 * @param nDiscountType - string - type of discount: 1-normal (default)\n
 *													 2-crew meal\n
 *													 3-manager meal
 * @param nInputMode - string - optional - type of input: 0-no input (default)\n
														  1-amount\n
														  2-rate\n
														  3-operator inputs an amount\n
														  4-operator inputs a rate
 * @param value - string - optional - it depends of input mode. If input mode is 1 it's a amount. If input mode is 2 it's a rate. Otherwise it's ignored.
 * @param description - string - optional - discount discription.
 * @success Discount granted successfully.
 * @failure	<i>Not authorized</i> - This operation needs manager authorization.\n
 * @failure	<i>Not valid discount</i> - The discount id is unknown.\n
 * @failure	<i>Amount exceeded</i> - Maximum discount amount allowed was exceeded.\n
 * @failure	<i>Rate exceeded</i> - Maximum discount rate allowed was exceeded.\n
 * @failure	<i>Unable to do tender</i> - The income must be equal or greater than the order value.\n
 * @failure <i>Not in sale operation</i> - The operator is allowed to apply a discount only if the operatation is a sale.\n
 * @hook <i>onDiscount()</i> - called when this BC starts.
 * @hook <i>onCanDiscount()</i> - called by PosDoDiscount_CSL after the discount is appllied. If this event returns false, the discount is cancelled.
 * @remarks
 *
 * Property Messages:\n
 *	 MSG_BC_DISCNOTALLOW: Show a message that the discount is not allowed.\n
 *   MSG_BC_DISCOUNT_AMOUNT: Show a message that discount amount is invalid.\n
 *   MSG_BC_DISCOUNT_RATE: Show a message that discount rate is invalid.\n
 *   MSG_BC_INVDISCOUNT: Show a message that the discount id is unkowning.\n
 *   MSG_BC_MAX_DISCOUNT: Show a message with maximum discount amount allowed.\n
 *   MSG_BC_MAX_RATE: Show a message with maximum discount rate allowed.\n
 *   MSG_BC_DISCNOTALLOW: Show a message that the operator is allowed to apply a discount only if the operation is a sale.\n
 * 	 MSG_BC_RETPAYMENT: Show a message when an error occured while computing discount.\n
 *
 */
function PosDoDiscount(nDiscountId, nType, nInputMode, value, description) {
	var result = false;
	if(!onDiscount(nDiscountId,nType)) {
		API.SLog("LOGLEVL_DEBUG", "[PosDoDiscount] onDiscount returned false");
		return false;
	}

	if(undefined == nDiscountId) {
		PosShowMessage("MSG_BC_INVDISCOUNT");
	}
	//Execute
	switch (nInputMode) {
		default:
			API.SLog("LOGLEVL_DEBUG","PosDoDiscount called with invalid Input Mode: "+nInputMode);
			nInputMode = "0";
		case "0":
		case "1":
		case "2":
			result = PosDoDiscount_CSL(nDiscountId, nType, nInputMode, value, description);
			break;
		case "3":
			cPosGetMaxAmount();
			var maxAmount = getResult("cPosGetMaxAmount");
			message = rootHlp.getSysMessage("MSG_BC_DISCOUNT_AMOUNT", maxAmount);
			var currencySymbol = rootStoreDB.StoreDB.StoreProfile.Localization.CurrencySymbol;
			value = PosShowCalculator(message,currencySymbol,0,2);
			result = PosDoDiscount_CSL(nDiscountId, nType, nInputMode, value, description);
			break;
		case "4":
			value = PosShowCalculator("MSG_BC_DISCOUNT_RATE","%",5,2)/100;	// 10^(number of decimal places)
			result = PosDoDiscount_CSL(nDiscountId, nType, nInputMode, value, description);
			break;
	}
	//Handle results
	if (!result) {
		var messageBC = null;
		switch (nInputMode) {
			case "0": //Discount by table
				messageBC = getLastFail("cPosAddDiscountTable");
				break;
			case "1": //Discount by amount
			case "3":
				messageBC = getLastFail("cPosAddDiscountAmount");
				break;
			case "2": //Discount by rate
			case "4":
				messageBC = getLastFail("cPosAddDiscountRate");
				break;
			default:
				messageBC = null;
				break;
		}
		if(messageBC != null) {
			PosShowMessage(messageBC);
		}
	}
	return result;
}

/**
 * @brief This function implements the BC,Business Component: <b>PosChangeBusinessDayJS</b>.
 *
 * Persistence:<b>Not Persisted</b>\n
 * This BC executes the change business day routine!\n.\n
 * In java script it should be called:<b>PosChangeBusinessDayJS()</b>
 * @success Business day changed.
 * @failure	<i>Unable to connect to way station</i> - Way station is offline, the MSG_CHGDAY_WAYOFFLINE could be retrieved by getLastFail.
 * @failure	<i>Wrong business day</i> - Business Day of the way station is different of the business day of the register, the MSG_CHGDAY_WRONGBUSINESSDAY could be retrieved by getLastFail.
 * @failure	<i>Operation not allowed</i> - The operator is logged, the MSG_CHGDAY_OPERATIONNOTALLOWED could be retrieved by getLastFail.
 * @failure	<i>Operation not allowed</i> - There is orders in progress, the MSG_CHGDAY_ORDERSINPROGRESS could be retrieved by getLastFail.
 * @remarks
 *
 * Property Messages:\n
 *   MSG_CHGDAY_WAYOFFLINE: Error message informing that way station is offline.\n
 *   MSG_CHGDAY_WRONGBUSINESSDAY: Error message informing that the way station business day is different of register business day.\n
 *   MSG_CHGDAY_OPERATIONNOTALLOWED: Error message informing that operation could not the performed, in this case the operator is logged.\n
 *   MSG_CHGDAY_ORDERSINPROGRESS: Error message informing that there is orders in progress.\n
 *
 */
function PosChangeBusinessDayJS() {
	if(!PosChangeBusinessDay()) {
		PosShowMessage(getLastFail());
		return false;
	}
	return true;
}

/**
 * @brief This function implements the BC,Business Component Local: <b>PosDayOpen</b>.
 *
 */
function PosDayOpen(openMode, level) {

  // call event
  if(typeof(onDayOpen) == "function") {
    onDayOpen(openMode, level);
  }

  var result = PosDayOpen_CSL(openMode, level);
  if (result) {
    // call event
    if(typeof(onDayOpened) == "function") {
      onDayOpened(openMode, level);
    }
  }
  var enabled = PosCheckParameter("OperationMode", "enableDualBump", "true");
  if (enabled) {
  	PosSetDualBump("true");
  } else {
  	PosSetDualBump("false");
  }
  
	var isEnabled="false";
	/* NVS-4080 -changed to Global StoreDB usage */ 
	isEnabled = GLOBAL_STOREDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "SuggestiveSelling").Parameter.(@name == "isEnabled").@value;
	if (isEnabled == "true") {
  		ChangeSuggestiveSellingModeJS("true");
	}
	
  
  return (result);
}	

/**
 * @brief This function implements the BC,Business Component Local: <b>PosEndOfDay</b>.
 *
 */
function PosEndOfDay(closeMode, level) {

  // call event
  if(typeof(onEndOfDay) == "function") {
    onEndOfDay(closeMode, level);
  }

  if (PosEndOfDay_CSL(closeMode, level)) {
    // call event
    if(typeof(onDayClosed) == "function") {
      onDayClosed(closeMode, level);
    }
		return true;
	} else {
		return false;
  }

}

/**
 * @brief This function implements the BC,Business Component Local: <b>PosDoSWOpenDay</b>.
 *
 */
function PosDoSWOpenDay(timeout, isForced) {

  // call event
  if(typeof(onSWDayOpen) == "function") {
    onSWDayOpen(timeout, isForced);
  }

  return(PosDoSWOpenDay_USCOE(timeout, isForced));

}

/**
 * @brief This function implements the BC,Business Component: <b>PosDoSWOpenDay_CSL</b>.
 *
 * Persistence:<b>Persisted</b>\n
 * This BC performs the actions needed to open the day for the store widely.\n
 * The action can be done in forced or non forced modes. In forced mode, all POS in the store are\n
 * commanded to open while in non forced mode, only when all POS are able to open the action is commanded.\n
 * This BC can be activated either locally, to start the process of opening the day for the store, or\n
 * remotelly, to locally perform the day opening.\n
 * In java script it should be called:<b>PosDoSWOpenDay_CSL(timeout, isForced)</b>
 * @param timeout - String - Optional, time to execute the command in miliseconds (default is 15000ms).
 * @param isForced - String - Optional, "true" or "false"(default).
 * @success Store wide open day was performed.
 * @failure <i>onSWDayOpen() failed</i> - hook returned false.
 * @failure <i>Cannot get POS state</i> - failed to retrieve POS state.
 * @failure <i>POS is not Closed</i> - Day is already open.
 * @failure <i>User Cancelled</i> - User cancelled calculator when asking for date to open the day.
 * @failure <i>User not Authorized</i> - User is not authorized to perform Store Wide Open day.
 * @failure <i>Communication Error</i> - WayStation is not available.
 * @hook <i>onSWDayOpen()</i> - called before BC start.
 * @sessioncontext <i>"dayOpenXML"</i> - set with the xml for day open.
 * @sessioncontext <i>"dayOpenBusinessDay"</i> - set as the business day being checked for opening.
 * @remarks
 *
 * Property Messages:\n
 * 	MSG_BC_SWALREADYOPEN: Shown when confirming to open all other registers, except this one, cause its already opened (only in forced mode).\n
 *	MSG_BC_ALREADYOPEN: Shown if day is already opened (only when not in forced mode).\n
 *	MSG_BC_DAYOPENCONF: Shown when confirming to open day or type a new date.\n
 *	MSG_BC_INVBUSDATE: Shown when invalid business date entered (only for non forced mode).\n
 *	MSG_BC_SWINVDATE: Shown when invalid business date entered (forced mode, maybe the date is valid elsewhere).\n
 *	MSG_BC_SWCOMMUNIC: Way Station is not available for Store Wide Command.\n
 *	MSG_BC_ERRSWOPEN: Shown when unable to open all registers in the store.\n
 */
function PosDoSWOpenDay_USCOE(timeout, isForced) {
	var ctx=new SessionContext;
	var cmd = "PosDoSWOpenDay_USCOE";
	CSL_dbglog(7, SRC_BC_REGISTER, cmd, "Start");
	var result = true;
  var dayOpen = null;
  // Parameters
	var	pisForced = "false";
  var	ptimeout = "15000";
  if (timeout != undefined && timeout != "true" && timeout != "false") {
  	ptimeout = timeout;
  }
  if (isForced != undefined && (isForced == "true" || isForced == "false")) {
    	pisForced = isForced;
  }
  // Get State POS
	var xmlPOS = new XML(rootHlp.getPOSState());
	var state  = Number(xmlPOS.@state);
	
	switch(state) {
	case POS_STA_CLOSED:
 		result = true;
		break;
	default:
	  if (pisForced == "true") {
    	if (!PosShowConfirmationMessage("MSG_BC_SWALREADYOPEN","MSG_YES","MSG_NO")) {
    		result = false;
    	}     
    } else {
		// SQC-1625
  		//PosShowMessage("MSG_BC_ALREADYOPEN");
  		//result = false;
    }
		break;
	}
	
	isEnabled = GLOBAL_STOREDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "SuggestiveSelling").Parameter.(@name == "isEnabled").@value;
	if (isEnabled == "true") {
		ChangeSuggestiveSellingModeJS("true");
	}

  if (result) {
    // Gets Date Format - Store-DB-Xml
   	var fmtDate	= rootStoreDB.StoreDB.StoreProfile.Localization.DateFormat;
    // Gets Date System
  	var wdate  = new Date();
  	var wyear  = setZerosOnLeft(wdate.getFullYear(),4);
  	var wmonth = setZerosOnLeft(wdate.getMonth() + 1,2);
  	var wday   = setZerosOnLeft(wdate.getDate(),2);
  	var sdate  = wyear + wmonth + wday;
    
	var sMsg=rootHlp.getSysMessage("MSG_BC_DAYOPENCONF",fmtDate);
 		if (PosAskDate(sdate, sMsg, 2)) {
   		dayOpen = getLastSuccess("PosAskDate");
   		if(!PosGetAuthorization("manager")) {
    		result = false;
    	}
    } else {
		result = false;
  	}
	
	
	if (result) {
		result = cPosSWOpenDay(dayOpen, ptimeout, pisForced);
		
		if (result == false) {
			PosShowMessage(getLastFail("cPosSWOpenDay"));
		}
		CSL_dbglog(0, SRC_BC_REGISTER, cmd, "cPosSWOpenDay result : " + result + " state: " + state);
		CSL_dbglog(0, SRC_BC_REGISTER, cmd, "dayOpenXML: " + ctx.get("dayOpenXML"));
		switch(state) { //state is equal to 0 WAY offline
		case POS_STA_CLOSED:
			// SQC-1625 - check POS state of other POS (if at least one is opened then try to open local too
			var opendayxml = new XML(rootCtx.get("dayOpenXML"));
			if(pisForced=="true"){
				var rootPosList=opendayxml.params.param.value.struct.member.(name=="POSLIST").value.array.data;

				var result=false;
				for each (item in rootPosList.value) {
					var varState = item.struct.member.(name=="State").value.string;
					if(("Opened"==varState)||("Logged"==varState)) {
						result=true;	// at least one POS is opened -> try to open the local (even if opened POS is in incorrect BD)
					}
				}
			}
			else{
				var canOpenClose=opendayxml.params.param.value.struct.member.(name=="CanOpenClose").value.i4;
				CSL_dbglog(0, SRC_BC_REGISTER, cmd, "canOpenClose: " + canOpenClose);
				if(canOpenClose=="1"){
					result = true;
				}
				else{
					result = false;
				}
			}
			break;
		default:
			// SQC-1625 - call cPosDayOpen only to update session variable
			//result=true;
			break;
		}
		
		var posMode;
		
		
		if (result == false) {
			posMode = "updateStatus";
		} else {
			// Local Open Day
			if (pisForced == "true") {
				posMode = "forced";
			} else {
				posMode = "storewide";
			}
		}
		result = cPosDayOpen(posMode, dayOpen);
		
		if (false==result){
			PosShowMessage(getLastFail("cPosDayOpen"));
		}
		adjustView("dayOpenXML", ctx, String(xmlPOS.@ID));
//		result=true;		// Remove for NVS-265
	}
  }
 	return(result);
}

/**
 * @brief This function implements the BC,Business Component Local: <b>PosDoSWCloseDay</b>.
 *
 */
function PosDoSWCloseDay(timeout, isForced) {

  // call event
  if(typeof(onSWEndOfDay) == "function") {
    onSWEndOfDay(timeout, isForced);
  }

  var result = PosDoSWCloseDay_CSL(timeout, isForced);
  return (result);
}	



/**PosIsAdaptorLoadedJS
 *
 * @brief - Checks if if an adaptor for the given sectionName is present in the pos-db/store-db.
 * Return - true if present, false otherwise
 */
function PosIsAdaptorLoadedJS(sectionName){
	var posDB;
	// parsing XML
	try {
		posDB	= new XML(API.getPosdb());
	} catch (e) {
		// parser error
		return(false);
	}

	var dllName = posDB.Services.Service.(@type == "POS").Adaptors.Adaptor.(@name == "npCLayer").Section.(@name == sectionName).Parameter.(@name == "extname").@value;
	if (dllName == "") { return false;	}
	if (dllName.indexOf(".dll") == -1){
		//dll not loaded
		return(false);
	}
	else {
		return(true)
		}
}
/*
 * @brief - This function implements the BC,PosHasElectronicTendersJS: <b>PosHasElectronicTendersJS</b>\n
 * This BC checks if the current sale has any Cashless Tenders already allied to the sale!\n
 * In a workflow sequence it is called:<b>PosHasElectronicTendersJS</b>\n
 * In java script it should be called:<b>PosHasElectronicTendersJS()</b>\n
 * This BC does not require parameters.\n
 * @Return - rval - True if has Cashless Tenders, otherwise, false.
*/
function PosHasElectronicTendersJS() {
	var status = false;

	if (!PosNotATransactionInProgress(true) ) {
		var currentView = rootHlp.getCurrentView();
		if(currentView == null) { return status; }

		var view = new XML(currentView);
		/* if the sale view have any tenders... */
		var tenders    = view.ItemTenderView;
		var numTenders = tenders.length();
		if (numTenders != 0) {
			/* NVS-330 ignore coupon tenders JWC 8-17-10 */
			/* NVS-3913 also not ignore blank tenders - for promotions */
			for (i=0; i<numTenders; i++){
				if(tenders[i].cat != "" && tenders[i].cat != "TENDER_GIFT_COUPON"){
					status = true;
				}
			}
		}
	}
	return status;
}
/**
 * \brief Constructor of ConsolidatedView class
 * \param [in] view - View to consolidate in flat string format
 */
function ConsolidatedView_Ex (view) {
    this.view = new XML (view);		// Original view to be consolidated
}

/**
 * \brief Change Equivalent information
 * \return
 */
ConsolidatedView_Ex.prototype.changeEquivalent = function () {
	var qtyViewItem=this.view.ItemView.length();
	var qtyEquivItem=this.view.EquivalentItemView.length();
	for(var j=0; j<qtyEquivItem; j++) {
		for(var i=0; i < qtyViewItem; i++) {
			if(this.view.ItemView[i].EquivalentCode.length() > 0) {
				if(this.view.EquivalentItemView[j].productCode.toString() == this.view.ItemView[i].EquivalentCode.toString()) {
					this.view.ItemView[i].productCode = this.view.EquivalentItemView[j].productCode;
					this.view.ItemView[i].description = this.view.EquivalentItemView[j].description;
					this.view.ItemView[i].longName = this.view.EquivalentItemView[j].longName;
					this.view.ItemView[i].dtName = this.view.EquivalentItemView[j].dtName;
					if(this.view.EquivalentItemView[j].displayOrder != 0) {
						if(this.view.EquivalentItemView[j].displayOrder < 0) {
							var a=this.view.ItemView[i].ProdIntId;
							if(a < 0) {
								a=this.view.ItemView[i].SaleLine;
							}
							this.view.ItemView[i].displayOrder=(this.view.EquivalentItemView[j].displayOrder+1)*-10000+a*10+((this.view.ItemView[i].isGrillLine || this.view.ItemView[i].ComponentsChange)?0:9);
						}
					}
					else {
						this.view.ItemView[i].displayOrder=-10000+this.view.ItemView[i].SaleLine*10+((this.view.ItemView[i].isGrillLine || this.view.ItemView[i].ComponentsChange)?0:9);
					}
				}
			}
		}
	}
}

/**
 * \brief Consolidates a view, returning its value in flat string format.
 * \return The consolidated view.
 */
ConsolidatedView_Ex.prototype.consolidate = function () {
	// Change equivalent
	this.changeEquivalent();
    // Create array with sale items
    var newViewArray = this.detachChoice ();
    // Create the consolidated view
    var sortedView = this.createConsolidation (newViewArray);
	// Sort the Consolidated View
    this.sortView (sortedView);
    // Copies attributes from original view
    this.copyViewAttributes (sortedView);

	// Deposit
	this.copyDeposit (sortedView);

	this.copyItemTenderView(sortedView);
    return sortedView.toXMLString();
}

/**
 * @brief Copies CustomInfo from internal view to a provided view.
 *
 * @param [in] view 
 * @since NPS-11233
 */
ConsolidatedView_Ex.prototype.copyCustomInfo = function (view) {

	// CustomInfo
	var qtyCustomInfo=this.view.CustomInfo.Info.length();
	
	for(var i=0; i < qtyCustomInfo; i++) {
		view.CustomInfo.Info[i] = "";
		for (var attr in this.view.CustomInfo.Info[i].@*) {
			view.CustomInfo.Info[i].@[this.view.CustomInfo.Info[i].@*[attr].name()] = this.view.CustomInfo.Info[i].@*[attr];
		}
	}
}

ConsolidatedView_Ex.prototype.resetItemCodeEnumeration = function (view) {
	var i = 0;
	for each (var item in view.ItemView) {
		if(item.quantity > 0) {
			if(Number(item.level) == 0) {
				item.itemCode = i;
				i++;
			} else {
				item.itemCode = i - 1;
			}
		}
	}
}

ConsolidatedView_Ex.prototype.copyDeposit = function (view) {

	// Deposit
	var qtyDepositItem=this.view.Deposit.length();
	var itemDeposit;

	for(var i=0; i < qtyDepositItem; i++) {
		view.Deposit[i] = "";
		for (var attr in this.view.Deposit[i].@*) {
			view.Deposit[i].@[this.view.Deposit[i].@*[attr].name()] = this.view.Deposit[i].@*[attr];
		}

		view.Deposit[i].taxChain="";

		var qtyDepositTaxItem=this.view.Deposit[i].taxChain.tax.length();

		for(var j=0; j < qtyDepositTaxItem; j++) {

			view.Deposit[i].taxChain.tax[j]="";

			for (var attr in this.view.Deposit[i].taxChain.tax[j].@*) {
				view.Deposit[i].taxChain.tax[j].@[this.view.Deposit[i].taxChain.tax[j].@*[attr].name()] = this.view.Deposit[i].taxChain.tax[j].@*[attr];
			}
		}
	}
}

/**
 * \brief Copies attributes from internal view to a provided view.
 * \param [in] view - View to add attributes to
 */
ConsolidatedView_Ex.prototype.copyViewAttributes = function (view) {
    for (var attr in this.view.@*) {
		view.@[this.view.@*[attr].name()] = this.view.@*[attr];
    }
}

ConsolidatedView_Ex.prototype.copyItemTenderView = function (view) {
	var qtyItemTenderView = this.view.ItemTenderView.length();
	for(var i=0;i<qtyItemTenderView;i++){
		view.ItemTenderView[i]="";
		view.ItemTenderView[i].kind = this.view.ItemTenderView[i].kind;
		view.ItemTenderView[i].description = this.view.ItemTenderView[i].description;
		view.ItemTenderView[i].code = this.view.ItemTenderView[i].code;
		view.ItemTenderView[i].qty = this.view.ItemTenderView[i].qty;
		view.ItemTenderView[i].value = this.view.ItemTenderView[i].value;
		view.ItemTenderView[i].fiscalIndex = this.view.ItemTenderView[i].fiscalIndex;
		view.ItemTenderView[i].taxOption = this.view.ItemTenderView[i].taxOption;
		view.ItemTenderView[i].cat = this.view.ItemTenderView[i].cat;
		view.ItemTenderView[i].fValue = this.view.ItemTenderView[i].fValue;
		view.ItemTenderView[i].pValue = this.view.ItemTenderView[i].pValue;
		view.ItemTenderView[i].srcPOSId = this.view.ItemTenderView[i].srcPOSId;
		view.ItemTenderView[i].subtotalOpt = this.view.ItemTenderView[i].subtotalOpt;
		view.ItemTenderView[i].skim = this.view.ItemTenderView[i].skim;
		view.ItemTenderView[i].srcTender = this.view.ItemTenderView[i].srcTender;
		for each (var item in this.view.ItemTenderView[i].SourceTenders.SourceTender) {
			// assuming that the first entry is always the last tender (push_back was used to store tender in the vector)
			view.ItemTenderView[i].SourceTender = ""+item.@sourceCode;
			break;
		}

		view.ItemTenderView[i].rounding = this.view.ItemTenderView[i].rounding;
		view.ItemTenderView[i].tenderRoundAdj = this.view.ItemTenderView[i].tenderRoundAdj;
	}
}

/**
 * \brief Detaches choices from a given view.
 *
 * \return Returns a view with choices put outside value meals.
 */
ConsolidatedView_Ex.prototype.detachChoice = function () {
	// Create array with sale items
	var itemChoice=new Array();
	var qtyPromoLevelZero=0;
	var qtyLevelZero=0;
	var qtyViewItem=this.view.ItemView.length();
	var newViewArray = new Array ();
	var isParentChoice=false;

	for(var i=0; i < qtyViewItem; i++) {
		var item=this.view.ItemView[i];
		lastItemCode=item.itemCode;
		if(Number(item.level) == 0) {
			qtyLevelZero=Number(item.quantity);
			qtyPromoLevelZero=Number(item.quantityPromo);
		}
		// Verify Choice
		if((Number(item.level) > 0) && (Number(item.prodAction) == 3)) {
			if(Number(item.productType) != 4) {
				// This is Choice
				var levelChoice=Number(item.level);
				item.level=0;
				item.levelChoice = levelChoice;
				itemChoice.push({item:XML(item)});
				for(var j=i+1; j < qtyViewItem; j++) {
					var itemChoiceB=this.view.ItemView[j];
					if(itemChoiceB.level > levelChoice) {
						itemChoiceB.isChoiceChild = true;
						itemChoiceB.level-=levelChoice;
						itemChoiceB.quantity*=item.quantity;
					}
					else {
						break;
					}
				}
				// calculate qty after child
				item.quantityPromo=qtyPromoLevelZero*item.quantity;
				item.quantity*=qtyLevelZero;
				isParentChoice=true;
			}
		}
		else if (item.isChoiceChild == true && isParentChoice == true) {
			// This item belongs to the Choice
			delete item.isChoiceChild;
			itemChoice.push({item:XML(item)});
		}
		else {
			// This is not Choice
			newViewArray.push({item:XML(item)});
			isParentChoice=false;
		}
	}
    // Put choice items at array's end
    for(var i=0; i < itemChoice.length; i++) {
		var iInd=newViewArray.length;
		newViewArray.push({item:XML(itemChoice[i].item)});
    }
	return newViewArray;
}

/**
 * \brief Create a consolidated view.
 *
 * \param [in] viewArray - Array representing a view
 */
ConsolidatedView_Ex.prototype.createConsolidation = function (viewArray) {
	//Recreate Original XML
	var auxXML=new XML("<View/>");
	var szViewArray=new Array();
	var szAux="";
	var i=0;

	// Create  line array with the same iItemCode
	//while(i < viewArray.length) {
	while(i < viewArray.length) {
		var ItemView=viewArray[i].item;
		var iItemCode = ItemView.itemCode.toString();
		szAux =szAux + ItemView.productCode + ItemView.grilledQuantity + ItemView.specialModifiers;
		/* NPS-7495 -variable arch card support */ 
		ItemView.specialModifiers + ItemView.unitPrice; 
		var count=1;
		for(var j=i+1; j < viewArray.length; j++) {
			var nextItemView=viewArray[j].item;

			//PosShowMessage("nextItemView: " + nextItemView.itemCode + " " + nextItemView.level);

			if((iItemCode!=nextItemView.itemCode) || (nextItemView.level==0)) {
				break;
			}
			count++;
			szAux=szAux + nextItemView.productCode + nextItemView.grilledQuantity + nextItemView.specialModifiers;
			/* NPS-7495 -variable arch card support */ 
			nextItemView.specialModifiers + nextItemView.unitPrice; 
		}
		for(var k=0;k<count;k++) {
			szViewArray.push({id:String(i), item:String(szAux)});
		}
		szAux="";
		i=j;
	}
	var bItemChecked = new Array(szViewArray.length);

	var iInd = -1;
	var count_iInd = 1;
	for(var i = 0; i < szViewArray.length; i++) {
		var ItemArray = szViewArray[i].item;

		if(bItemChecked[i] == "true"){
			continue;
		}else{
			bItemChecked[i] = "true";
			var ItemXML=XML(viewArray[i].item);
			auxXML.ItemView+=ItemXML;
			iInd += count_iInd;
			count_iInd = 1;
			var a=i+1;
			while((a < viewArray.length) && (ItemXML.itemCode==viewArray[a].item.itemCode) && (Number(viewArray[a].item.level) != 0) && (bItemChecked[a] != "true")){
				var ItemXML2=XML(viewArray[a].item);
				auxXML.ItemView+=ItemXML2;
				bItemChecked[a] = "true";
				count_iInd++;
				a++;
			}
		}

		for(var j = i+1; j < viewArray.length; j++) {	

			if((ItemArray == szViewArray[j].item) && (bItemChecked[j] != "true")) {
				bItemChecked[j] = "true";
				// Item already used in table
				szViewArray[j].item = -j;

				var ItemXML=XML(viewArray[j].item);

				if(ItemXML.level == 0) {
					auxXML.ItemView[iInd].quantity = Number (auxXML.ItemView[iInd].quantity)
					+ Number (ItemXML.quantity);

					auxXML.ItemView[iInd].quantityPromo = Number (auxXML.ItemView[iInd].quantityPromo)
					+ Number (ItemXML.quantityPromo);

					auxXML.ItemView[iInd].quantityItemPromo = Number (auxXML.ItemView[iInd].quantityItemPromo)
					+ Number (ItemXML.quantityItemPromo);

					var sizePromoDest=auxXML.ItemView[iInd].promo.length();
					for(var a=0;a<sizePromoDest;a++) {
						var id = auxXML.ItemView[iInd].promo[a].id;
						var sizePromoOrig = auxXML.ItemView[iInd].promo.length();
						for(var b=0;b<sizePromoOrig;b++){
							if(id = auxXML.ItemView[iInd].promo[b].id) {
								auxXML.ItemView[iInd].promo[a] = Number(auxXML.ItemView[iInd].promo[a]) + Number(auxXML.ItemView[iInd].promo[b]);
							}
						}
					}

					var value1 = new BigDecimal(auxXML.ItemView[iInd].unitPrice);
					var value2 = new BigDecimal(ItemXML.unitPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].unitPrice = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].netUnitPrice);
					var value2 = new BigDecimal(ItemXML.netUnitPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].netUnitPrice = value1.toString();;

					var value1 = new BigDecimal(auxXML.ItemView[iInd].unitTax);
					var value2 = new BigDecimal(ItemXML.unitTax);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].unitTax = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].totalPrice);
					var value2 = new BigDecimal(ItemXML.totalPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].totalPrice = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].netTotalPrice);
					var value2 = new BigDecimal(ItemXML.netTotalPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].netTotalPrice = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].totalTax);
					var value2 = new BigDecimal(ItemXML.totalTax);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].totalTax = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].ADTotalPrice);
					var value2 = new BigDecimal(ItemXML.ADTotalPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].ADTotalPrice = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].ADNetTotalPrice);
					var value2 = new BigDecimal(ItemXML.ADNetTotalPrice);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].ADNetTotalPrice = value1.toString();

					var value1 = new BigDecimal(auxXML.ItemView[iInd].ADTotalTax);
					var value2 = new BigDecimal(ItemXML.ADTotalTax);
					value1 = value1.add(value2);
					auxXML.ItemView[iInd].ADTotalTax = value1.toString();
				}
			}
		}
	}
	return auxXML;
}

/**
 * \brief Sorts a consolidated view
 *
 * \param [in, out] newViewCons - Consolidated view to sort, as a XML object
 */
ConsolidatedView_Ex.prototype.sortView = function (newViewCons) {
    var flagdisplayOrder=false;
    var displayOrderArray = new Array();
    var compfunc = function (a, b) {
	return (Number(a.id) - Number(b.id));
    };
    for each (var item in newViewCons.ItemView) {
	if (Number(item.level) == 0) {
	    displayOrderArray.push({id:Number(item.displayOrder)});
	}
    }
    // Sort displayOrder Array
    displayOrderArray.sort (compfunc)
    //Seach duplicate displayOrder
    for(var i=1; i < displayOrderArray.length; i++) {
	if(displayOrderArray[i-1].id == displayOrderArray[i].id){
	    // There is duplicate displayOrder
	    flagdisplayOrder=true;
	    break;
	}
    }

    // Create array with sale items
    var newViewArray = new Array();
    var key = "000000000";
    var displayOrder = "000000000";
    var productCode = "";
    for each (var item in newViewCons.ItemView) {
	if (Number(item.level) == 0) {
	    key = API.formatNumber(Number(item.displayOrder), "000000000", 9)
	}
	displayOrder = API.formatNumber(Number(item.displayOrder), "000000000", 9)
	if (flagdisplayOrder==true) {
	    productCode = API.formatNumber(Number(item.productCode), "00000", 5)
	}
	// Create key to sort
	var aux = String(key) + Number(item.level) + String(displayOrder)+ String(productCode);
	newViewArray.push({id:String(aux), item:String(item)});
    }
    // Sort array with sale items
    newViewArray.sort (compfunc);

    var sortViewCons = new XML("<View/>");
    for(var i = 0; i < newViewArray.length; i++) {
	var ItemView = new XML(newViewArray[i].item);
	sortViewCons.ItemView+=ItemView;
    }

    newViewCons = sortViewCons;
}


/**
 * @brief This function implements the BC,Business Component: <b>PosDoOperatorLogout_CSL</b>.
 *
 * Persistence:<b>Persisted</b>\n
 * The PosDoOperatorLogout_CSL is responsible for perform the operator logout routine, when it's in remote mode do not prompt for confirmation.
 * In java script it should be called:<b>PosDoOperatorLogout_CSL(remote)</b>
 * @param remote - String - Optional, "true" to indicate a remote logout (default:"false").
 * @success .
 * @failure <i>Transaction in progress</i> - Cannot logout operator when a transaction is in progress.
 * @failure <i>Cannot retrieve POS state</i> - Error getting POS state.
 * @failure <i>Operator not Logged</i> - There is no user logged.
 * @failure <i>onConfirmLogout() failed</i> - hook returned false.
 * @failure <i>Cannot set POS state</i> - Error setting POS state.
 * @failure <i>onLogoutFinalize() failed</i> - hook returned false.
 * @hook <i>onCheckFileForRemoteDelete()</i> - invoked before delete the file from the WayStation.
 * @sessioncontext <i>"workingMode"</i> - Read to get the working mode.
 * @remarks
 *
 * Property Messages:\n
 * 	MSG_BC_OPERLOGOUT: Message confirming log-off.\n
 *	MSG_BC_INVLOGOUT: Error message invalid log-out.\n
 */
function PosDoOperatorLogout(remote) {
	var cmd = "PosDoOperatorLogout_CSL";
	CSL_dbglog(7, SRC_BC_REGISTER, cmd, "Start");

	if(remote == undefined) {
		// Default value
		remote = "false";
	}

	var ret = false;
	var xmlPOS = new XML(rootHlp.getPOSState());
	var state  =  Number(xmlPOS.@state);

	switch(state) {
	case POS_STA_OPLOGGED:
	case POS_STA_BLOCKOP:
		var name   = xmlPOS.Operator.@name;
		// Confirms logout
		var sConfMsg=rootHlp.getSysMessage("MSG_BC_LOGOUTCONF",name);
		// In remote mode is not necessary to prompt for confirmation.
		if(remote == "true" || PosShowConfirmationMessage(sConfMsg,"MSG_YES","MSG_NO")) {
			// workingMode
			var podMode = rootCtx.get("workingMode");
			if (podMode != "orderTaker") {
			   ret = true;
			}
			// POD
			cmd = "PosDoOperatorLogout";

			if (executeBC(cmd, [remote])) {
				if(remote && PosCheckSessionProperty("POD","CSO")) {
					PosActivateScreenSaver(1);
				}
				if (ret && remote == "false") {
					PosOpenCashDrawer(false);
 			    }
				ret = true;
			} else {
				ret = false;
			}
		}
		break;
	default:
		PosShowMessage("MSG_BC_INVLOGOUT");
		break;
	}
	//if(("HOT" == pod) || (bRemote && (("CSO" == pod) || ("CK" == pod) || ("CKD" == pod))) || ((("DT" == pod) || ("WT" == pod)) && (rootCtx.get("workingMode") == "orderTaker"))) {
	//	return(false);
	//}
	if (ret == true)
	{
		 /*NVS-4287 - msilva*/
	     	 var result;
		 if (PosCheckParameter("TCLExtension","esocket","true")) {
			  // Terminal close, server Close
			  result=npTCLEvalEx("Everest_Operation 2 0 0");
		 }

		var message = rootHlp.findParamInSectionConfig("laneClosedMessage","Cashless3");
		if (message == null) {
			message = "This register is closed";
		}
		if(PosCheckParameter("Cashless3", "Active", "true")) {
			QuerySAF();
			if (CheckForUpdates() == true) {
		        if(PosShowConfirmationMessage("MSG_CASHLESS_APPLY_UPDATE_QUEST","MSG_YES","MSG_NO")) {
					ApplyPEDUpdate();
				}
			}

		ChangeIdleMessage(message);
	}
	}

	return(ret);
}


//NVS-362  11-1-10
function IsFaceToFace()
{
	var ReturnValue = false;

	var posDB;
	// parsing XML
	try {
		posDB	= new XML(API.getPosdb());
	} catch (e) {
		// parser error
		return(false);
	}

	var DTType  = posDB.Configuration.Section.(@name == "OperationMode").Parameter.(@name == "DTStoreMode").@value;
	if (DTType != null && DTType == "TANDEM") {
		ReturnValue = true;
	}

	return ReturnValue;
}

function TestPosChangeChoice() {
	var source = PosShowCalculator("Enter the product code of the source choice","",1,0);
	var dest = PosShowCalculator("Enter the product code of the destination choice","",1,0);
	var quantity = PosShowCalculator("Enter the quantity to change","",1,0);
	
	PosChangeChoice(quantity, source, dest);
}


/**PosSizeSelectionJS
 *
 * @brief - This BC calls PosSizeSelection to set or clear the dimension
 * @param size - String - dimension selected
 * @param persist - String - indicate if the dimension need to be persisted or not
 */
function PosSizeSelectionJS(size, persist) {
	if(!persist) {
		return PosSizeSelection(size, persist);
	}
	
	var current_size = rootHlp.getSizeSel();
	if(current_size == size) {
		return PosSizeSelection(-1, persist);
	}
	else {
		return PosSizeSelection(size, persist);
	}
}

/**PosToggleDualBumpJS
 * 
 * @brief This function calls the BC PosToggleDualBump to update the toggle button
 * @param button - button number
 */
function PosToggleDualBumpJS(button) {
	var enabled = rootCtx.get("dualBumpMode");
	var newState = (enabled == "true") ? false : true;
	
	var success = PosSetDualBump(newState);
	if (success) {
		var ret = getLastSuccess("PosToggleDualBump");
		if(ret == "disabled") {
			PosShowMessage("MSG_DUAL_BUMP_ERROR_KITCHEN");
		} else {
			var enabled = ret == "true";
			toggleDualBumpButton(button, enabled);
		}
		return true;
	}
	PosShowMessage("MSG_BC_TXRXPRD");
	return false;	
}


/**PosCheckDualBumpJS
 * 
 * @brief This function calls the BC PosCheckDualBump to update the text of the toggle button
 * @param button - button number
 */
function PosCheckDualBumpJS(button) {
	var enabled = PosCheckDualBump("true");
	toggleDualBumpButton(button, enabled);
	return true;	
}

/**
 * @brief This function changes the button text
 * @param button - button number
 * @param enabled - whether the dual bump mode is enabled
 */
function toggleDualBumpButton(button, enabled) {
	if (enabled) {
		PosChangeButtonProperties(button, "title|DUAL BUMP ON");
	} else {
		PosChangeButtonProperties(button, "title|DUAL BUMP OFF");
	}
}

/** PosCheckDualBumpInitJS
 *
 * @brief - This function calls the BC PosCheckDualBumpInit to check if a KVS is working as a initiator
 * @param kvs - kvs service id
 */
function PosCheckDualBumpInitJS(kvs) {
	var success = PosCheckDualBumpInit(kvs);
	if (success) {
		var resp = getLastSuccess("PosCheckDualBumpInit");
		if(resp == "true") {
			PosShowMessage("MSG_BC_DUALBUMP_IS_INIT");
		} else {
			PosShowMessage("MSG_BC_DUALBUMP_IS_ASSEMBLER");
		}

		PosSetSessionProperty("initiator", resp);
		return true;
	}
	
	var ret = getLastFail("PosCheckDualBumpInit");
	if(ret == "1000") {
		PosShowMessage("MSG_BC_DUALBUMP_NOT_ACCEPT");
	} else if(ret == "1001") {
		PosShowMessage("MSG_DUAL_BUMP_ERROR_KITCHEN");
	} else if(ret == "1003") {
		PosShowMessage("Undefined Error");	
	} else {
		PosShowMessage("MSG_BC_TXRXPRD");
	}

	return false;	
}


/** PosSetDualBumpInitJS
 *
 * @brief - This function implements the BC,Business Component: <b>cPosSetDualBumpInit</b>\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC Defines a KVS as the dual bump Initiator
 * In a workflow sequence it is called:<b>PosSetDualBumpInitJS</b>\n
 * In java script it should be called:<b>PosSetDualBumpInit(KvsId, enable)</b>
 * @param kvs - KVS service id
 * @param enable - "true" to set as a initiator, "false" to set as a assembler
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
function PosSetDualBumpInitJS(kvs, enable) {
	var initiator = "false";

	var ret = PosCheckDualBumpInit(kvs);
	if(ret) {
		initiator = getLastSuccess("PosCheckDualBumpInit");
	} else {
		var ret = getLastFail("PosCheckDualBumpInit");
		if(ret == "1000") {
			PosShowMessage("MSG_BC_DUALBUMP_NOT_ACCEPT");
		} else if(ret == "1001") {
			PosShowMessage("MSG_DUAL_BUMP_ERROR_KITCHEN");
		} else if(ret == "1003") {
			PosShowMessage("Undefined Error");	
		} else {
			PosShowMessage("MSG_BC_TXRXPRD");
		}
		return(true);
	}

	if(enable == "true" && initiator == "true") {
		PosShowMessage("MSG_BC_DUALBUMP_ALREADY_INIT");
		return(true);
	} else if(enable == "false" && initiator == "false") {
		PosShowMessage("MSG_BC_DUALBUMP_ALREADY_ASSEMBLER");	
		return(true);
	}

	var success = PosSetDualBumpInit(kvs, enable);
	if (success) {
		var isInitiator = enable == "true";
		var initiator = rootHlp.getSysMessage("MSG_BC_DUALBUMP_INITIATOR");
		var assembler = rootHlp.getSysMessage("MSG_BC_DUALBUMP_ASSEMBLER");
		if (getLastSuccess("PosSetDualBumpInit") == "true") {
			PosShowMessage("MSG_BC_DUALBUMP_MONITORS_CHANGED", kvs, (isInitiator ? initiator : assembler), (isInitiator ? assembler : initiator));
		} else {
			PosShowMessage("MSG_BC_DUALBUMP_MONITOR_CHANGED", kvs, (isInitiator ? initiator : assembler));			
		}
		return true;
	}

	var ret = getLastFail("PosSetDualBumpInit");
	if(ret == "1000") {
		PosShowMessage("MSG_BC_DUALBUMP_NOT_ACCEPT");
	} else if(ret == "1001") {
		PosShowMessage("MSG_DUAL_BUMP_ERROR_KITCHEN");
	} else if(ret == "1003") {
		PosShowMessage("Undefined Error");	
	} else {
		PosShowMessage("MSG_BC_TXRXPRD");
	}

	return true;
}

function PosRefundByOrder_JS() {
	if (PosSelectOrder("MSG_OK" , "MSG_CANCEL")) {
		var orderId = getLastSuccess("PosSelectOrder");
		PosShowMessage("orderId: [" + orderId + "]");


		// to be implemented by the COE
/*
		if (PosRefundByOrderKey_JS(orderId)) { //Call a local function that will refund a given order id. This must be implemented by regions.
			PosShowMessage("MSG_REFUND_SUCCESS");
		} else {
			PosShowMessage("MSG_REFUND_FAILED");
		}
*/


	}
	else {
		var errMsg=getLastFail("PosSelectOrder");
		API.SLog("LOGLEVL_DEBUG", "[PosRefundByOrder_JS] ["+errMsg+"]");
		if((null!=errMsg)&&(""!=errMsg)&&("MSG_BC_ERROR_REFUND_BY_ORDER_CANCEL"!=errMsg)) {
			PosShowMessage(errMsg);
		}
	}
	return true;
}

function PosRefundByCash_JS() {
	var retVal=PosRefundByCash()
	if(false==retVal) {
		var errMsg=getLastFail("PosRefundByCash");
		API.SLog("LOGLEVL_DEBUG", "[PosRefundByCash_JS] ["+errMsg+"]");
		if((null!=errMsg)&&(""!=errMsg)&&("MSG_BC_ERROR_REFUND_BY_AMOUNT_INVALID_AMOUNT"!=errMsg)) {
			PosShowMessage(errMsg);
		}
	}
	return(retVal);
}

/** PosCheckGrillSlipJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosCheckGrillSlipJS</b>\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC Checks if there was a grill slip error in the current order, if it has, it displays the
 * MSG_GRILLPRINTERERROR local message on the device defined by store.wide->RemoteMessageDevice->GrillPrinterError.
 * If the parameter is not present, the message will be sent to the device where the order started
 * In a workflow sequence it is called:<b>PosCheckGrillSlipJS</b>\n
 * In java script it should be called:<b>PosCheckGrillSlipJS()</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
 function PosCheckGrillSlipJS() {
	 
	var view = rootHlp.getCurrentView();
	if (view == null) { 
		return true;
	}
	view = new XML(view);
	var orderKey = view.@orderKey.toString();
	var failed = PosHasGrillSlipFailed(orderKey);
	if (!failed) {
		return true;
	}
	
	var result = getLastSuccess("PosHasGrillSlipFailed");
	result = result.split("|");
	var source = result[0];
	var errorCode = result[1];
	var target = rootHlp.findParamInSectionConfig("GrillPrinterError","RemoteMessageDevice");
	if (target == null || target == "") {
		target = source;
	}
	var message = API.getLocalMsg("MSG_GRILLPRINTERERROR", [orderKey, source, errorCode]); 
	var sent = PosShowRemoteMessage(target, message);
	if (!sent) { 
		API.SLog("LOGLEVL_ERROR", "Remote message could not be set to " + target);
	}
	return true;
}

/**
 * @brief This function implements the BC,Business Component: <b>PosRePrintReport</b>.
 *
 * Persistence:<b>Not Persisted</b>\n
 * The PosSearchAndReprintReceipt is responsible for reprinting a report.
 * In java script it should be called:<b>PosSearchAndReprintReceipt</b>
 * @remarks
 *
 * Property Messages:\n
 */
function PosSearchAndReprintReceiptJS() {

	var ret = false;
	var step = 1;

	var dlg_date;
	var dlg_pos;
	var dlg_pod;
	var dlg_valueMin = 0;
	var dlg_valueMax = 0;

	while(true) {
		// Step 1 - Date
		if(step == 1) {
			// SDO-5142: using daysToKeepReceipts parameter
			var days = rootHlp.findParamInSectionConfig("daysToKeepReceipts", "OperationMode");
			days = parseInt(days, 10);
			if (isNaN(days) || (days < 0)) {
				days = 1;
			}
			else {
				days++;
			}
			POSGetDate(days, "Select the Date to search receipts:");

			var ctx=new SessionContext;
			dlg_date=ctx.get("Date");
			if(dlg_date == "-1") {
				return(true);
			}
			else if(dlg_date == "0") {
				step = step - 1;
				continue;
			}
			step = step + 1;
		}

		// Step 2 - POS
		if(step == 2) {
			POSGetPOS("2", "Select Registers to include in the search criteria:");

			dlg_pos=ctx.get("dlgPOS");
			if(dlg_pos == "-1") {
				return(true);
			}
			else if(dlg_pos == "0") {
				step = step - 1;
				continue;
			}
			step = step + 1;
		}

		// Step 3 - POD
		if(step == 3) {
			POSGetPOD("2", "Select the POD to search receipts:");

			dlg_pod=ctx.get("dlgPOD");
			if(dlg_pod == "-1") {
				return(true);
			}
			else if(dlg_pod == "0") {
				step = step - 1;
				continue;
			}
			step = step + 1;
		}

		// Step 4 - Amount
		if(step == 4) {
			POSGetValueRange("Include the lower amount limit for the receipt search", "Include the higher amount limit for the receipt search");

			dlg_valueMin=ctx.get("ValueMin");
			dlg_valueMax=ctx.get("ValueMax");

			if(dlg_valueMin == "0" && dlg_valueMax == "0" && ret != 0) { // BACK
				step = step - 1;
				continue;
			}

			if(dlg_valueMin == "0" && dlg_valueMax == "0") { // Invalid Range: Max Value is
				PosShowMessage("Invalid Range: The Max value is less than the Min value.");
				step = step - 1;
				continue;
			}

			step = step + 1;
		}

		// Step 5 - Search and Reprint Receipt
		if(step == 5) {
			PosSearchAndReprintReceipt(dlg_date, dlg_pos, dlg_pod, dlg_valueMin, dlg_valueMax, "***** DUPLICATE *****");
		}
		break;
	}
	return(ret);
}


/* clear fees from sale */ 
function PosClearFee_COE() { 
	PosClearFees_CSL(1);
	PosClearFees_CSL(2);
} 


/* apply fee to a sale */
function PosApplyFee_COE(saleType) {
	var arrSaleType = new Array("EATIN","TAKEOUT");
	
	/* first clear any fees that were aplied before */ 
	//PosClearFee_COE();

	/* call every fee that's configured */
	for (var i=1;i<=2;i++) {
		if (FeeTypeList != null) {
			fee =FeeTypeList.(@feeCode == i && @status=="ACTIVE").Pricing.(@priceCode == arrSaleType[saleType]).Value;
			
			/* apply when amount > 0 */
			if (fee > 0) { PosApplyFee_CSL(i); }
		}
	}
}

function PosSetForeignCurrencyJS() {

	var FOREIGN_CUR;
	
	try {
		FOREIGN_CUR = rootCtx.get("ForeignCurrencyID");
	} catch (e) {
		FOREIGN_CUR = 12;
	}
	PosSetForeignCurrency(FOREIGN_CUR);
	
	return true;
}

// NVS-364
/** CreateEndDayReportSWJS
*
* @brief - This function implements the BC,Business Component: <b>CreateEndDayReportSWJS</b>\n
* Persistence:<b>Not Persisted</b>\n
* This BC asks user for a business day and generates a End Day Report Store Wide report if entered date is not in
future.
* In a workflow sequence it is called:<b>CreateEndDayReportSWJS</b>\n
* In java script it should be called:<b>CreateEndDayReportSWJS(dataTypes, reportScript, flags, customParam, pod,
serviceList)</b>
* Property Messages:none\n
* Hooks: none\n
* @return - rval - false if it was not possible to generate report.
*/
function CreateEndDayReportSWJS(dataTypes, reportScript, flags, customParam, pod, serviceList) {
	var posList, posListXML;
	var date, reportDate, posDate;
	var futureDate = true;
	var i;
	// getting report date (entered date should be checked...)
	date = rootHlp.showCalculator("Please enter business date", 2);
	// date must be in YYYYMMDD format
	reportDate = date.substr(4, 4) + date.substr(0, 2) + date.substr(2, 2);
	posList = rootHlp.getSWPosList();
	if (posList != null) {
		posListXML = new XML(posList);
		if (null == posListXML) {
			return false;
		}
	} else {
		PosShowMessage("Way Station is out");
		return false;
	}
	
	// checking if entered date is a future date
	for (i = 0; i < posListXML.PosList.Pos.length(); i++) {
		posDate = posListXML.PosList.Pos[i].@businessDate;
		if (posDate >= reportDate) {
			futureDate = false;
			break;
		}
	}
	
	if (futureDate) {
		PosShowMessage("There is no data for business date entered");
		return false;
	}
	if (flags != null) {
		if (flags.length > 0) {
			flags = flags + "|DATE_SUPPLIED";
		} else {
			flags = "DATE_SUPPLIED";
		}
	} else {
	flags = "DATE_SUPPLIED";
	}

	// generating report
	PosCreateReport(dataTypes, reportScript, flags, customParam, pod, serviceList, null, reportDate);
	return true;
}


// NVS-697
/* function PosIsCurrentSelectedValueMealJS
* @brief - This function implements the BC,Business Component: <b>PosIsCurrentSelectedValueMealJS</b>\n
* Persistence:<b>Not Persisted</b>\n
* This BC check the current selected item from the sale pane and determines if it is a value meal.
* In a workflow sequence it is called:<b>PosIsCurrentSelectedValueMealJS</b>\n
* In java script it should be called:<b>PosIsCurrentSelectedValueMealJS()</b>
* Property Messages:none\n
* Hooks: none\n
* @return - rval - false if current item selected item in sale pane is a value meal
*/
function PosIsCurrentSelectedValueMealJS() {
	
	var ReturnValue = false;
	var CurrentView = rootHlp.getCurrentView();
	
	if (CurrentView != null) {
		var View = new XML(CurrentView);
		if (View != null) {
			var items = View.ItemView;
			var ItemCount = items.length();
			for (var Loop = 0; Loop < ItemCount; Loop++) {
				if (items[Loop].currentSelected == "true") {
					if (items[Loop].productType == PC_VALUE_MEAL) {
						ReturnValue = true;
						break;
					}
				}
			}
		}
	}
	
	return ReturnValue;
}

// NVS-988
/* function PosIsVACCurrentlySelectedJS()
* @brief - This function implements the BC,Business Component: <b>PosIsVACCurrentlySelectedJS</b>\n
* Persistence:<b>Not Persisted</b>\n
* This BC check the current selected item from the sale pane and determines if VAC is selected.
* If VAC is selected and unit price is 0, Floating VAC screen will display.
* In a workflow sequence it is called:<b>PosIsVACCurrentlySelectedJS</b>\n
* In java script it should be called:<b>PosIsVACCurrentlySelectedJS()</b>
* Property Messages:none\n
* Hooks: none\n
* @return - rval - false if current item selected item in sale pane is not VAC (Reload or Activation)
* also returns false if VAC is selected but has a unit price
*/

function PosIsVACCurrentlySelectedJS() {
	var ReturnValue = false;
 	var CurrentView = rootHlp.getCurrentView();
	var CustomParam = "allowVariablePrice";
	
	//Obtain VAC screen number from store-db
	VACFloatingScreenNum = rootCtx.get("VACSceenNum");
	if ( VACFloatingScreenNum <= 0) { 
		VACFloatingScreenNum = 701; //Set default VAC floating screen number
	} 

	if (CurrentView != null) {
		var View = new XML(CurrentView);
		if (View != null) {			
			var items = View.ItemView;			
			var ItemCount = items.length();
			for (var Loop = ItemCount; Loop--;) {
				if (items[Loop].currentSelected == "true") {					
					prodCode=items[Loop].productCode;
					CheckIfProductIsVAC=checkCustomParameter(prodCode,CustomParam);
					if (CheckIfProductIsVAC && Number(items[Loop].unitPrice) == 0) {
						PosShowFloatScreen(VACFloatingScreenNum);
						ReturnValue = true;
						break;
					}
				}
			}
		}
	}
	
	return ReturnValue;
}


// NVS-702
/* function PosCheckCurrentPODType
 * @brief - this function implements a methd to compare the current POD type again a known value.
 */ 
function PosCheckCurrentPODTypeJS(TestType)
{
	var PodType = rootCtx.get("POD");
	var ReturnValue = false;
	
	if (PodType == TestType) {
		ReturnValue = true;
	}
	
	return ReturnValue;
 
}


/** PosVerifyAutoLogonJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosVerifyAutoLogonJS</b>\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC returns automatic login operation mode.
 * In a workflow sequence it is called:<b>PosVerifyAutoLogonJS</b>\n
 * In java script it should be called:<b>PosVerifyAutoLogonJS()</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - false if automatic login is enabled or true if not.
 * Available from 1.20
 */
function PosVerifyAutoLogonJS() {
	var bAutoLogin=rootHlp.findParamInSectionConfig("AutomaticOperatorLogin","OperationMode");
	if("true"==bAutoLogin) {
		return false;
	}
	return true;
}
/** PosSetFloatPriceJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosSetFloatPriceJS</b>\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC Set the Float Price in the product
 * In a workflow sequence it is called:<b>PosSetFloatPriceJS</b>\n
 * In java script it should be called:<b>PosSetFloatPriceJS(value)</b>
 * @param value string - amount
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
function PosSetFloatPriceJS(value) {
	/* check if value is between min and max default=5 to 50 */
	var vp = Number(rootCtx.get("VariablePrice"));	
	
	if (vp >=glo_VACMinAmt && vp<=glo_VACMaxAmt) {
		PosSetFloatPrice(value);
	} else {
		/* min and max exceed messages are the same */
		PosShowMessage("MSG_VARIABLE_AMOUNT_MINIMUM_AMOUNT_EXCEEDED",glo_VACMinAmt,glo_VACMaxAmt);
		/* NVS-961 -clear entry after error */ 
		PosSetVariableAmount(0,0);		
	} 

	if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
		if(! PosDoCheckOpenChoices()) {
			PosExecuteSavedWorkflow();
			PosEndSmartReminder();
		}
	}
}


/**
 * @brief This function implements the BC,Business Component: <b>PosSetVariableAmountJS</b>.
 *
 * This BC is responsible to manage the "VariablePrice" section context variable.
 *
 * @success The "VariablePrice" section context variable will store the new value
 * @failure
 * @param type string - indicate the operation type (0- Clear, 1- Integer Digits, 2- Digits, 3- Absolute Values, 4- Add)
 * @param value string - amount
 * @hook
 * @remarks
 * @since 1.20
 */
function PosSetVariableAmountJS(type, value) {

	/* check the bounds */ 
	if ((type==3) && (value >=glo_VACMinAmt && value<=glo_VACMaxAmt)) {
		PosSetVariableAmount(type, value);
	} else if (type!=3) { 
		PosSetVariableAmount(type, value);
	} else { 
		/* min and max exceed messages are the same */
		PosShowMessage("MSG_VARIABLE_AMOUNT_MINIMUM_AMOUNT_EXCEEDED",glo_VACMinAmt,glo_VACMaxAmt);	
		/* NVS-961 -clear entry after error */ 
		PosSetVariableAmount(0,0);		
	} 

	if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
		//@since : NPS-6076 - Auto Total
		if(! PosDoCheckOpenChoices()) {
			PosExecuteSavedWorkflow();
			PosEndSmartReminder();
		}
	}
}


/** * @brief This function implements the BC,Business Component: <b>PosSetVariableAmountJS</b>.
 *
 * This BC is responsible to manage the "VariablePrice" section context variable.
 *
 * @success The "VariablePrice" section context variable will store the new value
 * @failure
 * @param type string - indicate the operation type (0- Clear, 1- Integer Digits, 2- Digits, 3- Absolute Values, 4- Add)
 * @param value string - amount
 * @hook
 * @remarks
 * @since 1.20
 */
/* wrapper for variable Amounts */
function PosSetVariableAmountJSEx(type, value) {
	var vp = Number(rootCtx.get("VariablePrice"));
	
	/* check value to make sure is not greater than three digits */ 
	if (((type==1) && (vp <= 99)) || (type!=1)) {
		PosSetVariableAmount(type, value);
	}
} 


/* check if order has any open choices from the disable list */
function PosDoCheckOpenChoicesCSL() { 

	var currentView 	= rootHlp.getCurrentView();
	var view 			= new XML(currentView);

	/* iterate through items and check for any VAC or dummy products  (must solve these, can't bypass) */
	if (currentView != null) {
		var View = new XML(currentView);
		if (View != null) {			
			var items = View.ItemView;			
			var count = items.length();
			for (var i=0; i<count; i++) {

				/* no voided items */ 
				if (Number(items[i].quantity) == 0) { continue; } 
			
				/* check for dummy products */ 
				pCode = String(items[i].productCode);
				prodString =rootHlp.getProductDescr(pCode);
				if(prodString != null) {
					var prodXML = new XML(prodString);
					isDummyProduct =prodXML.Parameter.(@name = "isDummyProduct").@value;
					if (Number(isDummyProduct) == 1) { 
						return true;					
					}
				}
				
				/* check for VAC products */ 
				if ( (checkCustomParameter(pCode,"allowVariablePrice")) && (Number(items[i].unitPrice) == 0) ) { 
					return true;
				} 
			} 
		}
	}

	return false;
} 


/**
 * @brief This function implements the BC,Business Component: <b>PosDoHandleOpenChoices</b>.
 *
 * Persistence:<b>Not Persisted</b>\n
 * The PosDoHandleOpenChoices is to handle open choices when trying to totalize the sale
 * In java script it should be called:<b>PosDoHandleOpenChoices()</b>
 * @param choiceArray - array with the choices and screen
 * @param showByPassMessage - to show the by pass dialog
 * @param messageMissingChoice - message to be present in the missing choices dialog
 * @success There are no open choices in the sale or by pass the open choices
 * @failure There is open choices in the sale
 * @remarks
 *
 * Property Messages:\n
 *  MSG_BC_BYPASS: Message of the dialog to by pass
 * 	MSG_BYPASS: Message of the bypass button.\n
 *	MSG_OK: Message of the button OK.\n
 * @since 1.19
 */
function PosDoHandleOpenChoicesCSL(choiceArray, showByPassMessage, messageMissingChoice) {
	var disableList	= rootCtx.get("ChoiceDisableList");

	if(PosDoCheckOpenChoicesCSL()) {	
		if (PosSetOnTotalSmartReminder()) { 
			return false;
		} 
	} else if (PosDoCheckOpenChoices()) {
		if((showByPassMessage) && (PosCheckSessionProperty("enableByPassOpenChoice","true")) ) {
			if(PosShowConfirmationMessage("MSG_BC_BYPASS","MSG_BYPASS","MSG_OK")) {				
				var cmd = "PosSetByPassChoices";
				executeBC(cmd, [true]);
				return (true);
			}
		}

		var cmd = "PosSetByPassChoices";
		executeBC(cmd, [false]);

		return (true);
	}

	return (true);
}




/** PosShutdownKVSJS
 *
 * @brief - This function implements the BC,Business Component: <b>PosShutdownKVSJS</b>\n
 *
 * Persistence:<b>Not Persisted</b>\n
 *
 * This BC calls the BC PosShutdownKVS to select a KVS and send a sutdown command to it, 
 * and shows a success or failure message to the user.
 *
 * In a workflow sequence it is called:<b>PosShutdownKVSJS $endCode</b>\n
 * In java script it should be called:<b>PosShutdownKVSJS(endCode)</b>
 *
 * @param - endCode - shutdown command code:
 *			SHTDN_RESTART=91,			Restart
 *			SHTDN_CLOSE=92,				Close and goes to OS
 *			SHTDN_REBOOT=93,			Reboot machine
 *			SHTDN_SHUTOFF=94,			Shut off machine (default)
 * @success <i>MSG_BC_SUCCESS_SHUTDOWN_KVS</i> - The selected KVS received the shutdown command.
 * @failure	<i>MSG_BC_FAIL_ONLINE_KVS_LIST_ERROR</i>  - Error obtaining list of online KVSs.
 * @failure	<i>MSG_BC_FAIL_NO_ONLINE_KVS</i>  - No online KVS found.
 * @failure	<i>MSG_BC_FAIL_USER_CANCEL</i> - The user canceled the operation.
 * @failure	<i>MSG_BC_FAIL_KVS_STO_LIST_ERROR</i> - Error obtaining the list of STOs associated to the selected KVS.
 * @failure	<i>MSG_BC_FAIL_KVS_STO_SHUTDOWN_ERROR</i> - A STO failed to receive the shutdown command.
 * @return  True for successful execution or False for failed execution.
 */
function PosShutdownKVSJS(endCode) {
	var command = "shutdown"
	if(endCode == "91") {
		command = "restart";
	} else if(endCode == "92") {
		command = "close";
	} else if(endCode == "93") {
		command = "reboot";
	}
	var ret = PosShutdownKVS(endCode);
	if(ret) {
		var kvs = getLastSuccess("PosShutdownKVS");
		PosShowMessage("MSG_BC_SUCCESS_SHUTDOWN_KVS",command,kvs);
	} else {
		var msg = getLastFail("PosShutdownKVS");
		if(msg=="MSG_BC_FAIL_KVS_STO_SHUTDOWN_ERROR") {
			PosShowMessage(msg,command);
		} else {
			PosShowMessage(msg);
		}
	}
	return ret;
}

/** PosShutdownProductionJS
 *
 * @brief - This function calls the BC PosShutdownProduction to select a production node and send a sutdown command to it, 
 *          and shows a success or failure message to the user.
 * @param - endCode - shutdown command code:
 *			SHTDN_RESTART=91,			Restart
 *			SHTDN_CLOSE=92,				Close and goes to OS
 *			SHTDN_REBOOT=93,			Reboot machine
 *			SHTDN_SHUTOFF=94,			Shut off machine (default)
 * @success <i>MSG_BC_SUCCESS_SHUTDOWN_PST</i> - The selected production node received the shutdown command.
 * @failure	<i>MSG_BC_FAIL_ONLINE_PST_LIST_ERROR</i>  - Error obtaining list of on-line production nodes.
 * @failure	<i>MSG_BC_FAIL_NO_ONLINE_PST</i>  - No on-line production node  found.
 * @failure	<i>MSG_BC_FAIL_USER_CANCEL</i> - The user canceled the operation.
 * @failure	<i>MSG_BC_FAIL_PST_STO_LIST_ERROR</i> - Error obtaining the list of STOs associated to the selected production node.
 * @failure	<i>MSG_BC_FAIL_PST_STO_SHUTDOWN_ERROR</i> - A STO failed to receive the shutdown command.
 * @return  True for successful execution or False for failed execution.
 */
function PosShutdownProductionJS(endCode) {
	var command = "shutdown"
	if(endCode == "91") {
		command = "restart";
	} else if(endCode == "92") {
		command = "close";
	} else if(endCode == "93") {
		command = "reboot";
	}
	var ret = PosShutdownProduction(endCode);
	if(ret) {
		var pst = getLastSuccess("PosShutdownProduction");
		PosShowMessage("MSG_BC_SUCCESS_SHUTDOWN_PST",command,pst);
	} else {
		var msg = getLastFail("PosShutdownProduction");
		if(msg=="MSG_BC_FAIL_PST_STO_SHUTDOWN_ERROR") {
			PosShowMessage(msg,command);
		} else {
			PosShowMessage(msg);
		}
	}
	return ret;
}

/** PosGenerateUniqueCode_JS
 *
 * @brief - This function calls the BC PosGenerateUniqueCode generate a unique code associated to the current sale
 * @param - endCode - shutdown command code:
 *			SHTDN_RESTART=91,			Restart
 *			SHTDN_CLOSE=92,				Close and goes to OS
 *			SHTDN_REBOOT=93,			Reboot machine
 *			SHTDN_SHUTOFF=94,			Shut off machine (default)
 * @success <i>MSG_BC_SUCCESS_SHUTDOWN_PST</i> - The selected production node received the shutdown command.
 * @failure	<i>MSG_BC_FAIL_ONLINE_PST_LIST_ERROR</i>  - Error obtaining list of on-line production nodes.
 * @failure	<i>MSG_BC_FAIL_NO_ONLINE_PST</i>  - No on-line production node  found.
 * @failure	<i>MSG_BC_FAIL_USER_CANCEL</i> - The user canceled the operation.
 * @failure	<i>MSG_BC_FAIL_PST_STO_LIST_ERROR</i> - Error obtaining the list of STOs associated to the selected production node.
 * @failure	<i>MSG_BC_FAIL_PST_STO_SHUTDOWN_ERROR</i> - A STO failed to receive the shutdown command.
 * @return  True for successful execution or False for failed execution.
 * @since 1.20
 */
function PosGenerateUniqueCode_JS() {
	
	var currentView = rootHlp.getCurrentView();
	if(currentView == null) {
		// Could not find a view
		return false;
	}
		
	// Do not generate if it is a promo order
	var view = new XML(currentView);
	var subTotalAmt	= Number(view.@totalAmount);
	if(subTotalAmt == 0) {
		return false;
	}
	
	if((view.ItemTenderView.(code == DISCOUNT_KIND_MANAGER_MEAL)).length() != 0) {
		return false;
	}
	
	if((view.ItemTenderView.(code == DISCOUNT_KIND_EMPLOYEE_MEAL)).length() != 0) {	
		return false;
	}
	
	if((view.ItemTenderView.(code == DISCOUNT_KIND_POLICE)).length() != 0) {
		return false;
	}
	
	if((view.@saleStatus == SALE_STATUS_LAST_SALE_VOIDED) || (view.@saleStatus == SALE_STATUS_CURRENT_SALE_VOIDED)) {
		return false;
	}
	
	if(view.@transactionKind == TRANS_KIND_REFUND) {
		return false;
	}
	
	if(view.@transactionKind == TRANS_KIND_WASTE) {
		return false;
	}
		
	if(((view.ItemTenderView.(cat == "TENDER_GIFT_COUPON")).length() != 0) || ((view.ItemTenderView.(code == TENDER_CODE_AMEX)).length() != 0) || ((view.ItemTenderView.(code == TENDER_CODE_VISA)).length() != 0) || ((view.ItemTenderView.(code == TENDER_CODE_MASTER)).length() != 0)){	
		return false;
	}
	
	if(!PosGetUniqueCodeQuantity()) {
		return false;
	}
	
	var qtty = getLastSuccess("PosGetUniqueCodeQuantity");
	return(PosGenerateUniqueCode(qtty));
}

/** GrabSupportInfoJS
 *
 * @brief - This is an example of how to customize GrabSupportInfo BC to print a receipt.\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC invokes the GrabSupportInfo core BC passing the current business date, then either 
 * prints a ticket with the returned information or displayes an error message.
 * In a workflow sequence it is called:<b>GrabSupportInfo</b>\n
 * In java script it should be called:<b>GrabSupportInfo(businessDate)</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
function GrabSupportInfoJS() {
	var status = GrabSupportInfo();
	if (status) {
		return PosCreateReport("CUSTOMDATA","reportNPAudit@reports.nps","",getLastSuccess("GrabSupportInfo"));
	} else {
		return PosShowMessage(getLastFail("GrabSupportInfo"));
	}
}

/** GrabSupportInfoByDateJS
 *
 * @brief - This is an example of how to customize GrabSupportInfo BC to print a receipt.\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC invokes the GrabSupportInfo core BC passing the current business date, then either 
 * prints a ticket with the returned information or displayes an error message.
 * In a workflow sequence it is called:<b>GrabSupportInfo</b>\n
 * In java script it should be called:<b>GrabSupportInfo()</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
function GrabSupportInfoByDateJS() {
	var businessDateMDY = PosShowCalculator("Enter business date", "MMddyyyy", 2, 2, null, "");
	// reorder MMddyyyy to yyyyMMdd
	var businessDate = businessDateMDY.substr(4, 4) + businessDateMDY.substr(0, 4);
	var status = GrabSupportInfo(businessDate);
	if (status) {
		return PosCreateReport("CUSTOMDATA","reportNPAudit@reports.nps","",getLastSuccess("GrabSupportInfo"));
	} else {
		return PosShowMessage(getLastFail("GrabSupportInfo"));
	}
}

/** PosNPAuditFilter
 *
 * @brief - This is an example of how to invoke NPAuditFilter.\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC iterates through a series of user interface components, prompting the 
 * user for data to build the filtering criteria for NP Audit Filter. Then it 
 * invokes NP Audit Filter in the Waystation.
 * In a workflow sequence it is called:<b>PosNPAuditFilter</b>\n
 * In java script it should be called:<b>PosNPAuditFilter()</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - True for successful execution or False for failed execution.
 */
function PosNPAuditFilter() {
	var rval = false;
//DEBUG//	PosShowMessage("PosNPAuditFilter");
	// criteria data to collect
	var generateNPAuditFile = false;
	var fileName = null;
	var startDateTime = null;
	var endDateTime = null;
	var aliases = null;
	var levels = null;
	var criteria = null;
	var boh = new BusinessObjectHelper();
	// control the flow of user interaction:
	// -1. error | 0. cancelled | 1. file list <-> 2. beginDateTime <-> 3. endDateTime <-> 4. service aliases <-> 5. log levels <-> 6. finished
	var i = 1;
	var finished = false;
	while (!finished) {
//DEBUG//		PosShowMessage("i=" + i);
		switch (i) {
			case -2: {
				PosShowMessage("MSG_BC_SWCOMMUNIC");
				finished = true;
				rval = false;
			} break;
			case 0: {
				// cancelled -- return failure
				finished = true;
				rval = true;
			} break;
			case 1: {
				// init fileName here, to avoid duplicate names if the user goes back and forth between the states
				fileName = new Array();
				// retrieve file list every time?
				var fileList = null;
				{
					var cmd = "PosQueryAvailableNPAuditFiles";
//DEBUG//					PosShowMessage(cmd);
					if (executeBC(cmd)) {
						var result = getLastSuccess(cmd);
						if (result == null) {
							i = -1;
							break;
						}
						var tmpList = result.split("\n");
//DEBUG//						PosShowMessage("tmpList size: " + tmpList.length);
						if (tmpList[tmpList.length - 1] == "") {
							tmpList.pop();
						}
//DEBUG//						PosShowMessage("tmpList size: " + tmpList.length);
						var path = tmpList.shift();
						fileList = tmpList;
//DEBUG//						PosShowMessage("fileList size: " + fileList.length);
					} else {
						// error -- inform the user that the waystation is not available
						i = -2;
						break;
					}
				}
				
				// create a list of files to display
				var displayFiles = new Array();
//DEBUG//				PosShowMessage("fileList size: " + fileList.length);
				var maxLines = Number(boh.findParamInSectionWide("MaxLines", "NPAudit")) || 10;
//DEBUG//				PosShowMessage("MaxLines: " + maxLines);
				var tmpFileList = fileList;
				fileList = new Array();
				tmpFileList.forEach(function (item) {
					if (displayFiles.length < maxLines || maxLines == 0) {
						fileList.push(item);
						if (displayFiles.length == 0) {
							displayFiles.push("*" + item);
						} else {
							displayFiles.push(" " + item);
						}
					}
				});
				if (displayFiles.length == 0) {
					displayFiles.push("*Force NP Audit execution");
				} else {
					displayFiles.push(" Force NP Audit execution");
				}
				
				// request file choice
				var cmd = "PosShowPickListEx";
				var title = "Please select the desired file or the option to force NP Audit execution";
//DEBUG//				PosShowMessage(cmd);
				var status = executeBC(cmd, [title, displayFiles, true, true]);
				if (status) {
					var selection = getLastSuccess(cmd).split("|");
					var result = selection.shift();
					if (result == "NPGUI_DLGBOX_BACK") {
						// back
						i = 0;
					} else if (result == "NPGUI_DLGBOX_OK") {
						// ok
						i = 2;
						selection.forEach(function (item) {
							if (item < fileList.length) {
								fileName.push(fileList[item]);
							} else {
								generateNPAuditFile = true;
							}
						});
					}
				} else {
					var result = getLastFail(cmd);
					if (result == "NPGUI_DLGBOX_NO") {
						// cancel
						i = 0;
					} else {
						// error
						i = -1;
						break;
					}
				}
			} break;
			case 2: {
				// request start date time
				var cmd = "PosShowCalculator";
				var title = "Please enter the start of the period to be filtered using the format yyyyMMddhhmm";
//DEBUG//				PosShowMessage(cmd);
				var status = executeBC(cmd, ["", title, 7, 0, "999999999999", startDateTime]);
//DEBUG//				PosShowMessage("status: " + status);
				if (status) {
					// check validity of date
					if (status.length < 8) {
						PosShowMessage("Invalid start date.");
						i = 2;
						break;
					}
				
					// fill in missing hour and minute 
					while (status.length < 12) {
						status = status + "0";
					}

					// validate entered date
					var isValid = true;
					{
						var YYYY = status.substr(0, 4);
						var MM = status.substr(4, 2);
						var DD = status.substr(6, 2);
						var hh = status.substr(8, 2);
						var mm = status.substr(10, 2);
						var date = new Date(Number(YYYY), Number(MM) - 1, Number(DD), Number(hh), Number(mm));
//DEBUG//						PosShowMessage("Start date entered: " + date);
						if (date.getDate() != Number(DD) || date.getMonth() != Number(MM) - 1) isValid = false;
					}
					if (!isValid) {
						PosShowMessage("Invalid start date.");
						i = 2;
						break;
					}
					
					startDateTime = status;
					i = 3;
				} else {
					i = 1;
				}
			} break;
			case 3: {
				// request end date time
				var cmd = "PosShowCalculator";
				var title = "Please enter the end of the period to be filtered using the format yyyyMMddhhmm";
//DEBUG//				PosShowMessage(cmd);
				var status = executeBC(cmd, ["", title, 7, 0, "999999999999", endDateTime]);
//DEBUG//				PosShowMessage("status: " + status);
				if (status) {
					// check validity of date
					if (status.length < 8) {
						PosShowMessage("Invalid end date.");
						i = 3;
						break;
					}
				
					// fill in missing hour and minute 
					while (status.length < 12) {
						status = status + "0";
					}

					// validate entered date
					var isValid = true;
					{
						var YYYY = status.substr(0, 4);
						var MM = status.substr(4, 2);
						var DD = status.substr(6, 2);
						var hh = status.substr(8, 2);
						var mm = status.substr(10, 2);
						var date = new Date(Number(YYYY), Number(MM) - 1, Number(DD), Number(hh), Number(mm));
//DEBUG//						PosShowMessage("End date entered: " + date);
						if (date.getDate() != Number(DD) || date.getMonth() != Number(MM) - 1) isValid = false;
					}
					if (!isValid) {
						PosShowMessage("Invalid end date.");
						i = 3;
						break;
					}
					
					endDateTime = status;
					
					if (startDateTime > endDateTime) {
						PosShowMessage("Start date later than end date. Please review the dates.");
						i = 2;
						break;
					}
					
					i = 4;
				} else {
					i = 2;
				}
			} break;
			case 4: {
				// obtain service aliases every time?
				var serviceAliases = null;
				var cmd = "PosNPFListAvailableServices";
//DEBUG//				PosShowMessage(cmd);
				if (executeBC(cmd)) {
					var result = getLastSuccess(cmd);
					var tmpList = result.split("|");
					serviceAliases = tmpList;
				} else {
					// error
					i = -1;
					break;
				}
				
				// create an array for services to display
				var displayAliases = new Array();
				serviceAliases.forEach(function(item) {
					var pair = item.split(":");
					displayAliases.push("*" + pair[0]);
				});
				
				// request service alias selection
				var cmd = "PosShowPickListEx";
				var title = "Select the desired service aliases";
//DEBUG//				PosShowMessage(cmd);
				var status = executeBC(cmd, [title, displayAliases, false, true]);
				if (status) {
					var selection = getLastSuccess(cmd).split("|");
					// strip any empty strings that might have been put there by split
					var strippedSelection = new Array();
					selection.forEach(function (item) {
						if (item != "") {
							strippedSelection.push(item);
						}
					});
					selection = strippedSelection;
					
					var result = selection.shift();
					if (result == "NPGUI_DLGBOX_BACK") {
						// back
						i = 3;
					} else if (result == "NPGUI_DLGBOX_OK") {
						// ok
						i = 5;
						aliases = new Array();
//DEBUG//						PosShowMessage("Selected service aliases: " + selection.length);
						if (selection.length < 1) {
							PosShowMessage("At least one service alias must be selected.");
							i = 4;
							break;
						}
						selection.forEach(function(item) {
							aliases.push(serviceAliases[item]);
						});
					}
				} else {
					var result = getLastFail(cmd);
					if (result == "NPGUI_DLGBOX_NO") {
						// cancel
						i = 0;
					} else {
						// error
						i = -1;
						break;
					}
				}
			} break;
			case 5: {
				// request log level selection
				// obtain service aliases every time?
				var logLevels = null;
				var cmd = "PosNPFListAvailableLogLevels";
//DEBUG//				PosShowMessage(cmd);
				if (executeBC(cmd)) {
					var result = getLastSuccess(cmd);
					var tmpList = result.split("|");
					// strip any empty strings that might have been put there by split
					var strippedList = new Array();
					tmpList.forEach(function (item) {
						if (item != "") {
							strippedList.push(item);
						}
					});
					logLevels = strippedList;
				} else {
					// error
					i = -1;
					break;
				}
				
				// create an array for log levels to display
				var displayLogLevels = new Array();
				logLevels.forEach(function(item) {
					displayLogLevels.push("*" + item);
				});

				// request service alias selection
				var cmd = "PosShowPickListEx";
				var title = "Select the desired log levels";
//DEBUG//				PosShowMessage(cmd);
				var status = executeBC(cmd, [title, displayLogLevels, false, true]);
				if (status) {
					var selection = getLastSuccess(cmd).split("|");
					// strip any empty strings that might have been put there by split
					var strippedSelection = new Array();
					selection.forEach(function (item) {
						if (item != "") {
							strippedSelection.push(item);
						}
					});
					selection = strippedSelection;
					
					var result = selection.shift();
					if (result == "NPGUI_DLGBOX_BACK") {
						// back
						i = 4;
					} else if (result == "NPGUI_DLGBOX_OK") {
						// ok
						i = 6;
						levels = new Array();
//DEBUG//						PosShowMessage("Selected log levels: " + selection.length);
						if (selection.length < 1) {
							PosShowMessage("At least one log level must be selected.");
							i = 5;
							break;
						}
						selection.forEach(function(item) {
							levels.push(logLevels[item]);
						});
					}
				} else {
					var result = getLastFail(cmd);
					if (result == "NPGUI_DLGBOX_NO") {
						// cancel
						i = 0;
					} else {
						// error
						i = -1;
						break;
					}
				}
			} break;
			case 6: {
				// assemble criteria string and return success
//DEBUG//				var criteria = "{\n" + "begin:" + startDateTime + "\n" + "end:" + endDateTime + "\n" + "services:" + aliases + "\n" + "loglevels:" + levels + "\n" + "}\n";
//DEBUG//				PosShowMessage(criteria);
				var from = startDateTime;
				var to = endDateTime;
				var svcs = "";
				aliases.forEach(function (item) {
					var svcComps = item.split(":");
					svcs += (svcs.length == 0) ? "" : "|";
					// only STO
					svcs += svcComps[1];
				});
				var lvls = "";
				levels.forEach(function (item) {
					lvls += (lvls.length == 0) ? "" : "|";
					lvls += item;
				});

				var fileNameReport = null;
				// force NP Audit generation if nothing was selected in the files combo
				if (generateNPAuditFile || (fileName.length == 0)) {
//DEBUG//					PosShowMessage("GenerateNPAuditFile");
					
					var cmd = "PosGenerateAndFilterNPAuditFile";
//DEBUG//					PosShowMessage(cmd);
					var status = executeBC(cmd, [from, to, svcs, lvls]);
					if (status) {
						var fileNameReport = getLastSuccess(cmd);
					}
					rval = status;
				} else {
					var fileNames = "";
					var fileNameReport = "";
					fileName.forEach(function (item) {
						fileNames += (fileNames.length == 0) ? "" : "\n";
						fileNameReport += (fileNames.length == 0) ? "" : ", ";
						fileNames += item;
						fileNameReport += item;
					});
//DEBUG//					PosShowMessage(fileNames);
					
					var cmd = "PosFilterNPAuditFile";
//DEBUG//					PosShowMessage(cmd);
					var status = executeBC(cmd, [fileNames, from, to, svcs, lvls]);
					rval = status;
				}
				
				var message = null;
				if (rval) {
					PosCreateReport("CUSTOMDATA", "reportNPAuditFilter@reports.nps", "", fileNameReport + "|" + from + "|" + to);
				} else {
					PosShowMessage("An error occurred while requesting NP Audit Filter to process the file.\n");
				}
//				message += ("Filename: " + fileNameReport + "\n" + "From: " + from + "\n" + "To: " + to + "\n");
//				PosShowMessage(message);
				
				
//DEBUG//				var fileNames = "";
//DEBUG//				fileName.forEach(function (item) {
//DEBUG//					fileNames += (item + "\n");
//DEBUG//				});
//DEBUG//				if (fileName.length > 0) {
//DEBUG//				}
//DEBUG//				PosShowMessage(fileNames);
				
				finished = true;
			} break;
			default: {
				// handle any errors here
				rval = false;
				finished = true;
			} break;
		}
	}
	return result;
}



/** CreateEndDayReportSWJS
 *
 * @brief - This function implements the BC,Business Component: <b>CreateEndDayReportSWJS</b>\n
 * Persistence:<b>Not Persisted</b>\n
 * This BC asks user for a business day and generates a End Day Report Store Wide report if entered date is not in future.
 * In a workflow sequence it is called:<b>CreateEndDayReportSWJS</b>\n
 * In java script it should be called:<b>CreateEndDayReportSWJS(dataTypes, reportScript, flags, customParam, pod, serviceList)</b>
 * Property Messages:none\n
 * Hooks: none\n
 * @return - rval - false if it was not possible to generate report.
 */
function CreateEndDayReportSWJS(dataTypes, reportScript, flags, customParam, pod, serviceList) {
	var posList, posListXML;
	var date, reportDate, posDate;
	var futureDate = true;
	var i;

	// getting report date (entered date should be checked...)
	date = rootHlp.showCalculator("Please enter business date", 2);
	
	// date must be in YYYYMMDD format
	reportDate = date.substr(4, 4) + date.substr(0, 2) + date.substr(2, 2);

	posList = rootHlp.getSWPosList();
	if (posList != null) {
		posListXML = new XML(posList);
		if (null == posListXML) {
			return false;
		}
	} else {
		PosShowMessage("Way Station is out");
		return false;
	}

	// checking if entered date is a future date
	for (i = 0; i < posListXML.PosList.Pos.length(); i++) {
		posDate = posListXML.PosList.Pos[i].@businessDate;
		if (posDate >= reportDate) {
			futureDate = false;
			break;
		}
	}
	if (futureDate) {
		PosShowMessage("There is no data for business date entered");
		return false;
	}
	
	if (flags != null) {
		if (flags.length > 0) {
			flags = flags + "|DATE_SUPPLIED";
		} else {
			flags = "DATE_SUPPLIED";
		}
	} else {
		flags = "DATE_SUPPLIED";
	}

	// generating report
	PosCreateReport(dataTypes, reportScript, flags, customParam, pod, serviceList, null, reportDate);
	
	return true;
}



/* used to print the reports used when performing an ISP MAL on the ISP  */ 
function PrintISPMALReportJS () {
	var ctx=new SessionContext;
	
	/* getting report date (entered date should be checked...)
	var hlp 			= new BusinessObjectHelper;
	date = hlp.showCalculator("Please enter business date", 2);
	// date must be in YYYYMMDD format
	reportDate = date.substr(4, 4) + date.substr(0, 2) + date.substr(2, 2);
	*/ 
	
	PosShowMessage("Printing Report 1 of 3");

	/* 1. Print Storewide Cash */ 
	PosCreateReport("CASH|PMIX", "reportISPMalfunction@reports.nps", "DATE|CONSOLIDATED", null, null, null, null);
	/* get previously seclected date */ 
	reportDate =ctx.get("ISPMAL_DATE");

	PosShowMessage("Printing Report 2 of 3");
	
	/* 2. Print Hourly Sales */ 
	/* NVS-1102 -fixed hourly sales report for storewide (SW) -DKJ */ 
	PosCreateReport("CASH|HOURLYSALES", "reportSaleHourByDateSW@reports.nps","DATE|DATE_SUPPLIED|CONSOLIDATED", null, null, null, null, reportDate);
	
	PosShowMessage("Printing Report 3 of 3");
	
	/* 3. Print pmix */ 
	PosCreateReport("CASH|PMIX", "reportPMixByDateSW@reports.nps", "DATE|CONSOLIDATED|DATE_SUPPLIED", null, null, null, null, reportDate);
} 

/**PosCreateMDSInvoiceJS
 *
 * @brief - This BC creates the MDS invoice for accepted orders
 * Return - rval - true if POD type is delivery and invoice generation is ok
 */
function PosCreateMDSInvoiceJS()
{
	if(!PosCheckSessionProperty("POD","DLV")) {
		return false;
	}

	// Generating MDS invoice
	var ret = PosCreateReport("INVOICE", "reportMDSInvoice@reports.nps", "NOPREVIEW|SAVE", "<saveReport>INV</saveReport>");
	return ret;
}




function PosSetCustomCounterJS(customName, customValue)
{
	var success = PosSetCustomCounter_CSL(customName, customValue);
	if (success) {
		var ret = getLastSuccess("PosSetCustomCounter");
		PosShowMessage(ret);
		return true;
	}
	PosShowMessage("Error");
	return false;
}

function PosAddCustomCounterJS(customName, customValue)
{
	var success = PosAddCustomCounter_CSL(customName, customValue);
	if (success) {
		var ret = getLastSuccess("PosAddCustomCounter");
		PosShowMessage(ret);
		return true;
	}
	PosShowMessage("Error");
	return false;
}

function PosGetCustomCounterJS(customName)
{
	var success = PosGetCustomCounter_CSL(customName);
	if (success) {
		var ret = getLastSuccess("PosGetCustomCounter");
		PosShowMessage(ret);
		return true;
	}
	PosShowMessage("Error");
	return false;
}

function PosRemoveCustomCounterJS(customName)
{
	var success = PosRemoveCustomCounter_CSL(customName);
	if (success) {
		var ret = getLastSuccess("PosRemoveCustomCounter");
		PosShowMessage(ret);
		return true;
	}
	PosShowMessage("Error");
	return false;
}

/**PosIsSaleTendered
 *
 * @brief - This BC Checks if the current order has any payment made
 * Return - rval - true if the sale has any tender
 */
function PosIsSaleTendered() {
	var currentView = rootHlp.getCurrentView();
	if(currentView == null) {
		return false;
	}
	var view = new XML(currentView);
	if (view.ItemTenderView.length() > 0) {
		return true;
	}
	return false;
}

function POSSetBusinessDatesForMonthlyReportsJS()
{
 	var businessDay = new XML(rootHlp.getBusinessDate("false"));
	var finalBusinessDay=String(businessDay.@Register);
	var initialBusinessDay=finalBusinessDay.substring(0,6);
	initialBusinessDay=initialBusinessDay+"01";
	rootCtx.set(INITIAL_BUSINESS_DATE,initialBusinessDay,false);
	rootCtx.set(FINAL_BUSINESS_DATE,finalBusinessDay,false);

}

/**PosReportSOSByDateJS
 *
 * @brief - This BC creates an SOS report for the requested business date
 * Return - rval - true if allowed to continue
 */
function PosReportSOSByDateJS(dataTypes,flags) {

	var report="";
     var pod="";
	
	// select date for report
	var curDate = null;
	{ // get and format current date
		var now = new Date();
		var mm = now.getMonth() + 1;
		if (mm<10) { mm= '0' + mm; }
		var dd = now.getDate();
		if (dd<10) { dd='0'+dd; }
		var yyyy = now.getFullYear();
		curDate = '' + mm + dd + yyyy;
	}
	var date = PosShowCalculator("Please enter the report date (MMddyyyy).", "", 2, 2, null, curDate);
	if(""==date) {
		return (true);
	}
	// convert the date back from mmddyyyy to yyyymmdd
	date = date.substring(4, 8) + date.substring(0, 4);
	if (!PosValidateBusinessDate(date)) {
	 // invalid date
		PosShowMessage("MSG_BC_INVDATE");
		return false;
	}
	
	// inform PosCreateReport that a date is being fed as the 7th argument
	flags += '|DATE_SUPLLIED';
	
	//NVS-137 RPS 11/06/09
	PosItemSelection('BLK_MFY.png|BLK_DTS.png|BLK_FC.png|BLK_CSR.png|BLK_MCCAFE.png|BLK_OTHREP.png|BLK_CANCEL.png',
		'0|1|2|3|4|5|6',
		'MSG_WFL_SELECT',
		'MSG_WFL_SEL_REPORT_BY_DATE');
	var ctx = new SessionContext;
	selectedItem = Number(rootCtx.get("SelectedButtonValue"));
	/* "other" was chosen, display the "other" options */
	if (selectedItem == 5) {
		PosItemSelection('DTD.png|cancel.png',
			'7|6',
			'MSG_WFL_SELECT',
			'MSG_WFL_SEL_REPORT');
		selectedItem = Number(rootCtx.get("SelectedButtonValue"));
	}
	/* define the report params */
	switch(selectedItem) {
	case 0:
		report="reportSosMfy@reports.nps";
		pod="MFY";
		break;
	case 1:
		report="reportSosDTHourly@reports.nps";
		pod="DT|*WT";
		break;
	case 2:
		report="reportSosFc@reports.nps";
		pod="FC";
		break;
	case 3:
		report="reportSosCsr@reports.nps";
		pod="DT|*WT|FC|MFY|CBB";
		break;
	case 4:
		report="reportSosCbb@reports.nps";
		pod="CBB";
		break;
	case 7:
		report="reportSosDTDiagnostic@reports.nps";
		pod="DT|*WT";
		break;
	default:
		return(true);
	}
	
	PosCreateReport(dataTypes,report,flags,"","",pod,date);
	return(true);
}

/**PosConfirmPaidOrderJS
 *
 * @brief - This BC Checks if the current order has any payment made
 * Return - rval - true if the sale has any tender
 */
function PosConfirmPaidOrderJS()
{
	if(!PosDoStore(true, "2")) {        // ACMODE_ACCOUNT
		return(false);
	}
	if(!PosDoAutoRecallJS()) {
		PosShowScreen(rootCtx.get("baseScreenId"));
	}
	return(true);
}

/**PosReStoreOrderJS
 *
 * @brief - This BC Store the Order
 * Return - rval - true if the sale has any tender
 */
function PosReStoreOrderJS()
{
	if(!PosDoStore(true, "6")) {        // ACMODE_PAID
		return(false);
	}
	PosShowScreen(rootCtx.get("baseScreenId"));
	return(true);
}

/** PosIsMOTJS
 *
 * This function checks if the current POS is configured as a MOT
 * Return - True if it is
 */	
function PosIsMOTJS()
{
	var isMOT = rootHlp.findParamInSectionConfig("IsMOT","PosType");
	if((isMOT == "true") || (isMOT == "TRUE")){
		return(true);
	}
	return(false);
}

/** PosMOTRecallLastOrderJS
 * @brief - This BC recalls the last stored order. 
 * @return - true on success.
 * @message:
 *     MSG_BC_RPS_ORDERINPROGRESS - There is a order in progress
 *     MSG_BC_RPS_NOPREVIOUSORDER - If no order stored or found. 
 *     MSG_BC_ORDSRCMISMATCH - The last order was already recalled by other POS 
 *     MSG_BC_POSISNOTMOT  This POS is not a MOT 
 */ 
function PosMOTRecallLastOrderJS(ScreenNumber) {

	if(!PosIsMOTJS()) {
		PosShowMessage("MSG_BC_POSISNOTMOT"); 
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}	
	if(!PosNotATransactionInProgress("true")) {
		PosShowMessage("MSG_BC_RPS_ORDERINPROGRESS"); 
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}	
	if(gsLastOrderID.length == 0) {
		PosShowMessage("MSG_BC_RPS_NOPREVIOUSORDER");
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}
	if(!PosCheckOrderSource(gsLastOrderID)) {
		PosShowMessage("MSG_BC_ORDSRCMISMATCH");
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}
	if(PosRecallNextOrder("RECALL", gsLastOrderID, 1)) {
		gsCurrOrderID = gsLastOrderID;
		gsLastOrderID = "";
		var cmd = "cPosCheckSaleByPassManagerAuthorization";
		if(executeBC(cmd)) {
			var validateReturn = PosValidatePromoItem();
			if(validateReturn) {
				validateReturn = PosDoValidateLimits(false);
			}
			if(!validateReturn) {
				if(!PosCheckCashlessReversal(0)) {
					PosShowMessage ("Check Reversal failure");
					return(false);
				}
				// Void current sale
				var retVal = PosDoVoidSale(true);
				if (retVal) {
					PosCreateReport("VIEW", "receipt@reports.nps", "NOPREVIEW|SAVE");
				}

				PosShowScreen(rootCtx.get("baseScreenId"));
				return false;
			}	
		}		
		if(!PosDoTotal()){
			return(false);	
		}
		PosShowScreen(ScreenNumber);
		return(true);
	}
	PosShowScreen(rootCtx.get("baseScreenId"));
	return(false); 
}

/** recallByListJS
 *
 * This function implements the recall by list!\n
 * Return - rval - true if was cancelled on HHOT.
 */
function recallByListJS()
{

	PosRecallNextOrder("RecallByList");

	var curView = rootHlp.getCurrentView();
	if(curView == null) {
		return(false);
	}

	var view = new XML(curView);
	if(null == view) {
		return(false);
	}
	
	// CashlessOnHHOT - AccountMode = 6 means that order was paid on HHOT [NPS-8638]
	// CashlessOnHHOT - AccountMode = 7 means that order was paid on MOT (US-HHOT) [NPS-8638]
	if((view.@accountMode == "6") || (view.@accountMode == "7")){
		return(true);
	}	
	
	// NPS-9744
	if(rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED) {
		return(true);
	}

	if(!PosDoTotalJS(view.@type, TENDER_SCREEN_NBR, -1, 'NOPREVIEW|SAVE', "")) {
		return(false);	
	}
	return(true);
}


/** recallMobileOrderJS
 *
 * This function implements the recall of mobile orders!\n
 * Return - rval - true if was cancelled on HHOT.
 */
function recallMobileOrderJS(source,OrderKey)
{
	try
	{
		var ctx = new SessionContext;
		/* var hlp = new BusinessObjectHelper; */
		var silent = 0;

		if(source == '4') {
			if(!PosIsCODSelectedJS()) {
				PosSizeSelection(-1);//NPS-5843
				PosRefreshButtons();//NPS-5843
				PosShowMessage("MSG_BC_SELECTCOD");
				return(false);
			}
			silent = 1;
		}

		if(source == '3' || source == '4')
		{
			if(source == '3')
			{
				PosRecallNextOrder("RecallMobileOrder",MOS_SUBMITTED,MOS_RECALLED,silent);
			}
			else
			{
				var location = "COD" + ctx.get("activatedCOD");
				PosRecallNextOrder("RecallMobileOrder",MOS_SUBMITTED,MOS_RECALLED,silent,"",location);
			}
				
			var curView = rootHlp.getCurrentView();
			if(curView == null && source == '4') {
				PosSetSessionProperty("activatedCOD", "0", "true");
				PosShowScreen(rootCtx.get("baseScreenId"));
				return(false);
			}
		}
		else if(source == '1')
		{
			if(OrderKey != undefined && OrderKey != null)
			{
				return PosRecallNextOrder("RecallMobileOrder",MOS_SUBMITTED,MOS_RECALLED,1,OrderKey);
			}
			else
			{
				return PosRecallNextOrder("RecallMobileOrder",MOS_SUBMITTED,MOS_RECALLED,0);
			}
		}	
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[recallMobileOrderJS] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[recallMobileOrderJS] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return(true);
}

/**PosAuthorizeMobileOrderJS
 *
 * @brief - This BC authorizes the current mobile order
 * Return - rval - true if successful
 */
function PosAuthorizeMobileOrderJS()
{
	if(!PosSetMobileOrderStatus(MOS_AUTHORIZED)) {
		return(false);
	}

	if(!PosDoStore()) {
		return(false);
	}

	PosSetSessionProperty("activatedCOD","0","true");
	/* var ctx=new SessionContext; */
	PosShowScreen(rootCtx.get("baseScreenId"));

	return(true);
}

/**PosSubmitMobileOrderJS
 *
 * @brief - This BC submits back the current mobile order
 * Return - rval - true if the sale has any tender
 */
function PosSubmitMobileOrderJS()
{
	if(!PosSetMobileOrderStatus(MOS_SUBMITTED)) {
		return(false);
	}
	
	if(!PosDoStore()) {
		return(false);
	}

	PosRefreshSalePanel();
	PosSetSessionProperty("activatedCOD","0","true");
	PosShowScreen(rootCtx.get("baseScreenId"));

	return(true);
}

/**PosServeMobileOrderJS
 *
 * @brief - This BC serves the current mobile order
 * Return - rval - true if the sale has any tender
 */
 function PosServeMobileOrderJS()
{

	var curView = rootHlp.getCurrentView();
	if(curView == null) {
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}

	var view = new XML(curView);
	if(null == view) {
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}

	if(rootHlp.GetMobileOrderStatus() != MOS_AUTHORIZED) {
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}

	return(PosDoTenderJS(-1,0,'NOPREVIEW'));
}


/**POSVerifyDTAutoMergeJS
 *
 * @brief - This function implements the BC,Business Component: <b>POSVerifyDTAutoMergeJS</b>\n
 * Return - rval - True for successful execution or False for failure.
 */
function POSVerifyDTAutoMergeJS(prop1,prop2) {
	if(!PosCheckParameter("DTAutoMerge","enable","true")) {
		return(false);
	}
	var prop=PosVerifyDTAutoMerge("true")?prop2:prop1;
	PosChangeButtonProperties(0,prop);
	return(true);
}

/**
 * PosGetSuggestiveSellingItemJS
* @brief Get a suggestive item
* @returns
* @return The return value, if any.
* @remarks Any important remark about this function
 */
function PosGetSuggestiveSellingItemJS() {
	
	var view=new XML(rootHlp.getCurrentView());

	var isLunchSreen = !PosIsBreakfastTime(true);

	var salesType = "other";
	switch(rootHlp.getSaleType()) {
	case 0:
		salesType = "eatin";
		break;
	case 1:
		salesType = "takeout";
		break;
	case 2:
		salesType = "other";
		break;
	}

	var paramsToSuggestive = "<Params isLunch=\"" + isLunchSreen + "\" salesType=\"" + salesType + "\"></Params>";

	var productToSuggest;
	var result = PosGetSuggestiveSellingItem(view.toString(), paramsToSuggestive);
	if (result) {
		return getLastSuccess("PosGetSuggestiveSellingItem")
	} else {
		return "";
	}
}

/**
 * PosSuggestiveSellingAction
* @brief Called by workflow when crew accepted suggested item (press YES button)
* @return The return value, if any.
* @remarks Any important remark about this function
 */
function PosSuggestiveSellingAction(bToSell, reason) {
	
	var product = rootCtx.get("KEY_PROD_SUGGEST");
	if ( (product !== null) && (product !== "") ) {
		// do sale

		if (bToSell === "true") {
			PosDoSaleSuggestiveItem(product);
			PosHandleCalculatorButton("clear");
		} else {
			PosSuggestiveSellingItemNotAccepted(product, reason);
		}

		rootCtx.set("KEY_PROD_SUGGEST", "");
		PosSuggestiveSellingShow("");
		if(PosCanSuggestDonation()) { 
			PosRMHCdonation(); 
		} 
		PosChangeButtonProperties(0, "visible|false");
	}
}

/**
 * PosSuggestiveSelling
 * @brief Get, show or hide suggestive item
 * @return The return value, if any.
 * @remarks Any important remark about this function
 */
function PosSuggestiveSelling(btnNumber) {

	var productToSuggest = PosGetSuggestiveSellingItemJS();
	if (productToSuggest != "") {
		PosSetOnTotalSmartReminder();
		PosSuggestiveSellingShow(productToSuggest);
		PosChangeButtonProperties(btnNumber, "visible|true");
	} else {
		// hide button
		PosChangeButtonProperties(btnNumber, "visible|false");
	}
	rootCtx.set("KEY_PROD_SUGGEST", productToSuggest);
}

/**ShowSuggestiveSellingModeButtonJS
 *
 * @brief - 
 * Return - true if present, false otherwise
 */
function ShowSuggestiveSellingModeButtonJS()
{
	var isEnabled="false";
	
	isEnabled = storeDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "SuggestiveSelling").Parameter.(@name == "isEnabled").@value;

	if (isEnabled == "true") {
		
		const properties=[
		 "bitmap|Other_SuggestiveSellingOn.png,bitmapdn|Other_SuggestiveSellingOn.png,title|Suggestive\nSelling ON",
		 "bitmap|Other_SuggestiveSellingOff.png,bitmapdn|Other_SuggestiveSellingOff.png,title|Suggestive\nSelling OFF"
		];
		
		if(PosCheckSessionProperty("SuggestiveSellingMode","on")) {
			PosChangeButtonProperties(0,properties[1]);
		}
		else{
			PosChangeButtonProperties(0,properties[0]);
		}
	
		return (true);
	
	}else{
		return (false);
	}
	
}

function PosShowYesButtonJS(btnNumber){
	
	if(!PosCheckSessionProperty("SuggestiveSellingMode","on") || PosCheckSessionProperty("saleRecalled","true")) {
		PosChangeButtonProperties(btnNumber, "visible|false");
	}
}

function PosShowCustomerData(userName) {
	
	if(PosGetCustomerData(userName)) {
		var response = rootCtx.get("commandResponse");
		API.SLog("LOGLEVL_DEBUG", "PosShowCustomerData - result: " + response);
		eval("var customerData = " + response);
		PosShowMessage("FirstName: " + customerData.FirstName);
		return true;
	} else {
		var response = rootCtx.get("commandResponse");
		API.SLog("LOGLEVL_DEBUG", "PosShowCustomerData retrned false - response: " + response );
		if(response == null){
			PosShowMessage("No NPS resource found in the network.");
		}
		if(response == "-1"){
			PosShowMessage("Message timeout.");
		}
		if(response == "-2"){
			PosShowMessage("Multichannel service unavailable");
		}
		if(response == "-3"){
			PosShowMessage("eCP Command execution error. Check log for details");
		}
		if(response == "-4"){
			PosShowMessage("Invalid eCP Command. Check log for details");
		}
		if(response == "-5"){
			PosShowMessage("Generic eCP Command. Check log for details");
		}
		return false;
	}
}

function PosShowCustomerFavorites(userName) {
	
	if(PosGetCustomerFavorites(userName)) {
		var response = rootCtx.get("commandResponse");
		API.SLog("LOGLEVL_DEBUG", "PosShowCustomerFavorites - result: " + response);
		eval("var customerFavorites = " + response);
		PosShowMessage(" customerFavorites.Favorites[0].Name: " + customerFavorites.Favorites[0].Name);
		return true;
	} else {
		var response = rootCtx.get("commandResponse");
		API.SLog("LOGLEVL_DEBUG", "PosShowCustomerFavorites retrned false - response: " + response );
		if(response == null){
			PosShowMessage("No NPS resource found in the network.");
		}
		if(response == "-1"){
			PosShowMessage("Message timeout.");
		}
		if(response == "-2"){
			PosShowMessage("Multichannel service unavailable");
		}
		if(response == "-3"){
			PosShowMessage("eCP Command execution error. Check log for details");
		}
		if(response == "-4"){
			PosShowMessage("Invalid eCP Command. Check log for details");
		}
		if(response == "-5"){
			PosShowMessage("Generic eCP Command. Check log for details");
		}
		return false;
	}
}

/**** Offers Screen Processing START ****/

/**PosGetCurrentOfferCodeJS
 *
 * Get offer code from session and validate it
 *
 */
function PosGetCurrentOfferCodeJS() {
    var userEnteredCode = rootCtx.get("USERENTEREDCODE");
    var codeLength = userEnteredCode.length;

	//NVS-4155 - msilva - Remove then re-check promotions 
	var needsApplyPromotions = false;

	if(PosNotATransactionInProgress("true")) {
		PosShowMessage("MSG_BC_OFFERS_NOORDERINPROGRESS");
		return true;
	}

	if( hasReachedMaxOfferRedeemRetries_coe() == true ) {
		resetCountOfferRedeemRetries();
	}
	incCountOfferRedeemRetries();
			
    if ((codeLength === 4) || (codeLength === 8) || (codeLength === 10)) {
		if (PosHasSalePromotion() && userEnteredCode == rootCtx.get("CURRENTOFFERSCODE"))
		{
			PosShowMessage("MSG_BC_OFFERS_ENTER_NEXT_BARCODE", userEnteredCode);
		}
		else
		{

			//NVS-4155 - msilva - Remove then re-check promotions 
			//Sale in tendering process
			var view=new XML(rootHlp.getCurrentView());
			if(view != null && (view.@saleStatus == SALE_STATUS_TOTALIZED || view.@saleStatus == SALE_STATUS_ON_TOTAL)){
				//Remove promotions;
				PosRemoveOnTotalPromotions_USCOE();

				//NVS-4837 - msilva - Workaround to reset sale status (trxSubKind been reported wrongly)
				PosDoBackFromTotal();
				PosDoTotal();

				/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
				PosSetSessionProperty('ReApplyPromotions', 'true');

			}

			var canApplyOffers = true;
			if ( PosIsOfferApplied() && (userEnteredCode != rootCtx.get("CURRENTOFFERSCODE")) ) {		// NVS-1561&NVS-1573 change - clear offer before applying new scan
				canApplyOffers = PosDoClearOffer();
			}
			if (canApplyOffers) {
				PosApplyByRandomCode(userEnteredCode);
				rootCtx.set("CURRENTOFFERSCODE", userEnteredCode, true);
				setEnteredOffersRandomCode(userEnteredCode);
				PosDisplayText("", 1);
				PosBackToPreviousScreen();
				PosShowGrillFloatScreen();
			}
		}
	} 
	else 
	{	     
        PosShowMessage("Code is invalid. Please check code and try again");
    }

    return true;

}

/**PosProcessCodeKeyboardPressJS
 *
 *  Get the value of the virtual key that the user pressed and show it on the screen, characters permitting
 *
 */
function PosProcessCodeKeyboardPressJS($ButtonNumber, $ButtonTitle, $ButtonValue, $ButtonImage) {
    var ctx = new SessionContext;
    var userEnteredCode = ctx.get("USERENTEREDCODE");
    var userEnteredCodeLength = userEnteredCode.length;
    var starterButton = 21;    

    if (userEnteredCodeLength < 10) {   // NVS-1595
        PosChangeButtonProperties(parseInt(starterButton) + parseInt(userEnteredCodeLength), "visible|true", $ButtonTitle, $ButtonImage);
        ctx.set("USERENTEREDCODE", userEnteredCode + $ButtonValue, true);
    }
    return true;
}

/**PosProcessCodeClearPressJS
 *
 *  Clear the code from the screen when the virtual 'clear' button is pressed
 *
 */
function PosProcessCodeClearPressJS() {
    var ctx=new SessionContext;
    ctx.set("USERENTEREDCODE", "", true);
    for (var i = 21; i <= 30; i++) {
        PosChangeButtonProperties(parseInt(i), "visible|false", "title|");
    }
    return true;
}

/**PosProcessCodeBackSpacePressJS
 *
 * Backspace one character on the offers screen and update the session
 *
 */
function PosProcessCodeBackSpacePressJS() {
    var userEnteredCode = rootCtx.get("USERENTEREDCODE");
    var userEnteredCodeLength = userEnteredCode.length;
	var starterButton = 20;
    if (userEnteredCodeLength >= 0) {
        if (userEnteredCodeLength <= 10) {
            PosChangeButtonProperties(parseInt(starterButton) + parseInt(userEnteredCodeLength) , "visible|false", "title|", "bitmap|");			
            rootCtx.set("USERENTEREDCODE", userEnteredCode.slice(0, userEnteredCodeLength - 1), true);
        }
    }
    return true;
}
/**** Offers Screen Processing END ****/

/**PosProcessOffersScannerJS
 *
 * Process an Offers barcode
 *   OFFER|8NGK|1411794||F39932222D339EECEFD033A5E3AE8E1E788A4D31
 *   PAYMENT|MZUF||1407264|27FEEAD1D210802BEC7F7DA5D495029FFBEC2C78
 *
 */
function PosProcessOffersScannerJS(value) {

	//NVS-4155 - msilva - Remove then re-check promotions 
	var needsApplyPromotions = false;

	if (PosNotATransactionInProgress("true")) {
		API.dbg("PosProcessOffersScannerJS(" + value + ") - No Order in progress");
//		PosShowMessage("MSG_BC_OFFERS_NOORDERINPROGRESS");
	} else if (value.length == 4) {                                                // Workaround for Android App not generating full QR code
		API.dbg("PosProcessOffersScannerJS(" + value + ") - Android Offers error");
		PosSetSessionProperty('ReApplyPromotions', 'true');
		PosApplyByRandomCode(value);
		rootCtx.set("CURRENTOFFERSCODE", value, true);
	} else if (value.substring(0,5) == "OFFER") {
		API.dbg("PosProcessOffersScannerJS(" + value + ")");
		//if ( (value.length == 56) && (value.substring(5,6) != "|") ) {		// Workaround for SDO-9137 npDrvScannerKeyboard.dll stripping the |s
		//	value = "OFFER|"+value.substring(5,9)+"|"+value.substring(9,16)+"||"+value.substring(16);
		//	//API.dbg("using PosProcessOffersScannerJS(" + value + ")");
		//}
		if (PosTenderCondition("TENDER_GIFT_COUPON")) {
			PosShowMessage("MSG_BC_DISCOUNT_OFFER_REMOVE_COUPONS"); 
		} else if (PosTenderCondition(ANY_TENDER)) {  // NVS-1816
			PosShowMessage("MSG_BC_DISCOUNT_OFFER_REMOVE_TENDERS"); 
		} else if (value == rootCtx.get("CURRENTOFFERSCODE")) {     // duplicate scan of same code
			PosShowMessage("MSG_BC_BARCODE_ALREADY_SCANNED"); 
		} else {

			//NVS-4155 - msilva - Remove then re-check promotions 
			//Sale in tendering process
			var view=new XML(rootHlp.getCurrentView());
			if(view != null && (view.@saleStatus == SALE_STATUS_TOTALIZED || view.@saleStatus == SALE_STATUS_ON_TOTAL)){

				//Remove promotions;
				PosRemoveOnTotalPromotions_USCOE();
				/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
				PosSetSessionProperty('ReApplyPromotions', 'true');

			}			

			var canApplyOffers = true;
			if ( PosIsOfferApplied() ) {		// NVS-1561 change - clear offer before applying new scan
				canApplyOffers = PosDoClearOffer();
			}
			
			if(canApplyOffers == true) 
			{ 
				PosApplyByMobileCode(value);
				rootCtx.set("CURRENTOFFERSCODE", value, true);
			}
		}
	} else {		
		PosApplyByMobileCode(value);
	}	

    return true;
}

function PosShowOffersKeyboardUSJS(screenNo, field, defaultValue, enterWorkflow)
{
	if(PosNotATransactionInProgress(true) == true) {
		PosShowMessage("MSG_BC_NO_ORDER_IN_PROGRESS");
		return;
	}

	if( hasReachedMaxOfferRedeemRetries_coe() == true ) {
		resetCountOfferRedeemRetries();
	}

	if(PosIsOfferApplied() == false) {
		PosShowKeyboard(screenNo, 'MSG_BC_OFFERS_ENTER_BARCODE', field, defaultValue, enterWorkflow);
	} else {
		var msg = rootHlp.getSysMessage( "MSG_BC_OFFERS_ENTER_NEXT_BARCODE", getLastEnteredOffersRandomCode() );
		PosShowKeyboard(screenNo, msg, field, defaultValue, enterWorkflow);
	}
}

//workaround for NVS-1531 (this should be removed after CSL_Offers.nps is fixed)
function hasReachedMaxOfferRedeemRetries_coe( )
{
	var maxRetry = rootHlp.findParamInSectionWide( "offersCodeMaximumRetriesKeyboard", "Offers" );

	if(( maxRetry === null )
	|| ((!isNaN(parseFloat(maxRetry.toString())) && isFinite(maxRetry.toString())) == false)
	|| (parseInt( maxRetry.toString() ).toString() != parseFloat( maxRetry.toString() ).toString())
	|| (parseInt( maxRetry.toString() ) < 0 ) ) {
		maxRetry = new BigDecimal( "3" );
	} else {
		maxRetry = new BigDecimal( maxRetry );
	}

	if( maxRetry != 0 ) {
		var count = new BigDecimal( countOfferRedeemRetries );
		if( count >= maxRetry )	{
			PosShowMessage( "MSG_ERR_OFFERS_CODE_MAX_RETRIES_EXCEED" );
			return true;
		}
	}
	return false;
}
/**PosCheckSoftBumpDTJS 
  * 
  * Checks if the user pressed 'ZOOM' button when selected DT monitor 
  * used to fix the NVS-1666 
  * 
  * 
  */ 
 function PosCheckSoftBumpDTJS(selectedKvs, Command) { 
 //PosShowMessage("Selected kvs = " + selectedKvs); 
 if(Command.toUpperCase() == "ZOOM" && (selectedKvs.toUpperCase()=="KVS3410" || selectedKvs.toUpperCase()=="KVS3320" )){ 
 return false; 
 }else 
 {return true;} 
 } 
 
function lCanSetLight(productNode) {
	if (productNode.Department.Id == "QL") {
		if (productNode.Department.ClassDepartment.Id == "A0" && productNode.Department.ClassDepartment.SubClassDepartment.Id == "A0") {
			return false;
		}
		
		if (productNode.Department.ClassDepartment.Id == "A2" && productNode.Department.ClassDepartment.SubClassDepartment.Id == "A2") {
			return false;
		}
	}
	
	return true;
}

function lCanSetOnly(productNode) {
	if (productNode.Department.Id == "QL") {
		if (productNode.Department.ClassDepartment.Id == "A0" && productNode.Department.ClassDepartment.SubClassDepartment.Id == "A0") {
			return false;
		}
		
		if (productNode.Department.ClassDepartment.Id == "A1" && productNode.Department.ClassDepartment.SubClassDepartment.Id == "A1") {
			return false;
		}
	}
	
	return true;
}

/**
 * Encodes/Decodes XML's special characteres.<br>
 *
 * XML's special characters and their transalations are:<br>
 * "   &quot;
 * '   &apos;
 * <   &lt;
 * >   &gt;
 * &   &amp;
 *
 * @param buffer Receipt content.
 * @param encode Identify encode operation.
 * @return Converted buffer.
 */
function convXMLSpecialChars(buffer, encode) {
	var result = buffer;

	if (encode) {
		result = replaceChars(result, '\"', "$quot;");
	} else {
		result = replaceChars(result, "$quot;", '\"');
	}

	if (encode) {
		result = replaceChars(result, "'", "$apos;");
	} else {
		result = replaceChars(result, "$apos;", "'");
	}

	if (encode) {
		result = replaceChars(result, "<", "$lt;");
	} else {
		result = replaceChars(result, "$lt;", "<");
	}

	if (encode) {
		result = replaceChars(result, ">", "$gt;");
	} else {
		result = replaceChars(result, "$gt;", ">");
	}

	if (encode) {
		result = replaceChars(result, "&", "$amp;");
	} else {
		result = replaceChars(result, "$amp;", "&");
	}

	return result;
}

/**
 * Replaces all characters in a string.
 * @param buffer Buffer to be verified.
 * @param oldChars Old characters.
 * @param newChars New characters.
 * @return Replaced buffer.
 */
function replaceChars(buffer, oldChars, newChars) {

 	var result = buffer;
 	do {
 		result = result.replace(oldChars, newChars);
 	} while (result.indexOf(oldChars) >= 0);

 	return result;
}
function NGKRemoteDayOpen(remoteNGKName) 
{
	var result = true; 
	// Gets Date Format - Store-DB-Xml 
	var fmtDate = rootStoreDB.StoreDB.StoreProfile.Localization.DateFormat; 
	// Gets Date System 
	var wdate = new Date(); 
	var wyear = setZerosOnLeft(wdate.getFullYear(),4); 
	var wmonth = setZerosOnLeft(wdate.getMonth() + 1,2); 
	var wday = setZerosOnLeft(wdate.getDate(),2); 
	var sdate = wyear + wmonth + wday; 

	var sMsg=rootHlp.getSysMessage("MSG_BC_DAYOPENCONF",fmtDate); 
	if (PosAskDate(sdate, sMsg, 2)) { 
			dayOpen = getLastSuccess("PosAskDate"); 
			if(!PosGetAuthorization("manager")) 
			{ 
				result = false; 
			} 
	} 
	else 
	{ 
		result = false; 
	} 

	if(""==dayOpen) 
	{ 
		result = false; 
	} 

	if(result) 
	{ 
		return PosRemoteExecute(remoteNGKName, "cPosDayOpen", "offline", dayOpen); 
	} 
	else 
	{ 
		return false; 
	} 
} 

function CheckforTagIdJS()  //Kalpesh - NVS-3209
{
	/* var hlp = new BusinessObjectHelper; */
	var curView = rootHlp.getCurrentView();
	var view = new XML(curView);
	var items = view.ItemView;     

	/* check for CYT tag ID */
	if (!PosVerifyTagId())
	{		
		return true; //	TagID is already attached to the order
	}	
	var IsCYTitem = false;

	for each (var item in view.ItemView) {
		if (item.isCYT == "true") {  //We have order with CYT item						
			IsCYTitem = true;
			break;
			}
	}		

	if (IsCYTitem == true)
	{
			/* var hlp = new BusinessObjectHelper;  */
			var cytTagIdSR = rootHlp.findParamInSectionConfig("cytTagIdSR","UserInterface"); 		
			PosBackToPreviousScreen();
			PosShowTagIdSmartScreen(cytTagIdSR);
			return(false);
	}
	return(true);
}



/**POSCheckDualPointDoubleBumpJS  -added for NVS-3587
 *
 * @brief - This function implements the BC,Business Component: <b>POSCheckDualPointDoubleBumpJS</b>\n
 * Return - rval - True for successful execution or False for failure.
 */
function POSCheckDualPointDoubleBumpJS(disabledProperty, enabledProperty) {
	if(!PosCheckParameter("OperationMode","dualPointDoubleBumpActive","true")) {
		PosChangeButtonProperties(0,"visible|false");
		return(false);
	}
	var prop = PosCheckDualPointDoubleBump("true") ? enabledProperty : disabledProperty;
	/* NVS-3587 -changed button image */ 
	PosChangeButtonProperties(0,"bitmap|"+prop);
	PosChangeButtonProperties(0,"visible|true");
	return(true);
}

// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications
function VerifyAndShowTagIdSmartScreenJS(firstSmart,saleType) 
{ 
	/* var hlp = new BusinessObjectHelper;  */
	var cytTagIdSR = rootHlp.findParamInSectionConfig("cytTagIdSR","UserInterface");
	var tableServiceEatIn = rootHlp.findParamInSectionConfig("tableService.eatIn","UserInterface");
	var tableServiceTakeOut = rootHlp.findParamInSectionConfig("tableService.takeOut","UserInterface");
	var hasCYTInSale = PosHasCYTProductInSale(true);
	var displayTagIdFirst = PosCheckParameter("SmartRouting", "displayTagIdFirst", "true"); 

	if (tableServiceEatIn == null || tableServiceEatIn == "") tableServiceEatIn = "ONLY_WITH_CYT";
	if (tableServiceTakeOut == null || tableServiceTakeOut == "") tableServiceTakeOut = "ONLY_WITH_CYT";

	if (cytTagIdSR != null && cytTagIdSR != "") 
	{ 
		// EATIN
		if ((saleType == 0) && (tableServiceEatIn != "NEVER")) {
			if ((hasCYTInSale) || (tableServiceEatIn == "ALWAYS")) {
				if(((displayTagIdFirst) && (firstSmart)) || ((!displayTagIdFirst) && (!firstSmart))) { 
					return(PosShowTagIdSmartScreen(cytTagIdSR));
				}			
			}	
		} 	
		// TAKEOUT
		if ((saleType == 1) && (tableServiceTakeOut != "NEVER")) {
			if ((hasCYTInSale) || (tableServiceTakeOut == "ALWAYS")) {
				if(((displayTagIdFirst) && (firstSmart)) || ((!displayTagIdFirst) && (!firstSmart))) { 
					return(PosShowTagIdSmartScreen(cytTagIdSR));
				}			
			}	
		} 	
	  
		/*

		if(PosHasCYTProductInSale(true) && PosVerifyTagId()) 
		{ 
			var displayTagIdFirst = PosCheckParameter("SmartRouting", "displayTagIdFirst", "true"); 
			if((displayTagIdFirst) && (firstSmart)) 
			{ 
				 return(PosShowTagIdSmartScreen(cytTagIdSR)); 
			} 
			if((!displayTagIdFirst) && (!firstSmart)) 
			{ 
				 return(PosShowTagIdSmartScreen(cytTagIdSR)); 
			} 
		} 

		*/
	} 
	return(false); 
}

// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications
function PosSetVariableTagID(type, value) {
	var ctx = new SessionContext;
	var cont = ctx.get("VariableTagID");
	var vp = Number(cont);
	var maxPuck = rootHlp.findParamInSectionConfig("tableService.puck.maxNumberValue","UserInterface");
	var lenMax = maxPuck.length;
	var len = 0;
	if (cont != null) {
	 len = cont.length;
	}
	else {
		cont = "";
	}
	/* check value to make sure is not greater than three digits */ 
	if ((type==0)) {
		cont = "";
		ctx.set("VariableTagID",cont);
		return;
	}
	if (value == null) return;
	cont = cont + value;
	if (len < lenMax) {
		ctx.set("VariableTagID",cont);
	}
}

// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications
function PosAssociateTagIdJS (TagId){
	/* var hlp = new BusinessObjectHelper;  */
	var ctx = new SessionContext;
	var maxPuck = Number(rootHlp.findParamInSectionConfig("tableService.puck.maxNumberValue","UserInterface"));
	var cont = ctx.get("VariableTagID");
	var len = 0;
	
	if ((cont == null || cont == "") && TagId > 0) {
		PosAssociateTagId(TagId);
		return true;
	}
	// Lindomar Araujo - 2016/06/04 - NVS-4521 TagId problem when typing in a key pad and in the button pre-defined
	if (cont > 0 && TagId > 0) {
		if (TagId != cont) {
			PosAssociateTagId(TagId);
			ctx.set("VariableTagID","");
			return true;
		}
	}
	
	if (cont != null) {
	 len = cont.length;
	}
	else {
		cont = "";
	}
	if (len == 0 && TagId < 1) {
		PosShowMessage("MSG_TAGID_NOT_BE_EMPTY");
		ctx.set("VariableTagID","");
		return false;
	}
	var vp = Number(cont);
	if (vp == 0) {
		// Felipe Ramas - change message
		PosShowMessage("MSG_TAGID_GREATER_THAN_ZERO");
		ctx.set("VariableTagID","");
		return false;
	}
	if (vp > maxPuck) {
		PosShowMessage("MSG_TAGID_MAX_SELECTED",maxPuck);
		ctx.set("VariableTagID","");
		return false;
	}
	
	PosAssociateTagId(cont);
	return true;
}
<<<<<<< HEAD

function PosRefundByOrderIdOrData_JSUS(level,singleSignOn,refundReason, functionAndScriptName) {
	if (!PosIsInSaleMode(true) || !PosNotATransactionInProgress() || !PosRefundByOrderCheckWay()) {
		return false;
	}
	if (level == undefined ||  level == "undefined" ||  level == null) {
		level = "manager";
	}
	if (singleSignOn == undefined ||  singleSignOn == "undefined" ||  singleSignOn == null) {
		singleSignOn = "false";
	}

	if(!PosGetAuthorization(level,singleSignOn)) {
		return(false);
	}
	
	if (!PosShowConfirmationMessage("MSG_REFUND_SEARCH_OPTIONS", "MSG_REFUND_START_REFUND_SEARCH", "NGK_MSG_CANCEL")) {
		PosCancelRefundOrderBy();
		return false;
	}

	var ctx = new SessionContext;
	var searchResult = -1;
	searchResult = ExecutePosSearchOrderByData(functionAndScriptName);
	
	if (searchResult == -1) {  // Cancel 
		PosCancelRefundOrderBy();
		return false;
	}

	var viewToBeRefunded = new XML(rootCtx.get("KEY_VIEW_TO_BE_REFUNDED"));
	if (isTheOrderCanBeRefunded(viewToBeRefunded) == false) {
		PosCancelRefundOrderBy();
		return false;
	}
	
	if (PosStartRefundOrder()) {
		var cashlessType = -1;
		var cashType = -1;
		var tenderTypes = GetStoreDB().StoreDB.TenderTypes.TenderType;
		for each (tenderType in tenderTypes) {
			if (tenderType.TenderCategory == "TENDER_NATIVE") {
				cashType = tenderType.TenderId;
			}
			else if (tenderType.TenderCategory == "TENDER_ELECTRONIC_PAYMENT") {
				cashlessType = tenderType.TenderId;
			}
		}

		var selectedTenderType = -1;
		var options = cashlessType + "|" + cashType  + "|-1";
		var check_result = "ErrorPosDoTender";
		var refundResult = false;

		if(PosIsCashlessLoadedJS()) {
			ok=PosItemSelection("cashless.png|cash.png|cancel.png","10|0|-1","MSG_REFUND_TITLE","MSG_REFUND_OPTIONS");
		} else {
			ok=PosItemSelection("cash.png|cancel.png","0|-1","MSG_REFUND_TITLE","MSG_REFUND_OPTIONS_CASHLESS_DISABLED");
		}
		if (ok) {
			selectedTenderType = Number(ctx.get("SelectedButtonValue"));
		}
		if (Number(selectedTenderType) == 0) {
			var orderTotal       = viewToBeRefunded.@grossAmount;
			var cashInDrawer     = PosGetCashInDrawer("false");
			var drawerAmount     = getLastSuccess("PosGetCashInDrawer");
			if (Number(orderTotal) > Number(drawerAmount)) {
				PosShowMessage("MSG_BC_CHECKCASHREFUND");
				PosCancelRefundOrderBy();
				return false;
			}
		}
		refundResult = PosEndRefundOrder(selectedTenderType, refundReason);
		check_result = getLastFail("PosEndRefundOrder");
		if (selectedTenderType < 0) {
			return false;
		}
		return ( refundResult );
	}
	else {
		PosEndRefundOrder(-1);
	}
	return false;
	
	function isTheOrderCanBeRefunded(viewToBeRefund) {
		viewToBeRefund = new XML(viewToBeRefund);
		var orderIdToBeRefund = viewToBeRefund.@orderId;
		var trackSaleStatus   = viewToBeRefund.@trackSaleStatus;
		if (trackSaleStatus & 0x0800) {
			PosShowMessage("MSG_REFUND_NOT_POSSIBLE_OVERRING");
			return false;
		}
		for each (item in viewToBeRefund.ItemView) {
			var prodCode = item.productCode;
			var prodQtty = item.quantity;
			if (prodQtty > 0 && (prodCode == "936" || prodCode == "937" || prodCode == "8460" || prodCode == "8461" || prodCode == "8492" || prodCode == "8493" || prodCode == "8494" || prodCode == "8495" || prodCode == "8496" || prodCode == "8497" || prodCode == "8498" || prodCode == "8499" || prodCode == "8501" || prodCode == "8461")) {
				PosShowMessage("MSG_REFUND_NOT_POSSIBLE_GIFTCARD");
				return false;
			}
		}
		return true;
	}
	function ExecutePosSearchOrderById(functionAndScriptName) {
		var orderId;
		while (true) {
			orderId = PosShowCalculator("MSG_BC_ENTER_SEARCH_ORDER_NUMBER", "", 1, 0);
			if (orderId == "") {
				PosCancelRefundOrderBy();
				return 0;
			}
			else if (orderId == ";") {
				PosShowMessage("MSG_BC_ENTER_VALID_ORDER_NUMBER");
			}
			else {
				break;
			}
		}
		var ret = PosSearchOrderById(orderId, functionAndScriptName);
		return ret ? 1 : 2;
	}

	function ExecutePosSearchOrderByData(functionAndScriptName) {
		var hlp = new BusinessObjectHelper;
		var ctx = new SessionContext;
		var step = 1;
		var businessDate = "";
		var posList = "";
		var podList = "";
		var lowerAmount = "";
		var higherAmount = "";
		var ret = false;
		var PosText = "";  
		var PodText = "";  
		
		while(true) {
			// Step 1 - Date
			if (1 == step) {
				storedbPath = "Configurations.Configuration.(@type==\"POS\").Section.(@name==\"SpecialTransactions\").Parameter.(@name==\"daysLimitToRefund\").@value"; 
				posdbPath = "Configuration.(@imports==\"POS\").Section.(@name==\"SpecialTransactions\").Parameter.(@name==\"daysLimitToRefund\").@value";
				var daysLimitToRefund = getConfigValue(storedbPath , posdbPath, "3");
				if (daysLimitToRefund == "false" || daysLimitToRefund == "") {
					daysLimitToRefund = "3"
				}
				POSGetDateEx(daysLimitToRefund, "MSG_BC_ENTER_SEARCH_BUSINESS_DATE", true);

				businessDate=ctx.get("dlgDate");
				if(businessDate == "-1") {
					return(-1);
				}
				else if(businessDate == "0") {
					return(0);
				}
				step++;
			}

			// Step 2 - POS
			if (2 == step) {
				var allPos = new Array();
				var posXML = hlp.getSWPosList();
				if (posXML != null) {
					posXML = new XML(posXML);
					if (posXML != null) {
						var leading = "*";
						for each (pos in posXML.PosList.Pos) {
							allPos.push(leading + pos.@id.toString());
							leading = "0";
						}
					}
				}
				if (0 == allPos.length) {
					posXML = hlp.getPOSState();
					if (posXML != null) {
						posXML = new XML(posXML);
						if (posXML != null) {
							allPos.push("*" + posXML.@ID);
						}
					}
				}
				var cmd = "PosShowPickListEx";
				if (executeBC(cmd, ["MSG_BC_ENTER_SEARCH_POS", allPos, false, true])) {
					var selection = getLastSuccess(cmd).split("|");
					var result = selection.shift();
					if ("NPGUI_DLGBOX_BACK" == result) {
						step--;
						continue;
					}
					else if ("NPGUI_DLGBOX_OK" == result) {
						var leading = "";
						var numPos = 0;
						for each (element in selection) {
							var index = parseInt(element, 10);
							if (isNaN(index) || index < 0) continue;
							posList = posList + leading + allPos[index].substring(1, allPos[index].length);
							leading = "|";
							numPos++;
						}
						step++;
						if(numPos == allPos.length ) {
							PosText  = "ALL";
						}
					}
				}
				else {
					return(-1);
				}
			}

			var podList      = "DT|FC|WT|DLV|CSO";
			var PodText      = "";
			var lowerAmount  = "";
			var higherAmount = "";
			step = 5;
			
			// Step 5 - Search Order by data
			if(5 == step) {
				
				ret = PosSearchOrderByData(businessDate, posList, podList, lowerAmount, higherAmount, PosText, PodText, functionAndScriptName);
				ret = ret ? 1 : 2;
			}
			break;
		}
		return ret;
	}
=======
/**
* RMHC Donation Feature
* $Date: 2009/09/24 18:31:41 $ (of revision)
* $Author: Felipe Ramas
* NVS-4641 - Localization for 6.1.29
* PosRMHCdonationAction 
* @brief Called by workflow when crew accepted donate an item (press YES button) 
* @return The return value, if any. 
* type : types of donations accepted : 
*	fixed - a fixed value, example : U$ 1.00; 
*	cashless - donation done via pinpad; 
*	roundUp - the total due will be rounded up;	
*	variable - variable amount,defined by the customer and input by the crew via numeric key pad in the NP6 screen 
*/
function PosRMHCdonationAction(product,value,type,reason) { 
	var price; 
	var sCalc; 
	switch (type){ 
	case "fixed": 
	case "cashless": 
		price = value; 
		break; 
	case "roundUp": 
		price = -1; 
		break; 
	case "variable": 
		/* var hlp = new BusinessObjectHelper;  */
		var currencySymbol = rootStoreDB.StoreDB.StoreProfile.Localization.CurrencySymbol; 
		message = rootHlp.getSysMessage("MSG_ENTER_DONATION_AMOUNT"); 
		sCalc = PosShowCalculator(message,currencySymbol,0,2); 
		var tdCalc=new BigDecimal (sCalc/100); 
		price = trim(API.formatNumber (Number(tdCalc), "#0.00")); 
		break; 
	} 

	if (PosCanAcceptRMHCdonationItem(product)) { 
		PosDoSaleRMHCdonationItem(product,price,type); 
		PosRefreshButtons(); 
		PosHandleCalculatorButton("clear"); 
	} else { 
		PosRMHCdonationItemNotAccepted(product, reason); 
	} 
	PosChangeButtonProperties(1, "visible|false"); 
}

function PosRMHCdonationItemNotAcceptedJS(product,reason){ 
	PosRMHCdonationItemNotAccepted(product, reason); 
	PosChangeButtonProperties(1, "visible|false"); 
} 

/** 
* PosRMHCdonation 
* @brief Displays the question for donation in the smart reminder area and the donation floation screen 
* @return TRUE 
*/ 
function PosRMHCdonation() { 
	PosSetOnTotalSmartReminder(); 
	PosRMHCdonationShow(); 
	PosShowRMHCdonationSmartScreen("586"); 
	return true; 
}

//NVS-4809 - msilva
/** 
 * @brief - Call MobileOrderingPlugin to get information for data analysis 
 * @return Json containing data for analysis. 
 */ 
function LongTermCheckinGetData(initialDate, endDate) 
{ 
	var mobileOrdering = new NpSharpService('MobileOrdering'); 
	var params = { 'initialDate' : initialDate, 'endDate' : endDate}; 

	return mobileOrdering.Call('ProcessGenerateInformation', params); 
}

function PosGenerateInformation() 
{ 
	var initialDate = PosShowCalculator("Enter initial date", "", 1, 2); 
	var endDate = PosShowCalculator("Enter end date", "", 1, 2); 
	var ret = LongTermCheckinGetData(initialDate, endDate); 
	PosPrintPreview(ret); 
>>>>>>> FETCH_HEAD
}
