/**
 * BCEvents.nps
 * This NPS file implements Event Handlers for Business Componentes .
 *
 * Copyright - (c) 2005-2007 - Torex Retail PLC-
 *
 * $Source -: /NewPOS/SRC/uscvs/cvs/___Config61/Posdata/US/nps/BCEvents.nps,v $
 * $Revision: .1.20 $
 * $Date: 2009/09/22 19:02:10 $ (of revision)
  * $Author: rschreiber $ (of revision)
 */

// Name of this script (used by the new STT log API).
// MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
const BC_EVENTS_NAME = "BCEvents.nps";
 
var TENDER_BILLABLE_SALE=6;

var GLOBAL_OUTAGEFILE_LAST_ACCESS_TIME=-1;			// Part of TP-UI feature (Kiosk)
var GLOBAL_DAY_PART_DEFAULT=-9;						// Part of TP-UI feature (Kiosk)
var GLOBAL_DAY_PART_MENU=GLOBAL_DAY_PART_DEFAULT;	// Part of TP-UI feature (Kiosk)
//NPS-11233
var GLOBAL_STOREDB = new XML(API.getStoredb().toString());
var maxMobilePaymentRetry=0;
var MobilePaymentRetry = false;
 //rootProductDB is also used in the CLS_Sales.nps - NVS-1458
// var rootProductDB = new XML(API.getProductdb());
//var rootProductDB = GetRootProductDB();
var rootProductDB = null;
var FeeTypeList;
var employeeMealRate=0;
var managerMealRate=0;
var StoreDBXML=null;
var posDBXML =null;
var g_isNGCODEnabled = false;
var g_isLegacyCODEnabled = false;
var g_isCODEnabledInitialized = false;	//Lazy initialization control
var glo_VACMinAmt = 5;
var glo_VACMaxAmt = 50;
var DisableString = "";
/* NVS-4080 -inialized globals */
var rootCtx = ""; 
var rootHlp = ""; 

// NVS-5183 - msilva
var PODCSO = 8;

// Product "salability"
const PROD_SALABLE_OK=0;						//!< Product is salable
const PROD_SALABLE_UPGRADE=1;					//!< Product not salable due to upgrade
const PROD_SALABLE_POD=2;						//!< Product not salable due to POD
const PROD_SALABLE_NOTFOUND=3;					//!< Product not salable becuase was not found
const PROD_SALABLE_NOTINPROGRESS=4;				//!< Product not salable because sale is not in progress
const PROD_SALABLE_UPGRADEQTTY=6;				//!< Product not salable due to upgrade invalid quantity

const CARDLESS_INFO_SEPARATOR='|';

//common function declaration for Cashless
var	cashlessPayment;	
var	ChangeIdleMessage;
var	CleanCashlessState;
var	DayOpenPED;
var	GCBalanceJS;
var	GCCashOutJS;
var	PinpadIsOnlineJS;
var	PosActivateGCJS; 	
var	PosCashlessEndOfSale;
var	PosCashlessPayment;
var	PosRefundCashlessPayment;	
var	PosResetPinpad;	
var	StartCashlessSession;
var	StopCashlessSession;
var	PosDisplayLaneOpenMessage;
var 	ResetEverest;
//MOBILE
// MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
// DayPart default values
// MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
const DAYPART_BREAKFAST_MENU = 0;
const DAYPART_DAY_MENU = 1;
const DAYPART_BREAKFAST_DAY_MENU = 2;

// New POS POD definitions.
const PodDefinitions = {
	FRONT_COUNTER 		: 0,
	DRIVE_THROUGH 		: 1,
	WALK_THROUGH		: 2,
	DELIVERY			: 3,
	COLD_KIOSK			: 4,
	MC_CAFE				: 5,
	MC_EXPRESS			: 6,
	COLD_KIOSK_DRINK	: 7,
	CSO					: 8,
	HOT					: 9,
	LOCAL				: 11,
	MCD					: 20,
	CHIPOTLE			: 21,
	BOSTON_MARKET		: 22,
	DONATOS				: 23,
	UNDEFINED			: 24
}
const FOE_DEFAULT_PROD_MONITOR_VALUE = "ONRECALL";
const FOE_DEFAULT_EXPO_MONITOR_VALUE = "ONRECALL";

var foeStoreDbConfig;
var foePosDbConfig;
var foePodNameMappingArray;
var foeProductionMonitorsArray;
var foeExpoMonitorsArray;

var foeRoutingPodSourceArray;
var foeRoutingPaidStatusArray;
var foeRoutingTargetStoreAreaArray;
//SQM-1231
var foeRoutingOrderNumberPrefixArray;

//NPS-18526
const	CURB = "CURB";
var		foeCurbSideMapping;

//NVS-974 
function PosShareCODJS() {
     if (PosCheckSessionProperty("dedicatedCOD", "true")) {
          // Disable dedicated mode for a while (a dedicated POS can't release the COD!)
          PosSetSessionProperty("dedicatedCOD", "false");
          PosReleaseCOD();
          // Restore dedicated mode
          PosSetSessionProperty("dedicatedCOD", "true");
     }
     else   // NVS-1296
          PosReleaseCOD();
}

/**
 * \brief Entry point called by kernel in order to consolidate a view
 * \param [in] view - View to consolidate in string format
 * \return Consolidated view in string format
 */
function onConsolidateView (view) {
    var cnView = new ConsolidatedView_Ex (view);
    return cnView.consolidate ();
}

/** onCardReaderEvt
 *
 * @brief - Receives an external card reader event. This function is called by the library nGUICL:GuiCLCardReaderEvent() as
 *          a callback from external drivers sych as Eurecs/Sotec.
 * 
 * XML sample:
 * 
 *	<Event type="ASYNC" name="CARD_READER">
 *	   <Parameter name="Event" value="1"/> // 1=CARD INSERTED, 2=CARD REMOVED, 3=INCOMPLETE READ
 *	</Event>
 *
 * @return - TRUE when the event could be sent to UI driver.
 * @author - Kalil
 * @since - NPS-5559
 */
function onCardReaderEvt(crEvt) {
	var params = Array("Event|" + crEvt);
	var xml = lCreateKioskEvent("ASYNC", "CARD_READER", params);
	return PosSendUICmd(xml);
}

function MapCardNames(InputName)
{
	var NewName = InputName;
	
	switch (InputName.toUpperCase()) {
	case "MASTERCARD":
		NewName = "Master";
		break;
	case "DISCOVER":
		NewName = "Dscvr";
		break;
	case "ARCHCARD":
		NewName = "Gift Card"
		break;
	case "DINERS":
		NewName = "Dscvr";
		break;
	case "JCB":
		NewName = "Dscvr";
		break;
	case "AMEX":
		NewName = "Amex";
		break;
	}
		
	return NewName;
}

/** onTPUIHook
 *
 * @brief - This feature is part of external Kiosk UI (TPUI). This function is called by the npGUIExt driver every (n) seconds.
 * @return - Always TRUE.
 * @author - Kalil
 */
function onTPUIHook() {
	// Verifies if the outage file was changed/created and sends it to the TPUI.
	handleOutageFileChanges();

	// Verifies which is the state of the daypart menu (breakfast, day, both, default).
	handleDayPartMenuChanges();
	
	return(true);
	
	/*
	 * @brief - Sends the outage file (when change) to TP UI.
	 * 
	 * XML Sample:
	 * 
	 * <?xml version="1.0" encoding="UTF-8"?>
	 * <Event type="ASYNC" name="CONFIGURATION" action="PROD_OUTAGE_DB">
	 * 	  <Payload>..Outage file as an inner XML (CDATA)...</PayLoad>
	 * </Event>
	 * 
     * @author - Kalil
	 */
	function handleOutageFileChanges() {
		try {
			var posDataPath	= rootHlp.PosGetDataDir();
			var outageFile  = posDataPath + "/prodoutage.xml";
			var szProps 	= rootHlp.PosGetFileProperties(outageFile);
			if (szProps == null) {
				GLOBAL_OUTAGEFILE_LAST_ACCESS_TIME = 0;
			} else {
				var fProps 			= szProps.split("|");
				var fSize 			= Number(fProps[0]);
				var fCreationTime 	= Number(fProps[1]);
				var fLstAccessTime 	= Number(fProps[2]);
				var fLstWriteTime 	= Number(fProps[3]);
				if (GLOBAL_OUTAGEFILE_LAST_ACCESS_TIME != fLstAccessTime) {
					if (GLOBAL_OUTAGEFILE_LAST_ACCESS_TIME != -1) {
						var outageFileBuffer = rootHlp.PosReadFile(outageFile);
						if (outageFileBuffer == null) {
							return;
						}
						sendXML("CONFIGURATION", "PROD_OUTAGE_DB", null, outageFileBuffer);
					}
					GLOBAL_OUTAGEFILE_LAST_ACCESS_TIME = fLstAccessTime;
				}			
			}
		} catch(ex) {
			PosShowMessage("Failed while checking outage file changes, due to: " + ex);
		}
	}
	
	/*
	 * @brief - Sends the new day part menu to the TP UI. If daypart is not changed (default), the XML message is not sent.
	 * 
	 * XML Sample:
	 * 
	 * <?xml version="1.0" encoding="UTF-8"?>
	 * <Event type="ASYNC" name="CONFIGURATION" action="DAY_PART_MENU">
	 * 	  <Parameter name="dayPartMenu" value="BREAK_FAST_MENU"/>
	 * </Event>
	 * 
     * @author - Kalil
	 */
	function handleDayPartMenuChanges() {
		try {
			var isBF	= rootCtx.get("BreakfastTime");

			//PosShowMessage("isBF " + isBF + ", GLOBAL_DAY_PART_MENU " + GLOBAL_DAY_PART_MENU);
			
			if (isBF != null && ((isBF == "true") || (isBF == "false"))) {
				rootCtx.set("BreakfastTime", null);
				if (GLOBAL_DAY_PART_MENU == GLOBAL_DAY_PART_DEFAULT) {
					// Default was changed
					if (isBF == "true") {
						GLOBAL_DAY_PART_MENU = 0; // BREAKFAST
					} else {
						GLOBAL_DAY_PART_MENU = 2; // BOTH
					}
					sendXML("CONFIGURATION", "DAY_PART_MENU", ["dayPartMenu|" + decodeDPM(GLOBAL_DAY_PART_MENU)], null);
				} else {
					if ((isBF == "true" && GLOBAL_DAY_PART_MENU == 0)) {
						// do nothing
					} else if ((isBF == "false" && GLOBAL_DAY_PART_MENU == 2)) {
						// do nothing
					} else {
						GLOBAL_DAY_PART_MENU = GLOBAL_DAY_PART_DEFAULT;
						sendXML("CONFIGURATION", "DAY_PART_MENU", ["dayPartMenu|DEFAULT"], null);
					}
				}
			}
			return true;
		} catch(ex) {
			PosShowMessage("Failed while checking day-part menu, due to: " + ex);
		}
		return false;
	
		/**
		 * @brief - Decodes the configured day part menu.
		 * @return - Decoded daypart.
		 */
		function decodeDPM(dayPart) {
			var DP_BF 		= 0;						// Break-Fast menu
			var DP_DAY		= 1;						// Day menu
			var DP_BF_DAY	= 2;						// Break-Fast and Day menu (Both)
			if (dayPart == DP_BF) {
				return "BREAKFAST_MENU";
			} else if 	(dayPart == DP_DAY) {
				return "DAY_MENU";
			} else if 	(dayPart == DP_BF_DAY) {
				return "BREAKFAST_DAY_MENU";
			} else {
				return "UNDEFINED_DAYPART_CODE";
			}
		}
	}
	
	/**
	 * @brief - Sends the XML message with the given content.
	 */
	function sendXML(name, action, parameters, payload) {
	    var xml = new StringBuffer();
	    xml.append(GLOBAL_UTF8_PROLOG_XML);
	    xml.append("<Event ");
	    {
	        xml.append(" type=\"ASYNC\"");
	        xml.append(" name=\"" + name + "\"");
	        xml.append(" action=\"" + action + "\"");
	        xml.append(">\n");
	        if (parameters != null) {
				for(var zz=0;zz < parameters.length; zz++) {
					var par = parameters[zz].split("|");
					xml.append("\t<Parameter name=\"" + par[0] + "\" value=\"" + par[1] + "\"/>\n");
				}
	        }
        	if (payload != null) {
		        xml.append("\t<Payload>\n");
			        xml.append("\t\t<![CDATA[");
		        	xml.append(payload);
			        xml.append("]]>\n");
		        xml.append("\t</Payload>\n");
	        }
	    }
	    xml.append("</Event>");
		PosSendUICmd(xml.toString());
	}
}

 /**onWorkFlowAfterExec
 *
 * @brief - Receives the workflow name which has been performed and its last step result.
 * @return - rval - Always (true)
 * @author - kalil
 */
function onWorkFlowAfterExec(wfName, rc) {
	if ((PosCheckSessionProperty('EXT_UI','true')) && (wfName != "WF_Kiosk_Hook")) {
		var status = ((rc) ? "SUCCESS" : "FAIL");
		var view = rootHlp.getCurrentView();
		
		if (PosCheckSessionProperty('ON_TENDER','true')) {
			PosRemoveSessionProperty('ON_TENDER');
			if (view == null) {
				// Has reached the due amount.
				view = rootHlp.getLastSaleView()
			}
		}
		return PosDoActionFinishKioskJS(wfName, status, view);
	}
	return(true);
}

/**onCODRoutingChanged
 *
 * @brief - This function handles onCODRoutingChanged event
 * Return - rval - True
 */
function onCODRoutingChanged()
{
     PosShareCODJS(); // NVS-974
	// Should be in Sale mode (operator logged and not alreday performing a transaction
	if(PosIsInSaleMode("false")) {
		// Refresh screen
		PosRefreshButtons();
	}
	return(true);
}

/**onBeginInitialize
 *
 * @brief - This function handles onBeginInitialize event
 * Return - rval - True
 */
function onBeginInitialize() {
	//SetupTelequipt();
	if(PosCheckParameter("Cashless3", "Active", "true")) {
			//Setup function references for Cashless 3.0
			SetupCashless30functions();
			// load cashless 3.0
			SetUpCashless();
	} else {
			//Setup function references for Cashless 2.0 (Everest)
			SetupCashless20functions();
			// load legacy cashless
			SetUpEverest();
	}
		if(PosCheckParameter("Cashless3", "Active", "true")) {
			StartCashlessSession(false, false);
			StateFileReversal();
			PosDisplayPEDWaitingMessage();
		}

	if (IsBlueToothPrinterConfigured() == true) {
		PosSetSessionProperty("BlueToothConnected", "true");
	} else {
		PosSetSessionProperty("BlueToothConnected", "false");
	}
	return true;
}


function getStoreDB_CSL() { 
	sRawStoreDB = API.getStoredb().toString();
	var sStoreDB	= sRawStoreDB;
	// check for E4X documented bug
	if (sRawStoreDB.indexOf("<?xml") != -1) {
		var cutting = sRawStoreDB.indexOf("?>");
		if (cutting != -1) {
			sStoreDB = sRawStoreDB.substring(cutting + 2, sRawStoreDB.length);
		}
	}

	StoreDBXML = new XML(sStoreDB);
} 

/** sleep function 
* NVS-4916 01-SEP-2016 John Brancaleon - delay processing for a number of milliseconds.
* 
**/
function sleep(delay) {
	var start = new NPDate();
	var end = new NPDate();
	end.setMilliseconds((delay + start.getMilliseconds()));
	while (new NPDate() < end);
}

/* returns the pointer for POSDB xml file */
function getPOSDB() { 
	sRawPOSDB 	=API.getPosdb().toString();
	var sPOSDB	=sRawPOSDB;
	
	// check for E4X documented bug
	if (sRawPOSDB.indexOf("<?xml") != -1) {
		var cutting = sRawPOSDB.indexOf("?>");
		if (cutting != -1) {
			sPOSDB = sRawPOSDB.substring(cutting + 2, sRawPOSDB.length);
		}
	}

	posDBXML = new XML(sPOSDB);
} 

/* returns bool if COD is enabled */ 
function isNGCODEnabled()
{
	var posDB = "";
	//Checking if the posDBXML is instantied already, if so, let's us it
	if(posDBXML == undefined || posDBXML == null || posDBXML == "")
	{		
		posDB = new XML(API.getPosdb());
	}
	else
	{
		posDB = posDBXML;
	}
	
	//Testing ngcod
	var getConfig = posDB.Services.Service.(@classname == "npCODNew.dll"); 
	if ((getConfig != undefined) && (getConfig != null) && (getConfig != ""))
	{
		return true;
	}
	
	return false;
}

function isLegacyCODEnabled()
{
	var posDB = "";
	//Checking if the posDBXML is instantied already, if so, let's us it
	if(posDBXML == undefined || posDBXML == null || posDBXML == "")
	{		
		posDB = new XML(API.getPosdb());
	}
	else
	{
		posDB = posDBXML;
	}
	
	//Testing legacyCod
	var getConfig = posDB.Services.Service.(@classname == "npCOD.dll"); 
	if ((getConfig != undefined) && (getConfig != null) && (getConfig != ""))
	{
		return true;
	}

	return false;
}

/**onEndInitialize
 *
 * @brief - This function handles onEndInitialize event
 * Return - rval - True
 */
function onEndInitialize()
{

	// Lindomar Araujo - 2016/08/11 - NVS-4960 Changed ask for the manager id when doing the first PromoOrder after the startup
	PosSetSessionProperty("PromoOrderInProgress","false","false");
	
	/* NVS-4080 -made sure Session context is global */ 
	rootCtx =new SessionContext;
	rootHlp =new BusinessObjectHelper;
	PosShareCODJS(); 	// NVS-974
	//NVS-4916 - Check try to open the PED in cashless 3 only   06-SEP-2016 John Brancaleon
	if (PosCheckParameter("Cashless3", "Active", "true")) {
		SILENT_OPEN = true; 
		DayOpenPED();	
		SILENT_OPEN = false; 
	}
 
	/* NVS-48 -print the last receipt */
	if(!PosNotATransactionInProgress(true) && PosCheckSessionProperty('EndOfSaleReceiptPrinted','0') ) {   //NVS-1602
		PosCreateReceiptJS(0,"VIEW","Receipt#USReceiptReports","NOPREVIEW")
	}
     PosGCActivationJS("NOPREVIEW|SAVE");
	 PosDisplayLaneOpenMessage();

	PosBackFromTotalUndoOffer();
	PosBackFromTotalUndoPromotion(); 
	 
	/* check to see if we a pending order was in a partial payment state */
	if (!PosNotATransactionInProgress(true)) {
		cashlessTenders =String(rootCtx.get("CASHLESS"));

		/* if we've cashless tenders go to the tender screen */
		if (cashlessTenders.length != 0) {
			if (PosDoTotal()) {
				PosShowScreen(TENDER_SCREEN_NBR);
			}
		}

		
		/* check if was in the middle of partial reversal */
		  checkPartialTransactions();
	}

	//
	//  Set tender type to
	//  BusinessLimits->SkimAmountLimit
	//
	getStoreDB_CSL();

    // pickup Skim Amount
    var sSkimLimit  = StoreDBXML.StoreDB.StoreProfile.BusinessLimits.SkimAmountLimit;

    // get TenderTypes List
    var TenderTypeList = StoreDBXML.StoreDB.TenderTypes.TenderType;
	
	//Arch Card Timeout
	var GCTimeout = StoreDBXML.Configurations.Configuration.(@type=="POS").Section.(@name=="UserInterface").Parameter.(@name=="giftcardTimeout").@value;
	PosSetSessionProperty("giftCardTimeout",GCTimeout);	
    // First Tender Type
	var sTenderType = new XML(TenderTypeList[0]);
	var i = 0;
	
	//VAC floating screen	
	var VACscreen = StoreDBXML.Configurations.Configuration.(@type=="POS").Section.(@name=="UserInterface").Parameter.(@name=="VACFloatingScreenNum").@value;
	PosSetSessionProperty("VACSceenNum",VACscreen);	
	
	 // Check to see if a foreign currency has been defined
	 // Since we were going through the tender types anyway
    var ForeignCurrencyName  = StoreDBXML.Configurations.Configuration.(@type=="Store.wide").Section.(@name=="ForeignCurrency").Parameter.(@name=="SelectedCurrency").@value;
	PosSetSessionProperty("ForeignCurrencyID", "0");


	// process until there are no more TenderType
	while (	TenderTypeList[i] != null ) {
		var KeyName = "SKIM_LIMIT_" + sTenderType.TenderId

		// SDO-1541  RPS 9/10/09
		if (sTenderType.TenderCategory == "TENDER_NATIVE") {
			PosSetSessionProperty(KeyName, sSkimLimit, false);
		}

		//Now lets see if it is the foreign currency we wanted in the first place
		if (sTenderType.TenderName == ForeignCurrencyName) {
			//RequestedForeignCurrencyFound = true;
			if (sTenderType.@statusCode != "ACTIVE") {
				API.dbg("requested foreign currency >" + ForeignCurrencyName + "< is not active");
			} else {
				PosSetSessionProperty("ForeignCurrencyID", sTenderType.TenderId);
			}
		}

		// get Next TenderType
		i = i + 1;
		sTenderType = new XML(TenderTypeList[i]);
	}

	/* load fees from store db */
	FeeTypeList = StoreDBXML.StoreDB.FeeTypes.FeeType;

	var dlgTimeout = rootHlp.findParamInSectionConfig("screenTimeout","UserInterface") - 0
	dlgTimeout *= 1000;
	dlgTimeout = "_TIMEOUT:" + dlgTimeout;

	var cod = rootCtx.get("activatedCOD");
	switch (cod) {
		case "1":
		case "2":
			API.dbg("[onEndInitialize] COD" + cod + " allocated");
			PosSetSessionProperty("activatedCOD", "0", "true");
			ButtonCODJS(cod, 0);
			break;
	}
	/* NVS-140 -in case there was a restart after a cashless refund */
	if (!PosNotATransactionInProgress(true) && PosCheckTransactionKind(1)) {
		var curView = rootHlp.getCurrentView();
		var view = new XML(curView);
		var TotalDue = view.@totalDue;
		if (TotalDue == "0.00") {
			PosDoTotal();
			PosDoTenderJS(0,0,"NOPREVIEW|SAVE");
		}
	}
	if(PosCheckSessionProperty("bAUSaleDisable","true")) {
		if (	PosCheckSessionProperty("bGoForwardApplyUpdate", "true") ||
				PosCheckSessionProperty("bGoForwardApplyUpdateClient", "true")
		) {
			PosLockSales("true", "", "MSG_GO_FORWARD_TIMEOUT");
			PosShowMessage("MSG_GO_FORWARD_AU_EXECUTING", dlgTimeout);
		} else if (PosCheckSessionProperty("bChangeDayApplyUpdate", "true")) {
			PosLockSales("true", "", "MSG_AU_CHANGE_DAY_TIMEOUT");
			PosShowMessage("MSG_AU_CHANGE_DAY_EXECUTING", dlgTimeout);
		} else {
			PosLockSales("true", "", "MSG_BC_CFGROLLBACK_LOCKTIMEOUT");
			PosShowMessage("MSG_BC_CFGROLLBACK_WAIT","_TIMEOUT:60000");
		}
	}

	 // Build list of choices for drink check override logic
	 PosBuildDisableListJS();

     // eSocket.POS initialization
     // must initialize only if store is open state, otherwise it may cause
     // problem with cut-over process
     if (PosCheckParameter("TCLExtension","esocket","true")) {
         var bOpened = PosCheckState("POS_Opened");
         var bLogged = PosCheckState("POS_OpLogged");

          // SDE-2243  replaced || with && RPS 03/12/09
          // Changed to only check for bLogged sinced the open state doesn't work properly on a restart
          if (bLogged) {
               result=npTCLEvalEx("Everest_Operation 1 0 0");

               // Query pinpad
               result=npTCLEvalEx("Everest_Operation 6 0 0");
               if(result == "-1") {
                    PosShowMessage("MSG_BC_GC_NOT_AVAILABLE");
                    /* NVS-997 don't return return true; */ 
               }
          } 
     }

	// Walk the line defaults to enabled  NVS-729
	// Only for Hand hald device NVS-782
	if (PosCheckParameter("PosType", "IsMOT", "true") == true) {
		if (PosSetWalkLine("true") == false && PosCheckParameter("OperationMode", "enableWalkLine", "true") == true) {
			API.dbg("PosSetWalkLine failed in onEndInitialize()");
		}
	}
  
	// SDO-7835 OFFERS FUNCTIONALITIES FOR NP6.1.23
    // NVS-1291 added SessionProperty OFFERS_IS_ENABLED for activate workflow WF_CheckIfOffersIsEnabled
	//   Offers enabled in store-db.xml <Configurations> <Configuration type="Store.wide"> <Section name="Offers"> <Parameter name="isEnabled" value="true"/>
	var enableOffers = "false";
	try {
		enableOffers = GLOBAL_STOREDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "Offers").Parameter.(@name == "isEnabled").@value;
	} catch (e) {
		// parser error or missing section or anything else
		CSL_dbglog(7, SRC_BC_SALES, cmd, "FAILED to read store-db <Store.wide> <Offers> <isEnabled> flag");
	}
	PosSetSessionProperty("OFFERS_IS_ENABLED",enableOffers,"true");

	// SQC-1312 - test if lock cashout is active and sets the time out control
	if(PosCheckSessionProperty("bLockCashout","1")) {
		npAdpTlog_RequestSrv(NPSRVTLOG_CASHOUTLOCKTIMEOUT,ADPTLOG_INT_TIMEOUT_TYPE,"1");	
	}
	// SQC-1312 - test if is there a provision mande and sets the time out control
	if(PosGetProvision()) {
		provision=getLastSuccess("PosGetProvision");
		if(Number(provision)>0) {
			npAdpTlog_RequestSrv(NPSRVTLOG_PROVISIONTIMEOUT,ADPTLOG_INT_TIMEOUT_TYPE,"1");	
		}
	}
	
	/* get the rate for employee and manager meals NVS-834 */
	empNode =StoreDBXML.StoreDB.DiscountTables.DiscountTable.(DiscountId==1);
	if (empNode != null) { employeeMealRate = empNode.DiscountRate; }

	mgrNode =StoreDBXML.StoreDB.DiscountTables.DiscountTable.(DiscountId==2);
	if (mgrNode != null) { managerMealRate = mgrNode.DiscountRate; }
	
	/* -added for VAC support */ 
	var VACNode = StoreDBXML.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "AdditionalGiftCard");
	
	if (VACNode != null) {
		VACMinAmt =VACNode.Parameter.(@name == "variableAmountMinimumLimit");	
		if ((VACMinAmt != null)) {
			glo_VACMinAmt =Number(VACMinAmt.@value)>0?Number(VACMinAmt.@value):glo_VACMinAmt;
		} 

		VACMaxAmt =VACNode.Parameter.(@name == "variableAmountMaximumLimit");
		if ((VACMaxAmt != null) && (Number(VACMaxAmt.@value) >0) ) {
			glo_VACMaxAmt =Number(VACMaxAmt.@value)>0?Number(VACMaxAmt.@value):glo_VACMaxAmt;
		}
	}


	if(PosCheckSessionProperty("StoreAccountMode", "6")) {
		PosHideFloatScreen();
		PosShowScreen("55");
	}
	//Checking if it is a mobile order
	var MobileOrderStatus = rootHlp.GetMobileOrderStatus();
	var OrderSrc = rootHlp.GetOrderSrc();
	if(MobileOrderStatus != MOS_NONE)
	{
		if( OrderSrc == '3' || OrderSrc == '4')
		{
			if(MobileOrderStatus == MOS_RECALLED)
			{
				if(PosDoTotal())
				{
					PosHideFloatScreen();
					PosShowScreen((OrderSrc == '3' ? "563" : "564"));
				}
			}
			else if(MobileOrderStatus == MOS_AUTHORIZED)
			{
				if(PosDoTotal())
				{
					PosHideFloatScreen();
					PosShowScreen("57");
				}
			}
		}
		else if(OrderSrc == '1')
		{
			if(MobileOrderStatus == MOS_RECALLED)
			{
				if(PosDoTotal())
				{
					if (PosCheckSessionProperty("workingMode","orderTaker")){
						PosHideFloatScreen();
						PosShowScreen(STORE_SCREEN_NBR);
					}
					else {
						PosHideFloatScreen();
						PosShowScreen(STORE_MOBILE_ORDER);
					}
				}
			}
			else if(MobileOrderStatus == MOS_PENDING || MobileOrderStatus == MOS_DECLINED || MobileOrderStatus == MOS_TIMEDOUT || MobileOrderStatus == MOS_AUTHORIZED)
			{
				if(PosDoTotal())
				{
					if((PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) && PosCheckSessionProperty("workingMode","orderTaker"))
					{
						PosHideFloatScreen();
						PosShowScreen(STORE_SCREEN_NBR);
					}
					else
					{
						PosDoBeforeTenderScreenJS();
					}
				}
			}
		}
	}
	else if(OrderSrc == '1')
	{
		PosShowScreen(TENDER_SCREEN_NBR);
	}
	
	//NVS-6999 / NVS-7068 - msilva- Displays Delivery Tender Menu Screen
	//NVS-7143 - msilva - Avoid Tender Screen on OT when POS is inialized.
	if(isUberEatsOrder()){
		if(PosCheckSessionProperty("workingMode","cashier|both") || PosCheckSessionProperty("POD","FC")){
			//NVS-7142 - msilva - Totalize the order before tendering when POS restarts
			PosDoTotal();
			
			//NVS-8498
			var isSkipCar = false;
			var curView = rootHlp.getCurrentView();
			if(curView != null){
				var view = new XML(curView);
				if(view.@transactionKind == ACC_OT_SKIP_CAR){
						ShowHomeDeliveryTenderScreen();
						isSkipCar = true;
				}
			}
			
			if(!isSkipCar){
				ShowUberEatsDeliveryTenderScreen();
			}
				
		}else if(PosCheckSessionProperty("workingMode","orderTaker")){
			ShowUberEatsStoreOrderScreen();
		}
	}
	//NVS-7325 Tishin Thomas
	rootCtx.set("CURRENTOFFERSCODE", "", true);	
	/* NVS-4642 -start scanner only if an order is in progress *//* NVS-7173 -stop scanner only if customer preferences is off */
	if (PosNotATransactionInProgress(true) && !IsEnabledCustomerBarcodePreferences()) {
		PosScannerStopCaptureJS( true );		// NVS-1601 scanner now always on
	} else { 
		/* NVS-7096 - Customer Preference Barcode Integration. */
		PosScannerStartCapture( true );	
	} 
	
	var enableCustomerPreferenceBarcode = rootCtx.get("enableCustomerPreferenceBarcode");
	if((enableCustomerPreferenceBarcode == null) || (enableCustomerPreferenceBarcode.length <= 0)) {
		var customerPreferenceBarcodeConfig = rootHlp.findParamInSectionWide("enable","CustomerPreferenceBarcode");
		if((customerPreferenceBarcodeConfig == null) || (customerPreferenceBarcodeConfig.length <= 0) || (customerPreferenceBarcodeConfig != "true")) {
			rootCtx.set("enableCustomerPreferenceBarcode", null, true);
		}
		else {
			rootCtx.set("enableCustomerPreferenceBarcode", customerPreferenceBarcodeConfig, true);
		}
	}

	
	resetCountOfferRedeemRetries();

	PosSetSessionProperty("lastSelectedCOD", 0, "true"); // NVS-1639 - intitialize the "lastSelectdCOD" during the startup. 
	PosSetSessionProperty("Cashless3CutoverRequired", "false", true);

	rootCtx.set("TableServiceSelected", false);
	
    return(true);
}

/**onBeginFinalize
 *
 * @brief - This function handles onBeginFinalize event
 * Return - rval - True
 */
function onBeginFinalize()
{
     if(PosCheckSessionProperty("bAUSaleDisable","true")) {
          PosCloseStoreMessage();
     }
     return(true);
}

/* -returns true/false if item was already on reverseList */
function isReversed(transID, reverseList) {
	var hasID = false;
	for each (revID in reverseList) {
		if (transID == revID) {
			hasID = true;
			break;
		}
	}
	return hasID;
}

/**onBackFromTotal
 *
 * @brief - This function handles onBackFromTotal event
 * Return - rval - if it's true the caller is allowed to back from total
 */
function onBackFromTotal() {
     var curView = rootHlp.getCurrentView();
     if(curView == null) {
	      PosOffersBackFromTotal();
		//NVS-5482 - Order level offer can not be applied on KIOSK while the same offer can be applied on POS
		if (rootCtx.get("IS_NGK") != "true") {
	      PosBackFromTotalUndoOffer();
		}
	      PosBackFromTotalUndoPromotion(); 
          return(true);
     }
     var view = new XML(curView);
     if(null == view) {
	      PosOffersBackFromTotal();
		  //NVS-5482 - Order level offer can not be applied on KIOSK while the same offer can be applied on POS
		  if (rootCtx.get("IS_NGK") != "true"){
	      PosBackFromTotalUndoOffer();
		  }
	      PosBackFromTotalUndoPromotion(); 
          return(true);
     }
	
	/* clear fees */
	PosClearFee_COE();
	
	/* SDO-4800 -clear any local tax exemptions */ 
	rootCtx.set("ExemptLocalTax",false);
	
     if(String(view.@orderKey).search("N:") != -1) {
          // Skip Car
          PosShowMessage("MSG_BC_SKIPCAR_MODIFY");
          return(false);
     }

     var tenders    = view.ItemTenderView;
     if(tenders.length() == 0) {
	      PosOffersBackFromTotal();
		  //NVS-5482 - Order level offer can not be applied on KIOSK while the same offer can be applied on POS
			if (rootCtx.get("IS_NGK") != "true") {
	      PosBackFromTotalUndoOffer();
			} 
	      PosBackFromTotalUndoPromotion(); 
          return(true);
     }
     var electronicPayment = tenders.(cat == "TENDER_ELECTRONIC_PAYMENT");
     if(electronicPayment.length() == 0) {
	      PosOffersBackFromTotal();
	      //NVS-5482 - Order level offer can not be applied on KIOSK while the same offer can be applied on POS
			if (rootCtx.get("IS_NGK") != "true") {
	      PosBackFromTotalUndoOffer();
			}
	      PosBackFromTotalUndoPromotion(); 
          return(true);
     }

	/* SDE-2423 cancel the preswipe -SDE-2789 -only for FC*/
	if (PosCheckParameter("TCLExtension","esocket","true") && (!PosCheckSessionProperty("POD","DRIVE_THRU"))) {
		npTCLEvalEx("Everest_Operation 22 0 0");
	}

	/* attempt to reverse any cashless sales */
	if (PosCheckParameter("TCLExtension","esocket","true") || PosCheckParameter("Cashless3", "Active", "true")) {
		/* Issue change WWR-2517 by Felipe Ramas - GSS-190 */
		if(!PosCheckSessionProperty("POD","CSO")) {
			//NVS-234 RPS  05/10/2010
			rootCtx.set("msgTimeout",60000,false);
			PosShowMessage("Warning - You have chosen to modify an order that was partially tendered using one or more debit/credit/gift cards.  If you continue with modifying the order, then all cashless partial tenders will be reversed.", "_TIMEOUT:msgTimeout");
			PosItemSelection("YES.png|NO.png","1|0", "Warning", "Do you wish to continue with modifying this order?");
			if (Number(rootCtx.get("SelectedButtonValue")) == "0")
			{
				PosApplyOffers_COE();
				return(false);
			}
			while(!PosGetAuthorization("manager"));
			reversePartialTrans();
		} else {
			/* WWR-3976 - Change for don't reverse the payment accepted on kiosk - Felipe Ramas - GSS-190 */
			if(rootCtx.get("NGK_ORDER_REROUTE", "PAY_AT_COUNTER"))
			{
				PosDoStore(true, false);
			}else{
				reversePartialTrans();
			}
		}
	}

	if(PosCheckParameter("Cashless3", "Active", "true")) {
		StopCashlessSession();
	}
	
	//NVS-894
     //PosOpenCashDrawer(false);
	 PosOffersBackFromTotal();
	 //NVS-5482 - Order level offer can not be applied on KIOSK while the same offer can be applied on POS
	if (rootCtx.get("IS_NGK") != "true") {
	 PosBackFromTotalUndoOffer();
	}

	 PosBackFromTotalUndoPromotion(); 
	 PosOffersClearMessage();   /* NPO-270,NVS-1306 */

     return(true);
}


/**onCreateSale
 *
 * @brief - This function handles onCreateSale event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onCreateSale(tp,recall)
{
    var ret = true;
	var ctx = new SessionContext;
	var orderSource = rootHlp.GetOrderSrc();
     /* SDE-2275 -operator has to be logged in */
     if(!PosIsInSaleMode()) {
		 // Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications
		ctx.set("VariableTagID","");
		return false;
     }

     PosResetPinpad();
	PosScannerStartCapture(true);
	if (PosCheckParameter("Cashless3", "Active", "true")) {
	var resp = StartCashlessSession(true, true);

		// NVS-2062
		// If there is already a session open, we should close and open a new one
		if(resp != null && resp.RESULT_CODE == CASHLESS_SESSION_IN_PROGRESS) {
			StopCashlessSession();
			StartCashlessSession(true, true);
		}
	}
	
	// check if it isn't refund, waste or cashless refund
	if (!PosCheckTransactionKind("1") && !PosCheckTransactionKind("2") &&
		!PosCheckTransactionKind("7")) {
		PosSetCODRouting();
		if ((PosCheckSessionProperty("POD", "DRIVE_THRU") || PosCheckSessionProperty("POD", "WALK_THRU"))
			 && PosCheckSessionProperty("workingMode", "orderTaker|both")) {
			// NVS-6939: COD Collision - if COD is in use, try to set the other COD.
			ret = PosSetCOD(recall);
			if(orderSource == "1"){
				while (!ret) {
					var cod = rootCtx.get("activatedCOD");
					if (cod < 0) {
						var newCod = String(-cod);
						PosSetSessionProperty("activatedCOD", newCod, "true");
						ret = PosSetCOD(recall);
					} else {
						ret = true;
					}
				}
			}
		}
	}

	var nTandemBooth = rootCtx.get("tandemBooth")
	if(typeof(auxGetTandemNbrJS) == 'function') {
		nTandemBooth = auxGetTandemNbrJS();
	}
	if(PosCheckSessionProperty("walkLineMode","true") && (1 == nTandemBooth)) {
		PosSetWalkLineMode("false");
	}
	
     /* SDE-2146 -The kernel only clears the mem, we need to also clear the persistent */
    PosSetSessionProperty("CASHLESS","","true");
	//NVS-3948
	if (PosCheckParameter("TCLExtension","esocket","true") || PosCheckParameter("Cashless3", "Active", "true") || PosCheckParameter("NPScripts", "posCashless", "eftsim.nps")) {
		/* clear tenderID for start of sale SDE-2276 */
		PosSetSessionProperty("CASHLESS_TENDERID","","true");
		PosSetSessionProperty("CASHLESS_OPENDRAWER","0","true");
		PosSetSessionProperty("CASHLESS_STATUS","0","true");
		
		PosSetSessionProperty("CASHLESS_REVERSAL","","true");
		PosDoSetCustomInfo("CASHLESS_REVERSAL","");
		
		PosSetSessionProperty("CASHLESS_REVERSAL_AMT","","true");
		PosDoSetCustomInfo("CASHLESS_REVERSAL_AMT","");
		
		PosSetSessionProperty("CASHLESS_REVERSAL_PENDING","","true");		
		PosDoSetCustomInfo("CASHLESS_REVERSAL_PENDING","");
		
		PosSetSessionProperty("CASHLESS_REVERSAL_REFUND","","true");
		PosDoSetCustomInfo("CASHLESS_REVERSAL_REFUND","");
		
		/* For eSocket cashless, we need pre-swipe event call
		   SDE-2160 only send pre-swipe if not drive thru */
		if (PosCheckParameter("TCLExtension","esocket","true") && !PosCheckSessionProperty("POD","DRIVE_THRU")) {
			npTCLEvalEx("Everest_Operation 20 0 0");
		}
     }
	 // SDE-2600 - Make sure to clear out the PromoItemApproved session property
	 PosSetSessionProperty("PromoItemApproved", "false", true);
	PosSetSessionProperty("discountForPromoOrder","false","false");
	PosSetSessionProperty("ExemptLocalTax","false","false");
	//NVS-5297 JP Initializing these values for every sale
	PosSetSessionProperty("authorizedForQty", "false", true);
	PosSetSessionProperty("authorizedForAmt", "false", true);

	// Reset mobile order number indicator
	PosSetSessionProperty("MobileOrderNumberPrinted","false",true);
	// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications
	ctx.set("VariableTagID","");
	
	/*NVS-6925 - msilva - Clear tag ID and save previously selected*/
	ctx.set("TagIdRemoved", false);	
	ctx.set("TableServiceSelected", false);	
	
    return(ret);
}

/**onCreatedSale
 *
 * @brief - This function handles onCreatedSale event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onCreatedSale(tp,recall)
{
//	PosSetCOD(recall);
	PosScannerStartCapture(true);   // Not needed NVS-1601
	resetCountOfferRedeemRetries();
	//NVS-7325 Tishin Thomas
	rootCtx.set("CURRENTOFFERSCODE", "", true);
	return(true);
}

/**onPromoItem
 *
 * @brief - This function handles onPromoItem event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onPromoItem(tp)
{
	 // SDE-2600 See if we need to check for manager authorization
	 if(PosCheckSessionProperty("getAuthForPromoItem","true") && !PosCheckSessionProperty("PromoItemApproved", "true")) {
        if(!PosGetAuthorization("manager",false)) {
             // Not Authorized
            return(false);
        }
		PosSetSessionProperty("PromoItemApproved", "true", true);
     }


	if(PosCheckSessionProperty("POD","CSO")) {
		return(true);
	}
	var curView = rootHlp.getCurrentView();
	if(curView == null) {
		return(true);
	}
	var view = new XML(curView);
	if(null == view) {
		return(true);
	}

	// NVS-7370
	var custom = view.CustomInfo;
	if (custom == null) {
		PosSetSessionProperty("authorizedForAmt", "false", true);
		PosSetSessionProperty("authorizedForQty", "false", true);
	} else {
		PosSetSessionProperty("authorizedForAmt", custom.Info.(@name=="authorizedForAmt").@value.toString(), true);
		PosSetSessionProperty("authorizedForQty", custom.Info.(@name=="authorizedForQty").@value.toString(), true);
	}
	// SDO-15328 - NVS-5673
	var adTotalPriceGreatherThanZero; //NVS-7938
	var items=view.ItemView;
	var authLimits=rootHlp.getBusinessLimitsParam("PromoItemAuthorityLimits");
	var itemQty = 0; //NVS-8148
	var itemPromoQty = 0; 
	
	for(i=0; i < items.length(); i++) {
		var item=items[i];
		var bGiftCard = (item.quantity > 0) && (item.familyGroup == GIFT_COUPON) && (item.productType == NON_FOOD_PRODUCT) && (item.category == PAPER);
		var bGiftCert = (item.quantity > 0) && (item.familyGroup == GIFT_COUPON) && (item.productType == 9) && (item.category == PAPER);
		//NVS-871
		var bNonProduct = (item.familyGroup == NON_FOOD_PRODUCT);
		if (item.level == 0){//NVS-8148, only count parent product
			itemQty += Number(item.quantity); 
			itemPromoQty += Number(item.quantityPromo); 
		}
		
		if(item.currentSelected != "true") {
			if(false == adTotalPriceGreatherThanZero || (item.level == 0 && item.quantity > 0)) {			
				if(false == adTotalPriceGreatherThanZero && item.ADTotalPrice > 0) {
					// non promoted item have value
					adTotalPriceGreatherThanZero = true;
				}
			}
		} else {

			// adjust quantity to be promo
			var selQty = rootHlp.getQuantity();
			if(selQty == -1) {
				selQty = 1;
			}
			
			if((item.quantity - item.quantityPromo) > selQty && item.level == 0) {
				// Will promo only partially the item
				adTotalPriceGreatherThanZero = true;
			}
			
			// cannot promote a Gift Card / Gift Cert
			if(bGiftCard || bGiftCert) {
				PosShowMessage("MSG_BC_PROMO_GC");
				return(false);
			}
			
			//NPS 871
			// cannot promote a non product
			//NVS-6393 Sub/ask me can be promoted
			if (bNonProduct == true && item.level==0) {
				PosShowMessage("MSG_BC_DISCOUNT_NON_PRODUCT");
				return false;
			}
			
			if(null == items[i]) {
				return(true);
			}			
		}
	}

	 if("enable"==authLimits) {
		// NPS-5766 - enable this only for debug
		//API.SLog("LOGLEVL_DEBUG", "[onPromoItem] view ["+curView+"]");

		// NPS-5766
		var bReqAuthorization=false;
		var authorizationMsg="";
		var authLevel = "manager";

		if (!PosCheckSessionProperty("getAuthForPromoItem","true")) {
		//if (PosCheckParameter("UserInterface", "PromoItemAuthorityLevel", "true")) {
			authLevel = "crew";
		}
		//var authLevel=hlp.getBusinessLimitsParam("PromoItemAuthorityLevel");
		var bAcceptNegativeQty=false;
		var paramValue=rootHlp.findParamInSectionConfig("AcceptNegativeQty","Account");	// TODO: should get this from TLOG

		//API.SLog("LOGLEVL_DEBUG", "[onPromoItem] AcceptNegativeQty ["+paramValue+"]");
		//API.SLog("LOGLEVL_DEBUG", "[onPromoItem] PromoItemAuthorityLevel ["+authLevel+"]");

		if(("true"==paramValue)||("TRUE"==paramValue)) {
			bAcceptNegativeQty=true;
		}
		
		var isAuthorized = true;
		
		var bBlockMsg = false;
		var bBlockMsgPromoNbr = false;
		var bBlockMsgInvPromo = false;	

		//NVS-7938; NVS-8283 and NVS-9140, move last item order check
		if((false == adTotalPriceGreatherThanZero) || ((rootHlp.getQuantity() + itemPromoQty) >= itemQty) || ((itemQty - itemPromoQty) <= 1) && (rootHlp.getQuantity() != 0)) {//NVS-8253, allow revert promo (0 + Promo)		
			bBlockMsg = true;
			bBlockMsgPromoNbr = true;
		}			

		if("manager"==authLevel) {
			bReqAuthorization=true;
		}
		else if("crew"==authLevel) {
			var quantum=rootHlp.getQuantity();
			var promoQty=0;
			var promoAmount=new BigDecimal(0);
			var fatherQty=0;
			var fatherPromoQty=0;
			var fatherSelected=false;
			var lastFather=0;
			var iIndex;
			for (iIndex=0; iIndex<view.ItemView.length(); iIndex++) {
				var item = view.ItemView[iIndex];

				if(item.quantity!=0) {
					var meanUnitPrice=new BigDecimal(0);
					var totalPrice=new BigDecimal(item.totalPrice);
					var totalPriceBeforePromo=new BigDecimal(item.BPTotalPrice);
					var zeroBD=new BigDecimal(0);
					var itemQtty=new BigDecimal(lGetProductMultiplicity(view, iIndex, lastFather, true));
					if(0!=totalPriceBeforePromo.compareTo(zeroBD)) {
						// BPTotalPrice has the original total price
						meanUnitPrice=totalPriceBeforePromo.divide(itemQtty,6);
					}
					else {
						meanUnitPrice=totalPrice.divide(itemQtty,6);
					}
					if(0==Number(item.level)) {
						lastFather=iIndex;
						if(meanUnitPrice.compareTo(new BigDecimal(0))!=0) {		// can the meanUnitPrice be negative ?
							if(item.currentSelected != "true") {
								promoQty=promoQty+Number(item.quantityPromo);
								fatherSelected=false;
							}
							else {
								fatherSelected=true;
								if(quantum<0) {
									var itemQtyPromo=Number(item.quantityPromo);
									promoQty=promoQty+itemQtyPromo+1;
									if(itemQtyPromo>0) {
										promoAmount=promoAmount.add(new BigDecimal(item.BPTotalPrice));
										promoAmount=promoAmount.subtract(new BigDecimal(item.totalPrice));
									}
									// test if one more promo is possible
									if(itemQtyPromo>=Number(item.quantity)) {
										// more promos than items sold
										bBlockMsg = true;
										bBlockMsgInvPromo = true;
									}
								}
								else {
									promoQty=promoQty+quantum;
									meanUnitPrice=meanUnitPrice.multiply(new BigDecimal(quantum));
									// test if the the promo can be applied
									if(quantum>Number(item.quantity)) {
										// more promos than items sold
										bBlockMsg = true;
										bBlockMsgInvPromo = true;
									}
								}

								promoAmount=promoAmount.add(meanUnitPrice);
							}
						}
						fatherQty=Number(item.quantity);
						fatherPromoQty=Number(item.quantityPromo);
					}
					else {
						if(true==fatherSelected) {
							var totalPrice=new BigDecimal(item.totalPrice);
							var totalPriceBeforePromo=new BigDecimal(item.BPTotalPrice);
							var zeroBD=new BigDecimal(0);
							var isPriceGTZ=totalPrice.compareTo(zeroBD);
							var isPriceGTZBP=totalPriceBeforePromo.compareTo(zeroBD);

							if((item.quantity<0)&&(false==bAcceptNegativeQty)) {
								// do not accept negative qty
								isPriceGTZ=0;
								isPriceGTZBP=0;
							}

							// ignore cost inclusive items
							if((0!=isPriceGTZ)||(0!=isPriceGTZBP)) {
								var multiplicity=lGetProductMultiplicity(view, iIndex, lastFather, false);
								if(quantum<0) {
									multiplicity*=(fatherPromoQty+1);
								}
								else {
									multiplicity*=quantum;
								}
								meanUnitPrice=meanUnitPrice.multiply(new BigDecimal(multiplicity));
								promoAmount=promoAmount.add(meanUnitPrice);
							}
						}
					}

					if((fatherPromoQty>0)&&(false==fatherSelected)) {
						promoAmount=promoAmount.add(new BigDecimal(item.BPTotalPrice));
						promoAmount=promoAmount.subtract(new BigDecimal(item.totalPrice));
					}
				}
			}
			
			if(!bBlockMsg){
				// NPS-5766
				API.SLog("LOGLEVL_DEBUG", "[onPromoItem] total promo qtty ["+promoQty+"]");
				API.SLog("LOGLEVL_DEBUG", "[onPromoItem] total promo amount["+promoAmount.toString()+"]");

				var promoQtyLimit=rootHlp.getBusinessLimitsParam("PromoItemQuantityLimit");
				var promoAmtLimit=rootHlp.getBusinessLimitsParam("PromoItemAmountLimit");
				//NVS-6287 - msilva - Allow promo item when PromoItemQuantityLimit and PromoItemAmountLimit are not set, authority level = crew
				var isPromoLimitsNotSet = promoQtyLimit=="" && promoAmtLimit == "";
				
				if(isPromoLimitsNotSet && authLevel == "crew")
				{
					return true;
				}
				
				if(""==promoQtyLimit) {
					promoQtyLimit="99" //NVS-6665 23-JAN-2017 John Brancaleon - Change from global default to localized default
				}
				if(""==promoAmtLimit) {
					promoAmtLimit="999.99"  //NVS-6665 23-JAN-2017 John Brancaleon - Change from global default to localized default
				}

				API.SLog("LOGLEVL_DEBUG", "[onPromoItem] PromoItemQuantityLimit ["+promoQtyLimit+"]");
				API.SLog("LOGLEVL_DEBUG", "[onPromoItem] PromoItemAmountLimit ["+promoAmtLimit+"]");

				// NVS-7370
				if(promoQty > Number(promoQtyLimit) && (!PosCheckSessionProperty("authorizedForQty", "true"))) {
					isAuthorized = onPromoQuantityLimitExceededAuthorization();
				}
				// Lindomar Araujo - Jun/26/2017 - NVS-7781 - Changed to do not ask manager authorization for promotion amount if it's already provided for promotion quantity
				if (isAuthorized && promoAmount.compareTo(new BigDecimal(promoAmtLimit)) >= 0 && (!PosCheckSessionProperty("authorizedForAmt", "true") && !PosCheckSessionProperty("authorizedForQty", "true"))) {
					isAuthorized = onPromoAmountLimitExceededAuthorization();
				}
			}
		}
	}
	
	//NVS-9140: Check which message to show
	if (bBlockMsg){
		//PosShowMessage("authLevel: "+authLevel+" bBlockMsg: "+bBlockMsg+" bBlockMsgInvPromo: "+bBlockMsgInvPromo+" bBlockMsgPromoNbr: "+bBlockMsgPromoNbr);
		if(bBlockMsgInvPromo){
			// More promos than items sold
			PosShowMessage("MSG_BC_INVPROMO");
		} else if(bBlockMsgPromoNbr){
			// Cannot promo all the items in an order
			PosShowMessage("MSG_BC_PROMO_LAST_ITEM");
		}			
		
		return false;
	}
	
	if(isAuthorized == undefined)
		//For authLimits different than true as it was before
		return(true);
	else
		return(isAuthorized);
}

/**canAcceptTenderForFloatPrice
 *
 * @brief - Validates if the incoming tender has its category refused by configuration in transactions with float price items.
 * @return - TRUE - when the incoming tender is acceptable for this order transaction.
 * @since - NPS-5384
 * @author - Kalil
 */
function canAcceptTenderForFloatPrice(tenderId,amount,nTransactionType) {
	var refusedCategories = rootHlp.findParamInSectionConfig("refusedTenderCategories","FloatPrice");
	if ((refusedCategories != null && refusedCategories.length > 0) && (hasFloatPriceItems())) {
		var tenderXML = rootHlp.getTenderDescr(tenderId);
		try {
			var xml = new XML(tenderXML);
			var rtCategories = refusedCategories.split("|");
			for (var i=0; i<rtCategories.length;i++) {
				if (rtCategories[i] == xml.TenderCategory) {
					PosShowMessage("MSG_BC_FPTENDERNOTALLOWED");
					return false;
				}
			}
		} catch(ex) {
			var errorMsg = "Could not not handle tender validation for float price items, due to: " + ex;
			API.dbg(errorMsg);
			API.dbg(tenderXML);
			PosShowMessage(errorMsg);
		}
	}
	return true;

	/**hasFloatPriceItems
	 *
	 * @brief - Verifies if the current order has any float price item.
	 * @return - TRUE - if the order has at least one float price item.
	 * @since - NPS-5384
	 * @author - Kalil
	 */
	function hasFloatPriceItems() {
		var curView = rootHlp.getCurrentView();
		if (curView != null) {
			var view = new XML(curView);
			var items = view.ItemView;
			for (var i=0;i<items.length();i++) {
				if ((new Number(items[i].isFloatPrice)>0) && (new Number(items[i].quantity)>0)) {
					return true;
				}
			}
		}
		return false;
	}
}
/**onTender
 *
 * @brief - This function handles onTender event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onTender(tenderId,amount,nTransactionType) {

	if (!canAcceptTenderForFloatPrice(tenderId,amount,nTransactionType)) {
		// This tender is NOT acceptable for this transaction - NPS-5384
		return false;
	}
     if(TENDER_BILLABLE_SALE == Number(tenderId) && nTransactionType != ACC_OT_REFUND) {

          var curView = rootHlp.getCurrentView();
          if(curView == null) {
               return(auxShowMessageClearCalc("MSG_BC_NO_ORDER_IN_PROGRESS"));
          }
          var view = new XML(curView);
          if(view.@transactionKind == ACC_OT_MANAGER) {
               return(auxShowMessageClearCalc("MSG_BC_BILLABLE_EMP_MEAL"));
          }
          var items = view.ItemView;
          if(items.length() == 0) {
               return(true);
          }
          var giftCard = items.((quantity > 0) && (familyGroup == GIFT_COUPON) && (productType == NON_FOOD_PRODUCT) && (category == PAPER));
          var tenders    = view.ItemTenderView;
          if(giftCard.length() != 0 && tenders.length() != 0) {
               return(auxShowMessageClearCalc("MSG_BC_BILLABLE_GC"));
          }
          // Billable sale
          if(!PosGetAuthorizationJSUS("manager")) {
               PosHandleCalculatorButton("clear");
               return(false);
          }
     }
     return(true);
}

/**onVoidSale
 *
 * @brief - This function handles onVoidSale event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onVoidSale(keepOrder,replacePayment)
{
	 var keepCOD = PosCheckSessionProperty("KeepSelectedCODOnVoidSale", "true");
     if(replacePayment != null) {
	 if(!keepCOD){
         	PosShareCODJS(); // NVS-974
	 }
          return(true);
     }
     // Should be in Sale mode (operator logged and not alreday performing a transaction
     if(!PosIsInSaleMode()) {
          return(false);
     }
     // In U.S., can only cancel an order in progress
     if(PosNotATransactionInProgress(true)) {
          PosShowMessage("MSG_BC_NO_ORDER_IN_PROGRESS");
          return(false);
     }
     if(!PosCanVoidSaleJS()) {
          return(false);
     }
     if(!keepCOD){
     	PosShareCODJS(); // NVS-974
     }
	 resetCountOfferRedeemRetries();
     return(true);
}

/**onStoreInMemory
 *
 * @brief - This function handles onStoreInMemory event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onStoreInMemory()
{

	// Should be in Sale mode (operator logged and not alreday performing a transaction
	if(!PosIsInSaleMode()) {
		return(false);
	}

	if(!PosNotATransactionInProgress(true)) {
		PosShowMessage("MSG_BC_COMPLETE_FIRST");
		return(false);
	}


	var lastView = rootHlp.getLastSaleView();
	if(lastView == null) {
		PosShowMessage("MSG_BC_NO_ORDER_TO_STORE");
		return false;
	}

	var view = new XML(lastView);

	if((view.@transactionKind != ACC_OT_SALE && view.@transactionKind != ACC_OT_DISCOUNT) || view.@saleStatus < SALE_STATUS_PAID) {
		PosShowMessage("MSG_BC_INVALID_ORDER_TO_STORE");
		return false;
	}

	return(true);
}
/**auxShowMessageClearCalc
 *
 * @brief - auxiliary function to show message and clear calc
 * Return - false
 */
function auxShowMessageClearCalc(errMsg) {

     PosShowMessage(errMsg);
     PosHandleCalculatorButton("clear");
     return(false);
}

/**onDiscount
 *
 * @brief - This function handles onDiscount event, it checks if it's possible to apply a discount!
 * Where: discountType - type of discount:   1-normal\n
 *                                                     2-crew meal\n
 *                                                     3-manager meal\n
 * Return - rval - if it's true the caller is allowed to continue
 */
function onDiscount(discountId,discountType) {


     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(auxShowMessageClearCalc("MSG_BC_NO_ORDER_IN_PROGRESS"));
     }
     var view = new XML(curView);
     if(view.@transactionKind == ACC_OT_DISCOUNT || view.@transactionKind == ACC_OT_CREW || view.@transactionKind == ACC_OT_MANAGER) {
          return(auxShowMessageClearCalc("MSG_BC_2DISCOUNTS"));
     }
     var items = view.ItemView;
     if(items.length() == 0) {
          return(true);
     }

     // get total amount
     var TotalAmount = Number(view.@totalAmount);

     // total amount must be > 0 to be able to apply discount
     if (TotalAmount <= 0) {
          PosShowMessage("MSG_BC_NODISC_ZERO_AMT");
          return(false);
     }

     var giftCard = items.((quantity > 0) && (familyGroup == GIFT_COUPON) && (productType == NON_FOOD_PRODUCT) && (category == PAPER));
     if(giftCard.length() != 0) {
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_GC"));
     }
     var giftOrCoupon = items.((quantity > 0) && (familyGroup == GIFT_COUPON));
     if(giftOrCoupon.length() != 0) {
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_COUPON"));
     }
	if("true"!=rootHlp.findParamInSectionConfig("AllowNonProductDiscount","Cash"))
	{
     var NonProduct = items.((quantity > 0) && (isGrillLine != "true") && (familyGroup == NON_FOOD_PRODUCT));
     if(NonProduct.length() != 0) {
          return(auxShowMessageClearCalc("MSG_BC_DISCOUNT_NON_PRODUCT"));
		}
     }
	 
	/* NVS-623 -prevent manager/crew meal after coupons */ 
	if ((discountId == 2) || (discountId == 3)) { 
		var tenders    = view.ItemTenderView;
		var numTenders = tenders.length();
		if (numTenders != 0) {
			/* NVS-623 -prevent too many coupons from being applied */
			for (i=0; i<numTenders; i++){
				if(tenders[i].cat == "TENDER_GIFT_COUPON"){
					return(auxShowMessageClearCalc("MSG_BC_CREWMRGDISC"));       // NVS-1120
				}
			}
		}	 
	} 

	//NVS-582 RPS see if called from PosPromoOrderJS don't check for authorization if true
	if (!PosCheckSessionProperty("CalledFromPromoOrder" , "true")) {
		if(!PosCheckSessionProperty("getAuthForForDiscountOrder","false")) {
			if(!PosGetAuthorizationJSUS("manager", false)) {
				/* Not Authorized */
				PosHandleCalculatorButton("clear");
				return(false);
			}
		} else { 
			/* NVS-1162 -correctly report the manager ID */ 
			rootHlp.getSavedManagerId();
		} 
	}

	/* CLEAR any fees from the sale first if 100% discount NVS-*/
	if (StoreDBXML == null) { getStoreDB_CSL(); } 

	paramNode =StoreDBXML.StoreDB.DiscountTables.DiscountTable.(DiscountId==discountId);
	if (paramNode != null) {	
		if (paramNode.DiscountRate == 100) {
			PosClearFee_COE();
		}
	} 
	
     return(true);
}

/**onChangeTaxMode
 *
 * @brief - This function handles onChangeTaxMode event, it checks if it's possible to change sale tax mode!
 * Where: nMode - string - (numeric value) 0-Tax 1-No Tax 2-Exempt
 * Return - rval - if it's true the caller is allowed to continue
 */
function onChangeTaxMode(nMode) {

     if(nMode == 0) {
          return(true);
     }
     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(auxShowMessageClearCalc("There is no order in progress"));
     }
     /*
     var view = new XML(curView);
     if((view.@transactionKind != ACC_OT_SALE) && (view.@transactionKind != ACC_OT_MANAGER) && (view.@transactionKind != ACC_OT_CREW)) {
          return(auxShowMessageClearCalc("It isn't allowed to apply NO TAX key to current sale"));
     }
     */
    // NPS-5397  RPS 09/04/09  Yet again
	if(nMode == 2 && !PosGetAuthorizationJSUS("manager")) {
          PosHandleCalculatorButton("clear");
          return(false);
     }
     return(true);
}

/**onSetCDrawerOpMode
 *
 * @brief - This function handles onSetCDrawerOpMode event, it checks if it's possible to change cash drawer operation mode!
 * Where: nMode - string - (numeric value) 0-Normal 1-Forced
 *          drawers - string - not used
 * Return - rval - if it's true the caller is allowed to continue
 */
function onSetCDrawerOpMode(nMode,drawers) {

     if((1 == nMode) && !PosGetAuthorizationJSUS("manager")) {
          return(false);
     }
     return(true);
}

/**onDrawerClosing
 *
 * @brief - This function handles onDrawerClosing event, the closing of a cash drawer
 * Where: bAuthorized - boolean - true:autorized false:not authorized
 *          nPOSState - int - POS State
 *          nSaleStatus - int - Sale Status
 * Return - rval - if it's true the caller is allowed to continue
 */
function onDrawerClosing(bAuthorized,nPOSState,nSaleStatus) {


	if(bAuthorized && (POS_STA_OPLOGGED == nPOSState) && (UNDEFINED_SALE_STATUS == nSaleStatus)) {
		if(!PosCheckTransactionKind(1) && !PosCheckTransactionKind(2)) { 

			// NVS-664  RPS 10-24-2011
			// If FC counter we need to check for autoPreview, if DT check autoRecall
			var ParameterName;
			if (PosCheckSessionProperty("POD","FC") ) {
				ParameterName = "autoPreview";
				SectionName = "UserInterface";
			} else {
				ParameterName = "autoRecall";
				SectionName = "operationMode";
			}
			if(PosCheckParameter(SectionName, ParameterName, "true")) { 
				PosDoAutoRecallJS(); 
				PosHandleRecallScreen("Refresh"); 
			} 
		} 
	} 

	//  If this drawer close is After SKIM process
        if (PosCheckSessionProperty("SkimInProgress","true")) {

		// Clear SKIM in progress flag (The flag is set from the workflow)
		PosSetSessionProperty("SkimInProgress","false");
	}

	return(true);
}

/**onRecalledByPreview
 *
 * @brief - This function handles onRecalledByPreview event, a order that was recalled by preview
 * Return - rval - if it's true the caller is allowed to continue
 */
function onRecalledByPreview()
{
	 // Check if this Order is already PAID by HHOT
	 if(PosCheckSessionProperty("StoreAccountMode", "6")) {
	 	return(true);
	 }

     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(true);
     }
     var view = new XML(curView);
     if(null == view) {
          return(true);
     }
	 
	 //NVS-3480 - [DRM] KIOSK C1:While recalling Kiosk orders from FC, system shows an pop message (Message Key) asking user to provide tag id.
	 //Check if order needs the TagId
	 if (!PosCheckSessionProperty("POD","DT")){
		 // Non-CYT orders when recalled goes to Tender Screen, CYT orders get back to Sales Screen - Felipe Ramas/Marcelo Tripoli - NVS-3418
		 if(PosHasCYTProductInSale(true) && PosVerifyTagId() && !hlp.isPromoOrder() ) // NVS-3896
		 {
			/* Ensure for tagid */
			PosDoBackFromTotal();  
			PosShowScreen(rootCtx.get("baseScreenId"));
			return false;
		 }
	 }
	 PosSetSaleType(view.@type); //NVS-3870 Promotions
     if(PosDoTotal()) {
		  
			//NVS-6999 / NVS-7068 - msilva- Displays Delivery Tender Menu Screen
			if(isUberEatsOrder()){
				//NVS-8498
				var isSkipCar = false;
				if(view.@transactionKind == ACC_OT_SKIP_CAR){
						ShowHomeDeliveryTenderScreen();
						isSkipCar = true;
						return(false);
				}
				
				if(!isSkipCar){
					//Displays Delivery Tender Menu Screen
					ShowUberEatsDeliveryTenderScreen();
					return(false);
				}			
			}else{
				if(view.@transactionKind == ACC_OT_SKIP_CAR) {
				   PosDoTenderJS(0,-1,'NOPREVIEW');
				   return(true);
				}		
			}	
		  
			//NVS-772 RPS 1/24/2012
			if(rootHlp.isPromoOrder()) { 
				//Turn off the get authorization to discount 
				PosSetSessionProperty("discountForPromoOrder","true","false"); 
				PosSetSessionProperty("CalledFromPromoOrder","true","false");
				PosDoPromoOrder(); 
				//Turn on the get authorization to discount 
				PosSetSessionProperty("discountForPromoOrder","false","false"); 
			} 

			var ret = PosDoBeforeTenderScreenJS();


			if ( !rootHlp.isPromoOrder() ) { // NVS-3896
				/*NVS-4865 - msilva - Adjustments for async offers evaluation*/
				PosApplyOffers_COE(false);
			}
			
			// Lindomar Araujo - Oct/06/2016 - NVS-5428 - Changed to call the RMHC donation feature for DT recalled orders
			if(PosCheckSessionProperty("saleRecalled","true")) {
				if(PosCanSuggestDonationJS()) {
					PosRMHCdonation();
				}
			}
			return (ret);

          
     } else {
          /* total failed, return to basescreen */
         PosShowScreen(rootCtx.get("baseScreenId"));
     }
     return(false);
}

/**onRecalled
 *
 * @brief - This function handles onRecalled event, a order that was recalled
 * Return - rval - if it's true the caller is allowed to continue
 */
function onRecalled() {
//   PosCommStatusCOD("MSG_BC_ERRORSETCOD");
	if((PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) && PosCheckSessionProperty("workingMode","orderTaker|both")) {
		PosSetCOD(1);
	}
     var curView = rootHlp.getCurrentView();
     if(curView == null) {
          return(true);
     }
     var view = new XML(curView);
     if(null == view) {
          return(true);
     }
     
	 // NVS-7370
	var custom = view.CustomInfo;
	if (custom == null) {
		PosSetSessionProperty("authorizedForAmt", "false", true);
		PosSetSessionProperty("authorizedForQty", "false", true);
	} else {
		PosSetSessionProperty("authorizedForAmt", custom.Info.(@name=="authorizedForAmt").@value.toString(), true);
		PosSetSessionProperty("authorizedForQty", custom.Info.(@name=="authorizedForQty").@value.toString(), true);
	}
     /* NVS-753 -make sure any fees are cleared after recall */ 
     //PosClearFee_COE();
	
	if(!PosValidatePromoOrder("manager", false)) {
		//PosDoVoidSale(true);
		//PosSetSessionProperty("discountForPromoOrder","false","false");  //NVS-670  removed for NVS-801
		PosDoBackFromTotal();  // NVS-584  10-04-2011  RPS
        PosShowScreen(rootCtx.get("baseScreenId"));
		return false;
	} else if(PosDoCheckOpenChoices()) {
		PosSetSessionProperty("discountForPromoOrder","false","false");  //NVS-892
	} else {
		PosSetSessionProperty("discountForPromoOrder","true","false");  //NVS-670
	}
	
	var isAuthorized = PosCheckSessionProperty("authorizedForQty", "true") || PosCheckSessionProperty("authorizedForAmt", "true");
	if(!isAuthorized && !PosValidatePromoItem()) {
		//PosDoVoidSale(true);
		PosDoBackFromTotal();  // NVS-584  10-04-2011  RPS
        PosShowScreen(rootCtx.get("baseScreenId"));
		return false;
	}
	
	//NVS-873
	while (!PosDoValidateLimits(false));
		
	PosSetSaleType(view.@type);   //NVS-3870 Promotions
     if((view.@tenderAction & TA_CASHLESS_SIGN) != 0) {
          PosDoTotal();
          PosDoTenderJS(0,-1,"NOPREVIEW|SAVE");
          return(false);
     }
     return(true)
}

/**onStore
 *
 * @brief - This function handles onStore event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onStore(bTandemEnabled,nTandemMode,nTandemBooth,szCurOrderId, nMinor) {

	// Saves last order
	gsLastOrderID = gsCurrOrderID;
     PosSetCODRouting();
	//SDE-1665 - Tandem Speaker-Multi Orders from secondary should not require order Override
	if(bTandemEnabled && (TANDEM_INLINE == nTandemMode) && (nTandemBooth > 1) && (nMinor == 0) && PosCheckSessionProperty("walkLineMode","false")) {
          PosQueryStsQueueByTandem((SALE_STATUS_STORED|SALE_STATUS_RECALLED|SALE_STATUS_NON_ACCOUNTING/*|SALE_STATUS_TENDERED|SALE_STATUS_PAID*/),1,szCurOrderId);
     }
     //PosShareCODJS(); // NVS-974    - code fix removed for NVS-1344
     return(true);
}

/**onEndOfSale
 *
 * @brief - This function handles onEndOfSale event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onEndOfSale(bTandemEnabled,nTandemMode,nTandemBooth,szCurOrderId, nMinor) {

     PosSetCODRouting();
     PosShareCODJS(); // NVS-974

	 //NVS-7718 - msilva
	 PosSetDonationInfo();
	 
	//SDE-1665 - Tandem Face to Face-Multi Orders from secondary should not require order Override
     if(PosCheckSessionProperty("POD","DRIVE_THRU") && bTandemEnabled && (TANDEM_FACE == nTandemMode) && (nTandemBooth > 1) && (nMinor == 0)) {
          // SDE-1666 SALE_STATUS_PAID included
          PosQueryStsQueueByTandem((SALE_STATUS_START|SALE_STATUS_IN_PROGRESS|SALE_STATUS_ON_TOTAL|SALE_STATUS_TOTALIZED|SALE_STATUS_GRILLING|SALE_STATUS_STORED|SALE_STATUS_RECALLED|SALE_STATUS_NON_ACCOUNTING|SALE_STATUS_TENDERED|SALE_STATUS_PAID),1,szCurOrderId);
     }
     return(true);
	 
}

function onEndOfSaleExit(rc)
{
	var ret = true;
	resetCountOfferRedeemRetries();
	//Testing if it is needed to print the Concilliation Report
	if((PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU")) &&
	PosCheckSessionProperty("workingMode","cashier")) {
		if(rootHlp.GetOrderSrc() == '1' && rootHlp.GetMobileOrderStatus() == MOS_AUTHORIZED) {
			ret = PosGenRecReport();
		}
	}
	
	return (ret);
}

/**onSelIndex
 *
 * @brief - This function handles onSelIndex event, a selection in the sale list
 * Return - rval - if it's true the caller is allowed to continue
 */
function onSelIndex(index) {
	if (PosCheckSessionProperty('EXT_UI','true')) {
		return true;
	}
     if(PosCheckSessionProperty("POD","CSO") && (!PosCheckSessionProperty("CanChangeIndex","true"))) {
          return(false);
     }
    PosEndSmartReminder();
	return(true);
}
//NPS-4873
/**onSelectedItem
 *
 * @brief - This function handles onSelelectedIndex event, a selection in the sale list is completelly done
 * Return - rval - if it's true the caller is allowed to continue
 */
function onSelectedItem() {

	if(PosCheckSessionProperty("isSmartReminderON","TRUE")) {
		return(true);
	}

	if(PosCheckSessionProperty("PromoOrderInProgress","true"))
	{
		return false;
	}

	var curView = rootHlp.getCurrentView();

	if(curView == null) {
		return(true);
	}
	var view = new XML(curView);
	if(null == view) {
		return(true);
	}

	if(view.@saleStatus==SALE_STATUS_START || view.@saleStatus==SALE_STATUS_IN_PROGRESS || view.@saleStatus==SALE_STATUS_GRILLING) {
		// Handle printing of mobile order number if required
		BTPrintOrderNumber(view.@orderId);

		if(!PosShowGrillFloatScreen(false)) {
				PosHideFloatScreen();
			}
		}
	
	if (PosCheckCurrentScreen(8051)) {;
		PosShowScreen(8051);
	}


	return(true);
}

function BTPrintOrderNumber(OrderNumber)
{
	if (PosCheckSessionProperty("BlueToothConnected", "true") && PosCheckSessionProperty("MobileOrderNumberPrinted", "false")) {
		if (OrderNumber != null && OrderNumber != "") {
			var RetValue = PosRunOSCommand("E:/BThPrintOrderNumber.exe " + OrderNumber);
			PosSetSessionProperty("MobileOrderNumberPrinted", "true", true);
		}
	}
}
/* NVS-4916 John Brancaleon 31-Aug-2016 12-Sep-2016 [Corrected to Patch 9]
*  This function will determine if a plugin is available i.e. iCashless
*  31-Aug-2016 12-Sep-2016 [Corrected to Patch 9]
*  
*/
function isCashlessPluginAvailable() {
	var testResult;
	try {
		var myPlugin = GetCashlessService();
		testResult = myPlugin.Call("Ping");
	} catch (e) {
		testResult = false;

	}
	return testResult;
}

/**onDayOpened
 *
 * @brief - This function handles onDayOpened event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onDayOpened(pOpenMode,pLevel) {
	DayOpenPED20();

	/* reset session variables */
	PosSetSessionProperty("KPAROLLBACK_DONE","false",true,true);
     if((pOpenMode=="execute") && ((pLevel=="remote") || (pLevel=="forced"))) {
		if(PosCheckParameter("OperationMode","restartAfterOpen","true")) {
               // Restart After Open
               PosShutdown("91", "remote", "false");
		}
	}

     /* SDE-2229 -set the business date session. */
     d = new NPDate();
     var cdate = d.getDate();
     if (cdate < 10)     cdate = "0"+cdate.toString();

     var cmonth = d.getMonth()+1;
     if (cmonth < 10)     cmonth = "0"+cmonth.toString();

     var cyear = d.getFullYear().toString();

     businessDate = cyear+cmonth+cdate;
     PosSetSessionProperty("BUSINESSDATE", businessDate, true);

	PosSetSessionProperty("PED_OPEN_FAILUE", "false", true);

	if((pOpenMode=="execute") ) {
		if(PosCheckParameter("Cashless3", "Active", "true")) {
			//NVS-4916 31-AUG-2016 John Brancaleon - Check for the plugin to be available before trying to open the PED
			if(isCashlessPluginAvailable()) {
				// NVS-5336 RPS If the DayOpenPED doesn't work, we don't take any action here.  It is dealt with later when a user logs in
				// Otherwise we run into problems if, for example, the PED is disconnected.
				if (DayOpenPED() == true) {
					var posTerminal = "POS" + GetPosNumber();
					PosShowMessage("MWT_CASHLESS_OPEN_SUCCESS", posTerminal);
				}
			} else {
				// Restart After Open
				PosShutdown("91", "remote", "false");
			}
		}
	} 

	SetEnableCustomerBarcodePreferences(true);
     return(true);
}

function DisplayPEDOpenFailure()
{
	var ctx =new SessionContext;
	ctx.set("waitForever","0",false);
	
	var posTerminal = "POS" + GetPosNumber();
	
	PosShowMessage("MWT_CASHLESS_MANUAL_OPEN_FAILED", posTerminal, "_TIMEOUT:waitForever");
}

function GetPosNumber()
{
	var posDB;
	// parsing XML
	try {
		posDB	= new XML(API.getPosdb());
	} catch (e) {
		// parser error
		return("00");
	}

	var posNumber = posDB.Services.Service.(@type == "POS").@name;
	
	return posNumber
}
/**onLoadScreen
 *
 * @brief - This function handles onLoadScreen event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onLoadScreen(scrNbr) {

     var curMode=0;
     if((900<=Number(scrNbr)) && (1000>Number(scrNbr))) {
          curMode=1; // Manager Mode
     }
     // npAdpTlog_RequestSrv(Service,Type,parameters,..);
     npAdpTlog_RequestSrv(NPSRVTLOG_API_SET_STATE,ADPTLOG_INT_MANAGER_MODE,curMode);
     return(true);
}

/**onGrillStart
 *
 * @brief - This function handles onGrillStart event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onGrillStart(maxGrill) {

	 rootHlp.resetQuantity();

     var qtty=rootHlp.getQuantity();
     if(qtty >= 0) {
          if(maxGrill < qtty) {
               rootHlp.resetQuantity();
               PosDoQuantum(maxGrill);
               PosShowMessage("MSG_BC_GRILLMAXQTTY",qtty,maxGrill);
          }
     }
     return(true);
}

/**onGrillOperStart
 *
 * @brief - This function handles onGrillOperStart event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onGrillOperStart(maxGrill) {

     return(true);
}

/**onLoginOperator
 *
 * @brief - This function handles the first step in loggin
 * Return - rval - if it's true the caller is allowed to continue
 */
function onLoginOperator(bRemote,id) {


	CheckForPEDOpen();
	var operatorLoginMethod = rootHlp.findParamInSectionWide("operatorLoginAuthentication","Security");
     	if(bRemote && (id != null) && (id != undefined)) {
		rootHlp.getUserInfo(id,2);
		if(!rootHlp.validateUser(id,null,0,true)) {
			return(false);
		}
          return(true);
     }

     // Asks working mode, in case of DT
     var workingMode=auxAskWorkMode("Login as Secondary Cashier");
     if((workingMode != null) && (workingMode[0] != null)) {
          rootCtx.set("workingMode",workingMode[0],true);
          if(workingMode[1] != null) {
               rootCtx.set("tandemBooth",workingMode[1],true);
          }
          else {
               var tdBooth=rootHlp.findParamInSectionConfig("tandemBooth","PosType");
               rootCtx.set("tandemBooth",tdBooth,true);
          }
     }
	
	var ret = false;
	if (operatorLoginMethod == "biometric") {
		var isOperationalCmd = "AuthIsOperational";
		if (executeBC(isOperationalCmd)) {
			var identifyCmd = "AuthIdentify";
			if (executeBC(identifyCmd, [0, "MSG_BC_PROMPTBIO", "true"])) {
				ret = true;
			}
			else {
				var reason = getLastFail(verifyCmd);
				if (reason == "MSG_AUTH_TIMEOUT") {
					PosShowMessage("MSG_BC_AUTH_TIMEOUT");
				} else if (reason == "MSG_AUTH_CANCELLED") {
					PosShowMessage("MSG_BC_AUTH_CANCELLED");
				} else {
					PosShowMessage("MSG_BC_INVBIOAUTH");
				}
			}
		
			// adaptor is operational -- don't fall through to login auth 
			return ret;
		} // else fall through to login
	} else if (operatorLoginMethod == "token") {
		var isOperationalCmd = "AuthIsOperational";
		if (executeBC(isOperationalCmd)) {
			var verifyCmd = "AuthVerify";
			if (executeBC(verifyCmd, [0, "MSG_PROMPTOP", "true"])) {
				ret = true;
			}
			else {
				var reason = getLastFail(verifyCmd);
				if (reason == "MSG_AUTH_TIMEOUT") {
					PosShowMessage("MSG_BC_AUTH_TIMEOUT");
				} else if (reason == "MSG_AUTH_CANCELLED") {
					PosShowMessage("MSG_BC_AUTH_CANCELLED");
				} else {
					PosShowMessage("MSG_BC_INVTOKENAUTH");
				}
			}
		
			// adaptor is operational -- don't fall through to login auth 
			return ret;
		} // else fall through to login
	} else if (operatorLoginMethod != "login") {
		var cmd = "AuthDefaultToLogin";
		executeBC(cmd, ["Invalid operator login method configured", operatorLoginMethod]);
		//PosShowMessage("Invalid operator login mode \"" + managerAuth + "\": reverting to legacy authorization."); 
		managerAuth = "login";
	}
	
     // Gets user id
     var sIdtf=rootHlp.showCalculator("MSG_PROMPTOP",1);
     if(sIdtf.length == 0) {
          return(false);
     }
     // Checks operator validity
     nOperSecurityLevel=rootHlp.getUserInfo(sIdtf,2);
     if(!rootHlp.validateUser(sIdtf,null,0,true)) {
          // Reset needs at least a floor manager
          PosShowMessage("MSG_INVPASSWD");
          return(false);
     }
     return(true);
}

function CheckForPEDOpen()
{

	// First of all this only applies to cashless 3
	if(PosCheckParameter("Cashless3", "Active", "true")) {
	
		// see if the PED has opened
		if (PosCheckSessionProperty("PED_OPEN_FAILURE", "true")) {
			var ctx =new SessionContext;
			ctx.set("waitForever","0",false);

			var posTerminal = "POS" + GetPosNumber();
	

			PosShowMessage("MWT_CASHLESS_OPEN_FAILED", posTerminal, "_TIMEOUT:waitForever");
		}
	
	}
}

/**onLoginRemOperator
 *
 * @brief - This function handles the first step in loggin
 * Return - rval - if it's true the caller is allowed to continue
 */
function onLoginRemOperator(nbrPOS) {

	
	// NPS-9722 - Remote login of FOE node in RPS Service uses the auto-login parameters
	var skipOperator = false;
	if(nbrPOS != undefined && nbrPOS != null && nbrPOS != "") {
		var posList = rootHlp.getSWPosList();
		if (posList != null) {
			var posListXML = new XML(posList);
			if (null != posListXML) {
				var i = 0;
				for (i = 0; i < posListXML.PosList.Pos.length(); i++) {
					if(posListXML.PosList.Pos[i].@id == nbrPOS) {
						if(posListXML.PosList.Pos[i].@node.toString().toUpperCase() == "FOE" || posListXML.PosList.Pos[i].@alias.toString().substr(0,3).toUpperCase() == "FOE") {
							skipOperator = true;
							break;
						}
					}
				}
			}
		}
	}		
	
	if(!skipOperator) {
     // Gets user id
     var sIdtf=rootHlp.showCalculator("MSG_PROMPTOP",1);
     if(sIdtf.length == 0) {
          return(false);
     }
     // Checks operator validity
     if(!rootHlp.validateUser(sIdtf,null,0,true)) {
          PosShowMessage("MSG_INVPASSWD");
			return(false);
		}
	}
     return(true);
}

/**onInitialFloat
 *
 * @brief - This function checks if should ask for an initial float or use 0 
 * @param bRemote - String - "true" to indicate remote login (default:"false").
 * @param initialFloat - String - Optional, initial float amount.[1.20]
 * @param autoLogin - String - Optional, "true" to indicate auto login (default:"false").[1.20]
 * Return - rval - if it's true the caller should ask for a value
 */
function onInitialFloat(bRemote) {

     var pod=rootCtx.get("POD");
	 //NVS-57 don't get float for MOT device
	if (PosCheckParameter("PosType", "IsMOT", "true") == true) {
		return(false);
	}
     if(("HOT" == pod) || (bRemote && (("CSO" == pod) || ("CK" == pod) || ("CKD" == pod))) || ((("DT" == pod) || ("WT" == pod)) && (rootCtx.get("workingMode") == "orderTaker"))) {
          return(false);
     }
     return(true);
}

/**auxValidDtMode
 *
 * @brief - This function validates DT Mode
 * Return - rval - if it's true the caller is allowed to continue
 */
function auxValidDtMode() {

     // Validates FacexFace DT tandem mode...
     var pod=rootCtx.get("POD");
     if(("DT" == pod) && (rootCtx.get("tandemEnable").toString() == "true") && (Number(rootCtx.get("DTStoreMode")) == 1)) {
          var test=0;
          if(PosGetLoggedInPOS()) {
               var loggedin=rootCtx.get("loginDTPosition");
               if(loggedin != null) {
                    if(loggedin.indexOf("1") > 0) {
                         test|=1;
                    }
                    if(loggedin.indexOf("2") > 0) {
                         test|=2;
                    }
               }
          }
          switch(test) {
               case 1:
                    // Primary already logged-in
                    if(Number(rootCtx.get("tandemBooth")) != 1) {
                         test=0;
                    }
                    break;
               case 2:
                    // Secondary already logged-in
                    if(Number(rootCtx.get("tandemBooth")) != 2) {
                         test=0;
                    }
                    break;
               case 3:
                    if((Number(rootCtx.get("tandemBooth")) != 1) && (Number(rootCtx.get("tandemBooth")) != 2)) {
                         test=0;
                    }
                    break;
          }
          if(test != 0) {
               return(false);
          }
     }
     return(true);
}

/**onConfirmLogin
 *
 * @brief - This function confirms login
 * Return - rval - if it's true the caller is allowed to continue
 */
function onConfirmLogin(bRemote,name,currency,value) {

     if(bRemote) {
          return(true);
     }
     // Confirms login
     var sConfMsg=rootHlp.getSysMessage("MSG_BC_LOGINCONF",name,currency,value);
     if(!PosShowConfirmationMessage(sConfMsg,"MSG_YES","MSG_NO")) {
          return(false);
     }
     if(!auxValidDtMode()) {
          PosShowMessage("MSG_DT_LOGIN_TANDEM_ERR");
          return(false);
     }
     return(true);
}

/**onLoginFinalize
 *
 * @brief - This function handles the finalization of login process
 * Return - rval - if it's true the caller is allowed to continue
 */
function onLoginFinalize(bRemote,errorMessage) {

     if(!bRemote) {
          if(errorMessage.length != 0) {
               PosShowMessage(errorMessage);
               return(false);
          }

          var result;
          if (PosCheckParameter("TCLExtension","esocket","true")) {
              // Open socket, Server INIT
               result=npTCLEvalEx("Everest_Operation 1 0 0");
          }

          return(true);
     }
     
	// Remote cmd
	if(PosCheckSessionProperty("POD","CSO")) {
		PosActivateScreenSaver(2);
	}
	 
     var result;		// Init PED for both local and remote login's NVS-2956
     if (PosCheckParameter("TCLExtension","esocket","true")) {
          // Open socket, Server INIT
          result=npTCLEvalEx("Everest_Operation 1 0 0");
     }
     
     return(true);
}

/**onLogoutFinalize
 *
 * @brief - This function handles the finalization of logout process
 * Return - rval - if it's true the caller is allowed to continue
 */
function onLogoutFinalize(bRemote,success) {

     if(bRemote && success && PosCheckSessionProperty("POD","CSO")) {
          PosActivateScreenSaver(1);
     }

     var result;
     if (PosCheckParameter("TCLExtension","esocket","true")) {
          // Terminal close, server Close
          result=npTCLEvalEx("Everest_Operation 2 0 0");
     }

	 /*NVS-4287 - msilva*/
	 if(PosCheckParameter("Cashless3", "Active", "true")) {
		var message = rootHlp.findParamInSectionConfig("laneClosedMessage","Cashless3");
		if (message == null) {
			message = "This register is closed";
		}		 
		ChangeIdleMessage(message);
	 }	 

	// Lindomar Araujo - Sep/21/2016 - NVS-5317 - Changed to clear the offer information in salepanel when logged out operator.
	PosOffersClearMessage();
     return(success);
}

/**onConfirmLogout
 *
 * @brief - This function confirms login
 * Return - rval - if it's true the caller is allowed to continue
 */
function onConfirmLogout(bRemote,name) {

     // Confirms logout
     if(!bRemote) {
          var sConfMsg=rootHlp.getSysMessage("MSG_BC_LOGOUTCONF",name);
          if(!PosShowConfirmationMessage(sConfMsg,"MSG_YES","MSG_NO")) {
               return(false);
          }
     }
     // Rolls back tandem booth to original configuration
     var tdBooth=rootHlp.findParamInSectionConfig("tandemBooth","PosType");
     rootCtx.set("tandemBooth",tdBooth,true);
     return(true);
}

function onConfirmProceed(bRemote,name) {

	var sConfMsg=rootHlp.getSysMessage("MSG_CDC_OPEN_ORDERS");
	if(!PosShowConfirmationMessage(sConfMsg,"MSG_YES","MSG_NO")) {
		return(false);
	}
	return(true);
}

/**onChangeDtWorkingMode
 *
 * @brief - This function validates change in DT mode
 * Return - rval - if it's true the caller is allowed to continue
 */
function onChangeDtWorkingMode(bRemote,name,currency,value) {

     if(!auxValidDtMode()) {
          PosShowMessage("MSG_DT_CHANGE_MODE_ERR");
          return(false);
     }
     return(true);
}

/**onDeniedVoidLine
 *
 * @brief - This function handles onDeniedVoidLine event
 * Return - rval - false if shoud force a void line, true if not
 */
function onDeniedVoidLine() {
	if (PosCheckSessionProperty('EXT_UI','true')) {
		return (false);
	}
     if(!PosCheckSessionProperty("POD","CSO")) {
          return(true);
     }
     return(!PosShowConfirmationMessage("MSG_BC_CANC_ITEM","MSG_YES","MSG_NO"));
}

/**onTenderAccepted
 *
 * @brief - This function handles onTenderAccepted event
 * Return - rval - true
 */
function onTenderAccepted() {

     PosSetSessionProperty("TenderAccepted","true");
 	if(PosCheckParameter("Cashless3", "Active", "true")) {
		CleanStateFile();
	}

     return(true);
}

/**onCheckScreenSound
 *
 * @brief - This function handles load of sounds when screens are loaded
 * Return - rval - true allows the caller to play the default sound
 */
function onCheckScreenSound(scrNbr,nVisit,sound) {

     if((null==sound) || (sound.length==0) || PosCheckSessionProperty("NoSound","true")) {
          // No sound at all
          return(false);
     }
     var index=sound.indexOf("=");
     if(index < 0) {
          // generic sound, allow the screen loader play it
          return(true);
     }
     index=sound.indexOf(nVisit,index);
     if(index >= 0) {
          // Sound configured for this visit
          var index1=sound.lastIndexOf(";",index);
          if(index1 >= 0) {
               index1++;
          }
          else {
               index1=0;
          }
          index=sound.indexOf("=",index1);
          if(index > index1) {
               PosPlaySound(sound.substring(index1,index));
          }
     }
     return(false);
}

function onCheckforFaceToFaceTandem() {  //added for NVS-1716
     var pod=rootCtx.get("POD");
     if(("DT" == pod) || ("WT" == pod)){
          if(("DT" == pod) && (rootCtx.get("tandemEnable").toString() == "true") && (Number(rootCtx.get("DTStoreMode")) == TANDEM_FACE)) {
               // Face x Face
               return(true);
		   }
      }
     return(false);
}
// -------------------------------------- Script Hooks/Events --------------------------------
/**onDoSaleJS
 *
 * @brief - This function validates a item sale
 * Return - rval - true allows the caller to continue
 */
function onDoSaleJS() {

  if (!onCheckforFaceToFaceTandem())
  {
          // check if it isn't refund, waste  or cashless refund
          if(!PosCheckTransactionKind("1") && !PosCheckTransactionKind("2") &&
             !PosCheckTransactionKind("7")) {
               if(!PosIsCODSelectedJS()) {
				PosSizeSelection(-1);//NPS-5843
				PosRefreshButtons();//NPS-5843
                    PosShowMessage("MSG_BC_SELECTCOD");
                    return(false);
               }
          }
     }
     return(true);
}

/**onSaleStartJS
 *
 * @brief - This function validates the begining of a sale
 * Return - rval - true allows the caller to continue
 */
function onSaleStartJS() {
     // check the COD serial communication status
     PosCommStatusCOD("MSG_BC_ERRORSETCOD1");
     return(true);
}

/**onSndRcvStore
 *
 * @brief - This function returns the used tandem booth
 * Return - rval - tandem booth (instead of usual true/false)
 */
function onSndRcvStore() {

     // auxGetTandemNbrJS function might not exist in a local configuration!
     if(typeof(auxGetTandemNbrJS) == 'function') {
          return(auxGetTandemNbrJS());
     }
     // default
     return(0);
}

/**onItemListPOS
 *
 * @brief - This function returns a string with a single item to be shown onItemListPOS on a POS List
 * @param - nType - 0->list for cash drawer, 1->list for remote detach, 2->list for logged-in, 3->list for loggin
 * @param - szNumber - POS number in format POSXXXX
 * @param - online - 0->offline, 1->online
 * @param - state - Pos States POS_STA_INVALID,POS_STA_CLOSED,...
 * @param - dtPosition - 0->none, 1->primary, 2->secondary
 * @param - szOperator - operator name
 * @param - szAliasList - list in used service (service name,service alias|...)
 * @param - detached - 0->non-detached, 1->detached	(SDO-2849)
 * Return - rval - string with a single item to be shown onItemListPOS on a List, each item MUST begin wit the POS Id with 7 positions (POSXXXX)
 */
function onItemListPOS(nType,szNumber,online,state,dtPosition,szOperator,szAliasList,detached) {

     // Invoke event handler before clean up the sale
     var hideLine="";
     var lineRet="";
     var sDtPosition="";
     var textState="";
	/* SDO-2849: It checks if the current POS is detached. */
	/* If not, it checks the current state of the node */
	if ( 0 == detached )
	{
     switch(nType) {
     case 0:
          if((state != POS_STA_OPLOGGED) && (state != POS_STA_BLOCKOP)) {
               hideLine="!";
          }
          break;
     case 1:
          if((online != 0) || (POS_STA_BLOCKOP == state)) {
               hideLine="!";
          }
          break;
     case 2:
          if((online != 0) && (POS_STA_OPLOGGED == state) || (POS_STA_BLOCKOP == state)) {
               hideLine="!";
               sDtPosition="DTP:"+dtPosition;
          }
          break;
     case 3:
          if((0 == online) || (state != POS_STA_OPENED)) {
               hideLine="!";
          }
          break;
     }
     switch(state) {
          case POS_STA_OPLOGGED:
          case POS_STA_BLOCKOP:
               textState="";
               break;
          case POS_STA_CLOSED:
               textState="closed";
               break;
          case POS_STA_OPENED:
               textState="opened";
               break;
          case POS_STA_BLOCKED:
               textState="blocked";
               break;
          default:
               textState="unknown";
     }
     var bOnline=(0 == online)?"offline":"online";
     if((POS_STA_OPLOGGED == state) || (POS_STA_BLOCKOP == state)) {
          lineRet=hideLine+szNumber+"["+bOnline+":"+szOperator+"]"+sDtPosition;
     }
     else {
          lineRet=hideLine+szNumber+" ["+bOnline+" - "+textState+"]";
     }
     if(3 == nType) {
          var aux=lineRet;
          lineRet="";
          szNumber=szNumber.slice(3);
          var ind=szAliasList.indexOf(szNumber);
          if(ind >= 0) {
               var ind2=szAliasList.indexOf(",",ind);
               if(ind2 >= 0) {
                    var aux2=szAliasList.substr(ind2+1,3);
					if("CSO" == aux2.toUpperCase() || "FOE" == aux2.toUpperCase()) {
                         lineRet=aux;
                    }
               }
          }
     }
	}
	/* SDO-2849: If so, just inform the user that current POS is detached */
	else
	{
		lineRet="!"+szNumber+" [detached]";
	}
	/* SDO-2849: END */
     return(lineRet);
}


function cashlessConvertion(tenderView) {	//NPM - 1815
	API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [S]", "BCEvents.nps");				

	PosSetSessionProperty(CASHLESS,"");	

	var cardType = "CR";
	var auth = "******";
	var providername = "";
	var cardnum = "";
	var expire = "";
	var seqno = "";
	var msg = "";
	var receiptContent = "";
	var Account=0;
	var printFlag="0";
	var StoreNumber = ""; //NVS-8999, NVS-9481
	var GCBalance="";
	var MerchantID = "";
	var GiftCard_Footer = GLOBAL_STOREDB.Adaptors.Adaptor.(@type == "npCLayer").Section.(@name == "AdditionalGiftCard").Parameter.(@name == "contact").@value; //NVS-8999
	
	if ((tenderView != null) && (tenderView.length > 0)) {
		var TenderRoot = new XML(tenderView);
		if (TenderRoot != null) {

			providername = TenderRoot.Cashless.@cardProvider;
			cardnum = TenderRoot.Cashless.@cardNumber.toString();
			cardnum = cardnum.replace("@","0x41");
			expire = TenderRoot.Cashless.@expire;
			auth = TenderRoot.Cashless.@authorization;
			seqno = TenderRoot.Cashless.@sequenceNumber;
			printFlag = TenderRoot.Cashless.@printFlag;
			Account = TenderRoot.Cashless.@account;
			value = TenderRoot.@value;

			API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] providername: [" + providername + "]  - cardnum: [" + cardnum + "] - expire [" + expire + "] - auth: [" + auth + "] - seqno: [" + seqno + "] - printFlag: [" + printFlag + "] - Account: [" + Account + "] - value : [" + value + "]", "BCEvents.nps");				
			
			CashLessStr = formatCashlessString(providername, cardnum, expire, auth,
									printFlag, seqno, MerchantID, GCBalance, Account,
									value, StoreNumber, GiftCard_Footer); 

			
			API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [R] CashLessStr = [" + CashLessStr + "]", "BCEvents.nps");				
	
			PosAppendSessionProperty(CASHLESS,CashLessStr,true);
		}
	}

	API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [E]", "BCEvents.nps");				

	return true;
}

function PosCashlessConvertion(tender) {	//NPM - 1815
	API.STTDebugLog("0","[BCEvents.nps::PosCashlessConvertion] [S]", "BCEvents.nps");				
	var tempRetVal=cashlessConvertion(tender);
	API.STTDebugLog("0","[BCEvents.nps::PosCashlessConvertion] [E]", "BCEvents.nps");				
	return(tempRetVal);
}

/**onConvertFOE2View
 *
 * @brief - This function converts the FOE XML to a NP6 View
 * @param - sIn - string ->the FOE XML string representation
 * @return - rval - string representing the View XML
 */
function onConvertFOE2View(sIn,originalFOE,MobileOrderLocation,OrderKey){ 
	var xmlIn = null;
	var xmlView = null;
	var hasOnlyMCCProducts;

	try {
		if(sIn==null) {
		    sIn='<ProdInfo/>';
		}

		xmlIn = new XML(sIn);
		xmlView = new XML('<View/>');

		//TODO : check Header
		//xmlIn.Header.@command;
		//xmlIn.Header.@version;

		//TODO : check mandatory fields

		//Order Element
		if((xmlIn.Order.@orderSrc == 1 ) || (xmlIn.Order.@orderSource == 1)) {
			if(xmlIn.Order.@deliveryBillableSale == "true" && xmlIn.Order.@customerNickname == "UberEats" && xmlIn.Order.@shortCode != undefined && xmlIn.Order.@longCode != undefined){
			var foehlp = new FOEHelper();
			var autoTotalize = API.findParamInSectionWide("autoTotalizeFOEOrders","OperationMode");
			//Configure to modify paid order replacing invalid tender to default tender type
			foehlp.ModifyInvTenderPaidOrders(true);
			if(autoTotalize == "true"){
				foehlp.DoAutoTotalStoredOrders(true);
				}
			}
        	}
		//Enabling autoRecall
		if((xmlIn.Order.@orderSrc == 1 ) || (xmlIn.Order.@orderSource == 1)){	
			xmlView.@accountMode = "ToAccount";
		}
		//NPS-4686 - COC Store 3017 Hung order on DT expo, can't be bumped off.
		var okIndexCount=0;
		var orderKeyFirstPart = xmlIn.Order.@podName.toString();
		if(xmlIn.Order.@tableId && xmlIn.Order.@tableId.toString() != '') {
			orderKeyFirstPart='FOE';
			for(okIndexCount=(4-xmlIn.Order.@tableId.toString().length); okIndexCount>0; okIndexCount--) {
				orderKeyFirstPart += '0';
			}
			orderKeyFirstPart += xmlIn.Order.@tableId.toString();
		}

		xmlView.@orderKey 			= (OrderKey != undefined && OrderKey != "" ? OrderKey : orderKeyFirstPart + ':' + xmlIn.Order.@localOrderKey);
		//NVS-6394 - msilva
		xmlView.@EcpOrderId	= xmlIn.Order.@localOrderKey; 
		xmlView.@operatorId			= xmlIn.Order.@operatorId;
		xmlView.@operatorName       = xmlIn.Order.@operatorName;
		xmlView.@pod                = xmlIn.Order.@pod;
		//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
		//var isUnattended = Number(xmlIn.Order.@pod) == Number(PodDefinitions.COLD_KIOSK);
		var isUnattended = (xmlIn.Order.@status == "128") && xmlIn.Order.Tender && xmlIn.Order.Tender.length() > 0;
		var containsOffer = false;
		xmlView.@remPod             = xmlIn.Order.@remPod;
		xmlView.@podName            = xmlIn.Order.@podName;
		xmlView.@major              = xmlIn.Order.@major;
		xmlView.@minor              = xmlIn.Order.@minor;
		xmlView.@saleStatus         = xmlIn.Order.@status;
		xmlView.@trackSaleStatus    = xmlIn.Order.@trackStatus;
		xmlView.@transactionKind    = xmlIn.Order.@transactionKind;
		xmlView.@trxSubKind         = xmlIn.Order.@trxSubKind;
		xmlView.@saleDate           = xmlIn.Order.@saleDate;
		xmlView.@saleTime           = xmlIn.Order.@saleTime;
		xmlView.@businessDay        = xmlIn.Order.@businessDate;
		//View/ItemView/dayPart
		xmlView.@forceKVSDisplay    = xmlIn.Order.@forceKVSDisplay=='true'||xmlIn.Order.@forceKVSDisplay=='TRUE'?'1':'0';
		xmlView.@disabChoices       = xmlIn.Order.@disabChoices;
		xmlView.@type               = xmlIn.Order.@type;
		xmlView.@taxMode            = xmlIn.Order.@taxMode;
		//TODO : Verify which total is the one to be used
		/* NVS-7591 */
		if (xmlIn.Order.Promotions.length() == 0) { 		
			xmlView.@totalAmount        = xmlIn.Order.@totalAmount;
			xmlView.@totalTax           = xmlIn.Order.@totalTax;
		}
		xmlView.@grossAmount        = xmlIn.Order.@grossAmount;
		xmlView.@ManagerID          = xmlIn.Order.@ManagerID;
		xmlView.@checkOnly          = xmlIn.Order.@checkOnly;
		xmlView.@tableTagId         = xmlIn.Order.@tableTagId;
		xmlView.@tableServiceArea = xmlIn.Order.@tableServiceArea;
		xmlView.@tableServiceZoneId = xmlIn.Order.@tableServiceZoneId;
		xmlView.@tableServiceId = xmlIn.Order.@tableServiceId;
		//NPS-11237 - FOE failover
		xmlView.@originalFOE		= originalFOE;
		//NPS-11814 - Midnight Menu
		xmlView.@multipleMenuType	= xmlIn.Order.@multipleMenuType;		
		//BVS with mobile
		if(xmlIn.Order.@tableTagId != undefined)
		{
			xmlView.@tableTagId = xmlIn.Order.@tableTagId.toString();
		}
		if(xmlIn.Order.@tableServiceArea != undefined)
		{
			xmlView.@tableServiceArea = xmlIn.Order.@tableServiceArea.toString();
		}
		if(xmlIn.Order.@tableServiceZoneId != undefined)
		{
			xmlView.@tableServiceZoneId = xmlIn.Order.@tableServiceZoneId.toString();
		}
		if(xmlIn.Order.@tableServiceId != undefined)
		{
			xmlView.@tableServiceId = xmlIn.Order.@tableServiceId.toString();
		}
		if(xmlIn.Order.@tableServiceMode != undefined)
		{
			xmlView.@tableServiceMode = xmlIn.Order.@tableServiceMode.toString();
		}
		if(xmlIn.Order.@orderSrc == 1 || xmlIn.Order.@orderSource == 1){  //NVS-8302 code fix start - Kalpesh
			if(xmlIn.Order.@tableTagId != undefined){
				if((xmlIn.Order.@tableTagId == "-1") || (xmlIn.Order.@tableTagId == "") || (xmlIn.Order.@tableTagId == "0") || (xmlIn.Order.@tableTagId == null))
				{
					xmlView.@tableServiceMode = "";
				}				
				else if(Number(xmlIn.Order.@tableTagId) > 0)
				{					
					xmlView.@tableServiceMode = "locatorDevice";
				}
				//Special case for mobile order because we are getting -1 for tableTagId from eCP
				if(xmlView.@tableTagId.toString() == "-1" || xmlView.@tableTagId.toString() == "" || xmlView.@tableTagId.toString() == "0")
				{
					var checkInData = xmlIn.Order.@checkInData.toString();
					var locationType = checkInData.substr(12, 1);
					var PODtype = checkInData.substr(10, 2);
					//POD type 04 is cold Kiosk for curbside - so checkin data has stall number not table tag ID in it, so we need to ignore it.
					if(checkInData.length == 16 && locationType == "1" && PODtype != "04") 
					{
						var tagIdNumber = checkInData.substr(13, 2)
						xmlView.@tableTagId = tagIdNumber;
					}else if(checkInData.length == 17 && locationType == "1" && PODtype != "04"){
						var tagIdNumber = checkInData.substr(13, 3)
						xmlView.@tableTagId = tagIdNumber;
					}				
					if(Number(xmlView.@tableTagId) > 0)
					{					
							xmlView.@tableServiceMode = "locatorDevice";
					}	
				}
			}
		}  //NVS-8302 code fix end - Kalpesh
		
		//Setting orderSrc
		if(xmlIn.Order.@orderSource != undefined)
		{
			xmlView.@orderSrc 	= xmlIn.Order.@orderSource.toString();
		}
		else if(xmlIn.Order.@orderSrc != undefined)
		{
			xmlView.@orderSrc	= xmlIn.Order.@orderSrc.toString(); // MOT-237
		}
		
		if(xmlIn.Order.@shortCode != undefined)
		{
			xmlView.@shortCode = xmlIn.Order.@shortCode;
		}
		if(xmlIn.Order.@longCode != undefined)
		{
			xmlView.@longCode = xmlIn.Order.@longCode;
		} 
		/* if(isUberEatsOrder()){ */
		if(xmlIn.Order.@deliveryBillableSale == "true" && xmlIn.Order.@customerNickname == "UberEats" && xmlIn.Order.@shortCode != undefined && xmlIn.Order.@longCode != undefined) {
				var HomedeliverID = xmlIn.Order.@shortCode.toString() + xmlIn.Order.@longCode.toString();
		       	xmlView.@homeDeliveryOrderId = HomedeliverID.toUpperCase();
			//NVS-8495 - Set UberEats price for Auto Injected orderSource
			UberEatsUpdateProdinfoSaleType(xmlView);
				
		}
		/* } */
		// NPS-9722 - FOE modifications for Austrian Mobile Ordering - FC part
		// NPS-9744 - FOE modifications for Austrian Mobile Ordering - DT part
		if(xmlIn.Order.@orderSource && xmlIn.Order.@orderSource.toString()=='3') {	// Mobile Application  Austria
			if(xmlIn.Order.@remPod.toString()=='0') { // FC - set the attribute 'accountMode' to ACMODE_ACCOUNT_FOE
				xmlView.@accountMode='8';
			}
			if(xmlIn.Order.@remPod.toString()=='1') { // DT - set the attribute 'MobileOrderStatus' to 'SUBMITTED'.
				xmlView.@MobileOrderStatus=MOS_SUBMITTED;
			}
		}
		
		if(xmlIn.Order.@orderSource && xmlIn.Order.@orderSource.toString()=='4') {	// Mobile Application  France
			if(xmlIn.Order.@remPod.toString()=='0') { // FC - set the attribute 'accountMode' to ACMODE_ACCOUNT_FOE
				xmlView.@accountMode='8';
			}
			if(xmlIn.Order.@remPod.toString()=='1') { // DT - set the attribute 'MobileOrderStatus' to the value of the attribute 'location'.
				if(xmlIn.Order.@location && xmlIn.Order.@location.toString()!='') {
					xmlView.@MobileOrderStatus=MOS_SUBMITTED;
					xmlView.@MobileOrderLocation=xmlIn.Order.@location.toString();
				}
			}
		}
		
		//Testing if it is a Mobile Order 2.5 operation
		if(xmlIn.Order.@orderSrc && xmlIn.Order.@orderSrc.toString() == '1')
		{
			//NVS-4821 - msilva
			var isMobileCheckin = API.findParamInSectionWide("enableCheckinNotification","OperationMode");	
			
			if( isMobileCheckin == "true" ) { 
				xmlView.@MobileOrderStatus	= MOS_SUBMITTED; 
			} 
			else { 
				xmlView.@MobileOrderStatus	= (xmlIn.Order.@paymentType == "0" ? MOS_NONE : MOS_SUBMITTED); 
			}
			xmlView.@paymentType = xmlIn.Order.@paymentType; 

			// NVS-7920 SCRIPT CHANGE base on NPS-21623
			if(xmlIn.Order.@customerId) {
				xmlView.@foreignOrderCustomerId = xmlIn.Order.@customerId;
			}
			if(xmlIn.Order.@localOrderKey) {
				xmlView.@foreignOrderId = xmlIn.Order.@localOrderKey
			}
			
			//Setting account mode
			if(xmlIn.Order.@remPod.toString() != '1')
			{
				xmlView.@accountMode='8'; // set the attribute 'accountMode' to ACMODE_ACCOUNT_FOE
			}
			// Adds the Customer Id and Customer Nickname parameters to the CustomInfo tag.
			// MOT-155 - FOE - The customer's id and nickname should be added to the sale view generated by the FOE. 
			var customInfoTag = new XML('<CustomInfo />');
			var customerIdInfo = new XML('<Info />');
			customerIdInfo.@name = "customerId";
			customerIdInfo.@value = xmlIn.Order.@customerId;
			customInfoTag.appendChild(customerIdInfo);
			var customerNicknameInfo = new XML('<Info />');
			customerNicknameInfo.@name = "customerNickname";
			if (xmlIn.Order.@customerNickname == undefined || xmlIn.Order.@customerNickname == "")
				customerNicknameInfo.@value = " ";
			else
			customerNicknameInfo.@value = xmlIn.Order.@customerNickname;
			customInfoTag.appendChild(customerNicknameInfo);
			// Adding the Customer tag
			var customerTag = new XML('<Customer />');
			if (xmlIn.Order.@customerId != undefined) {
				customerTag.@id = xmlIn.Order.@customerId;
			}
			/* if (xmlIn.Order.@customerNickname == undefined || xmlIn.Order.@customerNickname == "")
				customerTag.@nickname = " ";
			else
				customerTag.@nickname = xmlIn.Order.@customerNickname; */
			//NVS-8271 - temporary solution
			customerTag.@nickname = " ";	
			if (xmlIn.Order.@greeting != undefined) {
				customerTag.@greeting = xmlIn.Order.@greeting;
			}
			xmlView.appendChild(customerTag);

			//Setting external services
			var ExecutePaymentUrl = new XML('<Info />');
			ExecutePaymentUrl.@name = "ExecutePaymentDT";
			var CancelPaymentUrl = new XML('<Info />');
			CancelPaymentUrl.@name = "CancelPaymentDT";
			for each (Service in xmlIn.ExternalServices.Service)
			{
				if(Service.@name.toString() == "ExecutePaymentDT")
				{
					ExecutePaymentUrl.@value = Service.@url;
				}
				else if(Service.@name.toString() == "CancelPaymentDT")
				{
					CancelPaymentUrl.@value = Service.@url;			
				}
			}
			customInfoTag.appendChild(ExecutePaymentUrl);
			customInfoTag.appendChild(CancelPaymentUrl);
			//Adding orderId
			var OrderId = new XML('<Info />');
			OrderId.@name = "OrderId";
			OrderId.@value = xmlIn.Order.@localOrderKey;
			customInfoTag.appendChild(OrderId);
			// Adds the Is Paid Mobile Order parameter to the custom info tag.
			// MOT-223 - ORB - For paid orders, the printed pick-list (when bumped by mini-orb) must be as the receipt layout
			var paidMobileOrderInfo = new XML('<Info />');
			paidMobileOrderInfo.@name = "isPaidMobileOrder";
			if ((xmlIn.Order.@orderSrc == "1") && (xmlIn.Order.@status == "128")) {
				paidMobileOrderInfo.@value = "true";
			} else {
				paidMobileOrderInfo.@value = "false";
			}
			customInfoTag.appendChild(paidMobileOrderInfo);
			
			// Adds the isMobileOrder parameter to the custom info tag.
			// NVS-7101 JP
			var isMobileOrderInfo = new XML('<Info />');
			isMobileOrderInfo.@name = "isMobileOrder";
			isMobileOrderInfo.@value = "true";
			customInfoTag.appendChild(isMobileOrderInfo);
			// Adds the Check In Data parameter into the custom info.
			// MOT-253 - FOE - Add a "checkInData" parameter to the Custom Info tag 
			var checkInDataInfo = new XML('<Info />');
			checkInDataInfo.@name = "checkInData";
			checkInDataInfo.@value = xmlIn.Order.@checkInData;
			customInfoTag.appendChild(checkInDataInfo);
			
			//UberEats NVS-6999 - msilva - UberEats Integration 
			var deliveryBillableSaleInfo = new XML('<Info />');			
			deliveryBillableSaleInfo.@name = "deliveryBillableSale";
			deliveryBillableSaleInfo.@value = xmlIn.Order.@deliveryBillableSale;
			customInfoTag.appendChild(deliveryBillableSaleInfo);			

			//NVS-8151 - msilva - CustomInfo in order to identify unattended mobile orders
			var isMobileUnattendedOrderInfo = new XML('<Info />');			
			isMobileUnattendedOrderInfo.@name = "isMobileUnattendedOrder";
			isMobileUnattendedOrderInfo.@value = isUnattended;
			customInfoTag.appendChild(isMobileUnattendedOrderInfo);			

			// Adding Tender Information
			// MOT - 329
			// NPM-2321 - NPM 2.75.2 - No authorization code included in .DAT for depleted Arch Card where authorization code is '000000'
			var tendercode = new XML('<Info />');
			tendercode.@name = "tendercode";
			var tenderQty = new XML('<Info />');
			tenderQty.@name = "tenderQty";
			var tenderValue = new XML('<Info />');
			tenderValue.@name = "tenderValue";
			var tenderCashlessCardProv = new XML('<Info />');
			tenderCashlessCardProv.@name = "tenderCashlessCardProv";
			var tenderCashlessCardNum = new XML('<Info />');
			tenderCashlessCardNum.@name = "tenderCashlessCardNum";
			var tenderCashlessExpire = new XML('<Info />');
			tenderCashlessExpire.@name = "tenderCashlessExpire";
			var tenderCashlessPrintFlag = new XML('<Info />');
			tenderCashlessPrintFlag.@name = "tenderCashlessPrintFlag";
			var tenderCashlessAuth = new XML('<Info />');
			tenderCashlessAuth.@name = "tenderCashlessAuth";
			var tenderCashlessAccount = new XML('<Info />');
			tenderCashlessAccount.@name = "tenderCashlessAccount";
			
			/* NVS-1191 added missing sales data */ 
			var tenderCashlessSeqNo = new XML('<Info />');
			tenderCashlessSeqNo.@name = "tenderCashlessSeqNo";
			//NVS-8105, tenderCashlessSeqNo displayed twice in report
			//tenderCashlessSeqNo.@value = xmlIn.Order.Tender.cashless.@seqNo;

			var tenderCashlessAmount = new XML('<Info />');
			tenderCashlessAmount.@name = "tenderCashlessAmount";
			//NVS-8105, tenderCashlessAmount displayed twice in report
			//tenderCashlessAmount.@value = xmlIn.Order.Tender.@value;

			
			for each (var tenderNode in xmlIn.Order.Tender)
			{
				if (tendercode.@value != undefined)
				{
					tendercode.@value = tendercode.@value.toString() + "|";
				}
				if (tenderQty.@value != undefined)
				{
					tenderQty.@value = tenderQty.@value.toString() + "|";
				}
				if (tenderValue.@value != undefined)
				{
					tenderValue.@value = tenderValue.@value.toString() + "|";
				}
				if (tenderCashlessCardProv.@value != undefined)
				{
					tenderCashlessCardProv.@value = tenderCashlessCardProv.@value.toString() + "|";
				}
				if (tenderCashlessCardNum.@value != undefined)
				{
					tenderCashlessCardNum.@value = tenderCashlessCardNum.@value.toString() + "|";
				}
				if (tenderCashlessExpire.@value != undefined)
				{
					tenderCashlessExpire.@value = tenderCashlessExpire.@value.toString() + "|";
				}
				if (tenderCashlessPrintFlag.@value != undefined)
				{
					tenderCashlessPrintFlag.@value = tenderCashlessPrintFlag.@value.toString() + "|";
				}
				if (tenderCashlessAuth.@value != undefined)
				{
					tenderCashlessAuth.@value = tenderCashlessAuth.@value.toString() + "|";
				}
				if (tenderCashlessAccount.@value != undefined)
				{
					tenderCashlessAccount.@value = tenderCashlessAccount.@value.toString() + "|";
				}
				if (tenderCashlessSeqNo.@value != undefined)
				{
					tenderCashlessSeqNo.@value = tenderCashlessSeqNo.@value.toString() + "|";
				}
				if (tenderCashlessAmount.@value != undefined)
				{
					tenderCashlessAmount.@value = tenderCashlessAmount.@value.toString() + "|";
				}
				
				tendercode.@value = tendercode.@value.toString() + tenderNode.@code.toString();
				tenderQty.@value = tenderQty.@value.toString() + tenderNode.@qty.toString();
				tenderValue.@value = tenderValue.@value.toString() + tenderNode.@value.toString();
				tenderCashlessCardProv.@value = tenderCashlessCardProv.@value.toString() + tenderNode.cashless.@cardProv.toString();


				var cardNumber = tenderNode.cashless.@cardNum.toString();
				var qtyDigits = 0;
				if (cardNumber.length < 4)
				{
					qtyDigits = 4 - cardNumber.length;
					for(var ct=0;ct < qtyDigits; ct++) {
						cardNumber = '*' + cardNumber;
					}
				}
				else
				{
					cardNumber = tenderNode.cashless.@cardNum.substring(cardNumber.length -4, cardNumber.length);
				}
			
				tenderCashlessCardNum.@value = tenderCashlessCardNum.@value.toString() + cardNumber;

				tenderCashlessExpire.@value = tenderCashlessExpire.@value.toString() + tenderNode.cashless.@expire.toString();
				tenderCashlessPrintFlag.@value = tenderCashlessPrintFlag.@value.toString() + tenderNode.cashless.@printFlag.toString();
				tenderCashlessAuth.@value = tenderCashlessAuth.@value.toString() + tenderNode.cashless.@auth.toString();
				tenderCashlessAccount.@value = tenderCashlessAccount.@value.toString() + tenderNode.cashless.@account.toString();
				tenderCashlessSeqNo.@value = tenderCashlessSeqNo.@value.toString() + tenderNode.cashless.@seqNo.toString();
				tenderCashlessAmount.@value = tenderCashlessAmount.@value.toString() + tenderNode.@value.toString();
			}
			
			customInfoTag.appendChild(tendercode);
			customInfoTag.appendChild(tenderQty);
			customInfoTag.appendChild(tenderValue);
			customInfoTag.appendChild(tenderCashlessCardProv);
			customInfoTag.appendChild(tenderCashlessCardNum);
			customInfoTag.appendChild(tenderCashlessExpire);
			customInfoTag.appendChild(tenderCashlessPrintFlag);
			customInfoTag.appendChild(tenderCashlessAuth);
			customInfoTag.appendChild(tenderCashlessAccount);
			customInfoTag.appendChild(tenderCashlessSeqNo);
			customInfoTag.appendChild(tenderCashlessAmount);
			
			//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
			if ( isUnattended && (( xmlIn.Order.@totalDiscount != null && xmlIn.Order.@totalDiscount != undefined && xmlIn.Order.@totalDiscount != "" && xmlIn.Order.@totalDiscount !="0") &&
				 ( xmlIn.Order.@totalBD != null && xmlIn.Order.@totalBD != undefined && xmlIn.Order.@totalBD != "" && xmlIn.Order.@totalBD !="0") &&
				 ( xmlIn.Order.@discountType != null && xmlIn.Order.@discountType != undefined && xmlIn.Order.@discountType != "" && xmlIn.Order.@discountType !="0") &&
				 ( xmlIn.Order.@discountId == "0"))) 
			{
				//NPM-2277
				xmlView.@transactionKind = 5;	//ACC_OT_DISCOUNT

				//MOT-362 Basic Promotions
				var totalDiscount = new XML('<Info />');
				totalDiscount.@name = "totalDiscount";
				totalDiscount.@value = xmlIn.Order.@totalDiscount;
				customInfoTag.appendChild(totalDiscount);	
				if (xmlIn.Order.@discountType == "2")
				{
					//Total discount percent
					var totalDiscountPercent = new XML('<Info />');
					totalDiscountPercent.@value = 0;
					totalDiscountPercent.@name = "totalDiscountPercent";
					var IsUsingNewRFMParameters = false;
					if (rootStoreDB.@useNewRFMParameters.toString() == "true")
					{
						IsUsingNewRFMParameters = true;
					}
					if (IsUsingNewRFMParameters)
					{
						var tableDiscount = rootStoreDB.StorePromotionDiscounts.Discount;
					}
					else
					{
						var tableDiscount = rootStoreDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "PromotionalDiscountTable");
					}
					if (tableDiscount != undefined 	&&
						tableDiscount != null		&&
						tableDiscount != "" )
					{		
						totalDiscountPercent.@value = getDiscountPercent(xmlIn.Order.@discountType, xmlIn.Order.@totalBD, xmlIn.Order.@totalDiscount ); //extract
					}
					API.STTDebugLog("0", "[onConvertFOE2View] - totalDiscountPercent: " + totalDiscountPercent.@value);
					customInfoTag.appendChild(totalDiscountPercent);
				}
				var totalBD = new XML('<Info />');
				totalBD.@name = "totalBD";
				totalBD.@value = xmlIn.Order.@totalBD;
				customInfoTag.appendChild(totalBD);
				var discountId = new XML('<Info />');
				discountId.@name = "discountId";
				discountId.@value = xmlIn.Order.@discountId;
				customInfoTag.appendChild(discountId);
				var discountType = new XML('<Info />');
				discountType.@name = "discountType";
				discountType.@value = xmlIn.Order.@discountType;
				customInfoTag.appendChild(discountType);
			}else{
				API.STTDebugLog("0", "[onConvertFOE2View] - Order without Discount - Basic Promotions ");
			}			
			
			
			xmlView.appendChild(customInfoTag);
			
			//NVS-4806 - msilva
			// Adding Promotions tag
			if (xmlIn.Order.Promotions.Promotion.length() > 0) {
				var promotionsTag = new XML('<Promotions />');
				for each (var promotion in xmlIn.Order.Promotions.Promotion) {
					
					//NVS-7757 - Bypass promotions not related to Offers
					//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
					var isOffer = promotion.@offerId != undefined && promotion.@offerId != null && promotion.@offerId != "" && promotion.@offerId != "0";
					
					if(isOffer){
						containsOffer = true;
					}
					
					if(isOffer || isUnattended){
					
						var promotionTag = new XML('<Promotion />');
						if (promotion.@id != undefined) {
							promotionTag.@id = promotion.@id;
						}
						if (promotion.@promotionCounter != undefined) {
							promotionTag.@counter = promotion.@promotionCounter;
						}
						if (promotion.@discountType != undefined) {
							promotionTag.@discountType = promotion.@discountType;
							
							if(promotion.@discountType.toUpperCase() == "DISCOUNTRATE" || promotion.@discountType.toUpperCase() == "DISCOUNTAMOUNT") { 
								promotionTag.@isSaleDiscount = "1"; 
								xmlView.@transactionKind = ACC_OT_DISCOUNT; 
							} 
							
						}
						if (promotion.@discountAmount != undefined) {
							promotionTag.@discountAmount = promotion.@discountAmount;
						}
						if (promotion.@offerId != undefined) {
							if(isOffer){
							promotionTag.@offerId = promotion.@offerId;
							} else {
								promotionTag.@offerId = "-1";
							}
						}
						if (promotion.@exclusive != undefined) {
							promotionTag.@exclusive = promotion.@exclusive;
						}

						//NPO-10435
						if (promotion.@isSaleDiscount != undefined) {
							promotionTag.@isSaleDiscount = promotion.@isSaleDiscount;
						}

						if (promotion.@promotionXml != undefined) {
							promotionTag.@promotionXml = promotion.@promotionXml;
							var hlp = new FOEHelper();
						
							//Convert a buffer from base64
							var promotionXmlData = hlp.revertDataFromBase64(promotion.@promotionXml.toString());
							if(promotionXmlData != null) {
								xmlPromotionData = new XML(promotionXmlData);
								//NVS-7683 - msilva
								var POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "-" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
								var promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);
								if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
									promotionTag.@promotionName = promotionLanguage.Name;

									}else{
									POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "_" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
									promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);         
									if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
										promotionTag.@promotionName = promotionLanguage.Name;
									}  
                                                                        else {
										POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language;
										promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);
										if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
											promotionTag.@promotionName = promotionLanguage.Name;
										}
									}            
								}
							}
						}
						promotionsTag.appendChild(promotionTag);
					}
				}
		
				//NVS-7757 - Bypass promotions not related to Offers	
				if(promotionsTag.length() > 0){
							xmlView.appendChild(promotionsTag); 
				}
            } 
			
            // Adding InvalidPromotions tag, NPS-13888 
            if (xmlIn.Order.InvalidPromotions.Promotion.length() > 0) { 
                var InvalidPromotionsTag = new XML('<InvalidPromotions />'); 
                for each (var promotion in xmlIn.Order.InvalidPromotions.Promotion) { 
                    
					//NVS-7757 - Bypass promotions not related to Offers	
					//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
					var isOffer = promotion.@offerId != undefined && promotion.@offerId != null && promotion.@offerId != "" && promotion.@offerId != "0";
					
					if(isOffer){
						containsOffer = true;
					}
					
					if(isOffer || isUnattended){
					
						var promotionTag = new XML('<Promotion />'); 
						if (promotion.@id != undefined) { 
							promotionTag.@id = promotion.@id; 
						} 
						if (promotion.@offerId != undefined) { 
							if(isOffer){
							promotionTag.@offerId = promotion.@offerId; 
							} else {
								promotionTag.@offerId = "-1"; 
							}
						} 
						if (promotion.@rejection != undefined) { 
							promotionTag.@rejection = promotion.@rejection; 
						} 

						//NPO-10435
						if (promotion.@isSaleDiscount != undefined) {
							promotionTag.@isSaleDiscount = promotion.@isSaleDiscount;
						}

						if (promotion.@promotionXml != undefined) { 
							var hlp = new FOEHelper(); 
						
							//Convert a buffer from base64 
							var promotionXmlData = hlp.revertDataFromBase64(promotion.@promotionXml.toString()); 
							if(promotionXmlData != null) { 
								xmlPromotionData = new XML(promotionXmlData); 
								var POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "-" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId; 
								var promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage); 
								if((promotionLanguage != null) && (promotionLanguage != undefined)){ 
									promotionTag.@promotionName = promotionLanguage.Name; 
								} 
							else{
                                 POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "_" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
                                 promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);         
                                 if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
                                           promotionTag.@promotionName = promotionLanguage.Name;
                                 }  
                                    else {
                                            POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language;
                                            promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);
                                            if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
                                                       promotionTag.@promotionName = promotionLanguage.Name;
                                            }
                                         }            
                                      }

				    } 
				 }
						
						InvalidPromotionsTag.appendChild(promotionTag); 
					}
                } 
		
				//NVS-7757 - Bypass promotions not related to Offers	
				if(InvalidPromotionsTag.length() > 0){
					xmlView.appendChild(InvalidPromotionsTag); 
				}
            } 
			
			// Adding Offers tag 
			if (xmlIn.Order.Offers.length() > 0) { 
				var offersTag = new XML('<Offers />'); 
				if (xmlIn.Order.Offers.@tagId != undefined) {
					offersTag.@tagId = xmlIn.Order.Offers.@tagId;
				}
				if (xmlIn.Order.Offers.@offerId != undefined) {
					offersTag.@offerId = xmlIn.Order.Offers.@offerId;
				}
				if (xmlIn.Order.Offers.@override != undefined) {
					offersTag.@override = xmlIn.Order.Offers.@override;
				}
				if (xmlIn.Order.Offers.@applied != undefined) {
					offersTag.@applied = xmlIn.Order.Offers.@applied;
				}
				if (xmlIn.Order.Offers.@clearAfterOverride != undefined) {
					offersTag.@clearAfterOverride = xmlIn.Order.Offers.@clearAfterOverride;
				}
				if (xmlIn.Order.Offers.@promotionId != undefined) {
					offersTag.@promotionId = xmlIn.Order.Offers.@promotionId;
				}
				if (xmlIn.Order.Offers.@promotionCounter != undefined) {
					offersTag.@promotionCounter = xmlIn.Order.Offers.@promotionCounter;
				}
				if(xmlIn.Order.@customerId != undefined) {
                    offersTag.@customerId = xmlIn.Order.@customerId;
				}
				xmlView.appendChild(offersTag);
			}
		}
		
		//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
		if (isUnattended || containsOffer) { 		
			xmlView.@totalAmount        = xmlIn.Order.@totalAmount;
			xmlView.@totalTax           = xmlIn.Order.@totalTax;
		}
		
		//NVS-4821 - msilva
		if (MobileOrderLocation != "") { 
			xmlView.@MobileOrderLocation=MobileOrderLocation; 
		} 
		
		var itemIn=null;
		//Item Elements
		for each (itemIn in xmlIn.Order.Item) {
			recurseIntoProducts(xmlView, itemIn.product[0], null, 0, itemIn.@index.toString(),
					itemIn.@currentSelected.toString(), itemIn.@voided.toString(),
					itemIn.@qtyPromo.toString(),
					(itemIn.@changedAfterTotal.toString()=='true'||itemIn.@changedAfterTotal.toString()=='TRUE'),
					itemIn.PromotionApplied);
		}
		
		//NPS-11233
		if(GLOBAL_STOREDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name=="UserInterface").Parameter.(@name=="displayExternalOrderId").@value == "true") {
			if(xmlIn.Order.@externalOrderId != null) {
				var customInfo = new XML('<CustomInfo/>');
				var externalOrderId = xmlIn.Order.@externalOrderId.toString();
				customInfo.Info.@name = "externalOrderId";

				if(externalOrderId.length > 0) {
					if(externalOrderId.length > 4) {
						externalOrderId = externalOrderId.substring(0,4);
					}
					API.dbg("[externalOrderId 2]["+externalOrderId+"]");
					customInfo.Info.@value = externalOrderId;
					xmlView.appendChild(customInfo);
				}
			}
		}
		
		//Testing if it is a Mobile Order 2.5 operation
		if(xmlIn.Order.@orderSrc && xmlIn.Order.@orderSrc.toString() == '1')
		{
			// Check if the current order has only Mc Cafe products (only if its destined to the front counter).
			// MOT-163 - FOE - IIdentify and re-route orders that have only Mc Cafe products.
			if (xmlIn.Order.@pod == PodDefinitions.FRONT_COUNTER && xmlIn.Order.@remPod == PodDefinitions.FRONT_COUNTER) {
				API.STTDebugLog("0", "[onConvertFOE2View] - Checking to see if the current order view has only MCC products.");
				hasOnlyMCCProducts = viewHasOnlyMcCafe(xmlView);
				// If the current order has only Mc Cafe products, route it to the Mc Cafe POD.
				if (hasOnlyMCCProducts) {
					API.STTDebugLog("0", "[onConvertFOE2View] - The current order view has only Mc Cafe products and will be routed to the POD: " + 5 + " and the REM POD: " + 5);
					xmlView.@pod = PodDefinitions.MC_CAFE;
					xmlView.@remPod = PodDefinitions.FRONT_COUNTER;
				}
				else {
					API.STTDebugLog("0", "[onConvertFOE2View] - The current order view doesn't have only Mc Cafe products.");
					xmlView.@pod = xmlIn.Order.@pod;
					xmlView.@remPod = xmlIn.Order.@remPod;
				}
			} else {
				xmlView.@pod = xmlIn.Order.@pod;
				xmlView.@remPod = xmlIn.Order.@remPod;
			}
			// Change the name of the POD, if necessary.
			// MOT-162 - FOE - Use a custom pod name instead of the one that is supplied in the FOE view. 
			var currentPod = parseInt(xmlView.@pod);
			if (currentPod in foePodNameMappingArray) {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is in the podNameMappingArray.");
				xmlView.@podName = foePodNameMappingArray[currentPod];
			} else {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is NOT in the podNameMappingArray.");
				xmlView.@podName = xmlIn.Order.@podName;
			}
			//NPS-18526 - curbside mobile order may have a custom pod name
			if(currentPod == PodDefinitions.COLD_KIOSK && foeCurbSideMapping)
			{
				API.STTDebugLog("0", "[onConvertFOE2View] - It's a curbside mobile order, its podNme will be changed to " + foeCurbSideMapping);
				xmlView.@podName = foeCurbSideMapping;

				//add curbsideStallNumber to view
				var checkInData = xmlIn.Order.@checkInData.toString();
				if(checkInData.length == 16)
				{
					var curbsideStallNumber = checkInData.substr(13, 2)
					xmlView.@curbsideStallNumber = curbsideStallNumber;
				}
			}
			//setting Table tag Id for mobile ordering table service NVS-6194 Tishin.
			if(currentPod == PodDefinitions.FRONT_COUNTER && ((xmlIn.Order.@orderSrc == "1") && (xmlIn.Order.@status == "128")) && (xmlView.@tableTagId.toString() == "-1" || xmlView.@tableTagId.toString() == ""))
			{
				var checkInData = xmlIn.Order.@checkInData.toString();
				var locationType = checkInData.substr(12, 1);
				if(checkInData.length == 16 && locationType == "1")
				{
					var tagIdNumber = checkInData.substr(13, 2)
					xmlView.@tableTagId = tagIdNumber;
				}else if(checkInData.length == 17 && locationType == "1"){
					var tagIdNumber = checkInData.substr(13, 3)
					xmlView.@tableTagId = tagIdNumber;
				}
			}
			// Add the productionMonitor parameter to the view.
			// MOT-222 - FOE - Insert the new production parameters into the order view header - (POD & production)
			if (currentPod in foeProductionMonitorsArray) {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is in the foeProductionMonitorsArray.");
				xmlView.@productionMonitor = foeProductionMonitorsArray[currentPod];
			} else {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is NOT in the foeProductionMonitorsArray. Using the default value: " + FOE_DEFAULT_PROD_MONITOR_VALUE);
				xmlView.@productionMonitor = FOE_DEFAULT_PROD_MONITOR_VALUE;
			}
			// Add the expoMonitor parameter to the view.
			// MOT-222 - FOE - Insert the new production parameters into the order view header - (POD & production)
			if (currentPod in foeExpoMonitorsArray) {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is in the foeExpoMonitorsArray.");
				xmlView.@expoMonitor = foeExpoMonitorsArray[currentPod];
			} else {
				API.STTDebugLog("0", "[onConvertFOE2View] - The current POD is NOT in the foeExpoMonitorsArray. Using the default value: " + FOE_DEFAULT_EXPO_MONITOR_VALUE);
				xmlView.@expoMonitor = FOE_DEFAULT_EXPO_MONITOR_VALUE;
			}
			
			if(OrderKey == undefined || OrderKey == "")
			{
				// Set the order key.
				// NPS-4686 - COC Store 3017 Hung order on DT expo, can't be bumped off.
				var okIndexCount=0;
				var orderKeyFirstPart = xmlView.@podName.toString();
				if(xmlIn.Order.@tableId && xmlIn.Order.@tableId.toString() != '') {
					orderKeyFirstPart='FOE';
					for(okIndexCount=(4-xmlIn.Order.@tableId.toString().length); okIndexCount>0; okIndexCount--) {
						orderKeyFirstPart += '0';
					}
					orderKeyFirstPart += xmlIn.Order.@tableId.toString();
				}
				xmlView.@orderKey = orderKeyFirstPart + ':' + xmlIn.Order.@localOrderKey;
			}
		}
		
		var tenderIn=null;
		var maxTenders=0;
		//only one cashless per view is allowed multiple values are '|' separated.
		var cashlessString = "";
		//Tender Elements
		for each (tenderIn in xmlIn.Order.Tender) {
			var cashlessView = null;
			var tender = new XML('<ItemTenderView/>');
			tender.code = tenderIn.@code.toString();
			tender.qty = tenderIn.@qty.toString();
			tender.value = tenderIn.@value.toString();
			tender.pValue = tenderIn.@value.toString();
			if(tenderIn.@srcPOSId.toString() != '') {
				tender.srcPOSId = tenderIn.@srcPOSId.toString();
			}
			tender.discMode = tenderIn.@discMode.toString();

			var cashlessIn=null;
			for each (cashlessIn in tenderIn.cashless) {
				tender.cat='TENDER_ELECTRONIC_PAYMENT';
				tender.cardProv = tenderIn.cashless.@cardProv.toString();
				// Need to align card With those we normally use for instore processing
				
				//NVS-6394 - msilva
				if(cashlessIn.@GCBalance != undefined && cashlessIn.@GCBalance != null && cashlessIn.@GCBalance.toString() != '') { 
					tender.cardBalance = cashlessIn.@GCBalance.toString(); 
				} 
				if(cashlessIn.@cardNum.toString() != '') {
					tender.cardNumber = cashlessIn.@cardNum.toString();
				}
				if(cashlessIn.@auth.toString() != '') {
					tender.authCode = cashlessIn.@auth.toString();
				}
				if(cashlessIn.@seqNo.toString() != '') {
					tender.sequenceNumber = cashlessIn.@seqNo.toString();
				}
				var ReceivedName = tenderIn.cashless.@cardProv.toString();
				
				// NPM-1786
				if (ReceivedName.toUpperCase() == "ARCHCARD" || ReceivedName.toUpperCase() == "GCARD") {
					tender.code = "11";
				}
				
	
				tender.cardProv = MapCardNames(ReceivedName);

				//TODO : recover aditional cashless information
				var local_MerchantID = '';
				var StoreNumber = "";//NVS-8999, to be sync with cashless3, may use .StoreDB.StoreProfile.StoreDetails.StoreId, NVS-9481
				var local_GiftCard_Footer = GLOBAL_STOREDB.Adaptors.Adaptor.(@type == "npCLayer").Section.(@name == "AdditionalGiftCard").Parameter.(@name == "contact").@value;;
				var cardNum = cashlessIn.@cardNum.toString();
				cardNum = cardNum.replace("@","0x41");
                		cashlessString = ((cashlessString == "")?"":(cashlessString+CARDLESS_INFO_SEPARATOR)) + formatCashlessString(MapCardNames(cashlessIn.@cardProv.toString()), cardNum,
					cashlessIn.@expire.toString(), cashlessIn.@auth.toString(),	cashlessIn.@printFlag.toString(),
					cashlessIn.@seqNo.toString(), local_MerchantID, cashlessIn.@gcBalance.toString(), cashlessIn.@account.toString(),
					tenderIn.@value.toString(), StoreNumber, local_GiftCard_Footer);
				API.dbg("[CashlessIn]["+cashlessIn.toXMLString()+"]");
				break;
			}
			// NVS-7920 Script Change Base on NPS-21623
			tender.paymentChannel = "Mobile";
			
			API.dbg("[TenderIn]["+tenderIn.toXMLString()+"]");

			API.dbg("[Tender]["+tender.toXMLString()+"]");

			xmlView.appendChild(tender);
			maxTenders++;
		}
		API.dbg("[cashlessString]["+cashlessString+"]");
		var cashlessView = new XML('<Cashless>' + cashlessString + '</Cashless>');
		xmlView.appendChild(cashlessView);

/*
		var timesIn=null;
		//Times Elements
		for each (timesIn in xmlIn.Order.Times) {
			var item = new XML('<ViewTimes/>');
			item.@totalTime = timesIn.@totalTime;
			item.@storeTime = timesIn.@storeTime;
			item.@orderTime = timesIn.@orderTime;
			xmlView.appendChild(item);

			break;
		}
*/
		xmlView.@tenderItems = maxTenders;

		//NVS-4801 - msilva
		//Testing if it is a Mobile Order 2.5 operation 
		// Add category hours 
		if(xmlIn.Order.@orderSrc && xmlIn.Order.@orderSrc.toString() == '1') 
		{ 
			if(xmlIn.CategoryHours != undefined) 
			{ 
				var categoryHours = new XML('<CategoryHours />'); 
				for each (categoryHourIn in xmlIn.CategoryHours.CategoryHour) 
				{ 
					var categoryHour = new XML('<CategoryHour />'); 
					categoryHour.@categoryId = categoryHourIn.@categoryId; 
					for each (weekDayIn in categoryHourIn) 
					{ 
						var Weekday = new XML('<Weekday />'); 
						Weekday.@name = weekDayIn.@name; 
						Weekday.@enabled = weekDayIn.@enabled; 
						Weekday.@startTime = weekDayIn.@startTime; 
						Weekday.@endTime = weekDayIn.@endTime; 
						categoryHour.appendChild(Weekday); 
					} 
					categoryHours.appendChild(categoryHour); 
				} 
				xmlView.appendChild(categoryHours); 
			} 
		} 
		
		return (xmlView.toXMLString()); 		
		
		
	} catch( ex ) {
	
		// MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE. 
		API.STTErrorLog("0", "[onConvertFOE2View] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onConvertFOE2View] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
		
		return (null);
	}


	//***** HELPER FUNCTIONS ******//
	function formatCashlessString(providername, cardnum, expire, auth,
									printFlag, seqno, MerchantID, GCBalance, Account,
									Value, StoreNumber, local_GiftCard_Footer) {

		//TODO : check cashless string format
		//function ParseTrackInfo(retcode,cardType)
		//function cashlessPayment(tenderId,tenderValue,refund)
		publishCashlessPaymentRecord(providername, cardnum, expire, auth,
									printFlag, seqno, MerchantID, GCBalance, Account,
									Value, StoreNumber, local_GiftCard_Footer, xmlView.@businessDay);
		//NVS-8999, mobile cashless string format needs to be sync with regular cashless string
		var cardType = ""; //expire date not needed, field is used by cardType
		var cardToken = emvChipIndicator = emvCVM = emvMode = emvAID = emvTVR = emvIAD = emvTSI = emvARC = cardEntryMode = cardPrintName = "";
		return 'CASHLESS:' +
				providername + '|' +
				cardnum + '|' +
				cardType + '|' +
				auth + '|0|' +
				printFlag + '|' +
				seqno + '|' +
				MerchantID + '|' +
				GCBalance + '|' +
				Account + '|' +
				Value + '|' +
				StoreNumber + '|' +
				local_GiftCard_Footer + "|"+
				""+//glo_transactionID
				"|mobile|" + //after this line all fields are empty just to be sync with regular cashless3 string
				cardToken + "|" +
				emvChipIndicator + "|" +
				emvCVM + "|" +
				emvMode + "|" +
				emvAID + "|" +
				emvTVR + "|" +
				emvIAD + "|" +
				emvTSI + "|" +
				emvARC + "|" +
				cardEntryMode + "|" +
				cardPrintName +
				"|#";

	}

	function recurseIntoProducts(xmlView, xmlProduct, xmlFather, level, index, currentSelected, voided, qtyPromo, changedAfterTotal, promotionApplied) {
		try
		{
			API.STTDebugLog("0","[BCEvents.nps::onConvertFOE2View::recurseIntoProducts] [S]", "BCEvents.nps");

			var product = XML(xmlProduct);
			var itemView = new XML('<ItemView/>');
			
			itemView.itemCode = Number(index);
			itemView.level = String(level);
			itemView.index = index;
			if(currentSelected!='') {
				itemView.currentSelected = currentSelected;
			}

			var name = product.@name.toString();
			if(name!='') {
				itemView.name = name;
			}
			else {
				itemView.name = 'PROD:'+product.@code.toString();
			}

		var unitPrice = product.@unitPrice.toString();
		var qty = product.@qty.toString();
		var grilledQty = product.@qty.toString();

		if(voided=='true' || voided=='TRUE') {
			qty = '0';
			grilledQty = '0';
		}

		itemView.quantity = qty;
		itemView.productCode = product.@code.toString();


		if(product.name()=='grill') {
			itemView.grilledQuantity= grilledQty;
				itemView.isGrillLine = 'true';
				if(product.@modifier.toString()!='') {
					itemView.specialModifiers = product.@modifier.toString();
				}
			}
			
			if(product.name()=='product')
			{
				var hlp = new FOEHelper();
				if(xmlFather != null)
				{
					itemView.prodAction = hlp.GetProdAction(xmlFather.@code.toString(),xmlProduct.@code.toString());
				}
				else
				{
					itemView.prodAction = hlp.GetProdAction("",xmlProduct.@code.toString());
				}
			}

			if(changedAfterTotal || (product.@changedAfterTotal && product.@changedAfterTotal.toString()!='')) {
				itemView.quantityChanged = (changedAfterTotal||product.@changedAfterTotal.toString()=='true'||product.@changedAfterTotal.toString()=='TRUE')?'true':'false';
			}

			// Adding PromotionApplied tag
			if (0 == level) {
				if (promotionApplied.length() > 0) {
					
					//NVS-7757 - Bypass promotions not related to Offers	
					//NVS-7821 - Update NP6 to NOT remove eCP promotions from unattended Mobile Orders
					var isOffer = promotionApplied.@offerId != undefined && promotionApplied.@offerId != null && promotionApplied.@offerId != "" && promotionApplied.@offerId != "0";
					
					if(isOffer){
						containsOffer = true;
					}
					
					if(isOffer || isUnattended){
					
						var promotionAppliedTag = new XML('<PromotionApplied />');
						if (promotionApplied.@promotionId != undefined) {
							promotionAppliedTag.@promotionId = promotionApplied.@promotionId;
						}
						if (promotionApplied.@promotionCounter != undefined) {
							promotionAppliedTag.@promotionCounter = promotionApplied.@promotionCounter;
						}
						if (promotionApplied.@eligible != undefined) {
							promotionAppliedTag.@eligible = promotionApplied.@eligible;
						}
						if (promotionApplied.@originalPrice != undefined) {
							promotionAppliedTag.@originalPrice = promotionApplied.@originalPrice;
						}
						if (promotionApplied.@discountAmount != undefined) {
							
							//Verify when originalPrice <> unitPrice
							//In case is different multiplies qty * discountAmount
							//Otherwise it is already multiplied
							//Root cause: eCP gap on setItem discounts implementation 
							if(unitPrice != undefined && unitPrice != null && 
								promotionApplied.@originalPrice != undefined && promotionApplied.@originalPrice != null && 
								unitPrice != promotionApplied.@originalPrice.toString()){
								var ecpCalculatedDiscount = new BigDecimal(promotionApplied.@discountAmount);
								var multipliedDiscount = ecpCalculatedDiscount.multiply(Number(qty));
								promotionAppliedTag.@discountAmount = multipliedDiscount; 
							} else {
								promotionAppliedTag.@discountAmount = new BigDecimal(promotionApplied.@discountAmount); 
							}
						}
						if (promotionApplied.@discountType != undefined) {
							promotionAppliedTag.@discountType = promotionApplied.@discountType;
						}
						if (promotionApplied.@originalItemPromoQty != undefined) {
							promotionAppliedTag.@originalItemPromoQty = promotionApplied.@originalItemPromoQty;
						}
						if (promotionApplied.@originalProductCode != undefined) {
							promotionAppliedTag.@originalProductCode = promotionApplied.@originalProductCode;
						}
						if (promotionApplied.@offerId != undefined) {
							if(isOffer){
							promotionAppliedTag.@offerId = promotionApplied.@offerId;
							} else {
								promotionAppliedTag.@offerId = "-1";
							}
						}

						//NPO-10435
						if (promotionApplied.@isSaleDiscount != undefined) {
							promotionAppliedTag.@isSaleDiscount = promotionApplied.@isSaleDiscount;
						}

						if (promotionApplied.Actions.Action.length() > 0) {
							var actionsTag = new XML('<Actions />');
							for each (var action in promotionApplied.Actions.Action) {
								var actionTag = new XML('<Action />');
								if (action.@name != undefined) {
									actionTag.@name = action.@name;
									if(isUnattended && action.@name == "SetItemPrice") { 
										xmlView.@transactionKind = ACC_OT_DISCOUNT; 
										var discountsTag = new XML('<discounts />');
										var discountTag = new XML('<discount />');
										var discountAmount = null; /*'' + Number(promotionApplied.@discountAmount) * Number(qty);*/
										if(unitPrice != undefined && unitPrice != null && 
											promotionApplied.@originalPrice != undefined && promotionApplied.@originalPrice != null && 
											unitPrice != promotionApplied.@originalPrice.toString()){
											var ecpCalculatedDiscount = new BigDecimal(promotionApplied.@discountAmount);
											discountAmount = ecpCalculatedDiscount.multiply(Number(qty));
										} else {
											discountAmount = new BigDecimal(promotionApplied.@discountAmount);
										}
										discountTag.@id = "100"; 	//PROMOTION_DISCOUNTBYITEM_BASEID
										discountTag.@type = "1"; 	//Discount is by amount
										discountTag.@value = discountAmount; //Should already contain the proper amount given the item quantity
										discountTag.@amount = discountAmount;
										discountsTag.appendChild(discountTag);
										itemView.appendChild(discountsTag);
									}
								}
								if (action.@newValue != undefined) {
									actionTag.@newValue = action.@newValue;
								}
								if (action.@oldValue != undefined) {
									actionTag.@oldValue = action.@oldValue;
								}
								actionsTag.appendChild(actionTag);
							}
							promotionAppliedTag.appendChild(actionsTag);
						}
						itemView.appendChild(promotionAppliedTag);
					}
				}
			}

			//NVS-7980 - Do not set promoitem when promotion is not added
			if(qtyPromo!='' && (isUnattended || isOffer)) {
				itemView.quantityPromo = qtyPromo;
				itemView.quantityItemPromo = qtyPromo;
				itemView.promo = qtyPromo;
				itemView.promo.@id = '0';
			}

			//Adding CYT information 
			if(product.@DeliverEarlierQuantity != '') 
			{  
				itemView.DeliveryEarlyQty = Number(product.@DeliverEarlierQuantity); 
			}
			xmlView.appendChild(itemView);

			var prdChildren = product.children();
			var iPrdCnt=0;
			for(iPrdCnt=0; iPrdCnt<prdChildren.length(); iPrdCnt++) {
				recurseIntoProducts(xmlView, prdChildren[iPrdCnt], xmlProduct, level+1, index, currentSelected, '', qtyPromo, false, promotionApplied);
			}
			
		}
		catch(ex)
		{	
			// MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE. 
			API.STTErrorLog("0", "[onConvertFOE2View] - " + ex.message, BC_EVENTS_NAME);
			API.STTErrorLog("0", "[onConvertFOE2View] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
			
			return (null);
		}
			
		API.STTDebugLog("0","[BCEvents.nps::onConvertFOE2View::recurseIntoProducts] [E]", "BCEvents.nps");
		return;
	}

	/** viewHasOnlyMcCafe
	 * 
	 * @brief - This function checks a New POS view to see if it contains Mc Cafe products.
	 * @param - xmlView - A New POS sale view.
	 * @returns - True if the current view has only MC Cafe products, otherwise false.
	 * @author - Felipe Armoni
	 * @since - MOT-156 - FOE - Route the FOE orders to the appropriate production queue.
	 */
	function viewHasOnlyMcCafe(xmlView) {
		var isOnlyMcc;
		var item;
		var productNode;
	
		isOnlyMcc = true;
	
		for each (item in xmlView.ItemView) {
		
			if (item.level == 0 || item.prodAction == 3) {
			
				// Retrieves the corresponding product node from the product-db.xml	
				productNode = productDictionary[item.productCode];
				
				if (productNode != undefined) {
				if (productNode.CustomParameters.Parameter.(@name=="IsMCC").@value.toString() != "true" && productNode.CustomParameters.Parameter.(@name=="IsMCC").@value.toString() != "1") {
					isOnlyMcc = false;
					break;
					}
				}
			}
		}
		
		return isOnlyMcc;
	}
}

function publishCashlessPaymentRecord(providername, cardnum, expire, auth,
								printFlag, seqno, MerchantID, GCBalance, Account,
								Value, StoreNumber, local_GiftCard_Footer, businessDate)
{
	var expYear;
	var expMonth;
	if (expire.length >= 2)
	{
		expMonth = expire.substring(0, 2);
	}
	else
	{
		expMonth = "00";
	}
	if (expire.length > 3)
	{
		expYear = expire.substring(2);
	}
	else
	{
		expYear = "00";
	}
	var	POS_ID = GetPosNumber();

	var currentTime = new NPDate();
	var hour = currentTime.getHours();
	var amPM;
	if (hour < 12)
	{
		if (hour == 0)
		{
			hour = 12;
		}
		amPM = "AM";
	}
	else
	{
		hour -= 12;
		amPM = "PM";
	}
	if (StoreNumber.length < 1 || Number(StoreNumber) == 0 )//NVS-9481, protection for storeNo.=0
	{
		StoreNumber = rootStoreDB.StoreDB.StoreProfile.StoreDetails.StoreId;  // If we don't get one, just use this
	}
	
	var minutes = currentTime.getMinutes().toString();
	if (minutes.length < 2) minutes = "0" + minutes;
	var seconds = currentTime.getSeconds().toString();
	if (seconds.length < 2) seconds = "0" + seconds;
	var month = currentTime.getMonth() + 1;
	var transactionTime = month.toString() + "/" + currentTime.getDate().toString() + "/" + currentTime.getFullYear().toString() +
						" " + hour.toString() + ":" + minutes + ":" + seconds + " " + amPM;
	//var transactionTime = currentTime.format("m/d/yyyy hh:MM:ss TT");

	// NVS-7207 we will use POS 0 for the POS number for all mobile cashless transactions
	var responseHeader = "<Header><MobileOrder>true</MobileOrder><StoreNumber>" + StoreNumber + "</StoreNumber>" +
						"<PosNumber>" + "0" + "</PosNumber><BusinessDate>" + businessDate + "</BusinessDate>" +
						"<SystemDateTime>" + transactionTime + "</SystemDateTime></Header>"
	var responsePortion = "<RESPONSE><PAYMENT_MEDIA>" + providername + "</PAYMENT_MEDIA><ACCT_NUM>" + cardnum + "</ACCT_NUM>" +
					"<MERCHID>" + Account + "</MERCHID><CARD_EXP_MONTH>" + expMonth + "</CARD_EXP_MONTH><CARD_EXP_YEAR>" +
					expYear + "</CARD_EXP_YEAR><APPROVED_AMOUNT>" + Value + "</APPROVED_AMOUNT><AUTH_CODE>" + auth + "</AUTH_CODE>" +
					"<TRANS_SEQ_NUM>" + seqno + "</TRANS_SEQ_NUM><INTRN_SEQ_NUM>" + seqno + "</INTRN_SEQ_NUM></RESPONSE>";
	var cashlessResult = "<NewPosData>" + responseHeader + responsePortion + "</NewPosData>";
					
	var messageData = "USCOE.PED.CashlessTransaction|" + cashlessResult;
	var jasonData =	{ 'commandInstruction':
							{
								'Topic':"publish",
								'Message': messageData
							}
						};
					
	PublishMobilePayment(jasonData);
}

function PublishMobilePayment(publishJason)
{
	try
	{
		var USUtility = new NpSharpService("iUtility"); 
		var response = USUtility.Call("UtilityMessenger", publishJason);
	}
	catch (e)
	{
		return;
	}
}

function reversePartialTrans () {

	API.dbg("reversePartialTrans: Revert partial transaction started");

	var pluralAre 		="are"
	var singularIs 	="is"
	var pluralTrans 	="transactions"
	var singularTrans ="transaction"
	var cashless =rootCtx.get("CASHLESS");
	var lines = String(cashless).split("CASHLESS:");
	var allApproved = true;
	var reverseList =new Array();
	var totalAmt=new BigDecimal(0);
	var paymentType;

	//NVS-3839, NVS-3844, NVS-3846 - msilva
	var lastView = rootHlp.getLastSaleView();
	if(lastView == null) {
		lastView = rootHlp.getCurrentView();

	}
	rootCtx.set("kioskReversePartialTransView", lastView.toString(), true);

	/* mark the start of the reversal process, because we must complete even after a reboot */
	rootCtx.set("CASHLESS_REVERSAL_PENDING",1,true);
	PosDoSetCustomInfo("CASHLESS_REVERSAL_PENDING","1");

	/* first check to see if we were in the middle of reversing partial trans before a restart */
	reversalAmt =new BigDecimal(rootCtx.get("CASHLESS_REVERSAL_AMT"));
	reversals =String(rootCtx.get("CASHLESS_REVERSAL"));
	if (reversals.length > 0) {
		revs = String(reversals).split("CASHLESS:");
		/* keep track of all transID's so we know which were already reversed */
		for(var i = 1; i < revs.length; i++) {
			revInfo =String(revs[i]);
			fields 	=revInfo.split("|");
			reverseList.push(fields[13]);
		}
	}

	/* display summary of all trans to be reversed. */
	confirmMsg = "";
	cardCount =0;
	numOfLines = lines.length-1;
	for(var i = 1; i <= numOfLines; i++) {
		cashlessInfo 	=String(lines[i]);
		fields 			=cashlessInfo.split("|");
		transID 		=fields[13];

		/* don't reverse ID's that were already reversed */
		if (isReversed(transID, reverseList)) continue;

		provider 		=fields[0].replace("CASHLESS:", "");
		card 			=fields[1];
		card = PadCardNumber(card);
		amt 				=fields[10];
		amt 				=trim(API.formatNumber(amt, "##,##0.00", 9));

		confirmMsg +=provider+"("+card+"): $"+amt+"\n";
		cardCount++;
	}

	//NVS-235 RPS 05/07/2010

	if (cardCount > 0)
	{
		rootCtx.set("msgTimeout",3000,true);
		confirmMsg = "There "+(cardCount>1?pluralAre:singularIs)+" "+cardCount+" partial tender "+(cardCount>1?pluralTrans:singularTrans)+" to be reversed:\n\n"+confirmMsg;
		PosShowMessage(confirmMsg, "_TIMEOUT:msgTimeout");
	}
	else
	{
		rootCtx.set("msgTimeout",3000,true);
		PosShowMessage("Your Transaction has been Cancelled.", "_TIMEOUT:msgTimeout");
	}

	var MobileReversed = false;
	var MobileIndicator = "";
	/* now actually do the work */
	for(var nextCard = 1; nextCard < lines.length; nextCard++) {
		cashlessInfo 	=String(lines[nextCard]);
		fields 			=cashlessInfo.split("|");
		transID 		=fields[13];
		MobileIndicator = fields[14];
		
		/* don't reverse ID's that were already reversed */
		if (isReversed(transID, reverseList)) continue;

		provider 		=fields[0].replace("CASHLESS:", "");
		card 			= fields[1];
		paymentType     = fields[2];
		card = PadCardNumber(card);
		amt 			=fields[10];
		amtfmt			=trim(API.formatNumber(amt, "##,##0.00", 9));
		amtNoDecimal	=amt.replace(/\./,"");
		
		if (MobileIndicator == "mobile") {
			// we only need to send one payment cancellation notice
			if (MobileReversed == false) {
				PosDoSendCommandToFOEJS(MOBILE_PAYMENT_CANCEL);
				MobileReversed = true;
			}
		} else {
			/* reverse trans */
			var success = ""; // NVS-2065
			if(CheckCashlessParam("Cashless3", "Active", "true")) {
				var returnValue = VoidSpecifiedTransaction(transID, paymentType);
				if (returnValue == true) {
					success = "1";
					PosSetSessionProperty("Cashless3CutoverRequired", "true", true);
				}
			} else {
				success =npTCLEvalEx("Everest_Operation 25 "+amtNoDecimal+" "+transID+" 0");
			}
			//if (nextCard == 3) success = 0;
			if (success == "1") {
				/* serialize reversal */
				PosAppendSessionProperty("CASHLESS_REVERSAL","CASHLESS:"+cashlessInfo,true);
				PosDoSetCustomInfo("CASHLESS_REVERSAL","CASHLESS:"+cashlessInfo);
			reversalAmt =reversalAmt.add(amt);
			PosSetSessionProperty("CASHLESS_REVERSAL_AMT",reversalAmt,true);
			PosDoSetCustomInfo("CASHLESS_REVERSAL_AMT",reversalAmt);

			//NVS-236 RPS 05/07/2010
			rootCtx.set("msgTimeout",3000,false);
			approveMsg = "The following partial tender has been reversed:\n\n"+provider+"("+card+"): $"+amtfmt;
			PosShowMessage(approveMsg, "_TIMEOUT:msgTimeout");
			} else {
				/* failure */
				allApproved = false;
				break;
			}
		}
	}
    PosDisplayPEDWaitingMessage();
	
	/* void the sale if all reversals weren't approved */
	if (!allApproved) {
		/* prepare message for reversal errors */
		errMsg ="The reversal request failed.  Initiating a cash refund for all remaining reversals that did not get approved.\n\n";
		for(var i = nextCard; i < lines.length; i++) {
			cashlessInfo 	=String(lines[i]);
			fields 			=cashlessInfo.split("|");
			transID 		=fields[13];

			/* don't reverse ID's that were already reversed */
			if (isReversed(transID, reverseList)) continue;

			provider 	=fields[0].replace("CASHLESS:", "");
			card 		=fields[1];
			card = PadCardNumber(card);
			amt 			=fields[10];
			amtfmt		=trim(API.formatNumber(amt, "##,##0.00", 9));
			totalAmt	=totalAmt.add(amt);
			errMsg 	  +=provider+"("+card+"): $"+amtfmt+"\n";
		}

		totalAmtFmt =trim(API.formatNumber(totalAmt, "##,##0.00", 9));
		rootCtx.set("CASHLESS_REVERSAL_REFUND",totalAmt,true);
		PosDoSetCustomInfo("CASHLESS_REVERSAL_REFUND",totalAmount);
		errMsg +="\nTotal Refund: $"+totalAmtFmt;
		// NVS-245 RPS 05/10/2010
		rootCtx.set("msgTimeout",60000,false);
		PosShowMessage(errMsg, "_TIMEOUT:msgTimeout");
	}

	/* tender the order then overring it */
	/* Issue change WWR-2517 by Felipe Ramas - GSS-190 */
	if(PosCheckSessionProperty("POD","CSO")) {
		/* if (rootCtx.get("NGK_ORDER_REROUTE", "PAY_AT_COUNTER") != "PAY_AT_COUNTER") {
			PosDoVoidSale(true,false);
			PosNGKDoGoHomeJS();
		} */

		//Receipt Params
		var vatNumber = rootHlp.findParamInSectionWide("VatNumber","VAT");
		if( rootHlp.findParamInSectionWide("FirstReceiptEmpty", "PrintFromKioskOnCounter") == "1")
		{
			PosSetSessionProperty("FirstReceiptEmpty", "1", false);
		}
		PosSetSessionProperty("SecondCopyOfReceipt", "false");			
			
		//NVS-3839, NVS-3844, NVS-3846 - msilva	
		if(allApproved)
		{
			//NVS-3948 - msilva - Reversal successfully - Clean cashless data
			ViewXml = rootHlp.getCurrentView();
			var newViewXML = new XML(ViewXml);
			newViewXML.ItemTenderView = null;
			newViewXML.Cashless = null;
			rootHlp.setCurrentView(newViewXML.toXMLString());

			//NVS-4552 - msilva - Remove promotions since the totalAmount is recalculated without promotions after voiding the order
			PosBackFromTotalUndoOffer();
			PosBackFromTotalUndoPromotion(); 
			
			//Prints reversal Receipt - All aproved
			//Overring
			PosDoVoidSale(true,true);

			//NVS-4192 - Do not print the reversal when there is no card payments
			if(cardCount > 0)
			{
				PosCreateReport("VIEW","Receipt#USReceiptReports","NOPREVIEW|SAVE",vatNumber+""+"|FirstPass");
			}
			rootHlp.setCurrentView(newViewXML.toXMLString());
		}else
		{
			//NVS-4192 - Do not print the reversal when there is no card payments
			if(cardCount > 0)
			{			
				PosCreateReport("VIEW","Receipt#USReceiptReports","NOPREVIEW|SAVE",vatNumber+""+"|FirstPass");		
			}				
		}			
			
		rootCtx.set("kioskReversePartialTransView", "", true);
		//NVS-3948 - msilva - Cancels order
		if(PosCheckSessionProperty("NGK_ORDER_CANCEL", "true"))
		{
			/* WWR-3972 - Change for reverse the payment */
			PosDoVoidSale(false,true);
		}
		
		/* PosNGKDoGoHomeJS(); */
		
	}else{
		//NVS-3241 - [DRM] CYT C3[ Ordering & Tendering_FC] CYT Grill monitor displays "Cancelled" proteins after the partially paid order transaction is reversed due to modification to the order
		/* NVS-4938 -added reversal report */ 
		PosDoTender(0,-1);
		PosDoEndOfSale(true);
		PosDoVoidSale(true,false);
	}

	if((typeof(PosIsCoinDispenseLoadedJS) == 'function') && (typeof(PosDispenseCoins) == 'function')) {
		if(PosIsCoinDispenseLoadedJS()) {
			var value=""+totalAmt;
			value=value.substr(value.length-2);
			if(Number(value) != 0) {
				PosDispenseCoins(value);
			}
		}
	}
	
}

function PadCardNumber(IncomingNumber) {

	IncomingNumber = IncomingNumber.replace(/^\s+|\s+$/g,"");
	
	// If the card number is 4 digits and numeric, pad it with a dozen leading *'s
	var NumberPattern = /^[0-9]{4}$/;
	var Pattern2  = /^\*\*\*\*[0-9]{4}$/;
	if (NumberPattern.test(IncomingNumber) == true)
	{
		IncomingNumber = "************" + IncomingNumber;
	}
	else if (Pattern2.test(IncomingNumber) == true)
	{
		IncomingNumber = "********" + IncomingNumber;
	}
	
	return IncomingNumber;
}
function checkPartialTransactions() {
	reversals =rootCtx.get("CASHLESS_REVERSAL_PENDING");
	if (reversals == "1") {
		PosShowMessage("Warning -This order needs to continue reversing partial tenders");
		reversePartialTrans();
		PosCreateReceiptJS(0,"VIEW","Receipt#USReceiptReports","NOPREVIEW");
		PosShowScreen(rootCtx.get("baseScreenId"));
	}
}


/**onConvertView2FOE
 *
 * @brief - This function converts a NP6 View to the FOE response XML
 * @param - sView - string ->the View XML string representation
 * Return - rval - string representing the FOE XML response
 */
function onConvertView2FOE(sView, sInvalidItemsView) {
	API.STTDebugLog("0","[BCEvents.nps::onConvertView2FOE] [S]", "BCEvents.nps");
	try {
		if(sView==null) {
		    sView='<View/>';
		}

		var xmlView = new XML(sView);
		var viewChildren = xmlView.children();
		var xmlOut = new XML('<ProdInfoResponse/>');

		if(sInvalidItemsView!=null) {
			var xmlInvalidItemsView = new XML(sInvalidItemsView);
		}

		//Header Element
		xmlOut.Header.@command = '0';
		xmlOut.Header.@version = '2';

		//Order Element
		xmlOut.Order.@storedOrderKey = xmlView.CustomInfo.Info.(@name=="OrderId").@value.toString();
		xmlOut.Order.@major = xmlView.@major;
		xmlOut.Order.@minor = xmlView.@minor;
		//TODO : Verify which is the total amount and tax to be sent to the client
		xmlOut.Order.@totalAmount = xmlView.@totalAmount;
		xmlOut.Order.@totalTax = xmlView.@totalTax;
		xmlOut.Order.@grossAmount = xmlView.@grossAmount;
		
		//NPS-11233
		var externalOrderId = xmlView.CustomInfo.Info.(@name == "externalOrderId").@value;
		if(externalOrderId != undefined && externalOrderId != null ) {
			xmlOut.Order.@externalOrderId = externalOrderId;
		} 
		//SQM-1231 
		currentOrderPod = xmlView.@pod;
		currentOrderRemPod = xmlView.@remPod;
		currentOrderStatus = xmlView.@saleStatus;
		
		// MOT-257 - FOE - Add the order number to the DoFoeStoreFromFile return view. 
		// Get a String with the order's major and minor numbers
		var majorMinor = PosMountOrderIdJS("1", xmlView.@orderKey.toXMLString(), xmlView.@major.toXMLString(), xmlView.@minor.toXMLString());
		prefix = lGetOrderPrefix(currentOrderPod, currentOrderRemPod, currentOrderStatus);
		//SQM-1231 
		
		//Not Paid order doesnt need prefix digit 
		if (currentOrderStatus == 64) { 
			xmlOut.Order.@displayOrderNumber = majorMinor;	
		}else{
			xmlOut.Order.@displayOrderNumber = prefix + majorMinor;	
		}
		
		var customerId = xmlView.Customer.@id;
		if (customerId != undefined && customerId != null) {
			xmlOut.Order.@customerId = customerId;
		}
		var nickname = xmlView.Customer.@nickname;
		if (nickname != undefined && nickname != null) {
			xmlOut.Order.@nickname = nickname;
		}
		var greeting = xmlView.Customer.@greeting;
		if (greeting != undefined && greeting != null) {
			xmlOut.Order.@greeting = greeting;
		}
		
		// Adding Promotions tag
		if (xmlView.Promotions.Promotion.length() > 0) {
			var promotionsTag = new XML('<Promotions />');
			for each (var promotion in xmlView.Promotions.Promotion) {
				var promotionTag = new XML('<Promotion />');
				if (promotion.@id != undefined) {
					promotionTag.@id = promotion.@id;
				}
				if (promotion.@counter != undefined) {
					promotionTag.@promotionCounter = promotion.@counter;
				}
				if (promotion.@discountType != undefined) {
					promotionTag.@discountType = promotion.@discountType;
				}
				if (promotion.@discountAmount != undefined) {
					promotionTag.@discountAmount = promotion.@discountAmount;
				}
				if (promotion.@offerId != undefined) {
					promotionTag.@offerId = promotion.@offerId;
				}
				if (promotion.@exclusive != undefined) {
					promotionTag.@exclusive = promotion.@exclusive;
				}
				if (promotion.@promotionXml != undefined) {
					promotionTag.@promotionXml = promotion.@promotionXml;
				}
				promotionsTag.appendChild(promotionTag);
			}
			xmlOut.appendChild(promotionsTag);
		}
		
		//NVS-4806 - msilva
		// Adding InvalidPromotions tag 
        //PosShowMessage(xmlView); 
        if (xmlView.InvalidPromotions.Promotion.length() > 0) { 
            var promotionsTag = new XML('<InvalidPromotions />'); 
            for each (var promotion in xmlView.InvalidPromotions.Promotion) { 
                var promotionTag = new XML('<Promotion />'); 
                if (promotion.@id != undefined) { 
                    promotionTag.@id = promotion.@id; 
                } 
                if (promotion.@offerId != undefined) { 
                    promotionTag.@offerId = promotion.@offerId; 
                } 
                if (promotion.@rejection != undefined) { 
                    promotionTag.@rejection = promotion.@rejection; 
                } 
                if (promotion.@promotionName != undefined) { 
                    promotionTag.@promotionName = promotion.@promotionName; 
                } 
				promotionsTag.appendChild(promotionTag); 
			} 
			xmlOut.appendChild(promotionsTag);
		}			
		
		// Adding Offers tag
		if (xmlView.Offers.length() > 0) {
			var offersTag = new XML('<Offers />');
			if (xmlView.Offers.@tagId != undefined) {
				offersTag.@tagId = xmlView.Offers.@tagId;
			}
			if (xmlView.Offers.@offerId != undefined) {
				offersTag.@offerId = xmlView.Offers.@offerId;
			}
			if (xmlView.Offers.@override != undefined) {
				offersTag.@override = xmlView.Offers.@override;
			}
			if (xmlView.Offers.@applied != undefined) {
				offersTag.@applied = xmlView.Offers.@applied;
			}
			if (xmlView.Offers.@clearAfterOverride != undefined) {
				offersTag.@clearAfterOverride = xmlView.Offers.@clearAfterOverride;
			}
			if (xmlView.Offers.@promotionId != undefined) {
				offersTag.@promotionId = xmlView.Offers.@promotionId;
			}
			if (xmlView.Offers.@promotionCounter != undefined) {
				offersTag.@promotionCounter = xmlView.Offers.@promotionCounter;
			}
			xmlOut.appendChild(offersTag);
		}

		var lastItem='x';
		var lastLevel=0;
		var level=0;
		var item = null;
		var product = null;
		var newProduct = null;
		var changedAfterTotal=false;

		var itemView=null;
		//Items
		for each (itemView in xmlView.ItemView) {
			if(lastItem!=itemView.itemCode) {
				if(item!=null) {
					if(changedAfterTotal) {
						item.@changedAfterTotal='true';
					}
					xmlOut.Order.appendChild(item);
				}

				//Item Element
				item = new XML('<Item/>');
				item.@index = Number(itemView.itemCode)+1;
				item.@voided = ((itemView.quantity==0) && (itemView.grilledQuantity==0));
				item.@qtyPromo = itemView.quantityPromo;
				item.@currentSelected = itemView.currentSelected;

		        changedAfterTotal=false;
				lastItem=itemView.itemCode;
				lastLevel=0;

			}

			// Adding PromotionApplied tag
			var promotionApplied = itemView.PromotionApplied;
			if (promotionApplied.length() > 0) {
				var promotionAppliedTag = new XML('<PromotionApplied />');
				if (promotionApplied.@promotionId != undefined) {
					promotionAppliedTag.@promotionId = promotionApplied.@promotionId;
				}
				if (promotionApplied.@promotionCounter != undefined) {
					promotionAppliedTag.@promotionCounter = promotionApplied.@promotionCounter;
				}
				if (promotionApplied.@eligible != undefined) {
					promotionAppliedTag.@eligible = promotionApplied.@eligible;
				}
				if (promotionApplied.@originalPrice != undefined) {
					promotionAppliedTag.@originalPrice = promotionApplied.@originalPrice;
				}
				if (promotionApplied.@discountAmount != undefined) {
					promotionAppliedTag.@discountAmount = promotionApplied.@discountAmount;
				}
				if (promotionApplied.@discountType != undefined) {
					promotionAppliedTag.@discountType = promotionApplied.@discountType;
				}
				if (promotionApplied.@originalItemPromoQty != undefined) {
					promotionAppliedTag.@originalItemPromoQty = promotionApplied.@originalItemPromoQty;
				}
				if (promotionApplied.@originalProductCode != undefined) {
					promotionAppliedTag.@originalProductCode = promotionApplied.@originalProductCode;
				}
				if (promotionApplied.@offerId != undefined) {
					promotionAppliedTag.@offerId = promotionApplied.@offerId;
				}

				if (promotionApplied.Actions.Action.length() > 0) {
					var actionsTag = new XML('<Actions />');
					for each (var action in promotionApplied.Actions.Action) {
						var actionTag = new XML('<Action />');
						if (action.@name != undefined) {
							actionTag.@name = action.@name;
						}
						if (action.@newValue != undefined) {
							actionTag.@newValue = action.@newValue;
						}
						if (action.@oldValue != undefined) {
							actionTag.@oldValue = action.@oldValue;
						}
						actionsTag.appendChild(actionTag);
					}
					promotionAppliedTag.appendChild(actionsTag);
				}
				item.appendChild(promotionAppliedTag);
			}

 			//Remove open choices from FOE Response XML
			var productType = Number(itemView.productType);
			if(productType == 4) { //productType == 4 -> indicates an open choice
				continue;
			}

			level=Number(itemView.level);
			var defQty = Number(itemView.componentDefaultQtd);
			var qty = Number(itemView.quantity);

			if(itemView.isGrillLine=='true') {
				//Grill
				newProduct = new XML('<grill/>');
				//Modifiers
				newProduct.@modifier = itemView.specialModifiers;
				//newProduct.@defQty = defQty;

				if(itemView.specialModifiers!="0") {
					newProduct.@qty = defQty;
				} else if(defQty>0) {
					newProduct.@qty = defQty+qty;
					//newProduct.@alter = qty;
				} else {
					newProduct.@qty = qty;
				}

			} else {
				newProduct = new XML('<product/>');
				newProduct.@qty = qty;
			}

			newProduct.@code = itemView.productCode;
			//TODO : Verify which unitPrice will be used unitPrice or netUnitPrice
			newProduct.@unitPrice = itemView.unitPrice;

			//newProduct.@lastLevel = lastLevel;
			//newProduct.@level = level;
			//TODO : remove
			//newProduct.@name = itemView.dtName;

			//changedAfterTotal
			if(!changedAfterTotal) {
				changedAfterTotal = (itemView.quantityChanged=='true'||itemView.quantityChanged=='TRUE');
			}

			//check levels
			if(level>lastLevel) {
				product.appendChild(newProduct);
				product = newProduct;
			} else if((level<=lastLevel) &&  (level!=0)) {
				for(j=0; j<((lastLevel-level)+1); j++) {
					product = product.parent();
				}
				product.appendChild(newProduct);
				product = newProduct;
			} else {
				product = newProduct;
				item.appendChild(product);
			}
			lastLevel=level;
		}
		if(item!=null) {
			if(changedAfterTotal) {
				item.@changedAfterTotal='true';
			}
			xmlOut.Order.appendChild(item);
		}
		if(sInvalidItemsView!=null) {
			var invalidItems = new XML('<InvalidItems/>');
			var invalid_item;
			xmlOut.Order.appendChild(invalidItems);

			for each (InvalidItemView in xmlInvalidItemsView.InvalidItemView) {
				invalid_item = new XML('<InvalidItem/>');
				invalidItems.appendChild(invalid_item);

				invalid_item.@index = Number(InvalidItemView.itemCode)+1;
				var invalid_product = new XML('<product/>');;
				invalid_item.appendChild(invalid_product);
				invalid_product.@code = InvalidItemView.productCode;
				invalid_product.@qty = InvalidItemView.quantity;
				invalid_product.@name = InvalidItemView.name;
				invalid_product.@validationCode = InvalidItemView.validationCode;
			}
		}

		API.dbg("[xmlView.ItemTenderView]["+xmlView.ItemTenderView+"]");
		var cashless = null;
		var cashlessCounter=0;
		var itemTenderView=null;
		var cashlessArray = xmlView.Cashless.split(CARDLESS_INFO_SEPARATOR);
		//Tender + Cashless
		for each (itemTenderView in xmlView.ItemTenderView) {
			item = new XML('<Tender/>');

			item.@code = itemTenderView.code;
			item.@qty = itemTenderView.qty;
			item.@value = itemTenderView.value;
			item.@srcPOSId = itemTenderView.srcPOSId;
			item.@discMode = itemTenderView.discMode;

			//Cashless
			if(itemTenderView.cat=="TENDER_ELECTRONIC_PAYMENT") {
				API.dbg("[xmlView.Cashless]["+cashlessArray[cashlessCounter]+"]");
				cashless = stripCashlessString(cashlessArray[cashlessCounter]);
				item.appendChild(cashless);
				cashlessCounter++;
			}
			API.dbg("[Tender Item]["+item+"]");
			xmlOut.Order.appendChild(item);
		}
/*
		var itemViewTimes=null;
		//Times
		for each (itemViewTimes in xmlView.ViewTimes) {
			item = new XML('<Times/>');
			item.@totalTime = itemViewTimes.@totalTime;
			item.@storeTime = itemViewTimes.@storeTime;
			item.@orderTime = itemViewTimes.@orderTime;
			xmlOut.Order.appendChild(item);

			//Only one by XML
			break;
		}
*/
		API.dbg("[XmlOut]["+xmlOut+"]");
		return(xmlOut.toXMLString());
	} catch( ex ) {
		
		API.STTErrorLog("0", "[onConvertView2FOE] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onConvertView2FOE] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
	
		return (null);
	}

	//***** HELPER FUNCTIONS ******//
	function stripCashlessString(cashlessStr) {
		//TODO : check cashless string format
		//function ParseTrackInfo(retcode,cardType)
		//function cashlessPayment(tenderId,tenderValue,refund)
		var cashless = new XML('<cashless/>');
		//TODO : check the split
		API.dbg("[cashlessStr]["+cashlessStr+"]");
		var splitStr = cashlessStr.split("@");
		API.dbg("[splitStr]["+splitStr+"]");			
		for(i=0; i < splitStr.length; i++) {
			API.dbg("[splitStr - "+i+"]["+splitStr[i]+"]");
		}
		if(splitStr.length<12) {			
			return cashless;
		}

		cashless.@cardProv = splitStr[0].split(":")[1];
		cashless.@cardNum = splitStr[1];
		cashless.@expire = splitStr[2];
		cashless.@auth = splitStr[3];
		cashless.@printFlag = splitStr[5];
		cashless.@seqNo = splitStr[6];
		cashless.@gcBalance = splitStr[10];
		cashless.@account = splitStr[11];
		
		API.dbg("[cashless]["+cashless.toXMLString()+"]");
		
		return cashless;
	}

	function lGetOrderPrefix(currentOrderPod, currentOrderRemPod, currentOrderStatus) {
		var i;
		var orderPrefix;
		var podSource;
		var orderStatus;
		
		try {
		
			API.STTInfoLog("0", "[lGetOrderPrefix] - Initiating function", BC_EVENTS_NAME);
			
			resultRemPod = lParsePodCode(currentOrderRemPod);
					
			// Search the PodSource array for a corresponding Rem POD.
			for (i in foeRoutingPodSourceArray) {
			
				podSource = foeRoutingPodSourceArray[i];
				
				// If a matching Pod Source was found, check to see if the order status also match.
				if (podSource == currentOrderRemPod) {
					
					orderStatus = foeRoutingPaidStatusArray[i];
					
					// If the order status also match.
					if (orderStatus == currentOrderStatus) {
					
						orderPrefix = foeRoutingOrderNumberPrefixArray[i];
						//If have a configuration error, the prefix returned is "00"
						if(orderPrefix == undefined) {
							orderPrefix = "00";
						}
						break;
					}
				}	
			}
			//If have a configuration error, the prefix returned is "00"
			if(orderPrefix == undefined) {
				orderPrefix = "00";
			}
			
			API.STTInfoLog("0", "[lGetOrderPrefix] - This function was successfully executed. Returned Order Prefix value: " + orderPrefix, BC_EVENTS_NAME);
			
			return orderPrefix;
			
		} catch( ex ) {
			API.STTErrorLog("0", "[lGetOrderPrefix] - " + ex.message, BC_EVENTS_NAME);
			API.STTErrorLog("0", "[lGetOrderPrefix] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
			return (null);
		}
	}
}

/**onExtractInvoiceFromFOE
 *
 * @brief - This function extracts the delivery invoice data from FOE XML
 * @param - sIn - string ->the FOE XML string representation
 * Return - rval - string representing the delivery invoice data XML
 */
function onExtractInvoiceFromFOE(sIn) {
	var xmlIn = null;
	var xmlView = null;

	try {
		if(sIn==null) {
		    sIn='<ProdInfo/>';
		}

		xmlIn = new XML(sIn);
		
		return (xmlIn.InvoiceData.toXMLString());
	} catch( ex ) {
		return (null);
	}
}

/**onSWDayOpen
 *
 * @brief - called at Store Wide Open of the day
 * @Parameter - timeout - string - (optional) - time to execute the command in miliseconds (default is 15000ms) \n
 * @Parameter - isForded - string - (optional) - "true" or "false"(default)\n
 */
function onSWDayOpen(timeout,isForded) {
     // For eSocket cashless, we need to properly open the connection
     // at store open
     if (PosCheckParameter("TCLExtension","esocket","true")) {
          npTCLEvalEx("Everest_Operation 1 0 0");
     }

     return(true);
}


/**onSWEndOfDay
 * @brief - called at Store Wide End of day
 * @Parameter - timeout - string - (optional) - time to execute the command in miliseconds (default is 15000ms) \n
 * @Parameter - isForded - string - (optional) - "true" or "false"(default)\n
 */
function onSWEndOfDay(timeout,isForded) {
     // For eSocket cashless, we need to disconnect server connection at
     // store close
	if(PosCheckParameter("Cashless3", "Active", "true")) {    				// cashless 3.0 operation
		PerformCutoverIfNeeded();
	} else if (PosCheckParameter("TCLExtension","esocket","true")) {		// cashless 2.0 operation
          npTCLEvalEx("Everest_Operation 2 0 0");
     }

     return(true);
}


/**onRequestCard
 *
 * @brief - This function initializes the card reader
 * Return - true if valid
 */
function onRequestCard(msg) {
	if(0 == msg.length) {
		return(false);
	}
	PosShowMessage(msg,"_NOMODAL:STBTN:MSG_CANCEL");
	return(true);
}

/**onValidateManagerCard
 *
 * @brief - This function validates a string read by card reader
 * @param - minLevel - minimun level for validation
 * @param - cardData - data read from card
 * Return - true if valid
 */
function onValidateManagerCard(minLevel,cardData) {
	PosShowMessage("MSG_PROMPTCARD","_NOMODAL:END");

	if(cardData.length < 32) {
		if (cardData == "-1") {
			// Timeout
			PosShowMessage("MSG_PROMPTTIMEOUT");
		}
		else if (cardData == "-2") {
			// No data available
			PosShowMessage("MSG_INVCARD");
		}
		
		return(false);
	}
	var site=cardData.substr(0,8);
	var store=cardData.substr(4,4);
	var id=cardData.substr(12,4);
	var level=cardData.substr(21,2);
	var passwd=cardData.substr(23,8);
	var signature=cardData.substr(17,4);
	var magpar=cardData.substr(8,1);

	if("F" == magpar) {
		level=""+rootHlp.getUserInfo(id,2);
	}
	if (((level == "86") || (level == "88") || (level == "90")) && (signature == "1299") && (Number(level) >= Number(minLevel))) {
		if(rootHlp.validateUser(id,null,minLevel,"manager")) {
			return(true);
		}
	}
	PosShowMessage("MSG_INVCARD");
	return(false);
}

/**onEndRequestCard
 *
 * @brief - This function finalizes the  card reader
 * @param - mode - operation mode
 * Return - true if valid
 */
function onEndRequestCard(mode) {
	if(0 == mode)
	{
		// mode equal 0 - Card validated is Ok
		return(true);
	}
	// mode equal 1 - Card not valid - FALSE as return stops execution, TRUE would open the keypad....
	return(false);
}

//SDE-2351
/**onBeforeChangeSizeSelection
 *
 * @brief - This function handles onBeforeChangeSizeSelection event
 * Return - rval - if it's true the caller is allowed to continue
 */
function onBeforeChangeSizeSelection(upgradeSize)
{
	if(PosCheckSessionProperty("POD","CSO")) {
		return(true);
	}

	var curView = rootHlp.getCurrentView();
	if(curView == null) {
		return(true);
	}
	var view = new XML(curView);
	if(null == view) {
		return(true);
	}
	var items=view.ItemView.(level == 0 && quantity > 0);
	if(null == items) {
		return(true);
	}

	var i;
	var selItem=null;
	var balance=0;
	for(i=0; i < items.length(); i++) {
		var item=items[i];
		if(item.currentSelected == "true") {
			selItem=items[i];
			if(item.familyGroup != REGULAR_ENTREE && item.familyGroup != BREAKFAST_ENTREE) {
                                return(false);
			}
		//NVS-6889, check outage
		var pCode=item.productCode.toString();
		var itemDescr=new XML(API.getProductdbProduct(pCode));
		var upsizeProductCode="";
		//SDO-16419 - Check which product this size selection creates 
		for(var i = 0; i < itemDescr.SizeSelection.Size.length(); i++) { 
			if(itemDescr.SizeSelection.Size[i].@entry == upgradeSize) { 
				upsizeProductCode = itemDescr.SizeSelection.Size[i].@code; 
				break; 
			} 
		}
		var isOutage=lIsInProductOutage(upsizeProductCode);
		if (isOutage){
			return false;
		}
		else{
			return true;
		}
			
		}
	}
	return(null!=selItem);
	
	/** lIsInProductOutage
	 * 
	 * @brief - Checks to see if a given product code is the prodoutage.xml file.
	 * @param - string - Product code
	 * @retruns - True if the product code is in the outage file, otherwise false.
	 */
	function lIsInProductOutage(productCode) {		
		var outageFile = API.getProductOutage();
		var outageXML;				
		// Check if the outage file exists.
		if(outageFile == undefined || outageFile == null) {
			return false;
		}		
		outageXML = new XML(outageFile.toString());		
		// Check if the current product code is inside the outage file.
		for each(var outageProductCode in outageXML.Product.@code) {		
			// If the current product is in the outage file.
			if(outageProductCode == productCode.toString()) {
				return true;
			}
		}		
		// If the current product isn't in the outage file.
		return false;
	} 	
}

//SDE-2536
/**onChoiceMade
 *
 * @brief - This is called once choices are made
 * @param - code - product code
 * @param - qty - quantity of choices made
 * Return - always returns true
 */
function onChoiceMade(qty, forceAll) {
	/* SDO-3839 -protect non-erc stores */
	if (PosCheckParameter("UserInterface", "ERC_substitution", "true")) {
     if(forceAll) {
         if (PosConvertProductForceAll()) {
           PosAutoChoice();
         }

     } else {
         if (PosConvertProduct()) {
           PosAutoChoice();
	         }
         }
     }

     return(true);
} 

// NPS-5771
/** onNewSaleList
 *
 * @brief - Formats the incoming order view to be used by the sale panel (display purposes only, this data will not be persisted).
 *			The incoming order view is sent to this function on the fly (after every ordered/changed item).
 * @return - changed order view (if necessary) to be displayed on sale panel.
 * @author - Kalil
 */
function onNewSaleList(sSalePanelType, sView) {
	// Calls the consolidation mechanism for autocondiment items.
	//NVS-3226 
	//return consolidateACSalePanel(sView);
	
	//Kalpesh - NVS-6690 - Bun and protein of signature crafted sandwiches are displaying after the grill items on register sales panel.
	var view = null;
	if (sView == null) {
	return null;
	} else {
	try {
		var view = new XML(sView);
		levelChefCrafted = 0;
		isChefCrafted = false;
		for (var j = 0; j < view.ItemView.length(); ++j) {
			if(isChefCrafted && levelChefCrafted == (toInt(view.ItemView[j].level)-1)){
					if(view.ItemView[j].isGrillLine == "true") {
						// Change displayOrder of grill of Signature Crafted items in order to display grill instructions at the end of the item
						view.ItemView[j].displayOrder = 999999 + toInt(view.ItemView[j].displayOrder);
					}
				} else {
					isChefCrafted = false;
					levelChefCrafted = 0;
					var pCode = new XML(API.getProductdbProduct(view.ItemView[j].productCode));
					if(pCode != null && pCode != ""){
						if(pCode.CustomParameters != null){
							for each (var param in pCode.CustomParameters.Parameter){
								if(param.@name == "isChefCrafted" && param.@value == "true"){
								levelChefCrafted = toInt(view.ItemView[j].level);
								isChefCrafted = true;
								break;
								}
							}
						}
					}
			}
		}//end of for loop
	}catch(ex) {
		API.dbg("FATAL ERROR: Could not handle onNewSaleList on the view, due to: " + ex);
		return sView;
		}
	}
return view != null ? view.toXMLString() : null; 	
}

// NPS-5771
/** consolidateACSalePanel
 *
 * @brief - Consolidates the autocondiment items and changes its level to zero. (Part of feature PLE-194 : Auto condiment)
 * @return - New order view having all autocondiments consolidated and its level set to zero.
 * @author - Kalil
 */
function consolidateACSalePanel(sView) {
 	if (sView == null) {
		return null;
	} else {
		try {
			var view 			= new XML(sView);
			var acItemsList 	= new Array();
			var viewWrapper		= new StringBuffer();
			assertPromoQuantities(view);
			// Removes all the auto-condiment items from the view.
			for (var j = 0; j < view.ItemView.length(); ++j) {
				var isAC 		= view.ItemView[j].AutoCondiment;
				var acDisplay 	= view.ItemView[j].ACDisplay;
				if (isAC=='true') {
					var acItemView 	= view.ItemView[j];
					var acLevel 	= new Number(acItemView.level);
					var parentsQty 	= getParentsQuantity(view, j, acLevel);
					if (displaySalePanel(acDisplay)) {
						acItemView.quantity *= parentsQty;
						// Consolidates the ACs based on the product code.
						consolidateACItem(acItemView);
					}
					delete view.ItemView[j];
					j--
				}
			}
			// Removes the AC zombie parents.
			removeACZombieParents(view);
			// Re-adds the joined auto-condiment items to the view.
			for (var x=0; x < acItemsList.length; x++) {
				view.appendChild(acItemsList[x]);
			}
			viewWrapper.append(view.toXMLString());
			return viewWrapper;
		} catch(ex) {
			API.dbg("FATAL ERROR: Could not handle auto-condiments on the view, due to: " + ex);
			return sView;
		}
	}

	function assertPromoQuantities(view) {
		try {
			var promoId  = 0;
			var promoQty = 0;
			for (var j = 0; j < view.ItemView.length(); ++j) {
				var isAC 	= view.ItemView[j].AutoCondiment;
				var item  	= view.ItemView[j];
				var level 	= new Number(item.level);

				if (level == 0) {
					// root item
					// rootItem		= item;
					rootQtyPromo	= new Number(item.quantityPromo);
					rootPromoId		= new Number(item.promo.@id);
				} else if (rootQtyPromo > 0 && isAC == 'true') {
					// Autocondiment with promo
					var parentQty		= getLevelQuantity(view, j, level);
					var	qtyPromo		= rootQtyPromo * parentQty * new Number(item.quantity);
					var promoxml		= '<promo id="' + rootPromoId + '">' + rootQtyPromo + '</promo>';
					API.dbg("[assertPromoQuantities] promoxml: [" + promoxml + "]");
					var promo			= new XML(promoxml);

					// item.quantity		= getLevelQuantity(view, j, level);
					API.dbg("[assertPromoQuantities] item.quantity: [" + item.quantity + "]");
					item.quantityPromo	= qtyPromo;
					API.dbg("[assertPromoQuantities] item.quantityPromo: [" + item.quantityPromo + "]");
					delete item.promo;
					item.appendChild(promo);
				}
			}
		} catch (ex) {
			API.dbg("FATAL ERROR: Could not fix promo quantities, due to: " + ex);
		}
		/*
		 * Gets the quantity of a given level.
		 * @author - Kalil
		 */
		 function getLevelQuantity(view, curIndex, level) {
			try {
				var total = 1;
				for (var x = curIndex; x >=0; x--) {
					if (new Number(view.ItemView[x].level) < level) {
						if (view.ItemView[x].level == 0) {
							return total;
						} else {
							total = total * new Number(view.ItemView[x].quantity);
						}
					}
				}
			} catch (ex) {
				API.dbg("FATAL ERROR: Could not get the quantity of the previous level, due to: " + ex);
			}
			return 1;
		}
	}

	/*
	 * Removes the AC zombie parents.
	 * @author - Kalil
	 */
	function removeACZombieParents(view) {
		for (var j=0; j<view.ItemView.length(); ++j) {
			var acDNAPath		= new Number(view.ItemView[j].acDNAPath);
			var isLastElement 	= (j == view.ItemView.length() - 1);
			if (acDNAPath==1) {
				if (!hasChild(j)) {
					// Has no child and it was linked to an AC item, lets check if it is a zombie parent.
					if (removeZombieParent(j)) {
						// Lets reset it and starts again, we dont know if we left the grandparent as a zombie.
						j=-1;
					}
				}
			}
		}
		// Lets remove the DNA information.
		for (var j = 0; j < view.ItemView.length(); ++j) {
			var acDNAPath = new Number(view.ItemView[j].acDNAPath);
			if (acDNAPath == 1) {
				delete view.ItemView[j].acDNAPath;
			}
		}

		/*
		 * Verifies if the given item index has children items.
		 * @author - Kalil
		 */
		 function hasChild(curIndex) {
			var level = new Number(view.ItemView[curIndex].level);
			var isLastElement = (j == view.ItemView.length() - 1);
			if ((!isLastElement) && (level < new Number(view.ItemView[curIndex+1].level))) {
				return true;
			}
			return false;
		}

		/*
		 * Removes the zombie parent. It will only be preserved if it has at least one of the following characteristics:
		 * 		1) OPENED CHOICE (MUST SHOW OPENED CHOICES)
		 * 		2) GRILLED ITEMS (MUST SHOW GRILLED PRODUCTS)
		 * 		3) NON ZERO PRICE (COST NOT INCLUSE)
		 *      4) QUANTITY GREATER THAN ZERO (MUST SHOW VOID ITEM)
		 *		5) PROMO QUANTITY NOT EQUALS TO ZERO (MUST SHOW PROMOTED ITEMS)
		 * @author - Kalil
		 */
		function removeZombieParent(index) {
			var quantity		= new Number(view.ItemView[index].quantity);
			var promoQty		= new Number(view.ItemView[index].quantityPromo);
			var totalPrice		= new Number(view.ItemView[index].totalPrice);
			var totalPriceBP	= new Number(view.ItemView[index].BPTotalPrice);
			var isGrillLine		= view.ItemView[index].isGrillLine;
			var productType		= new Number(view.ItemView[index].productType);	// OPEN CHOICE=4
			var	level			= new Number(view.ItemView[index].level);
			var prodAction		= new Number(view.ItemView[index].prodAction);
			if (	totalPriceBP		== 0		&&
					promoQty			== 0		&&
					quantity			> 0			&&
					productType			!= 4		&&
					isGrillLine			== 'false'	&&
					totalPrice			== 0		&&
					level				!= 0		&&
					prodAction			!= 3
			) {
				delete view.ItemView[index];
				return true;
			} else {
				return false;
			}
		}
	}

	/*
	 * Calculates the parents quantity.
	 * @author - Kalil
	 */
	 function getParentsQuantity(view, curIndex, curLevel) {
		try {
			var qty = 1;
			for (var x=curIndex;x>=0;x--) {
				if (new Number(view.ItemView[x].level) < curLevel) {
					curLevel = new Number(view.ItemView[x].level);
					qty *= new Number(view.ItemView[x].quantity);
					// Creates the AC DNA indicating the genealogy path, so we
					// can find the its possible zombie parents.
					view.ItemView[x].acDNAPath = "1";
					if (curLevel == 0) {
						break;
					}
				}
			}
			return qty;
		} catch (ex) {
			API.dbg("FATAL ERROR: Could not calculate parents quantity for auto-condiments, due to: " + ex);
			return 1; // At least keeps the AC default quantity.
		}
	}

	/*
	 * Verifies the AC item can be shown on sale panel.
	 *
	 *  1) OT: 		Does not display auto condiments (In any situation).
	 *  2) OT/CS: 	Displays the auto condiments on the sales panel only if the order was recalled
	 *  3) CS: 		Displays the auto condiments on the sales panel
	 * @author - Kalil
	 */
	 function displaySalePanel(acDisplay) {
		if ((PosCheckSessionProperty("workingMode","orderTaker")) ||
			((PosCheckSessionProperty("workingMode","both") && (!PosCheckSessionProperty("saleRecalled","true"))))) {
			return false;
		}
		var props = acDisplay.split("|");
		for (var w=0;w<props.length;w++) {
			if (props[w]=="pos") {
				return true;
			}
		}
		return false;
	}

	/*
	 * Consolidates the incoming order items.
	 * @author - Kalil
	 */
	function consolidateACItem(acItemView) {
		// Auto-condiment must be in the level zero.
		acItemView.level 			= 0;
		// Auto-condiment item does not accept non-zero price.
		acItemView.unitPrice		= 0;
		acItemView.netUnitPrice		= 0;
		acItemView.unitTax			= 0;
		acItemView.totalPrice		= 0;
		acItemView.netTotalPrice	= 0;
		acItemView.totalTax			= 0;
		acItemView.ADTotalPrice		= 0;
		acItemView.ADNetTotalPrice	= 0;
		acItemView.ADTotalTax		= 0;
		// Is not selected any more.
		acItemView.currentSelected  = 'false';
		var sz = acItemsList.length;
		for (var x=0; x < sz; x++) {
			var item = acItemsList[x];
			if (item.productCode == acItemView.productCode) {
				// By design, does not support grilled quantities. (AC items are not grillable)
				var promoQty		= (new Number(item.quantityPromo) 	+ new Number(acItemView.quantityPromo));
				var promoId			= getPromoId(item, acItemView);
				item.quantity 		= (new Number(item.quantity) 		+ new Number(acItemView.quantity));
				item.quantityPromo	= promoQty;
				if (promoQty > 0) {
					var promoxml = '<promo id="' + promoId + '">' + promoQty + '</promo>';
					var promo = new XML(promoxml);
					delete item.promo;
					item.appendChild(promo);
				}
				return;
			}
		}
		// Item was not found in the list, lets add it.
		acItemsList[sz] = acItemView;
	}

	function getPromoId(item, acItemView) {
		if (new Number(item.quantityPromo) > 0) {
			return item.promo.@id;
		} else {
			return acItemView.promo.@id;
		}
	}
}

/**
 * \brief Entry point called by kernel in order to create a EVMR view
 * \param [in] view - View to consolidate in string format
 * \since NPS-4867
 */
function onAdjustViewForEvmr (view) {
    var evmrView = new EVMRView (view);
    evmrView.adjustViewItems ();
    return evmrView.getStringView ();
}

/**
 * \brief Entry point called by kernel in order to create a EVMR view
 * \param [in] view - View to consolidate in string format
 * \since SDO-3214
 */
function onAdjustViewForEvmrOverride (view) {
    var evmrView = new EVMRView (view);
    evmrView.adjustViewItemsOverride ();
    return evmrView.getStringView ();
}

/**
 * \brief Entry point called by kernel in order to create a EVM view
 * \param [in] view - View to consolidate in string format
 * \since NPS-4867
 */
function onAdjustViewForEvmCOD (view) {
	EVMCODView.prototype.US2_adjustVMPrices = US2_adjustVMPrices;
    var evmCODView = new EVMCODView (view);
    //evmCODView.removeUnsolvedChoiceItems ();
    evmCODView.US2_adjustVMPrices ();
    return evmCODView.getStringView ();
}

function US2_adjustVMPrices() {
    var parentVm = null

	/* check for mcSavings */
	isMcSavings = false;
	promotionName = this.view().Promotions.Promotion.@promotionName;
	if ( promotionName.indexOf("McSavings") > -1) { 
		isMcSavings = true;
	}


    for (var i = 0; i <  this.view().ItemView.length(); i++) {
        var item = this.view().ItemView[i];
		/* NVS-4126 -added discount product update item level only */ 
		if ((0 == item.level) && (isMcSavings == false) ) { 
			if (item.ADTotalPrice != null) { item.totalPrice = API.formatNumber (parseFloat(item.ADTotalPrice), NUMBER_FORMAT, 8); } 
		} 
		
		if ((0 == item.level) && (this.PC_VALUE_MEAL == item.productType)){
				// This the value meal
				item.totalVMPrice = API.formatNumber (parseFloat(item.totalPrice), NUMBER_FORMAT, 8);
				parentVm = item;
			} else if ((0 == item.level) && (this.PC_VALUE_MEAL != item.productType) && (item.choiceLevel <= 0)){
				parentVm = null;

			} else if ((item.level > 0)
				//  && (this.PC_CHOICE != item.productType)
					&& (3 == item.prodAction) ) {
			// This is a choice
			if(parentVm!=null) {
					//var diff = this.priceDifference (item);
				var diff = parseFloat(item.totalPrice) - (parseFloat(item.referencePrice)*(parseFloat(item.quantity)-parseFloat(item.quantityPromo))*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo)));
			diff = API.formatNumber (diff, NUMBER_FORMAT, 8);
					
			if(diff>0 && this.config.showUpCharge) {
						parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + (parseFloat (item.referencePrice) * (parseFloat(item.quantity)-parseFloat(item.quantityPromo))*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo))), NUMBER_FORMAT, 8);
						item.choicePriceDiff = API.formatNumber (diff, NUMBER_FORMAT, 8);
			} else if(diff<0 && (!this.config.suppressDiscount) && (this.config.showDiscount)) {
						parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + (parseFloat (item.referencePrice) * (parseFloat(item.quantity)-parseFloat(item.quantityPromo))*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo))), NUMBER_FORMAT, 8);
						item.choicePriceDiff = API.formatNumber (diff, NUMBER_FORMAT, 8);
			} else {
						parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + parseFloat(item.totalPrice), NUMBER_FORMAT, 8);
						item.choicePriceDiff = API.formatNumber ("0", NUMBER_FORMAT, 8);
					}
			}
		}
    }
	if(!g_isCODEnabledInitialized)
	{
		g_isNGCODEnabled = isNGCODEnabled();
		g_isLegacyCODEnabled = isLegacyCODEnabled();
		g_isCODEnabledInitialized = true;
	}
	/* add a last line with the amount discounted */ 
	if ((!g_isNGCODEnabled || g_isLegacyCODEnabled) && isMcSavings) { 
		rate 	= 0
		amt	= 0
		name	= "";

		/* get values */ 
		view =this.view();		
		for (var i = 0; i <  view.ItemTenderView.length(); i++) {
			if (view.ItemTenderView[i].kind == 1) { 
				rate 	= view.ItemTenderView[i].discRate														
				amt	= view.ItemTenderView[i].value;
				desc	= view.ItemTenderView[i].description;
				break;
			}
		} 

		/* populate values */
		savingssLine 			= view.ItemView[0].copy();
		savingssLine.quantity 		= Number(rate);
		savingssLine.quantityPromo	= 0;
		savingssLine.quantityItemPromo	= 0;
		savingssLine.totalPrice		= API.formatNumber (amt, NUMBER_FORMAT, 8);
		savingssLine.totalVMPrice	= API.formatNumber (amt, NUMBER_FORMAT, 8);
		savingssLine.longName 		= String(desc);

		/* add back to list */ 
		view.ItemView += savingssLine;		
	} 	
}

function onAdjustViewForCOD(view)
{
	return onAdjustViewForEvmCOD(view);
}

/**
 * \brief Entry point called by kernel in order to create a EVM view
 * \param [in] view - View to consolidate in string format
 * \since NPS-4867
 */
function onAdjustViewForEvmLD (view) {
	EVMCODView.prototype.US_adjustVMPrices = US_adjustVMPrices;
    var evmCODView = new EVMCODView (view);
    evmCODView.US_adjustVMPrices ();
    return evmCODView.getStringView ();

}
function US_adjustVMPrices() {
    var parentVm = null;
    var config = new Config ("ValueMealDisplay", true);
	LDUpChargeText = config.getParameter("VMDisplay_UpChargeLDText");
    LDDiscountText = config.getParameter("VMDisplay_DiscountLDText");
    for (var i = 0; i <  this.view().ItemView.length(); i++) {
        var item = this.view().ItemView[i];
		if ((0 == item.level) && (this.PC_VALUE_MEAL == item.productType)){
            // This the value meal
            item.totalVMPrice = API.formatNumber (parseFloat(item.totalPrice), NUMBER_FORMAT, 8);
            parentVm = item;
        } else if ((0 == item.level) && (this.PC_VALUE_MEAL != item.productType) && (item.choiceLevel <= 0)){
            parentVm = null;
        } else if ((item.level > 0)
            //  && (this.PC_CHOICE != item.productType)
                && (3 == item.prodAction) ) {
					// This is a choice
					if(parentVm!=null) {
						//var diff = this.priceDifference (item);
						var diff = parseFloat(item.totalPrice) - (parseFloat(item.referencePrice)*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo)));
						// NVS-537 force diff to be a number
						diff = API.formatNumber (diff, NUMBER_FORMAT, 8);

					if(diff > 0 && this.config.showUpCharge) {
						//parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + (parseFloat (item.referencePrice) * (parseFloat(item.quantity)-parseFloat(item.quantityPromo))*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo))), NUMBER_FORMAT, 8);
						parentVm.totalVMPrice = API.formatNumber(diff);
						item.choicePriceDiff = API.formatNumber (diff, NUMBER_FORMAT, 8);
						parentVm.longName = item.longName + "<" + LDUpChargeText + ">";
					} else if(diff < 0 && (!this.config.suppressDiscount) && (this.config.showDiscount)) {
						//parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + (parseFloat (item.referencePrice) * (parseFloat(item.quantity)-parseFloat(item.quantityPromo))*(parseFloat(parentVm.quantity)-parseFloat(parentVm.quantityPromo))), NUMBER_FORMAT, 8);
						parentVm.totalVMPrice = API.formatNumber(diff);
						item.choicePriceDiff = API.formatNumber (diff, NUMBER_FORMAT, 8);
						parentVm.longName = item.longName + "<" + LDDiscountText + ">";
					} else {
						parentVm.totalVMPrice= API.formatNumber (parseFloat(parentVm.totalVMPrice) + parseFloat(item.totalPrice), NUMBER_FORMAT, 8);
						item.choicePriceDiff = API.formatNumber ("0", NUMBER_FORMAT, 8);
					}
			}
		}
    }
}

// NVS-58 RPS 9/10/09
/** PosBuildDisableListJS
 *
 * @brief - Builds a list of product ID's to use for disabling drink choice logic
 * @param - none
 * return - always return true
*/


function onProductDBIteration(item, mObj)
{
	ActiveProd = new XML(item);
	
	/* NVS-3316 -fixed drink check logic issue */ 
	if (ActiveProd.@productClass == "CHOICE") {
		if (ActiveProd.FamilyGroup.indexOf("DRINK") != -1) {
			DisableString += ActiveProd.ProductCode + "|";
		}
	} 

	return true;
}
function CashOutJS (maxCashOut) {
	return GCCashOutJS(maxCashOut);
}

/** onCanDiscount
 * @brief Event used to verify whether or not the discount can be applyed. This is a localization rule to evaluate the discount.
 * This event is called from PosDoDiscount_CSL() BC in CSL_Tender.nps. If this event returns false, the current discount is canceled.
 * @param discountId - string - (numeric value) discount id as configured in store-db
 * @param type - string - type of discount: 1-normal (default)\n 
 *													 2-crew meal\n 
 *													 3-manager meal
 * @param amount - amount value to apply the discount
 * @since SDO-2175
 */
function onCanDiscount (discountId, type, amount) {
	return true;
}

/** onPromoItemAuthorization 
 * @brief Event used to handles a promo item authorization.
 * This event is called from PosValidatePromoItem() BC in CSL_Sales.nps. 
 * @param type - string - authorization type
 * @param message - string - message to be present
 */
function onPromoItemAuthorization (type, message) {
	var bAuth=false;
	if(""==message) {
		bAuth=PosGetAuthorization(type);	// SingleSignOn - false
	}
	else {
		bAuth=PosGetAuthorizationJSUS(type,message);	// SingleSignOn - false
	}
	if(false==bAuth) {
		// Not Authorized
		return(false);
	}
	
	return (true);
}

/** onPromoOrderAuthorization 
 * @brief Event used to handles a promo order authorization.
 * This event is called from PosValidatePromoOrder() BC in CSL_Sales.nps. 
 * @param level - string - authorization level
 * @param sigleSignOn - string -
 */
function onPromoOrderAuthorization (level,sigleSignOn) {
	return(PosGetAuthorizationJSUS(level,sigleSignOn));
}

/** onDeniedSizeSelection 
 * @brief Event used to handles a change size selection error.
 * This event is called from PosChangeSizeSelection() BC in CSL_Sales.nps. 
 * @param ErrorCode - int - error reason
 */
function onDeniedSizeSelection (notUsed) {
	var curView = rootHlp.getCurrentView();
	if(curView == null) { return(true); }

	var view = new XML(curView);
	if(null == view) { return(true); }
	var selectedItem =view.ItemView.(level == "0").(currentSelected == "true");

	if (Number(selectedItem.quantityPromo) >= Number(selectedItem.quantity)) { //NVS-1761 Converted to number before compare
		PosShowMessage("MSG_BC_SIZEINVD_PROMO");
	} else {
		PosShowMessage("MSG_BC_SIZEINVD");
	}
}

function onTenderExceeded(TenderId, TenderName, HaloLimit)
{
	var ReturnValue = PosGetAuthorizationJSUS("manager", "ACTION_Tender HALO");
	
	if (ReturnValue == false) {
		PosSetSessionProperty("LargeTenderApproved", "false");
	}

	return ReturnValue;
}


function onTotal() {
	var ReturnValue = true;
	var view = rootHlp.getCurrentView();
	view = new XML(view);
	var hlp = new BusinessObjectHelper();
	var saleType = hlp.getSaleType();
	var byPassChoices = PosGetByPassChoice();
	
	var isFromKiosk = (rootCtx.get("POD") == "CSO");

	//NVS-670  start
	cmd = "cPosCheckPromotedOrder";
	// See if the order if promo'd
	if(executeBC(cmd)) {
		// Check to see if it's already been approved
		if(PosCheckSessionProperty("discountForPromoOrder", "true")) {
			ReturnValue = true;
		} else {
			if((!PosCheckSessionProperty("getAuthForForPromoOrder","false")) && (!onPromoOrderAuthorization("manager", "false"))) {
				// Not Authorized
				PosSetSessionProperty("discountForPromoOrder","false","false");
				ReturnValue = false;
			} else {
				PosSetSessionProperty("discountForPromoOrder","true","false");
			}
		}
	}
	// NVS-670  end

	//NVS-864 start
	if (ReturnValue == true) {
		if (view != null && !byPassChoices) {  //NVS-982 byPass verification
			var items = view.ItemView;
			var ItemCount = items.length();

			/* NVS-931 - added to support choices */
			var itemQuantityLevelZero = 0;
			for (var Loop = 0; Loop < ItemCount; Loop++) {
				if(items[Loop].level == 0) {
					itemQuantityLevelZero = items[Loop].quantity ;
				}
				if (items[Loop].description.indexOf('***') != -1 && items[Loop].quantity > 0 && itemQuantityLevelZero != 0) {
					PosShowMessage("MSG_BC_ITEMINCOMPLETE", items[Loop].description );
					ReturnValue = false;
					break;
				}
			}
		}
	}
	// NVS-864 end

	if ((ReturnValue == true) 
		&& (!PosCheckSessionProperty("saleRecalled", "true")) 
		&& (!PosCheckSessionProperty("CalledFromGCActivate", "true")) ) {

		/* NVS-1020 -prevent manager promts, has already been prompted */ 
		if(!PosDoValidateLimits(false)) {
 			ReturnValue = false;
		}
	}
	
	
     /*tax enhancements (apply fees) */
     /* SDO-5015 -don't apply fees if it's a promo order */
     if ((ReturnValue == true) /* && (!PosCheckSessionProperty("CalledFromPromoOrder", "true")) Removed per NVS-776 */) { 
		var view = rootHlp.getCurrentView();
		view = new XML(view);
		PosApplyFee_COE(view.@type);
	} 

	if (ReturnValue == true) {
		BTPrintOrderNumber(view.@orderId);
		TableServiceSelected = rootCtx.get("TableServiceSelected");
		
		if (TableServiceSelected == undefined || TableServiceSelected == null || TableServiceSelected == "") {
			rootCtx.set("TableServiceSelected", false);
			TableServiceSelected = false;
		}
		
		if(TableServiceSelected == false || TableServiceSelected == "false") {
			// Felipe Ramas - NVS-4118 - Implement Table Service Model Specifications	
			// NVS-6925 - msilva - Ask / Remove tag ID when order conditions match or not
			if (VerifyAndShowTagIdSmartScreenJS(false,saleType)) {
				// If tag id floating screen is displayed, PosDoTotal must not continue
				ReturnValue = false;
			}
		}
	}
	
	return ReturnValue;
}



/**onRecallVoidWithReversalFailure
 *
 * @brief - This function handles onRecallVoidWithReversalFailure event, a void order that was recalled with reversal payment that failure.
 * Return - rval - if it's true the caller is allowed to continue
 */

function onRecallVoidWithReversalFailure() {
	
    PosShowMessage("MSG_BC_RPS_CHANGE_IN_CANCELED_ORDER");
	
    // Void current sale
    var retVal = PosDoVoidSale(true);
    if (retVal) {
        PosCreateReport("VIEW", "Receipt#USReceiptReports", "NOPREVIEW|SAVE");
    }
	PosShowScreen(rootCtx.get("baseScreenId"));
	return(true)
}


/**onRecallPaidOrder
 *
 * @brief - This function handles onRecallPaidOrder event, a PAID order that was recalled.
 * Return - rval - if it's true the caller is allowed to continue
 */
function onRecallPaidOrder()
{

	// Totalize the current sale
	if(!PosDoTotal()) {
		/* total failed, return to basescreen */
		PosShowScreen(rootCtx.get("baseScreenId"));
		return(false);
	}
	
	PosShowScreen("55");
	
	return(true)
}

/**onRecalledMobileOrder
 *
 * @brief - This function handles onRecalledMobileOrder event, a mobile order was recalled.
 * Return - rval - if it's true the caller is allowed to continue
 */
function onRecalledMobileOrder(MobileOrderStatus)
{
		
	OnMobilePaymentChanged( rootHlp.GetViewOrderKey());		
	try
	{
		// && PosCheckSessionProperty("workingMode","orderTaker"))
		if(PosCheckSessionProperty("POD","DRIVE_THRU") || PosCheckSessionProperty("POD","WALK_THRU"))
		{
			if(PosCheckSessionProperty("workingMode","orderTaker"))
			{
				// show invalid items
				//NVS-4801 - msilva
				var ret = PosVerifyMobileOrder(true, "TRUE");
				PosSetSaleType(1); //TAKEOUT

				//NVS-4821 - msilva
				if(rootHlp.GetOrderSrc() == '1') 
				{ 
					if (PosDoTotal()) { 
						if(MobileOrderStatus == MOS_RECALLED) 
						{ 
							PosShowScreen(STORE_MOBILE_ORDER); 
						} 
						else if(MobileOrderStatus == MOS_NONE) 
						{ 
							PosShowScreen(STORE_SCREEN_NBR); 
						} 
					} 
				}
				else if(rootHlp.GetOrderSrc() == '3' || rootHlp.GetOrderSrc() == '4')
				{

					// Totalize the current sale
					if(!PosDoTotal()) {
						/* total failed, return to basescreen */
						PosShowScreen(rootCtx.get("baseScreenId"));
						return(false);
					}
					if(MobileOrderStatus == MOS_RECALLED)
					{
						PosShowScreen((rootHlp.GetOrderSrc() == '3' ? "563" : "564"));
					}
				}
			}
			else if(PosCheckSessionProperty("workingMode","cashier"))
			{
				if(rootHlp.GetOrderSrc() == '3' || rootHlp.GetOrderSrc() == '4')
				{
					if(MobileOrderStatus == MOS_AUTHORIZED)
					{
						PosHideFloatScreen();
						PosShowScreen("57");
					}
				}
			}
		}
	}
	catch( ex )
	{
		API.STTErrorLog("0","[onRecalledMobileOrder] - ERROR: " + ex.message);
		API.STTErrorLog("0","[onRecalledMobileOrder] - ERROR - Stack trace: " + ex.stack);

		return false;
	}

	return(true)
}


/**onItemRecallByList
 *
 * @brief - This function returns a string with a description that identifies an order for the RecallByList dialog.
 * @param - nType - 2->RecallByList, 5->RecallForced, 6->RecallMobileOrder
 * @param - key - Order key (POSNNNN:XXXXXXXXXX)
 * @param - major - Order major number
 * @param - minor - Order minor number
 * Return - rval - string with a description that identifies an order for the RecallByList dialog.
 */
function onItemRecallByList(type,key,major,minor)
{
	var value = key;
	
	switch(type) {
		case 2:	// RecallByList
		case 5:	// RecallForced
			break;
		case 6: // RecallMobileOrder
		{
			var format = rootHlp.findParamInSectionConfig("orderNbrFormat","UserInterface");
			if(format == null) {
				format = 1;
			}
			value=PosMountOrderIdJS(format,key,major,minor);
		}
		break;
	}
	
	return(value);
}

/** lParseFoePaidStatus
 *
 * @brief - This function parses a string contaning the order status: PAID or NOTPAID.
 * @param - status - String that contains the order status (PAID or NOTPAID).
 * @returns - The integer 64 if the status was NOTPAID, the integer 128 if the status was PAID or the integer -1 if 
 * the status was neither one.
 * @author - Felipe Armoni
 * @since - MOT-156 - FOE - Route the FOE orders to the appropriate production queue.
 */
function lParseFoePaidStatus(status) {
	var statusValue;
	status = status.toUpperCase();
	switch (status) {
		case "NOTPAID":
			statusValue = 64;
			break;
		case "PAID":
			statusValue = 128;
			break;
		default:
			statusValue = -1;
			break;
	}
	return statusValue;
}
/** lParsePodCode
 *
 * @brief - This function parses a POD code and returns its corresponding name.
 * @param - podCode - POD code to be parsed (must be an integer).
 * @returns - A string containing the correspondent POD name.
 * @author - Felipe Armoni
 * @since - MOT-156 - FOE - Route the FOE orders to the appropriate production queue. 
 */
function lParsePodCode(podCode) {
	var podName;
	podCode = parseInt(podCode);
	switch(podCode) {
		case PodDefinitions.FRONT_COUNTER:
			podName = "FC";
			break;
		case PodDefinitions.DRIVE_THROUGH:
			podName = "DT";
			break;
		case PodDefinitions.WALK_THROUGH:
			podName = "WT";
			break;
		case PodDefinitions.DELIVERY:
			podName = "DLV";
			break;
		case PodDefinitions.COLD_KIOSK:
			podName = "CK";
			break;
		case PodDefinitions.MC_CAFE:
			podName = "MCC";
			break;
		case PodDefinitions.MC_EXPRESS:
			podName = "MCE";
			break;
		case PodDefinitions.COLD_KIOSK_DRINK:
			podName = "CKD";
			break;
		case PodDefinitions.CSO:
			podName = "CSO";
			break;
		case PodDefinitions.HOT:
			podName = "HOT";
			break;
		case PodDefinitions.LOCAL:
			podName = "STAND_ALONE";
			break;
		case PodDefinitions.MCD:
			podName = "MCD";
			break;
		case PodDefinitions.CHIPOTLE:
			podName = "CHIPOTLE";
			break;
		case PodDefinitions.BOSTON_MARKET:
			podName = "BOSTON";
			break;
		case PodDefinitions.DONATOS:
			podName = "DONATOS";
			break;
		default:
			podName = "";
			break;
	}
	return podName;
}
/** lParsePodName
 *
 * @brief - This function parses a string containg the name of a POD and returns its equivalent numerical value.
 * @param - podName - String containing the name of the POD.
 * @returns - An integer with the equivalent name of the POD (the integer that is returned is taken from the PodDefinitions
 * structure).
 * @author - Felipe Armoni
 * @since - MOT-162 - FOE - Use a custom pod name instead of the one that is supplied in the FOE view. 
 */
function lParsePodName(podName) {
	var podValue;
	podName = podName.toUpperCase();
	switch (podName) {
		case "FC":
		case "FRONTCOUNTER":
		case "FRONT COUNTER":
		case "FRONT_COUNTER":
			podValue = PodDefinitions.FRONT_COUNTER;
			break;
		case "DT":
		case "DRIVETHRU":
		case "DRIVE THRU":
		case "DRIVE THROUGH":
			podValue = PodDefinitions.DRIVE_THROUGH;
			break;
		case "WT":
		case "WALKTHRU":
		case "WALK THRU":
		case "WALK THROUGH":
			podValue = PodDefinitions.WALK_THROUGH;
			break;
		case "DLV":
		case "DELIVERY":
			podValue = PodDefinitions.DELIVERY;
			break;
		case "CK":
		case "COLDKIOSK":
			podValue = PodDefinitions.COLD_KIOSK;
			break;
		case "MCC":
		case "MCCAFE":
			podValue = PodDefinitions.MC_CAFE;
			break;
		case "MCE":
		case "MCEXPRESS":
			podValue = PodDefinitions.MC_EXPRESS;
			break;
		case "CKD":
		case "COLDKIOSK":
			podValue = PodDefinitions.COLD_KIOSK_DRINK;
			break;
		case "CSO":
			podValue = PodDefinitions.CSO;
			break;
		case "HOT":
			podValue = PodDefinitions.HOT;
			break;
		case "STAND_ALONE":
		case "LOCAL":
			podValue = PodDefinitions.LOCAL;
			break;
		case "MCD":
			podValue = PodDefinitions.MCD;
			break;
		case "CHIPOTLE":
			podValue = PodDefinitions.CHIPOTLE;
			break;
		case "BOSTON":
		case "BOSTONMARKET":
		case "BOSTON MARKET":
		case "BOSTON_MARKET":
			podValue = PodDefinitions.BOSTON_MARKET;
			break;
		case "DONATOS":
			podValue = PodDefinitions.DONATOS;
			break;
		default:
			podValue = PodDefinitions.UNDEFINED;
			break;
	}
	return podValue;
}

/** onFoeInitialize
 *
 * @brief - This method initializes the variables that will be used by the FOE.
 * @returns - 0 if this method was successfully executed, otherwise returns -1.
 * @author - Felipe Armoni
 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
 */
function onFoeInitialize()
{
	var product;
	var rootPosDB;
	try 
	{
		API.STTDebugLog("0","[onFoeInitialize] - Initiating function.");
		lLoadConfigurations();
		loadProductDB();
		API.STTDebugLog("0","[onFoeInitialize] - This function was successfully executed.");
		
		return 0;
	} catch( ex ) {
		API.STTErrorLog("0","[onFoeInitialize] - ERROR: " + ex.message);
		API.STTErrorLog("0","[onFoeInitialize] - ERROR - Stack trace: " + ex.stack);

		return -1;
	}

	/** lLoadConfigurations
	 *
	 * @brief - This function loads the FOE configuration from the store-db.xml and the pos-db.xml files.
	 * @author - Felipe Armoni
	 * @since - MOT-162 FOE - Use a custom pod name instead of the one that is supplied in the FOE view. 
	 */
	function lLoadConfigurations() {
		var posDbPodNameMapping;
		var storeDbPodNameMapping;
		var podNameMapping;
		var customPodNameValues;
		var posDbRoutingSection;
		var storeDbRoutingSection;
		var routingSection;
		var posDbExpoMonitorsSection;
		var storeDbExpoMonitorsSection;
		var expoMonitorsSection;
		var posDbProductionMonitorsSection;
		var storeDbProductionMonitorsSection;
		var productionMonitorsSection;
		var parameter;
		var parsedValues;
		var value;
		var pod;
		var status;
		API.STTDebugLog("0", "[onFoeInitialize] - Loading the configurations from the Store DB and the Pos DB.", BC_EVENTS_NAME);
		// Load the Store DB
		loadStoreDB();		
		foeStoreDbConfig = rootStoreDB.Configurations.Configuration.(@type == "FOE");
		if (foeStoreDbConfig != undefined)
			API.STTDebugLog("0", "[onFoeInitialize] - The FOE Store DB configurations were loaded:\n" + foeStoreDbConfig.toXMLString(), BC_EVENTS_NAME);
		else
			API.STTWarningLog("0", "[onFoeInitialize] - The FOE Store DB configurations could not be loaded.", BC_EVENTS_NAME);
		// Load the POS DB
		rootPosDB = new XML(API.getPosdb());
		foePosDbConfig = rootPosDB.Services.Service.(@type == "FOE").Configuration.(@imports == "FOE");
		if (foePosDbConfig != undefined)
			API.STTDebugLog("0", "[onFoeInitialize] - The FOE POS DB configurations were loaded:" + foePosDbConfig.toXMLString(), BC_EVENTS_NAME);
		else 
			API.STTWarningLog("0", "[onFoeInitialize] - The FOE POS DB configurations could not be loaded.", BC_EVENTS_NAME);
		// Process the "podNameMapping" section (if it exists).
		foePodNameMappingArray = new Array();
		posDbPodNameMapping = foePosDbConfig.Section.(@name == "podNameMapping");
		storeDbPodNameMapping = foeStoreDbConfig.Section.(@name == "podNameMapping");
		// Try to load the section from the POS DB.
		if (posDbPodNameMapping != undefined) {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"podNameMapping\" was loaded from the POS DB. Value: " + posDbPodNameMapping, BC_EVENTS_NAME);
			podNameMapping = posDbPodNameMapping;
		// If the section was not found in the POS DB, try to load it from the Store DB.
		} else if (storeDbPodNameMapping != undefined) {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"podNameMapping\" was loaded from the Store DB. Value: " + storeDbPodNameMapping, BC_EVENTS_NAME);
			podNameMapping = storeDbPodNameMapping;
		} else {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"podNameMapping\" was not found.", BC_EVENTS_NAME);
			podNameMapping = undefined;
		}
		// Process the values (if the podNameMapping section actually exists).
		if (podNameMapping != undefined) {
			for each (parameter in podNameMapping.Parameter) {
				if(parameter.@name == CURB) foeCurbSideMapping = parameter.@value;
				else
				{// Parse the POD name to get its numerical value.
					value = lParsePodName(parameter.@name);
					foePodNameMappingArray[value] = parameter.@value;
				}
			}
		}
		// Process the "routing" section (if it exists).
		foeRoutingPodSourceArray = new Array();
		foeRoutingPaidStatusArray = new Array();
		foeRoutingTargetStoreAreaArray = new Array();
		//SQM-1231		
		foeRoutingOrderNumberPrefixArray = new Array();
		posDbRoutingSection = foePosDbConfig.Section.(@name == "routing");
		storeDbRoutingSection = foeStoreDbConfig.Section.(@name == "routing");
		// Try to load the section from the POS DB.
		if (posDbRoutingSection != undefined) {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"routing\" was loaded from the POS DB. Value: " + posDbRoutingSection, BC_EVENTS_NAME);
			routingSection = posDbRoutingSection;
		// If the section was not found in the POS DB, try to load it from the Store DB.
		} else if (storeDbRoutingSection != undefined) {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"routing\" was loaded from the Store DB. Value: " + storeDbRoutingSection, BC_EVENTS_NAME);
			routingSection = storeDbRoutingSection;
		} else {
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"routing\" was not found.", BC_EVENTS_NAME);
			routingSection = undefined;
		}
		if (routingSection != undefined) {
			// Process the "podSource" parameter
			parameter = routingSection.Parameter.(@name == "podSource").@value;
			if (parameter != undefined) {
				parsedValues = parameter.split(';');
				for each (value in parsedValues) {
					pod = lParsePodName(value)
					foeRoutingPodSourceArray.push(pod);
				}
			}
			// Process the "paidStatus" parameter
			parameter = routingSection.Parameter.(@name == "paidStatus").@value;
			if (parameter != undefined) {
				parsedValues = parameter.split(';');
				for each (value in parsedValues) {
					status = lParseFoePaidStatus(value);
					foeRoutingPaidStatusArray.push(status);
				}
			}
			// Process the "targetStoreArea" parameter
			parameter = routingSection.Parameter.(@name == "targetStoreArea").@value;
			if (parameter != undefined) {
				parsedValues = parameter.split(';');
				for each (value in parsedValues) {
					foeRoutingTargetStoreAreaArray.push(value);
				}
			}
			//SQM-1231
			// Process the "orderNumberPrefix" parameter
			parameter = routingSection.Parameter.(@name == "orderNumberPrefix").@value;
			if (parameter != undefined) {
				parsedValues = parameter.split(';');
				for each (value in parsedValues) {
					foeRoutingOrderNumberPrefixArray.push(value);
				}
			}
			// Validate if the number of elements of each array are the same.
			if (foeRoutingPodSourceArray.length != foeRoutingPaidStatusArray.length || foeRoutingPodSourceArray.length != foeRoutingTargetStoreAreaArray.length || foeRoutingPaidStatusArray.length != foeRoutingTargetStoreAreaArray.length) {
				// If the validation failed (two or more arrays above don't have the same number of elements).
				API.STTWarningLog("0", "[onFoeInitialize] - The number of elements configured in the parameters: \"podSource\", \"paidStatus\" and \"targetStoreArea\" are different. This configuration will be ignored until this problem is solved.", BC_EVENTS_NAME);
				// Reset the configuration
				foeRoutingPodSourceArray = new Array();
				foeRoutingPaidStatusArray = new Array();
				foeRoutingTargetStoreAreaArray = new Array();
				//SQM-1231
				foeRoutingOrderNumberPrefixArray = new Array();
			}
		}

		// SQM-2479
		// Process the "productionMonitors" section (if it exists)
		foeProductionMonitorsArray = new Array();
		var StoreWide = rootStoreDB.Configurations.Configuration.(@type == "Store.wide");

		storeDbProductionMonitorsSection = StoreWide.Section.(@name == "productionMonitors");
		if (storeDbProductionMonitorsSection != undefined) 
		{
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"productionMonitors\" was loaded from the Store DB. Value: " + storeDbProductionMonitorsSection, BC_EVENTS_NAME);
			productionMonitorsSection = storeDbProductionMonitorsSection;
		} 
		else 
		{
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"productionMonitors\" was not found.", BC_EVENTS_NAME);
			productionMonitorsSection = undefined;	
		}		
		if (productionMonitorsSection != undefined) 
		{
			for each (parameter in productionMonitorsSection.Parameter) 
			{
				// SQM-2479 - parameter name should start with "FOE_"
				if (parameter.@name.indexOf('FOE_') == 0)
				{
					// Remove the "FOE_" from beggining and parse the POD name to get its numerical value.
					podname = parameter.@name.toString().replace("FOE_", "");
					value = lParsePodName(podname);
					foeProductionMonitorsArray[value] = parameter.@value;
				}
			}
		}
		// Process the "expoMonitors" section (if it exists)
		foeExpoMonitorsArray = new Array();
		storeDbExpoMonitorsSection = StoreWide.Section.(@name == "expoMonitors");
		if (storeDbExpoMonitorsSection != undefined) 
		{
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"expoMonitors\" was loaded from the Store DB. Value: " + storeDbExpoMonitorsSection, BC_EVENTS_NAME);
			expoMonitorsSection = storeDbExpoMonitorsSection;
		} 
		else 
		{
			API.STTDebugLog("0", "[onFoeInitialize] - The section: \"expoMonitors\" was not found.", BC_EVENTS_NAME);
			expoMonitorsSection = undefined;	
		}		
		if (expoMonitorsSection != undefined) 
		{
			for each (parameter in expoMonitorsSection.Parameter) 
			{
				// SQM-2479 - parameter name should start with "FOE_"
				if (parameter.@name.indexOf('FOE_') == 0)
				{
					// Remove the "FOE_" from beggining and parse the POD name to get its numerical value.
					podname = parameter.@name.toString().replace("FOE_", "");
					value = lParsePodName(podname);
					foeExpoMonitorsArray[value] = parameter.@value;
				}
			}
		}
		API.STTDebugLog("0", "[onFoeInitialize] - The configurations for the POS DB and Store DB files were successfully loaded.", BC_EVENTS_NAME);
	}
}

/** onFoeGetRemPodName
 *
 * @brief - This function is called by the FOE to translate a given Rem POD code into its correspondent name.
 * NOTE: This name can be either a standard POD name, like FC, DT, etc or an alias that was configured in either the store-db.xml
 * or the FOE's pos-db.xml.
 * @param - currentOrderPod - Code for the current order's POD.
 * @param - currentOrderRemPod - Code for the current order's REM POD.
 * @param - currentOrderStatus - Code for the current order's status (128 or 64).
 * @return - The correspondent REM POD name.
 * @author - Felipe Armoni
 * @since - MOT-156 - FOE - Route the FOE orders to the appropriate production queue.
 */
function onFoeGetRemPodName(currentOrderPod, currentOrderRemPod, currentOrderStatus) {
	var i;
	var resultRemPod;
	var podSource;
	var orderStatus;
	try {
		API.STTInfoLog("0", "[onFoeGetRemPodName] - Initiating function", BC_EVENTS_NAME);
		resultRemPod = lParsePodCode(currentOrderRemPod);
		// Search the PodSource array for a corresponding Rem POD.
		for (i in foeRoutingPodSourceArray) {
			podSource = foeRoutingPodSourceArray[i];
			// If a matching Pod Source was found, check to see if the order status also match.
			if (podSource == currentOrderRemPod) {
				orderStatus = foeRoutingPaidStatusArray[i];
				// If the order status also match.
				if (orderStatus == currentOrderStatus) {
					resultRemPod = foeRoutingTargetStoreAreaArray[i];
					break;
				}
			}	
		}
		API.STTInfoLog("0", "[onFoeGetRemPodName] - This function was successfully executed. Returned Rem POD value: " + resultRemPod, BC_EVENTS_NAME);
		return resultRemPod;
	} catch( ex ) {
		API.STTErrorLog("0", "[onFoeGetRemPodName] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onFoeGetRemPodName] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
		return (null);
	}
}

/** onFoeValidateSaleView
 *
 * @brief - This method validates if a New POS sale XML generated by the FOE can be sold.
 * @param - view - xml string -  The sale XML generated by the FOE
 * @param - storeDaypart - int  - The current day part code of the Store
 * @return - An integer containg the result of the XML validation (see return codes below). Note: If an exception is thrown this function returns -1.
 * @author - Felipe Armoni
 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
 * @remarks 
 *	 
 *  - Return Codes:
 *		0 - XML OK
 *		1 - A product in the XML is not in the product-db.xml
 *		2 - One of the products in the XML is not salable (salable="false")
 *		3 - One of the products in the XML has its statusCode set as INACTIVE
 *		4 - One of the products in the XML is not available (an unavailable product has an entry in the prodoutage.xml)
 *		5 - One of the products in the XML is in an invalid day part
 *		6 - One of the products in the XML is out of its time restriction
 *
 *	- A valid product is:
 *		- Exists in the catalog;
 *		- Is salable (for parent items);
 *		- Is active;
 *		- Is NOT in the outage file;
 *		- Is from the same day part (see business limits in the store-db file);
 *		- Is in time restriction
 */
function onFoeValidateSaleView(view, storeDaypart) {

	var xmlView;
	var productNode;
	var result = 0;
	var hlp = new FOEHelper();
	var UsingNewRFMParameters =hlp.GetMobileOrderingConfigVersion();
	var isMidnightMenu;
	API.STTInfoLog("0", "[onFoeValidateSaleView] - Initiating function", BC_EVENTS_NAME);
	API.STTInfoLog("0", "[onFoeValidateSaleView] - UsingNewRFMParameters = " + UsingNewRFMParameters, BC_EVENTS_NAME);
	
	var bHasSaleGlobalPromotion = false;
	
	try	{
	
		API.STTInfoLog("0", "[onFoeValidateSaleView] - Initiating function", BC_EVENTS_NAME);

		xmlView = new XML(view);
		//NPS-11814 - Midnight Menu
		isMidnightMenu = xmlView.@multipleMenuType.toString();

		if (xmlView.Promotions.Promotion.length() > 0)
		{
			for each (var promotion in xmlView.Promotions.Promotion)
			{
				if ((promotion.@discountType != undefined) && (promotion.@discountType.toString() != ""))
				{
					bHasSaleGlobalPromotion = true;
				}
			}
		}		

		for each (var item in xmlView.ItemView) {
		
			var productXML = new XML(item.toString());
			
			API.STTDebugLog("0", "[onFoeValidateSaleView] - Retrieving product node for code: " + item.productCode, BC_EVENTS_NAME);
			
			// Retrieves the corresponding product node from the product-db.xml	
			productNode = productDictionary[item.productCode];
					
			if(productNode == undefined || productNode == null) {
				// not in the catalog
				API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" not in the catalog", BC_EVENTS_NAME);
				result = 1;
				break;
			}
			else {
				API.STTDebugLog("0", "[onFoeValidateSaleView] - The XML node for the product code: " + item.productCode + " was sucessfully retrieved.", BC_EVENTS_NAME);
						
				if (productNode.@salable == "false" && item.level == "0") {
					// not salable
					API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" not salable", BC_EVENTS_NAME);
					result = 2;
					break;
				}
				else if (productNode.@statusCode == "INACTIVE") {
					// inactive
					API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" inactive", BC_EVENTS_NAME);
					result = 3;
					break;
				}
				else if (lIsInProductOutage(item.productCode)) {
					// prodoutage
					API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" is in prodoutage.xml", BC_EVENTS_NAME);
					result = 4;
					break;
				}
				else if((isMidnightMenu != "true") && (!lIsInDayPart(productNode.CustomParameters.Parameter.(@name=="dayPart").@value.toString(), productNode.DayPartCode, storeDaypart))) {
					// invalid day part
					var customDayPart = productNode.CustomParameters.Parameter.(@name=="dayPart").@value.toString();
					API.STTErrorLog("0", "[onFoeValidateSaleView] - product " + item.productCode + " only salable in daypart " +
						((customDayPart == undefined || customDayPart == "") ? productNode.DayPartCode : customDayPart) +
						", current daypart is " + storeDaypart, BC_EVENTS_NAME);
					
					result = 5;
					break;
					
				}
				else  
				{
					if (UsingNewRFMParameters)
					{
						API.STTInfoLog("0", "[onFoeValidateSaleView] UsingNewRFMParameters", BC_EVENTS_NAME);

						var TimeRule = "";
						var first = true;
		
						for each (allowed_time in productNode.TimeRestrictions.AllowedTime) 
						{
							if (first == false) 
							{
								TimeRule += "|";
							}

							first = false;
							TimeRule += allowed_time.@startTime.toString();
							TimeRule += ",";
							TimeRule += allowed_time.@endTime.toString();
						}
					
						API.STTWarningLog("0", "[onFoeValidateSaleView] productCode" + item.productCode + "- TimeRule = " + TimeRule, BC_EVENTS_NAME);

						if(!lIsInTimeRestriction(TimeRule))
						{
							// invalid time of day
							API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" not salable at this time of the day", BC_EVENTS_NAME);
							result = 6;
							break;
						}
					} // IsUsingNewRFMParameters
					else 
					{
						if(!lIsInTimeRestriction(productNode.CustomParameters.Parameter.(@name=="timeRestriction").@value.toString())) {
							// invalid time of day
							API.STTWarningLog("0", "[onFoeValidateSaleView] - product "+item.productCode+" not salable at this time of the day", BC_EVENTS_NAME);
							result = 6;
							break;
						}
					}
				}
				
				//MOT-362 Basic Promotions - TimeFrame validating
				if (UsingNewRFMParameters)
				{
					if (productNode.Promotion.@isPromotional.toString() != undefined	&&
						productNode.Promotion.@isPromotional.toString() != null			&&
						productNode.Promotion.@isPromotional.toString() != "")
					{
						var isPromo = productNode.Promotion.@isPromotional.toString();
					}else{
						API.STTWarningLog("0", "[onFoeValidateSaleView] - IsPromotional parameter was not found for Product:" + item.productCode + " ." , BC_EVENTS_NAME);
					}
				}
				else
				{
					if (productNode.CustomParameters.Parameter.(@name=="IsPromotional").@value.toString() != undefined 	&&
						productNode.CustomParameters.Parameter.(@name=="IsPromotional").@value.toString() != null		&&
						productNode.CustomParameters.Parameter.(@name=="IsPromotional").@value.toString() != "")
					{
						var isPromo = productNode.CustomParameters.Parameter.(@name=="IsPromotional").@value.toString();
					}else{
						API.STTWarningLog("0", "[onFoeValidateSaleView] - IsPromotional parameter was not found for Product:" + item.productCode + " ." , BC_EVENTS_NAME);
					}
				}

				if (isPromo == "true")
				{					 
					var weekDayRule = "";
					
					if (UsingNewRFMParameters)
					{
						var promoStartDate = productNode.Promotion.@startDate.toString();
						var promoEndDate = productNode.Promotion.@endDate.toString();
						//This field is not mandatory
						if (promoStartDate != "" && promoStartDate != null && promoStartDate != undefined &&
							promoEndDate != "" && promoEndDate != null && promoEndDate != undefined)
						{
							if (!isInDateInRange(promoStartDate, promoEndDate))
							{
								API.STTWarningLog("0", "[onFoeValidateSaleView] - Product "+item.productCode+" is not in a valid promotion period", BC_EVENTS_NAME);
								result = 7;
								break;
							}
						}
						
						var currentday = getWeekDayName();
						
						var TimeRestr = productNode.Promotion.TimeRestrictions.TimeRestriction.(@weekday==currentday).AllowedTime;
						
						var first = true;
		
						for each (allowed_time in TimeRestr) 
						{
							if (first == false) 
							{
								weekDayRule += "|";
							}

						first = false;
						weekDayRule += allowed_time.@startTime.toString();
						weekDayRule += ",";
						weekDayRule += allowed_time.@endTime.toString();
						}
					}
					else
					{
						var promoStartDate = productNode.CustomParameters.Parameter.(@name=="PromotionStartDate").@value.toString();
						var promoEndDate = productNode.CustomParameters.Parameter.(@name=="PromotionEndDate").@value.toString();
						//This field is not mandatory
						if (promoStartDate != "" && promoStartDate != null && promoStartDate != undefined &&
							promoEndDate != "" && promoEndDate != null && promoEndDate != undefined)
						{
							if (!isInDateInRange(promoStartDate, promoEndDate))
							{
								API.STTWarningLog("0", "[onFoeValidateSaleView] - Product "+item.productCode+" is not in a valid promotion period", BC_EVENTS_NAME);
								result = 7;
								break;
							}
						}
						
						weekDayRule = productNode.CustomParameters.Parameter.(@name==getDayAsTagName()).@value.toString();
					}
					
					if (!lIsInTimeRestriction(weekDayRule))
					{					
						API.STTWarningLog("0", "[onFoeValidateSaleView] - Product "+item.productCode+" is not in a valid promotion timeframe or it is disabled", BC_EVENTS_NAME);							
						result = 7;
						break;																							
					}					
				}
				//Item Discount 
				//Checking if there is a Promotion Item configured at 'store.wide' section at store-db.xml
				if (UsingNewRFMParameters)
				{
					var tableDiscount = rootStoreDB.StorePromotionDiscounts.Discount;
				}
				else
				{
					var tableDiscount = rootStoreDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "PromotionalDiscountTable");
				}
				
				if (tableDiscount != undefined 	&&
					tableDiscount != null		&&
					tableDiscount != "" )					
				{				
					if (bHasSaleGlobalPromotion)
					{
						if (!isPromotionValid(xmlView))
						{
							break;
						}
					}
					else if( !isDiscountValid(xmlView) )						 
					{
						API.STTWarningLog("0", "[onFoeValidateSaleView] - Product "+item.productCode+" is not in a valid promotional timeframe", BC_EVENTS_NAME);
						result = 7;
						break;						
					}
				}else{
					API.STTWarningLog("0", "[onFoeValidateSaleView] - StorePromotionDiscounts section at store.db was not found." , BC_EVENTS_NAME);
				}					
				
				if (result == 0)
				{
					API.STTInfoLog("0", "[onFoeValidateSaleView] - Product "+item.productCode+" OK", BC_EVENTS_NAME);
				}
			}
		
		}
		
		return result;
	} catch( ex ) {
	
		API.STTErrorLog("0", "[onFoeValidateSaleView] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onFoeValidateSaleView] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
		
		return -1;
	}

	function isPromotionValid(xmlView)
	{
		return true;
	}
	
	function isDiscountValid(xmlView)
	{
		
		var ret = true;
		
		API.STTDebugLog("0", " [isDiscountValid] - Checking... ", BC_EVENTS_NAME);
		
		var totalDiscount =  xmlView.CustomInfo.Info.(@name=="totalDiscount").@value.toString();
		var totalBD = xmlView.CustomInfo.Info.(@name=="totalBD").@value.toString();
		var discountId = xmlView.CustomInfo.Info.(@name=="discountId").@value.toString();		
		var discountType =xmlView.CustomInfo.Info.(@name=="discountType").@value.toString();		
		
		if ( (totalDiscount	!= "" && totalDiscount != undefined && totalDiscount != null && totalDiscount != "0"  )   &&
			 (totalBD	  	!= "" && totalBD != undefined && totalBD != null && totalBD != "0") 					  &&
			 (discountId    == "0")			  																		  &&
 			 (discountType	!= "" && discountType != undefined && discountType != null && discountType != "0") ) 
		   {
				ret = getDiscountPercent(discountType, totalBD, totalDiscount);
				API.STTDebugLog("0", " [isDiscountValid] - isDiscountValid: " + ret + ".", BC_EVENTS_NAME);		
				
		   }else{

				API.STTDebugLog("0", " [isDiscountValid] - Not a promotional Order", BC_EVENTS_NAME);

		   }
		return (ret != 0);
	}
	
	/** lIsInProductOutage
	 * 
	 * @brief - Checks to see if a given product code is the prodoutage.xml file.
	 * @param - string - Product code
	 * @retruns - True if the product code is in the outage file, otherwise false.
	 * @author - Felipe Armoni
	 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
	 */
	function lIsInProductOutage(productCode) {
		
		var outageFile = API.getProductOutage();
		var outageXML;		
		
		// Check if the outage file exists.
		if(outageFile == undefined || outageFile == null) {
			API.STTWarningLog("0", "[onFoeValidateSaleView.lIsInProductOutage] Outage file not found.", BC_EVENTS_NAME);
			return false;
		}
		
		outageXML = new XML(outageFile.toString());
		
		// Check if the current product code is inside the outage file.
		for each(var outageProductCode in outageXML.Product.@code) {
		
			// If the current product is in the outage file.
			if(outageProductCode == productCode.toString()) {
				return true;
			}
		}
		
		// If the current product isn't in the outage file.
		return false;
	}
	
	/** lIsInTimeRestriction
	 *
	 * @brief - Checks if the the product is in salable period.
	 * @param - interval - string - period when the product can be sold. The format is <from>,<to>. Where the format for <from> and <to> is
	 * hh:mm where hh is the hour (from 00 to 23) and mm is the minute (from 00 to 59). Multiple values must be concatenated using "|", 
	 * for instance "<from>,<to>| <from>,<to>| <from>,<to>".
	 * Examples:
	 *	- Product can only be sold from 10:00 to 14:00 = "10:00,14:00"
	 *	- Product can only be sold from 22:00 to 04:00 = "22:00,23:59|00:00,04:00"
	 *	- Product can be sold from 14:00 to 16:00 and  from 21:00 to 23:00="14:00,16:00|21:00,23:00"
	 * @return - true if the current time is within the period. false otherwise
	 * @author - Raphael Almeida
	 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
	 */
	function lIsInTimeRestriction(period) {
		if(period == null || period == "") {
			return true;
		}
		var timeNow = new NPDate();
		API.STTErrorLog("0", "[lIsInTimeRestriction] - product salable in " + period + " period(s) and the current time is " + timeNow.getHours() + ":" + timeNow.getMinutes() + ":" + timeNow.getSeconds(), BC_EVENTS_NAME);		
		
		var intervals = String(period).split("|");
		for each(interval in intervals) {
			var timeRange = String(interval).split(",");
			var initialHour = Number(String(timeRange[0]).split(":")[0]);
			var initialMinute = Number(String(timeRange[0]).split(":")[1]);
			var finalHour = Number(String(timeRange[1]).split(":")[0]);
			var finalMinute = Number(String(timeRange[1]).split(":")[1]);
			
			var initialTime = new NPDate(timeNow.getFullYear(), timeNow.getMonth(), timeNow.getDate(), initialHour, initialMinute);
			var finalTime = new NPDate(timeNow.getFullYear(), timeNow.getMonth(), timeNow.getDate(), finalHour, finalMinute);
			if(timeNow >= initialTime && timeNow < finalTime) {
				return true;
			}
		}
		return false;
	}
	
	/** lIsInDayPart
	 *
	 * @brief - Checks if the the product is in salable day partition, based on daypart custom parameter and <DayPartCode> parameter. Custom overides <DayPartCode>.
	 * @param - customDayPart - day partition from custom parameter to be checked. Possible values: "BREAKFAST_MENU", "DAY_MENU", or "BREAKFAST_DAY_MENU"
	 * @param - dayPartCode - day partition from <DayPartCode> parameter to be checked. Possible values: "BREAKFAST_MENU", "DAY_MENU", or "BREAKFAST_DAY_MENU"
	 * @param - storeDayPart - integer - current day part of the store.
	 * @return - true if the received dayPart matches the current one. false otherwise. 
	 * @author - Raphael Almeida
	 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
	 */
	function lIsInDayPart(customDayPart, dayPart, storeDayPart) {
		
		var dayPartCode;
		var result;
		
		// If there is no custom parameter configured as Day Part.
		if(customDayPart == undefined || customDayPart == "")
			dayPartCode = lConvertDayPartFromStringToCode(dayPart);
		else
			dayPartCode = lConvertDayPartFromStringToCode(customDayPart);		
			
		// If the day part code is DAYPART_BREAKFAST_DAY_MENU, than this product belongs to both day parts and may be selled at any time.
		if (dayPartCode == DAYPART_BREAKFAST_DAY_MENU)
			result = true;
			
		else if (dayPartCode == storeDayPart) 
			result = true;
		
		else
			result = false;
		
		return result;
		
		/** lConvertDayPartFromStringToCode
		 *
		 * @brief - Converts a day part string into its correspondent code.
		 * @param - String - dayPartString - String containing the day part.
		 * @returns - An integer containing the correpondent day part code.
		 * @since - MOT-154 - FOE - Implement the product validation used in the Check-In Device into the FOE.
		 */
		function lConvertDayPartFromStringToCode(dayPartString) {			

			if (dayPartString == "BREAKFAST_MENU") {
				return DAYPART_BREAKFAST_MENU;
			}
			else if (dayPartString == "DAY_MENU") {
				return DAYPART_DAY_MENU;
			}
			else if (dayPartString == "BREAKFAST_DAY_MENU") {
				return DAYPART_BREAKFAST_DAY_MENU;
			}
			else {
				API.STTDebugLog("0", "[onFoeValidateSaleView.lIsInDayPart.lConvertDayPartFromStringToCode] No day part string matches the value: " + dayPartString + ". Using the default value (BREAKFAST_DAY_MENU", BC_EVENTS_NAME);
				return DAYPART_BREAKFAST_DAY_MENU; // Default value.
			}
		}
	}
}

function getDayAsTagName()
	{
		var curdate = new NPDate();
		var wday = curdate.getDay();
		var wdayString="";
		
		switch(wday) {
			case 0:
				wdayString = "PromotionTimeSun";
				break;
			case 1:
				wdayString = "PromotionTimeMon";
				break;		
			case 2:
				wdayString = "PromotionTimeTue";
				break;
			case 3:
				wdayString = "PromotionTimeWed";
				break;
			case 4:
				wdayString = "PromotionTimeThu";
				break;
			case 5:
				wdayString = "PromotionTimeFri";
				break;
			case 6:
				wdayString = "PromotionTimeSat";
				break;			
			default:
				break;	
		}		
		
		return wdayString;
	
	}

function getWeekDayName()
{
	var curdate = new NPDate();
	var wday = curdate.getDay();
	var wdayString="";
		
	switch(wday) {
		case 0:
			wdayString = "Sunday";
			break;
		case 1:
			wdayString = "Monday";
			break;		
		case 2:
			wdayString = "Tuesday";
			break;
		case 3:
			wdayString = "Wednesday";
			break;
		case 4:
			wdayString = "Thursday";
			break;
		case 5:
			wdayString = "Friday";
			break;
		case 6:
			wdayString = "Saturday";
			break;			
		default:
			break;	
	}
		
	return wdayString;
}	

function isAmountInRange(value, discountType, range1, range2)
	{
		ret = true;
		
		//Range1 Is mandatory only when the Discount Type is equal to "Amount"
		if (discountType == "1" && (range1 == undefined || range1 == null || range1 == ""))
		{
			API.STTErrorLog("0", "[isAmountInRange] - Initial Order Total Value is mandatory when the Discount Type is equal to Amount" , BC_EVENTS_NAME);		   
			return false;
		}			
		
		if ( (range1 == undefined || range1 == null || range1 == "") && (range2 != "") )
		{
			API.STTDebugLog("0", "[isAmountInRange] - Range1 empty, Range2 filled" , BC_EVENTS_NAME);		   
			if (Number(value) > Number(range2))
			{
				ret = false;
			}			
			
		}else if ((range1 != "") && (range2 == undefined || range2 == null || range2 == ""))
		{
			API.STTDebugLog("0", "[isAmountInRange] - Range1 filled, Range2 empty" , BC_EVENTS_NAME);		   
			if ( Number(value) < Number(range1) )
			{
				ret = false;
			}
			
		}else if ((range1 != "") && (range2 != ""))
		{
			API.STTDebugLog("0", "[isAmountInRange] - Range1 Range2 filled" , BC_EVENTS_NAME);		   
			if ( Number(value) > Number(range2) || //SQM-2032
				 Number(value) < Number(range1) )
			{
				ret = false;
			}
		}
		
		return ret;			
	}	

function isInDateInRange(startDate, finalDate)
	{
		if ( (finalDate == "" || finalDate == undefined || finalDate == null) &&
		
			 (startDate == "" || startDate == undefined || startDate == null) )
		{
			API.STTErrorLog("0", "[isInDateInRange] - StartDate and InitDate in blank - Order allowed" , BC_EVENTS_NAME);		   		
			return true;
		}		
		
		var timeNow = new NPDate();
		//SQM-2032
		timeNow.setHours(0,0,0,0);		
		//initDate: 2012-12-01
		//finalDate: 2012-12-15
		if (startDate != "" && startDate != undefined && startDate != null)
		{
		var YYYY = startDate.substr(0, 4);
		var MM = startDate.substr(5, 2);
		var DD = startDate.substr(8, 2);
		
		var startD = new NPDate(Number(YYYY), Number(MM) - 1, Number(DD));
			if (startD.getDate() != Number(DD) || startD.getMonth() != Number(MM) - 1)
			{			
				API.STTErrorLog("0", "[isInDateInRange] - Initial Effective Date is invalid" , BC_EVENTS_NAME);		   
			return false;
			}
		}
		
		if (finalDate != "" && finalDate != undefined && finalDate != null)
		{
			YYYY = finalDate.substr(0, 4);
			MM = finalDate.substr(5, 2);
			DD = finalDate.substr(8, 2);
			var finalD = new NPDate(Number(YYYY), Number(MM) - 1, Number(DD));
			if (finalD.getDate() != Number(DD) || finalD.getMonth() != Number(MM) - 1)
			{
				API.STTErrorLog("0", "[isInDateInRange] - Final Effective Date is invalid" , BC_EVENTS_NAME);		   
				return false;
			}
		}
		
		//StartDate and FinalDate are valid
		if ( (finalD != "" && finalD != undefined && finalD != null) &&
			 (startD != "" && startD != undefined && startD != null) )
		{		
			if ( (timeNow < startD) || (timeNow > finalD)){
				API.STTErrorLog("0", "[isInDateInRange] - Date is not in the range allowed" , BC_EVENTS_NAME);		   		
				return false;
			}
		}		
		//Just StartDate is filled
		else if ((startD != "" && startD != undefined  && startD != null) &&
				 (finalD == "" || finalD == undefined || finalD == null) )
		{			
			if (timeNow < startD){
				API.STTErrorLog("0", "[isInDateInRange] - StartDate is invalid" , BC_EVENTS_NAME);		   		
				return false;
			}
		}			
		//Just FinalDate is filled
		else if ((finalD != "" && finalD != undefined  && finalD != null) &&
				 (startD == "" || startD == undefined  || startD == null) )
		{		
			if (timeNow > finalD){
				API.STTErrorLog("0", "[isInDateInRange] - FinalDate is invalid" , BC_EVENTS_NAME);		   		
				return false;
			}
		}
		return true;
	}	

function getDiscountPercent(discountType, totalBD, totalDiscount)
{
		var ret = true;
		var discountValueDb = 0;
		
		loadStoreDB();

		var hlp = new FOEHelper();
		var UsingNewRFMParameters = hlp.GetMobileOrderingConfigVersion();	
		
		if (UsingNewRFMParameters)
		{
			var tableDiscount = rootStoreDB.StorePromotionDiscounts.Discount;
		
			if (tableDiscount == undefined 	||
				tableDiscount == null		||
				tableDiscount == "" )					
			{
				API.STTDebugLog("0", "[getDiscountPercent] StorePromotionDiscounts not found. ", BC_EVENTS_NAME);												
				return 0;
			}
		
			for each(var promoItem in tableDiscount)
			{	
				API.STTDebugLog("0", "[getDiscountPercent] promoItem.(@name): " + promoItem.@name.toString(), BC_EVENTS_NAME);												
				if ((promoItem.@name.toString() != null) && (promoItem.@name.toString() != ""))
				{							
					var enableDb = promoItem.@status.toString();
					var initDateDb = promoItem.@initialDate.toString();
					var finalDateDb = promoItem.@finalDate.toString();
					var initRangeDb = promoItem.@initialOrderTotalValue.toString();
					var finalRangeDb = promoItem.@finalOrderTotalValue.toString();
					var discountIdDb = promoItem.@discountID.toString();
					var discountTypeDb = promoItem.@discountType.toString();
					discountValueDb = promoItem.@discountValue.toString();
				
					if (enableDb.toUpperCase() == "ENABLED")
					{
						if ( ( (discountTypeDb.toUpperCase() == "P") && (discountType != "2") ) ||
							( (discountTypeDb.toUpperCase() == "A") && (discountType != "1") ) )
						{
							API.STTErrorLog("0", "[getDiscountPercent] - Discount Type differs from the configured at store-db.xml" , BC_EVENTS_NAME);
							ret =  false;								
						
						}							
					
						else if (!isInDateInRange(initDateDb, finalDateDb)) 
						{
							API.STTErrorLog("0", "[getDiscountPercent] - The Order's date is not in a valid period" , BC_EVENTS_NAME);
							ret = false;								
						
						}							
					
						else if (!isAmountInRange(totalBD, discountType, initRangeDb, finalRangeDb)) {	
							API.STTErrorLog("0", "[getDiscountPercent] - The Order Total is not in a valid range" , BC_EVENTS_NAME);
							ret = false;								
						}							
						else if (discountTypeDb.toUpperCase() == "P")
						{
							//just do debug
							API.dbg("[getDiscountPercent] - totalDiscount: " + totalDiscount);
							var percentDiscount = (discountValueDb)/100;
							var totalDiscountCalculated = totalBD * percentDiscount;
							API.dbg("[getDiscountPercent] - totalDiscountCalculated : " + totalDiscountCalculated.rhte(0.01));
						
							if (totalDiscountCalculated.rhte(0.01) != totalDiscount){
								API.dbg("[getDiscountPercent] - Invalid totalDiscount");						
								ret = false;
							
							}else{
			
								ret = true;
								break;
							}
						}							
						else if (discountTypeDb.toUpperCase() == "A")
						{
							if (Number(totalDiscount) != Number(discountValueDb))
							{
								API.STTErrorLog("0", "[getDiscountPercent] - Total Discount (Amount) differs from the configured at store-db.xml" , BC_EVENTS_NAME);
								ret =  false;
							}else{
								ret = true;
								break;
							}
						}else{
				
							API.STTDebugLog("0", "[getDiscountPercent] - Promotional Discount Order OK" , BC_EVENTS_NAME);						
							ret  = true;
							break;
						}						
					}
				}						
			} //for each
		} //UsingNewRFMParameters
		else
		{
			var tableDiscount = rootStoreDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "PromotionalDiscountTable");
			if (tableDiscount == undefined 	||
				tableDiscount == null		||
				tableDiscount == "" )					
			{
				API.STTDebugLog("0", "[getDiscountPercent] PromotionalDiscountTable not found. ", BC_EVENTS_NAME);												
				return 0;
			}
		
			var xmlPromoDiscTable =	new XML(rootStoreDB.Configurations.Configuration.(@type == "Store.wide").Section.(@name == "PromotionalDiscountTable"));		
		
			var arrayDiscount = [];
			var count = 0;
			for each (var promoItem2 in xmlPromoDiscTable.Parameter)
			{
				arrayDiscount[count] = {name:parseInt(promoItem2.@name.toString()), value:promoItem2.@value};
				count++;
			}		
		
			arrayDiscount.sort(function(a, b){
				return a.name > b.name;
			})						
		
			for each(var promoItem in arrayDiscount)
			{	
				API.STTDebugLog("0", "[getDiscountPercent] promoItem.(@name): " + promoItem.name, BC_EVENTS_NAME);												
				if (promoItem.name != null && promoItem.name > 0)
				{							
					var discountToken = promoItem.value;
					API.STTDebugLog("0", "[getDiscountPercent] discountToken: " + discountToken, BC_EVENTS_NAME);											
					var token = discountToken.split("|");
					var enableDb = token[0];
					var initDateDb = token[1];
					var finalDateDb = token[2];
					var initRangeDb = token[3];
					var finalRangeDb = token[4];
					var discountIdDb = token[5];
					var discountTypeDb = token[6];
					discountValueDb = token[7];
				
					if (enableDb.toUpperCase() == "ENABLED")
					{
						if ( ( (discountTypeDb.toUpperCase() == "P") && (discountType != "2") ) ||
							( (discountTypeDb.toUpperCase() == "A") && (discountType != "1") ) )
						{
							API.STTErrorLog("0", "[getDiscountPercent] - Discount Type differs from the configured at store-db.xml" , BC_EVENTS_NAME);
							ret =  false;								
						
						}							
					
						else if (!isInDateInRange(initDateDb, finalDateDb)) 
						{
							API.STTErrorLog("0", "[getDiscountPercent] - The Order's date is not in a valid period" , BC_EVENTS_NAME);
							ret = false;								
						
						}							
					
						else if (!isAmountInRange(totalBD, discountType, initRangeDb, finalRangeDb)) {	
							API.STTErrorLog("0", "[getDiscountPercent] - The Order Total is not in a valid range" , BC_EVENTS_NAME);
							ret = false;								
						}							
						//SDO-8079						
						else if (discountTypeDb.toUpperCase() == "P")
							{
								//just do debug
							var percentDiscount = new BigDecimal(discountValueDb);
							// Should not divide by 100 twice
							//percentDiscount = percentDiscount.divide(100, Rounding_Mode.ROUND_HALF_EVEN);
							var totalDiscountCalculated = new BigDecimal(totalBD);
							totalDiscountCalculated = totalDiscountCalculated.multiply(percentDiscount);
							totalDiscountCalculated = totalDiscountCalculated.divide(100, Rounding_Mode.ROUND_HALF_EVEN);
							totalDiscountCalculated = totalDiscountCalculated.setScale(2, Rounding_Mode.ROUND_HALF_EVEN);
							API.dbg("[getDiscountPercent] - totalBD:["+totalBD+"] totalDiscount:["+totalDiscount+"] percentDiscount:["+percentDiscount+"] totalDiscountCalculated : [" + totalDiscountCalculated +"]");						
							if (totalDiscountCalculated.compareTo(new BigDecimal(totalDiscount))){
								API.dbg("[getDiscountPercent] - Invalid totalDiscount");						
								ret = false;
							
							}else{
			
								ret = true;
								break;
							}
						}							
						else if (discountTypeDb.toUpperCase() == "A")
						{
							if (Number(totalDiscount) != Number(discountValueDb))
							{
								API.STTErrorLog("0", "[getDiscountPercent] - Total Discount (Amount) differs from the configured at store-db.xml" , BC_EVENTS_NAME);
								ret =  false;
							}else{
								ret = true;
								break;
							}
						}else{
				
							API.STTDebugLog("0", "[getDiscountPercent] - Promotional Discount Order OK" , BC_EVENTS_NAME);						
							ret  = true;
							break;
						}						
					}
				}						
			} //for each
		}
		
		if (ret){
			API.STTDebugLog("0", "[getDiscountPercent] - Returning: " + discountValueDb + " . " , BC_EVENTS_NAME);						
			return discountValueDb;
		}
		return 0;
}

function onAcceptMobileOrderBegin(bUpdateCOD,bMobileOrder)
{
	var ret = true;
	if(bMobileOrder && recallMobileOrderJS('1'))
	{
		ret = false;
	}
	else if(bUpdateCOD)
	{
		PosSetCODRouting();
		if(bMobileOrder)
		{
			ret = PosSetCOD(0);

			// One situation where PosSetCOD Return false is when we were asked if we wanted to switch the COD
			// and we said yes.  When This happens the Session property activeCOD will be set to the negative number of
			// the desired COD.  For example, if we weant to set this COD 2 it will contain -2.
			if (ret == false)
			{
				var SetResult = rootCtx.get("activatedCOD");
			
				// If the value of activatedCOD is "0", we don't wan to try setting the COD
				if (SetResult != "0")
				{
					var MinusLocation = SetResult.indexOf('-');  // Look for the minus sign
					if (MinusLocation != -1)
					{
						// there is a minus sign so lets get rid of it.
						SetResult = SetResult.substring(MinusLocation + 1);
					}
					
					// Now we will attempt to set the COD to this value
					ButtonCODJS(SetResult, 1);
					
					// If it does not work the second time we will give up.
					ret = PosSetCOD(0);
					if (ret = false)
					{
						PosSetSessionProperty("activatedCOD","0","true");
					}
				}
				
			}
		}
		else
		{
			PosReleaseCOD();
			PosSetSessionProperty("activatedCOD","0","true");
		}
	}

	return ret;
}

function onAcceptMobileOrderEnd(bUpdateCOD,bMobileOrderOk)
{
	if(bUpdateCOD && !bMobileOrderOk)
	{
		PosReleaseCOD();
		PosSetSessionProperty("activatedCOD","0","true");
	}
	PosRefreshButtons();

	return true;
}


function onGetDataFromNP6View(sIn)
{
	var ret = null;
	var ExecuteUrl = null;
	var CancelUrl = null;
	try
	{
		var view = new XML(sIn);
		for each(Info in view.CustomInfo.Info)
		{
			if(Info.@name == "ExecutePaymentDT" && Info.@value != null && Info.@value != "")
			{
				ExecuteUrl = Info.@value;
			}
			else if(Info.@name == "CancelPaymentDT" && Info.@value != null && Info.@value != "")
			{
				CancelUrl = Info.@value;
			}
		}
		if(ExecuteUrl != null && CancelUrl != null)
		{
			ret = ExecuteUrl + "|" + CancelUrl;
		}
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onGetDataFromNP6View] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onGetDataFromNP6View] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function OnMobilePaymentChanged(OrderKey)
{
	PosDoQueryPaymentStatus(OrderKey);
	if(rootHlp.GetMobileOrderStatus() != MOS_PENDING) {
		PosDoSetGenericCounter(false,0);
	}
	PosDoSetCustomInfo("isPaidMobileOrder", true);
}

function OnGenericCounterTimeout()
{
	var ret = true;
	if(PosDoSendCommandToFOEJS(MOBILE_PAYMENT_TIMEDOUT))
	{
		PosSetMobileOrderStatus(MOS_TIMEDOUT);
	}
	PosDoSetGenericCounter(false,0);
	PosRefreshButtons();
	PosRefreshSalePanel();
	
	return ret;
}

 function MapCardNames(InputName)
 {
  var NewName = InputName;
  
  switch (InputName.toUpperCase()) {
  case "MASTERCARD":
   NewName = "Master";
   break;
  case "DISCOVER":
   NewName = "Dscvr";
   break;
  case "ARCHCARD":
   NewName = "Gift Card"
   break;
  case "DINERS":
   NewName = "Dscvr";
   break;
  case "JCB":
   NewName = "Dscvr";
   break;
  case "AMEX":
   NewName = "Amex";
   break;
  }
  
  return NewName;
 }

function onGetDataFromPaymentCommand(sIn, storeNumber, businessDate)
{
	var OrderPaymentStatus = null;
	var ret = null;
	var strOrderKey = null;
	var strPaymentStatus = null;
	var strPODName = null;
	var strTender = null;
	
	
	try
	{
		if(sIn == null)
		{
			sIn='<OrderPaymentStatus/>';
		}
		OrderPaymentStatus = new XML(sIn);
		//Getting Orderkey
		strOrderKey = OrderPaymentStatus.@npOrderKey.toString();
		//Getting Payment Status
		strPaymentStatus = OrderPaymentStatus.@paymentStatus.toString();
		//Getting podname
		strPODName = OrderPaymentStatus.@podName.toString();
		//Setting Cardprovider name
		for each(Tender in OrderPaymentStatus.Tender)
		{
			var Value = Tender.@value;
			for each(Cashless in Tender.Cashless)
			{
				if(Cashless.@cardProvider.toString().toUpperCase() == "ARCHCARD")
				{
					API.dbg("[onGetDataFromPaymentCommand] - Found Archcard...");
					Tender.@code = "11";
				}
				Cashless.@cardProvider = MapCardNames(Cashless.@cardProvider);
				publishCashlessPaymentRecord(Cashless.@cardProvider, Cashless.@cardNumber, Cashless.@expire, Cashless.@authorization,
									Cashless.@printFlag, Cashless.@sequenceNumber, Cashless.@account, "", Cashless.@account,
									Value, storeNumber, "", businessDate);
			}
		}
		//Getting tender information
		strTender = OrderPaymentStatus.Tender.toString();
		//Returning data
		ret = strOrderKey + "|" + strPODName + "|" + strPaymentStatus + "|" + strTender;
		// NVS-7154: Set isPaidMobileOrder for attended, pay by mobile flow.
		//PosDoSetCustomInfo("isPaidMobileOrder", true);
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onGetDataFromPaymentCommand] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onGetDataFromPaymentCommand] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function onGetDataFromDTCommand(sIn)
{
	var xmlProdInfo = null;
	var ret = null;
	var strCheckInData = null;
	var strExecutePaymentDT = null;
	var strCancelPaymentDT = null;
	try
	{
		if(sIn == null)
		{
			sIn='<ProdInfo/>';
		}
		xmlProdInfo = new XML(sIn);
		//Getting checkindata
		strCheckInData = xmlProdInfo.Order.@checkInData.toString();
		//Getting ExecutePaymentDTUrl
		for each(Service in xmlProdInfo.ExternalServices.Service)
		{
			if(Service.@name.toString() == "ExecutePaymentDT")
			{
				strExecutePaymentDT = Service.@url.toString();
			}
			else if(Service.@name.toString() == "CancelPaymentDT")
			{
				strCancelPaymentDT = Service.@url.toString();
			}
		}
		//Returning AOP data
		ret = strCheckInData + "|" + strExecutePaymentDT + "|" + strCancelPaymentDT;				
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onGetDataFromDTCommand] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onGetDataFromDTCommand] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}

	return ret;
}

function onMobilePaymentReceived(Status,Tender)
{
	var ret = false;
	try
	{
		var TenderXML = new XML(Tender);
		//Getting tenderID
		var TenderID = TenderXML.@code.toString();
		//Getting Value
		var Value = TenderXML.@value.toString();
		//Executing tender
		ret = PosDoTenderJS_LOCAL(TenderID,Value,"NOPREVIEW|SAVE");
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onMobilePaymentReceived] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onMobilePaymentReceived] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}
	
	return ret;	
}

function onConvertNP6ViewToCancelPaymentView(sIn,Response)
{
	var ret = sIn;
	try
	{
		var view = new XML(sIn);
		//Getting data
		for each(Info in view.CustomInfo.Info)
		{
			if(Info.@name == "OrderId")
			{
				OrderId = Info.@value;
			}
		}
		//Mounting view
		ret =  "{" + "\n";
		ret += "\"orderId\":\"" + OrderId + "\"\n";
		ret +=  "}";
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onConvertNP6ViewToCancelPaymentView] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onConvertNP6ViewToCancelPaymentView] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}
	
	return ret;
}

function onConvertNP6ViewToExecutePaymentView(sIn,Response)
{
	var ret = sIn;
	try
	{
		var view = new XML(sIn);
		//Getting data
		for each(Info in view.CustomInfo.Info)
		{
			if(Info.@name == "OrderId")
			{
				OrderId = Info.@value;
			}
		}
		var TotalValue = view.@grossAmount;
		var TotalValueNet = view.@totalAmount;
		var TotalTax = view.@totalTax;
		var npOrderKey = view.@orderKey.toString();
		
		//NVS-6957 - msilva - Localization for SDO-16244
		var storeId = rootStoreDB.StoreDB.StoreProfile.StoreDetails.StoreId; 
		//Mounting view
		ret =  "{" + "\n";
		ret += "\"orderId\":\"" + OrderId + "\",\n";
		ret += "\"totalValue\":" + TotalValue + ",\n";
		ret += "\"totalValueNet\":" + TotalValueNet + ",\n";
		ret += "\"totalTax\":" + TotalTax + ",\n";
		ret += "\"npOrderKey\":\"" + npOrderKey + "\",\n";
		ret += "\"npOrderView\":\"" + Response + "\",\n"; 
		ret += "\"storeId\":" + storeId + "\n"; 
		ret += "}"; 
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onConvertNP6ViewToExecutePaymentView] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onConvertNP6ViewToExecutePaymentView] - Stack trace: " + ex.stack, BC_EVENTS_NAME);

		return null;
	}
	
	return ret;
}

function formatCashlessString(providername, cardnum, expire, auth,
									printFlag, seqno, MerchantID, GCBalance, Account,
									Value, StoreNumber, local_GiftCard_Footer) {

		//TODO : check cashless string format
		//function ParseTrackInfo(retcode,cardType)
		//function cashlessPayment(tenderId,tenderValue,refund)
		//NVS-8999, mobile cashless string format needs to be sync with regular cashless string
		var cardType = ""; //expire date not needed, field is used by cardType
		var cardToken = emvChipIndicator = emvCVM = emvMode = emvAID = emvTVR = emvIAD = emvTSI = emvARC = cardEntryMode = cardPrintName = "";
		return 'CASHLESS:' +
				providername + '|' +
				cardnum + '|' +
				cardType + '|' +
				auth + '|0|' +
				printFlag + '|' +
				seqno + '|' +
				MerchantID + '|' +
				GCBalance + '|' +
				Account + '|' +
				Value + '|' +
				StoreNumber + '|' +
				local_GiftCard_Footer + "|"+
				""+//glo_transactionID
				"|mobile|" + //NVS-8999 after this line all fields are empty just to be sync with regular cashless3 string
				cardToken + "|" +
				emvChipIndicator + "|" +
				emvCVM + "|" +
				emvMode + "|" +
				emvAID + "|" +
				emvTVR + "|" +
				emvIAD + "|" +
				emvTSI + "|" +
				emvARC + "|" +
				cardEntryMode + "|" +
				cardPrintName +
				"|#";
}
function cashlessConvertion(tenderView) {
	API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [S]", "BCEvents.nps");				
	PosSetSessionProperty(CASHLESS,"");	
	var cardType = "CR";
	var auth = "******";
	var providername = "";
	var cardnum = "";
	var expire = "";
	var seqno = "";
	var msg = "";
	var receiptContent = "";
	var Account=0;
	var printFlag="0";
	var StoreNumber = "";//NVS-8999, NVS-9481
	var GCBalance="";
	var MerchantID = "";
	var GiftCard_Footer = GLOBAL_STOREDB.Adaptors.Adaptor.(@type == "npCLayer").Section.(@name == "AdditionalGiftCard").Parameter.(@name == "contact").@value;//NVS-8999;
	if ((tenderView != null) && (tenderView.length > 0)) {
		var TenderRoot = new XML(tenderView);
		if (TenderRoot != null) {
			providername = TenderRoot.Cashless.@cardProvider;
			cardnum = TenderRoot.Cashless.@cardNumber.toString();
			cardnum = cardnum.replace("@","0x41");
			expire = TenderRoot.Cashless.@expire;
			auth = TenderRoot.Cashless.@authorization;
			seqno = TenderRoot.Cashless.@sequenceNumber;
			printFlag = TenderRoot.Cashless.@printFlag;
			Account = TenderRoot.Cashless.@account;
			value = TenderRoot.@value;
			GiftCard_Footer = GLOBAL_STOREDB.Adaptors.Adaptor.(@type == "npCLayer").Section.(@name == "AdditionalGiftCard").Parameter.(@name == "contact").@value;//NVS-8999
			API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] providername: [" + providername + "]  - cardnum: [" + cardnum + "] - expire [" + expire + "] - auth: [" + auth + "] - seqno: [" + seqno + "] - printFlag: [" + printFlag + "] - Account: [" + Account + "] - value : [" + value + "]", "BCEvents.nps");				
			CashLessStr = formatCashlessString(providername, cardnum, expire, auth,
									printFlag, seqno, MerchantID, GCBalance, Account,
									value, StoreNumber, GiftCard_Footer); 
			API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [R] CashLessStr = [" + CashLessStr + "]", "BCEvents.nps");				
			PosAppendSessionProperty(CASHLESS,CashLessStr,true);
		}
	}
	API.STTDebugLog("0","[BCEvents.nps::cashlessConvertion] [E]", "BCEvents.nps");				
	return true;
}
function PosCashlessConvertion(tender) {
	API.STTDebugLog("0","[BCEvents.nps::PosCashlessConvertion] [S]", "BCEvents.nps");				
	var tempRetVal=cashlessConvertion(tender);
	API.STTDebugLog("0","[BCEvents.nps::PosCashlessConvertion] [E]", "BCEvents.nps");				
	return(tempRetVal);
}

function onRebuildNP6View(xmlView)
{
	try
	{
		var hlp = FOEHelper();
		//hlp.ApplyFee(1); //Use this hook to apply the fee property

		return true;
	}
	catch(ex)
	{
		API.STTErrorLog("0", "[onRebuildNP6View] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onRebuildNP6View] - Stack trace: " + ex.stack, BC_EVENTS_NAME);	
		
		return (false);
	}	
}

function onConvertView2FOEDT(sView) {
	API.STTDebugLog("0","[BCEvents.nps::onConvertView2FOEDT] [S]", "BCEvents.nps");
	try {
		if(sView==null) {
		    sView='<View/>';
		}
		
		var xmlView = new XML(sView);
				
		var viewChildren = xmlView.children();
		var xmlOut = new XML('<Order/>');


		//Order Element
		xmlOut.Order.@storedOrderKey = xmlView.CustomInfo.Info.(@name=="OrderId").@value.toString();
		xmlOut.@major = xmlView.@major;
		xmlOut.@minor = xmlView.@minor;
		//TODO : Verify which is the total amount and tax to be sent to the client
		xmlOut.@TotalAmount = xmlView.@grossAmount;
		xmlOut.@TaxAmount = xmlView.@totalTax;
		xmlOut.@SubTotalAmount = xmlView.@totalAmount;
		xmlOut.@SaleType = 2;
		xmlOut.@Currency = rootStoreDB.StoreDB.StoreProfile.Localization.CurrencySymbol.toString();
		//NPM-1946
		var saleDateString = String(xmlView.@saleDate);
		var saleTimeString = String(xmlView.@saleTime);
		var year = saleDateString.substring(0,4);
		var month = saleDateString.substring(4,6);
		var day = saleDateString.substring(6,8);
		var hours = Number(saleTimeString.substring(0,2));
		var minutes = saleTimeString.substring(2,4);
		var seconds = saleTimeString.substring(4,6);
		var ampm = hours >= 12 ? 'PM' : 'AM';
		hours = hours % 12;
		hours = hours ? hours : 12;		
		xmlOut.@OrderDate = day + "/" + month + "/" + year + " " + hours.toString() + ":" + minutes + ":" + seconds + " " + ampm;
		//xmlOut.@OrderDate = xmlView.@saleDate + " " +  xmlView.@saleTime;
		
		//SDO-7613
		xmlOut.@Number = xmlView.@orderSrc;
		xmlOut.@DisplayOrderNumber = xmlView.@orderSrc;
		xmlOut.@TotalDiscount = xmlView.@discountAftRound;
		
		//xmlOut.@Number = xmlView.CustomInfo.Info.(@name=="OrderId").@value.toString();
		//xmlOut.@DisplayOrderNumber = xmlView.CustomInfo.Info.(@name=="OrderId").@value.toString();
		//xmlOut.@TotalDiscount = xmlView.CustomInfo.Info.(@name=="totalDiscount").@value.toString();
		
		
		//SQM-1231 
		currentOrderPod = xmlView.@pod;
		currentOrderRemPod = xmlView.@remPod;
		currentOrderStatus = xmlView.@saleStatus;
		xmlOut.@Status = currentOrderStatus;
		
		// MOT-257 - FOE - Add the order number to the DoFoeStoreFromFile return view. 
		// Get a String with the order's major and minor numbers
		var majorMinor = PosMountOrderIdJS("1", xmlView.@orderKey.toXMLString(), xmlView.@major.toXMLString(), xmlView.@minor.toXMLString());
		prefix = lGetOrderPrefix(currentOrderPod, currentOrderRemPod, currentOrderStatus);
		//SQM-1231 
		
		//Not Paid order doesnt need prefix digit 
		if (currentOrderStatus == 64) { 
			xmlOut.@DisplayOrderNumber = majorMinor;	
		}else{
			xmlOut.@DisplayOrderNumber = prefix + majorMinor;	
		}
		
		var lastItem='x';
		var products = null;
		var product = null;
		var newProduct = null;
		var changedAfterTotal=false;
		
			// Adding Offers tag
			if (xmlView.Offers.length() > 0) {
				var offersTag = new XML('<Offers />');
				if (xmlView.Offers.@tagId != undefined) {
					offersTag.@tagId = xmlView.Offers.@tagId;
				}
				if (xmlView.Offers.@offerId != undefined) {
					offersTag.@offerId = xmlView.Offers.@offerId;
				}
				if (xmlView.Offers.@override != undefined) {
					offersTag.@override = xmlView.Offers.@override;
				}
				if (xmlView.Offers.@applied != undefined) {
					offersTag.@applied = xmlView.Offers.@applied;
				}
				if (xmlView.Offers.@clearAfterOverride != undefined) {
					offersTag.@clearAfterOverride = xmlView.Offers.@clearAfterOverride;
				}
				if (xmlView.Offers.@promotionId != undefined) {
					offersTag.@promotionId = xmlView.Offers.@promotionId;
				}
				if (xmlView.Offers.@promotionCounter != undefined) {
					offersTag.@promotionCounter = xmlView.Offers.@promotionCounter;
				}
				xmlOut.appendChild(offersTag);
			}
		
			// Adding Promotions tag
			if (xmlView.Promotions.Promotion.length() > 0) {
				var promotionsTag = new XML('<Promotions />');
				if(xmlView.Promotions.@authorizedZeroAmount != undefined){
					promotionsTag.@authorizedZeroAmount = xmlView.Promotions.@authorizedZeroAmount;
				}
				if(xmlView.Promotions.@tenderId != undefined){
				promotionsTag.@tenderId = xmlView.Promotions.@tenderId;
				}
				for each (var promotion in xmlView.Promotions.Promotion) {
					var promotionTag = new XML('<Promotion />');
					if (promotion.@id != undefined) {
						promotionTag.@id = promotion.@id;
					}
					if (promotion.@counter != undefined) {
						promotionTag.@counter = promotion.@counter;
					}
					if (promotion.@discountType != undefined) {
						promotionTag.@discountType = promotion.@discountType;
					}
					if (promotion.@discountAmount != undefined) {
						promotionTag.@discountAmount = promotion.@discountAmount;
					}
					if (promotion.@offerId != undefined) {
						promotionTag.@offerId = promotion.@offerId;
					}
					if (promotion.@exclusive != undefined) {
						promotionTag.@exclusive = promotion.@exclusive;
					}
					if (promotion.@promotionXml != undefined) {
						promotionTag.@promotionXml = promotion.@promotionXml;
						var hlp = new FOEHelper();
						//Convert a buffer from base64
						var promotionXmlData = hlp.revertDataFromBase64(promotion.@promotionXml.toString());
						if(promotionXmlData != null) {
							xmlPromotionData = new XML(promotionXmlData);
							//NVS-7683 - msilva
							var POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "-" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
							var promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);
							if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
								promotionTag.@promotionName = promotionLanguage.Name;
							}    else{
                                 POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "_" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
                                 promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);         
                                 if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
                                           promotionTag.@promotionName = promotionLanguage.Name;
                                 }  
                                    else {
                                            POSLanguage = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language;
                                            promotionLanguage = xmlPromotionData.Languages.Language.(@code == POSLanguage);
                                             if ((promotionLanguage != null) && (promotionLanguage != undefined)) {
                                                       promotionTag.@promotionName = promotionLanguage.Name;
                                             }
                                           }            
                                         }
		                  	}
				    }
					promotionsTag.appendChild(promotionTag);
				}
				xmlOut.appendChild(promotionsTag);
			}
			// Adding the Customer tag
			if(xmlView.Customer.length() > 0){
			var customerTag = new XML('<Customer />');
			if (xmlView.Customer.@id != undefined) {
				customerTag.@id = xmlView.Customer.@id;
			}
			if (xmlView.Customer.@nickname == undefined || xmlView.Customer.@nickname == "")
				customerTag.@nickname = " ";
			else
				customerTag.@nickname = xmlView.Customer.@nickname;
			if (xmlView.Customer.@greeting != undefined) {
				customerTag.@greeting = xmlView.Customer.@greeting;
			}
			xmlOut.appendChild(customerTag);				
		}
		
		products = new XML('<Products/>');
		xmlOut.appendChild(products);
		
		var itemView=null;
		//Items
		for each (itemView in xmlView.ItemView) {
 			//Remove open choices from FOE Response XML
			var productType = Number(itemView.productType);
			var displayGroup = Number(itemView.displayGroup);
			//NPS-12196
			var isAC = itemView.AutoCondiment; 
			if (isAC == 'true') { 
				continue; 
			}
			//			
			if(productType == 4 || (itemView.isGrillLine!='true' && displayGroup == 4))
			{ //productType == 4 -> indicates an open choice
				continue;
			}
			
			newProduct = new XML('<Product/>');

			var defQty = Number(itemView.componentDefaultQtd);
			var qty = Number(itemView.quantity);			
			
			if(itemView.isGrillLine=='true') {
				//Grill
				//Modifiers
				newProduct.@IsGrill = 1;
				newProduct.@IsLight = itemView.specialModifiers;

				if(itemView.specialModifiers!="0") {
					newProduct.@Quantity = defQty;
				} else if(defQty>0) {
					newProduct.@Quantity = defQty+qty;
				} else {
					newProduct.@Quantity = qty;
				}

			} else {
				newProduct.@Quantity = qty;
				newProduct.@IsGrill = 0;
				newProduct.@IsLight = 0;
			}

			newProduct.@DefaultQuantity = defQty;
			newProduct.@ProductCode = itemView.productCode;
			newProduct.@Name = itemView.longName;
			newProduct.@UnitPrice = itemView.unitPrice;
			newProduct.@TotalActualCost = itemView.totalPrice;
			newProduct.@TotalTax = itemView.totalTax;
			newProduct.@Currency = rootStoreDB.StoreDB.StoreProfile.Localization.CurrencySymbol.toString();
			newProduct.@UnitPrice = itemView.unitPrice;
			newProduct.@ProductType = itemView.productType;
			newProduct.@Level = itemView.level;
			newProduct.@DisplayGroup = itemView.displayGroup;	
			newProduct.@IsGrillLine = itemView.isGrillLine;			
			//NPM-2724
			newProduct.@QuantityPromoted= itemView.quantityPromo;			
			
			if(Number(itemView.totalTax) == 0 && Number(itemView.totalPrice)>0)
			{
				newProduct.@IsNoTax = 1;
			}
			else
			{
				newProduct.@IsNoTax = 0;
			}
			
			//changedAfterTotal
			if(!changedAfterTotal) {
				changedAfterTotal = (itemView.quantityChanged=='true'||itemView.quantityChanged=='TRUE');
			}
			if ( itemView.PromotionApplied.length()>0){
			var promotionApplied = new XML('<PromotionApplied/>');
				if (itemView.PromotionApplied.@promotionId != undefined) {
			 promotionApplied.@promotionId = itemView.PromotionApplied.@promotionId;
						}
				if (itemView.PromotionApplied.@promotionCounter != undefined) {
			 promotionApplied.@promotionCounter = itemView.PromotionApplied.@promotionCounter;
						}
				if (itemView.PromotionApplied.@eligible != undefined) {
			 promotionApplied.@eligible = itemView.PromotionApplied.@eligible;
						}
				if (itemView.PromotionApplied.@originalPrice != undefined) {
			 promotionApplied.@originalPrice = itemView.PromotionApplied.@originalPrice;
						}
				if (itemView.PromotionApplied.@discountAmount != undefined) {
			 promotionApplied.@discountAmount = itemView.PromotionApplied.@discountAmount;
						}
				if (itemView.PromotionApplied.@discountType != undefined) {
			 promotionApplied.@discountType = itemView.PromotionApplied.@discountType;
						}
				if (itemView.PromotionApplied.@originalItemPromoQty != undefined) {
			 promotionApplied.@originalItemPromoQty = itemView.PromotionApplied.@originalItemPromoQty;
						}
				if (itemView.PromotionApplied.@originalProductCode != undefined) {
			 promotionApplied.@originalProductCode = itemView.PromotionApplied.@originalProductCode;
						}
				if (itemView.PromotionApplied.@offerId != undefined) {
			 promotionApplied.@offerId = itemView.PromotionApplied.@offerId;
						}
				if (itemView.PromotionApplied.@discountLimit!= undefined){
			 promotionApplied.@discountLimit = itemView.PromotionApplied.@discountLimit;
						}			
				if (itemView.PromotionApplied.Actions.length() > 0) {				
				 var actions = new XML('<Actions/>');
					for each(var action in itemView.PromotionApplied.Actions.Action){
					 var actionTag = new XML('<Action/>');
						 if ( action.@name != undefined){
					 actionTag.@name = action.@name;
						 }
						 if( action.@newValue != undefined){
					 actionTag.@newValue = action.@newValue;
						 }
						 if( action.@oldValue != undefined){
					 actionTag.@oldValue = action.@oldValue;
			 }
						 actions.appendChild(actionTag);
						 }
					promotionApplied.appendChild(actions);
				 }
				newProduct.appendChild(promotionApplied);
			}			
			products.appendChild(newProduct);
		}

		API.dbg("[xmlView.ItemTenderView]["+xmlView.ItemTenderView+"]");
		var cashless = null;
		var cashlessCounter=0;
		var itemTenderView=null;
		var cashlessArray = xmlView.Cashless.split(CARDLESS_INFO_SEPARATOR);
		//Tender + Cashless
		for each (itemTenderView in xmlView.ItemTenderView) {
			item = new XML('<Tender/>');

			item.@code = itemTenderView.code;
			item.@qty = itemTenderView.qty;
			item.@value = itemTenderView.value;
			item.@srcPOSId = itemTenderView.srcPOSId;
			item.@discMode = itemTenderView.discMode;

			//Cashless
			if(itemTenderView.cat=="TENDER_ELECTRONIC_PAYMENT") {
				API.dbg("[xmlView.Cashless]["+cashlessArray[cashlessCounter]+"]");
				
				cashless = stripCashlessString(cashlessArray[cashlessCounter]);
				item.appendChild(cashless);
				cashlessCounter++;
			}
			API.dbg("[Tender Item]["+item+"]");
			xmlOut.appendChild(item);
		}
/*
		var itemViewTimes=null;
		//Times
		for each (itemViewTimes in xmlView.ViewTimes) {
			item = new XML('<Times/>');
			item.@totalTime = itemViewTimes.@totalTime;
			item.@storeTime = itemViewTimes.@storeTime;
			item.@orderTime = itemViewTimes.@orderTime;
			xmlOut.Order.appendChild(item);

			//Only one by XML
			break;
		}
*/
		API.dbg("[XmlOut]["+xmlOut+"]");
		return(xmlOut.toXMLString());
	} catch( ex ) {
		
		API.STTErrorLog("0", "[onConvertView2FOEDT] - " + ex.message, BC_EVENTS_NAME);
		API.STTErrorLog("0", "[onConvertView2FOEDT] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
	
		return (null);
	}

	//***** HELPER FUNCTIONS ******//
	function stripCashlessString(cashlessStr) {
		//TODO : check cashless string format
		//function ParseTrackInfo(retcode,cardType)
		//function cashlessPayment(tenderId,tenderValue,refund)
		var cashless = new XML('<cashless/>');
		//TODO : check the split
		API.dbg("[cashlessStr]["+cashlessStr+"]");
		var splitStr = cashlessStr.split("@");
		API.dbg("[splitStr]["+splitStr+"]");			
		for(i=0; i < splitStr.length; i++) {
			API.dbg("[splitStr - "+i+"]["+splitStr[i]+"]");
		}
		if(splitStr.length<12) {			
			return cashless;
		}

		cashless.@cardProv = splitStr[0].split(":")[1];
		cashless.@cardNum = splitStr[1];
		cashless.@expire = splitStr[2];
		cashless.@auth = splitStr[3];
		cashless.@printFlag = splitStr[5];
		cashless.@seqNo = splitStr[6];
		cashless.@gcBalance = splitStr[10];
		cashless.@account = splitStr[11];
		
		API.dbg("[cashless]["+cashless.toXMLString()+"]");
		
		return cashless;
	}
	
	function lGetOrderPrefix(currentOrderPod, currentOrderRemPod, currentOrderStatus) {
		var i;
		var orderPrefix;
		var podSource;
		var orderStatus;
		
		try {
		
			API.STTInfoLog("0", "[lGetOrderPrefix] - Initiating function", BC_EVENTS_NAME);
			
			resultRemPod = lParsePodCode(currentOrderRemPod);
					
			// Search the PodSource array for a corresponding Rem POD.
			for (i in foeRoutingPodSourceArray) {
			
				podSource = foeRoutingPodSourceArray[i];
				
				// If a matching Pod Source was found, check to see if the order status also match.
				if (podSource == currentOrderRemPod) {
					
					orderStatus = foeRoutingPaidStatusArray[i];
					
					// If the order status also match.
					if (orderStatus == currentOrderStatus) {
					
						orderPrefix = foeRoutingOrderNumberPrefixArray[i];
						//If have a configuration error, the prefix returned is "00"
						if(orderPrefix == undefined) {
							orderPrefix = "00";
						}
						break;
					}
				}	
			}
			//If have a configuration error, the prefix returned is "00"
			if(orderPrefix == undefined) {
				orderPrefix = "00";
			}
			
			API.STTInfoLog("0", "[lGetOrderPrefix] - This function was successfully executed. Returned Order Prefix value: " + orderPrefix, BC_EVENTS_NAME);
			
			return orderPrefix;
			
		} catch( ex ) {
			API.STTErrorLog("0", "[lGetOrderPrefix] - " + ex.message, BC_EVENTS_NAME);
			API.STTErrorLog("0", "[lGetOrderPrefix] - Stack trace: " + ex.stack, BC_EVENTS_NAME);
			return (null);
		}
	}
}

/** onCheckTotalAmount
 * @brief Event used to verify whether or not the total amount is zeroed and, if true, if it the order can be accept . If this event returns false, the current order is can not be accepted.
 * @param totalAmount - string - (numeric value) total order amount
 * @since MOT-658
 */
function onCheckTotalAmount_DISABLE (totalAmount) {

	API.STTInfoLog("0", "[onCheckTotalAmount] - Initiating function.", BC_EVENTS_NAME);

	cmd = "cPosCheckPromotedOrder";
	if(!executeBC(cmd)) {

		var hlp = new BusinessObjectHelper;
		
		// test order total price
        var amount=new BigDecimal(totalAmount);
	    var isRedeemable = hlp.isSaleRedeemableOnly();    

		API.STTInfoLog("0", "[onCheckTotalAmount] - totalAmount:" + totalAmount + ", amount:" + amount + ", isRedeemable:" + isRedeemable, BC_EVENTS_NAME);

        if(amount.compareTo("0.00") == 0 && !isRedeemable)
		{
			var orderType = hlp.GetMobileOrderStatus(); 
			var isOT = PosCheckSessionProperty("workingMode" ,"orderTaker")
			API.STTInfoLog("0", "[onCheckTotalAmount] - OrderType:" + orderType + ", orderTaker:" + isOT , BC_EVENTS_NAME);
			
			if(orderType != POS_ORDER && isOT)	//If mobile order to DT, do additional validation...
			{
				API.STTInfoLog("0", "[onCheckTotalAmount] - Zeroed mobile order...", BC_EVENTS_NAME);
				// get the sale description 
				var curView = hlp.getCurrentView();
				if(curView == null) {
					return true;
				}
				// create a XML object
				var view = new XML(curView);
				if(null == view) {
					return true;
				}

				// filter the order items
				var items=view.ItemView.(level == 0 && quantity > 0);
				if(null == items) {
					return true;
				}

				// check if this order is a promo order
				var testZeroPrice = false;
				var item = null; 
				for each (item in items) {
					var productNode = productDictionary[item.productCode];
					if(productNode.CustomParameters.Parameter.(@name=="mobileInvalidItemDummyProd").@value.toString().toUpperCase() == "TRUE") {
						API.STTInfoLog("0", "[onCheckTotalAmount] - Zeroed mobile order with special product...", BC_EVENTS_NAME);
						return true;
					}
				}				
			}
			if(!PosHasSalePromotion()) {
				// zero price order
				PosShowMessage("MSG_BC_ZERO_TOTAL");
				return false;
			}
		}
	}

	return true;
}

/** onOrderFinalized
 * @brief Event  called by Rps after an order being processed
 * @param 
 * @since NPS-11471
 */
function onOrderFinalized() {
 	return true;
}

/** onCancelRefundByOrder
 * @brief Event  called when refund by order is cancelled by operator
 * @param 
 * @since NPS-11471
 */
function onCancelRefundByOrder() {
	return true;
}

/** SetupCashless30
 * @Set up Cashless 3.0
 * @param 
 * @for NVS-1690
 */
function SetupCashless30functions() {
	cashlessPayment = cashlessPayment30;		
	ChangeIdleMessage = ChangeIdleMessage30;
	CleanCashlessState = CleanCashlessState30;
	DayOpenPED = DayOpenPED30;
	GCBalanceJS = GCBalanceJS30;
	GCCashOutJS = GCCashOutJS30;
	PinpadIsOnlineJS = PinpadIsOnlineJS30;
	PosActivateGCJS = PosActivateGCJS30; 
	PosCashlessEndOfSale = PosCashlessEndOfSale30;
	PosCashlessPayment = PosCashlessPayment30;
	PosRefundCashlessPayment = PosRefundCashlessPayment30;
	PosResetPinpad = PosResetPinpad30;
	StartCashlessSession = StartCashlessSession30;
	StopCashlessSession = StopCashlessSession30;
	ResetEverest = ResetEverest30;
	PosDisplayLaneOpenMessage = PosDisplayLaneOpenMessage30;
	return true;
}
/** SetupCashless20 - Everest
 * @Set up Cashless 2.0
 * @param 
 * @for NVS-1690
 */
function SetupCashless20functions() {
	cashlessPayment = cashlessPayment20;	
	ChangeIdleMessage = ChangeIdleMessage20;
	CleanCashlessState = CleanCashlessState20;
	DayOpenPED = DayOpenPED20;
	GCBalanceJS = GCBalanceJS20;
	GCCashOutJS = GCCashOutJS20;
	PinpadIsOnlineJS = PinpadIsOnlineJS20;
	PosActivateGCJS = PosActivateGCJS20; 	
	PosCashlessEndOfSale = PosCashlessEndOfSale20;
	PosCashlessPayment = PosCashlessPayment20;
	PosRefundCashlessPayment = PosRefundCashlessPayment20;	
	PosResetPinpad = PosResetPinpad20;	
	StartCashlessSession = StartCashlessSession20;
	StopCashlessSession = StopCashlessSession20;
	ResetEverest = ResetEverest20;
	PosDisplayLaneOpenMessage = PosDisplayLaneOpenMessage20;
	return true;
}

function onDayClosed(closeMode, level) {
	

	return PerformCutoverIfNeeded();
}

function PerformCutoverIfNeeded()
{
	if (PosCheckParameter("Cashless3", "Active", "true")) 
	{
		rootCtx = new SessionContext;
		
		PosCreateReport("ALL", "getNumCashlessTransactions@reports.nps", "NOPREVIEW|SKIP");
		var transCount = rootCtx.get("cashless_total_transaction_count");
		
		if(Number(transCount) > 0)
		{
			API.dbg("onDayClosed: transaction count = " + transCount + ", executing CashlessEndOfDay()");		
			CashlessEndOfDay();
		}
		else
		{
			API.dbg("onDayClosed: transaction count = " + transCount + ", NOT executing CashlessEndOfDay()");
		}
			
	}

	return true;
}

function onEndOfDay(closeMode, level){ 
	//NVS-3674 - msilva
	PosSetSessionProperty("pickListAutomaticPrint","off","true","false");
} 

function PosBuildDisableListJS() { 
	var hlp = new BusinessObjectHelper();
	obj = "";

	hlp.iterateProductDB(obj,"statusCode=\"ACTIVE\"");
	API.dbg("PosProdDBJS: DisableString = " + DisableString);
    	PosSetSessionProperty("ChoiceDisableList", DisableString, "false");
	
} 
/** COECheckForCashDrawer
 * @brief Checks to see if the node has a cash drawer
 * @param 
 * @for NVS-6039
 */
function COECheckForCashDrawer(){
	if (typeof(PosCheckCashDrawer) == "function"){
		return(PosCheckCashDrawer());
	}else{
		return true;
	}
}

/** formatMobileOrderItems
 * @brief Formats mobile order items
 * @param 
 * @for NVS-6309
 */
function formatMobileOrderItems(itemsView, invalidItemsView) {
	var outputBuffer = new StringBuffer();
	var hlp = new BusinessObjectHelper;
	var xmlItemsView = XML(itemsView);
	var xmlInvalidItemsView = XML('<InvalidItemsView>' + invalidItemsView + '</InvalidItemsView>');
	var invalidItemsHeader = '<l>' + API.geti18nMsg(5, "RES_LABEL_UNAVAILABLE_ITEMS");
	var validItemsHeader = '<l>' + API.geti18nMsg(5, "RES_LABEL_AVAILABLE_ITEMS");
	var invalidPromotionsHeader = '<l>Invalid Offers';
	var msgInvalidationReason;
	var hasInvalidItems = invalidItemsView !== "";

	//Print offer's name if there is one
	var promotionName = String(xmlItemsView.Promotions.Promotion.( @ id == xmlItemsView.Offers. @ promotionId). @ promotionName);

	if (promotionName != '') {
		addLine("<l>" + API.geti18nMsg(1, "MSG_BC_OFFERS_APPLIED") + ":");
		addLine("<l>" + promotionName);
		addLine();
	}

	if (xmlItemsView.ItemView.length() == 0 && hasInvalidItems==true) { 
		addLine("<l>" + API.geti18nMsg(5, "RES_LABEL_ALL_ORDER_ITEMS_UNAVAILABLE")); 
	} 
	else if (hasInvalidItems == true) { 
		addLine("<l>" + API.geti18nMsg(5, "RES_LABEL_INVALID_ORDER"));
	}

	var bShowHeader = true;
	for each(var item in xmlInvalidItemsView.InvalidItemView) {
		if (Number(item.quantity) > 0) {
			if (true == bShowHeader) {
				addLine();
				addLine(invalidItemsHeader);
				bShowHeader = false;
			}
			
			//NVS-6852 - msilva - Product name is not displayed on the Mobile Order Recall screen when product is inactive
			var languageName = GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.Language + "_" + GLOBAL_STOREDB.StoreDB.StoreProfile.Localization.CountryId;
			
			var productName = getProductName(item.productCode, languageName, ProductNameType2.DTName);

			productName = productName === null ? "pc:" + item.productCode : productName;

			//We should avoid errorCode 62 (NVS-6778)
			if(item.validationCode != 62)
			{
				var msgvalidationCode = hlp.getSysMessage("MSG_PRODUCTVALIDATIONCODE_" + item.validationCode);
				addLine("<s>" + item.quantity + " " + productName + " (" + msgvalidationCode + ")");
			}
			else
			{
				addLine("<s>" + item.quantity + " " + productName);
			}
		}
	}

	bShowHeader = true;
	for each(var promotion in xmlInvalidItemsView.InvalidPromotions.Promotion) {
		if (true == bShowHeader) {
			addLine();
			addLine(invalidPromotionsHeader);
			bShowHeader = false;
		}
		switch (promotion. @ rejection.toString()) {
		case "Expired":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_EXPIRED");
			break;
		case "InvalidStore":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_INVALID_STORE");
			break;
		case "MissingProducts":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_MISSING_PRODUCTS");
			break;
		case "InvalidPod":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_INVALID_POD");
			break;
		case "InvalidDateTime":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_INVALID_DATE_TIME");
			break;
		case "InvalidItems":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_INVALID_ITEMS");
			break;
		default:
		case "Other":
			msgInvalidationReason = hlp.getSysMessage("MSG_PROMOTION_VALIDATION_OTHER");
			break;
		}
		addLine("<s>" + promotion. @ promotionName + " - " + msgInvalidationReason);
	}

	bShowHeader = hasInvalidItems;

	var levelQty = []; // stores the current quantity for each level in the view

	for each(var item in xmlItemsView.ItemView) {

		if (Number(item.quantity) != 0) {
			if (true == bShowHeader) {
				addLine();
				addLine(validItemsHeader);
				bShowHeader = false;
			}

			//Calculating quantity
			
			if(levelQty.length == 0 || levelQty.length < (Number(item.level)-1)) {
				levelQty.push(Number(item.quantity));
			}
			else{
				levelQty[Number(item.level)] = Number(item.quantity);
			}
			
			var diffQty = Number(item.componentDefaultQtd) + Number(item.grilledQuantity);
			var qtyText = "";

			if(Number(item.level) > 0){
				qtyText += String(Number(item.quantity) * levelQty[Number(item.level) - 1]);
			}
			else{
				qtyText += item.quantity;
			}
			
			var isChoice = (item.solvedChoice != undefined);

			if(diffQty <= 0 && !isChoice)
			{
				qtyText = "" + API.geti18nMsg(1, "MSG_SL_NO");
			}
			
			//NVS-7596
			if (0 == Number(item.level)) { 
				addLine((hasInvalidItems ? "<s>" : "<l>") + qtyText + " " + item.dtName); 
			} else {	
				addLine("<s>" + Array(Number(item.level) + 1).join(" ") + qtyText + " " + item.dtName); 
			} 			
			
		}
	}

	return outputBuffer;

	function addLine(line) {
		if (line != null) {
			outputBuffer.append(line);
		}
		outputBuffer.append("\n");
	}
}
function onHALO(currentValue,highAmountSaleLimit)
{
	if(isUberEatsOrder())
	{
		return true;
	}
	
    var sConfMsg = "";//= rootHlp.getSysMessage("MSG_PROMPTHALO", currentValue, highAmountSaleLimit);
     // NVS-6851 Tishin Thomas HILO/HALO showing wrong Popup 2/1/2017
     var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
   
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTHALO_BIOMETRICS", currentValue, highAmountSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTHALO", currentValue, highAmountSaleLimit);
				}
			API.dbg("TISH sConfMsg"+sConfMsg);
	if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	// NVS-6820 Tishin Thomas HILO/HALO orders can not be completed 1/31/2017
	return true;
}

function onHILO(nQtty, nHighQuantitySaleLimit)
{
	if(isUberEatsOrder())
	{
		return true;
	}

    var sConfMsg = "";
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTHILO_BIOMETRICS", nQtty, nHighQuantitySaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTHILO", nQtty, nHighQuantitySaleLimit);
				}
			API.dbg("TISH sConfMsg"+sConfMsg);
    if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	// NVS-6820 Tishin Thomas HILO/HALO orders can not be completed 1/31/2017
	return true;
}
function onGiftCardHILO(nQtty, nSaleLimit)
{
	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTGCHILO_BIOMETRICS", nQtty, nSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTGCHILO", nQtty, nSaleLimit);
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onReductionHILOBeforeTotal(nQtty, nSaleLimit)
{

	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTBT_BIOMETRICS", nQtty, nSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTBT", nQtty, nSaleLimit);
				}
			 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onReductionHILOAfterTotal(nQtty, nSaleLimit)
{

	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTAT_BIOMETRICS", nQtty, nSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTAT", nQtty, nSaleLimit);
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onReductionHALOAfterTotal(nQtty, nSaleLimit)
{

	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTVAT_BIOMETRICS", nQtty, nSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTREDUCTVAT", nQtty, nSaleLimit);
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onManagerAuthorizationforZeroValueOrder()
{

	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_BC_MANAGER_AUTHORIZATION_ON_ZERO_VALUE_ORDER_BIOMETRICS");
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_BC_MANAGER_AUTHORIZATION_ON_ZERO_VALUE_ORDER");
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onManagerAuthorizationforIndividualDiscount(NAME, nQtty, nSaleLimit)
{

	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTINDIVIDUALDISCOUNTLIMIT_BIOMETRICS",NAME, nQtty, nSaleLimit);
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_PROMPTINDIVIDUALDISCOUNTLIMIT",NAME, nQtty, nSaleLimit);
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
function onSwitchProduction()
{
	var sConfMsg;
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization","Security");
				if(operatorLoginMethod == "biometric"){
					sConfMsg = rootHlp.getSysMessage("MSG_BC_SWITCH_WARN_BIOMETRICS");
				}
				else {
					sConfMsg = rootHlp.getSysMessage("MSG_BC_SWITCH_WARN");
				}
			
	 if (!PosGetAuthorizationJSUS("manager", sConfMsg)) {
        return false;
    }
	return true;
}
// NVS-7370
function onPromoAmountLimitExceededAuthorization()
{
	var authorizationMsg = "MSG_BC_PROMO_ITEM_AMT_LIMIT";
	//NVS-5851
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization", "Security");
	if (operatorLoginMethod == "biometric") {
		authorizationMsg = "MSG_PROMPTPROMOAMTAUTHBIO";
	}
	// NVS-7370
	var result = PosGetAuthorizationJSUS("manager", authorizationMsg);
	if (result == true) {
		PosDoSetCustomInfo("authorizedForAmt", true);
		// Lindomar Araujo - Jun/26/2017 - NVS-7781 - Changed to do not ask manager authorization for promotion amount if it's already provided for promotion quantity
		PosSetSessionProperty("authorizedForAmt", "true", true);
	}
	return result;
}
// NVS-7370
function onPromoQuantityLimitExceededAuthorization()
{
	var authorizationMsg = "MSG_BC_PROMO_ITEM_QUAN_LIMIT";
	//NVS-5851
	var operatorLoginMethod = rootHlp.findParamInSectionWide("managerAuthorization", "Security");
	if (operatorLoginMethod == "biometric") {
		authorizationMsg = "MSG_PROMPTPROMOQTYAUTHBIO";
	}
	// NVS-7370
	var result = PosGetAuthorizationJSUS("manager", authorizationMsg);
	if (result == true) {
		PosDoSetCustomInfo("authorizedForQty", true);
		// Lindomar Araujo - Jun/26/2017 - NVS-7781 - Changed to do not ask manager authorization for promotion amount if it's already provided for promotion quantity
		PosSetSessionProperty("authorizedForQty", "true", true);
	}
	return result;
} 

/** 
 * @brief Set donationProducts separeted by "," then donation is added to the order.
 * @NVS-7718 - msilva - MCD is requesting a task to add an identifier to Donation menu item in the STLD 
 * @return true if function identifies and add the donationProducts tag to the sale custominfo, false otherwise. 
 */
function PosSetDonationInfo(){
	
	var currentView = hlp.getCurrentView();
	if(currentView == undefined || currentView == null || currentView == "")
	{
		return false;
	}
	
	var orderView = new XML(currentView);
	
	if(orderView == undefined || orderView == null || orderView == "")
	{
		return false;
	}
	
	var donationProducts = "";
	
	for (var i = 0; i < orderView.ItemView.length(); ++i) {
		
		var itemView = orderView.ItemView[i];
		
		if(itemView.donationProduct != undefined && (itemView.donationProduct == "true" || itemView.donationProduct == true))
		{
			if(donationProducts == ""){
				donationProducts = itemView.productCode;
			}else{
				donationProducts += "," + itemView.productCode
			}
		}
	}
	
	if(donationProducts != ""){
		PosDoSetCustomInfo("donationProducts", donationProducts);
		API.dbg("PosSetDonationInfo donationProducts setted successfully = " + donationProducts);
		return true;
	}

	return false;
}
/**
 * @brief - Localization to Filter Home Delivery Orders
 * @author - Felipe Ramas
 * @since - 9/07/2017 NVS-8425
 */
function onFilterHomeDeliveryOrders(prodInfos) {
	try {
		var xml = new XML(prodInfos);
		for(var i = 0 ; i < xml.ProdInfo.length() ; i++) {
			if(xml.ProdInfo[i].Order.@deliveryBillableSale != "true" || xml.ProdInfo[i].Order.@customerNickname != "UberEats") {
				delete xml.ProdInfo[i];
				i--;
			}
		}
		return xml.toString();
	} catch(e) {
		return false;                
	}        
}

/** 
 * @brief Set UberEats sale type based on the UberSaleTypeMode configuration parameter.
 * @since UberEats NVS-8161/NVS-8495 - msilva - UberEats Auto Injected Orders
 */
function UberEatsUpdateProdinfoSaleType(xmlView){
	
	//-1 - No change; 0 - EATIN; 1 - TAKEOUT; 2 - OTHER
	var uberSaleTypeMode = API.findParamInSectionConfig("UberSaleTypeMode","Cash");
	
	if(uberSaleTypeMode == undefined || uberSaleTypeMode == null || uberSaleTypeMode == ""){
		uberSaleTypeMode = API.findParamInSectionWide("UberSaleTypeMode","Cash");
	}

	switch(uberSaleTypeMode)
	{
		case "-1": //POS behavior
			return true;
		case "0": //Eat In
			xmlView.@type = "0";
			break;
		case "1": //Take Out
			xmlView.@type = "1";
			break;
		case "2": //Others
			xmlView.@type = "2";
			break;
		default: //Default: Take Out
			xmlView.@type = "1";
			break;
	}
	
	return true;
}

/* signed aut version 9-9076
 * authority id = coe
 * authority level = 40
 * authority name = NewPOS COE developer
 * group = npi
 * validity = 2010-04-18
 * signature type = slash_star
 * time stamp (GMT) = Wed Jan 31 01:28:44 2018
 * certificate = 393735312d3739343700aecd69e17a615cbe114ea9896858db786ffaa256f87e89cb20665b7dfd2957c030e6c47e53135daf757ab9a928a6a916920b0010
 * =================================================================================================================================
*/
